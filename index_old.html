<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invision - ÊäïË≥áÊà¶Áï•„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†</title>
    <meta name="description" content="ÊäïË≥á„ÇíÂßã„ÇÅ„ÇãÂâç„Å´„ÄÅËá™ÂàÜ„ÇíÁü•„Çã„ÄÇInvision„ÅØ„ÄÅ„ÅÇ„Å™„Åü„Å´ÊúÄÈÅ©„Å™ÊäïË≥áÊà¶Áï•„ÇíÂ∞é„ÅèÈ´òÂìÅË≥™„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†„Åß„Åô„ÄÇ">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/framer-motion@11/dist/framer-motion.js"></script>
    <script src="cards.js?v=2"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FIREBASE SDKs (Compat version for simple HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        /* =========================================
           [USER SETUP REQUIRED] FIREBASE CONFIGURATION
           Firebase„Ç≥„É≥„ÇΩ„Éº„É´„ÅÆ„Äå„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË®≠ÂÆö„Äç„Åã„Çâ„Ç≥„Éî„Éº„Åó„Åü
           firebaseConfig „ÅÆ‰∏≠Ë∫´„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
           
           ‚Äª apiKey„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØ„Äå„Éá„É¢„É¢„Éº„ÉâÔºà‰øùÂ≠ò„Åï„Çå„Å™„ÅÑÔºâ„Äç„ÅßÂãï‰Ωú„Åó„Åæ„Åô„ÄÇ
           ========================================= */
        const firebaseConfig = {
            apiKey: "AIzaSyAxr2BB2pOPTGENaMHgyVqUne0AjX9LQkI",
            authDomain: "invison-demo.firebaseapp.com",
            projectId: "invison-demo",
            storageBucket: "invison-demo.firebasestorage.app",
            messagingSenderId: "836688239433",
            appId: "1:836688239433:web:fed3a1fedc790d6a909898",
            measurementId: "G-F6H4QZGGQ4"
        };

        // Initialize Firebase if config is present
        let auth, db;
        let isFirebaseReady = false;

        if (firebaseConfig.apiKey) {
            try {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseReady = true;
                console.log("‚úÖ Firebase initialized!");
            } catch (e) {
                console.error("Firebase init failed:", e);
            }
        } else {
            console.log("‚ö†Ô∏è No Firebase config found. Running in Demo Mode.");
        }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        obsidian: '#050505',
                        matte: '#0a0a0a',
                        carbon: '#111111',
                        ash: '#1a1a1a',
                        stone: '#2a2a2a',
                        gold: '#C9A227',
                        platinum: '#E8E8E8',
                        dim: '#666666',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'ticker': 'ticker 40s linear infinite',
                    },
                    keyframes: {
                        ticker: {
                            '0%': { transform: 'translateX(0)' },
                            '100%': { transform: 'translateX(-100%)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* ============================================
           DESIGN TOKENS
           ============================================ */
        :root {
            /* Colors - Primary */
            --color-gold: #C9A227;
            --color-gold-light: #E8D068;
            --color-gold-dark: #9A7B1E;

            /* Colors - Neutral */
            --color-obsidian: #050505;
            --color-ash: #1A1A1A;
            --color-platinum: #E8E8E8;
            --color-dim: #6B7280;

            /* Colors - Semantic */
            --color-success: #10B981;
            --color-warning: #F59E0B;
            --color-error: #EF4444;
            --color-info: #3B82F6;

            /* Spacing Scale (4px base) */
            --space-1: 0.25rem;
            /* 4px */
            --space-2: 0.5rem;
            /* 8px */
            --space-3: 0.75rem;
            /* 12px */
            --space-4: 1rem;
            /* 16px */
            --space-5: 1.25rem;
            /* 20px */
            --space-6: 1.5rem;
            /* 24px */
            --space-8: 2rem;
            /* 32px */
            --space-10: 2.5rem;
            /* 40px */
            --space-12: 3rem;
            /* 48px */
            --space-16: 4rem;
            /* 64px */

            /* Typography Scale */
            --text-xs: 0.75rem;
            /* 12px */
            --text-sm: 0.875rem;
            /* 14px */
            --text-base: 1rem;
            /* 16px */
            --text-lg: 1.125rem;
            /* 18px */
            --text-xl: 1.25rem;
            /* 20px */
            --text-2xl: 1.5rem;
            /* 24px */
            --text-3xl: 1.875rem;
            /* 30px */
            --text-4xl: 2.25rem;
            /* 36px */

            /* Border Radius */
            --radius-sm: 2px;
            --radius-md: 4px;
            --radius-lg: 8px;
            --radius-full: 9999px;

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 300ms ease;
            --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 50px rgba(0, 0, 0, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background: var(--color-obsidian);
            color: var(--color-platinum);
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
        }

        /* ============================================
           SCROLLBAR STYLES
           ============================================ */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: var(--color-obsidian);
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-gold);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-full);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(201, 162, 39, 0.3);
            border-radius: var(--radius-full);
        }

        /* ============================================
           BUTTON STYLES
           ============================================ */
        .btn-sharp {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all var(--transition-slow);
            cursor: pointer;
            font-weight: 600;
        }

        .btn-sharp:hover {
            border-color: rgba(201, 162, 39, 0.4);
            color: var(--color-gold);
            background: rgba(201, 162, 39, 0.03);
        }

        .btn-primary {
            background: var(--color-gold);
            color: var(--color-obsidian);
            border: none;
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-sm);
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .btn-primary:hover {
            background: var(--color-gold-light);
            box-shadow: 0 0 20px rgba(201, 162, 39, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-platinum);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--color-error);
            border: 1px solid rgba(239, 68, 68, 0.5);
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .btn-danger:hover {
            background: var(--color-error);
            color: white;
        }

        /* ============================================
           INPUT STYLES
           ============================================ */
        .input-base {
            width: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
            padding: var(--space-3) var(--space-4);
            color: var(--color-platinum);
            font-size: var(--text-sm);
            transition: border-color var(--transition-normal);
            outline: none;
        }

        .input-base:focus {
            border-color: var(--color-gold);
        }

        .input-base::placeholder {
            color: var(--color-dim);
        }

        /* ============================================
           TYPOGRAPHY
           ============================================ */
        .text-gold-gradient {
            background: linear-gradient(135deg, var(--color-gold), var(--color-gold-light));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .text-label {
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--color-dim);
        }

        /* ============================================
           EFFECTS
           ============================================ */
        .grain::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.15;
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        .custom-shadow {
            box-shadow: var(--shadow-xl);
        }

        .subtle-border {
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        /* Luxury glow effects */
        .luxury-glow {
            box-shadow:
                0 0 80px rgba(201, 162, 39, 0.1),
                0 0 120px rgba(201, 162, 39, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .luxury-glow::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(105deg,
                    transparent 20%,
                    rgba(255, 255, 255, 0.03) 25%,
                    transparent 30%);
            animation: shimmer 8s infinite;
        }

        .luxury-glow:hover {
            box-shadow:
                0 0 100px rgba(201, 162, 39, 0.15),
                0 0 150px rgba(201, 162, 39, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Frosted glass effect */
        .glass-panel {
            background: linear-gradient(135deg, rgba(28, 28, 28, 0.8), rgba(18, 18, 18, 0.6));
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 0 80px rgba(201, 162, 39, 0.03);
        }

        /* ============================================
           ERROR / FEEDBACK STYLES
           ============================================ */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-sm);
            padding: var(--space-3) var(--space-4);
            color: var(--color-error);
            font-size: var(--text-sm);
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: var(--radius-sm);
            padding: var(--space-3) var(--space-4);
            color: var(--color-success);
            font-size: var(--text-sm);
        }

        .warning-message {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: var(--radius-sm);
            padding: var(--space-3) var(--space-4);
            color: var(--color-warning);
            font-size: var(--text-sm);
        }

        /* Radar Chart Animations */
        @keyframes radarDraw {
            to {
                stroke-dashoffset: 0;
            }
        }

        @keyframes radarFadeIn {
            to {
                opacity: 1;
            }
        }

        /* iOS Install Prompt */
        .ios-share-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border: 2px solid #C9A227;
            border-radius: 6px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback, useReducer } = React;
        const { motion, AnimatePresence } = Motion;

        // ============================================
        // SHARED CONSTANTS
        // ============================================
        const profiles = [
            {
                id: 'guardian',
                name: 'The Guardian',
                nameJp: 'ÂÆàË≠∑ËÄÖ',
                icon: 'üõ°Ô∏è',
                description: 'Ë≥áÁî£„ÇíÂÆà„Çã„Åì„Å®„ÇíÊúÄÂÑ™ÂÖà„ÄÇÂÖÉÊú¨Ââ≤„Çå„É™„Çπ„ÇØ„ÇíÊ•µÂäõÈÅø„Åë„ÄÅÈ†êÈáë„ÇÑÂõΩÂÇµ„Å™„Å©ÂÆâÂÖ®Ë≥áÁî£„Çí‰∏≠ÂøÉ„Å´ÈÅãÁî®„Åó„Åæ„Åô„ÄÇ',
                detailedDescription: '„ÅÇ„Å™„Åü„ÅØË≥áÁî£„ÅÆ„ÄåÂÆà„Çä„Äç„ÇíÈáçË¶ñ„Åô„Çã„Çø„Ç§„Éó„Åß„Åô„ÄÇÂ∏ÇÂ†¥„ÅÆÂ§âÂãï„Å´‰∏ÄÂñú‰∏ÄÊÜÇ„Åõ„Åö„ÄÅÁùÄÂÆü„Å´Ë≥áÁî£„ÇíÂÆà„Çä„Å™„Åå„Çâ„ÄÅ„Ç§„É≥„Éï„É¨„Å´Ë≤†„Åë„Å™„ÅÑÁ®ãÂ∫¶„ÅÆÂà©Âõû„Çä„ÇíÁõÆÊåá„Åó„Åæ„Åô„ÄÇÂÖÉÊú¨‰øùË®º„ÇÑ‰Ωé„É™„Çπ„ÇØÂïÜÂìÅ„ÇíÂ•Ω„Åø„ÄÅÊäïË≥á„Çà„Çä„ÇÇË≤ØËìÑ„Å´Ëøë„ÅÑ„Çπ„Çø„É≥„Çπ„ÅßË≥áÁî£ÂΩ¢Êàê„Å´Âèñ„ÇäÁµÑ„Åø„Åæ„Åô„ÄÇ',
                strengths: ['Êö¥ËêΩÊôÇ„Åß„ÇÇÂÜ∑Èùô„Å´ÂØæÂøú„Åß„Åç„Çã', 'ÁÑ°ÁêÜ„ÅÆ„Å™„ÅÑÈÅãÁî®„ÅßÈï∑ÊúüÁ∂ôÁ∂ö„Åó„ÇÑ„Åô„ÅÑ', 'ÁîüÊ¥ªÈò≤Ë°õË≥áÈáë„Çí„Åó„Å£„Åã„ÇäÁ¢∫‰øù„Åß„Åç„Çã'],
                watchOut: ['„Ç§„É≥„Éï„É¨„Å´Ë≤†„Åë„Å¶ÂÆüË≥™ÁöÑ„Å™Ë≥áÁî£‰æ°ÂÄ§„ÅåÁõÆÊ∏õ„Çä„Åô„ÇãÂèØËÉΩÊÄß', 'Ê©ü‰ºöÊêçÂ§±Ôºà„ÇÇ„Å£„Å®Â¢ó„ÇÑ„Åõ„Åü„Åã„ÇÇÔºâ„Å∏„ÅÆÂæåÊÇî'],
                levelAdvice: {
                    1: '„Åæ„Åö„ÅØ„Äå„Å™„ÅúÊäïË≥á„ÅåÂøÖË¶Å„Åã„Äç„ÇíÂ≠¶„Å≥„Åæ„Åó„Çá„ÅÜ„ÄÇÈ†êÈáë„Å†„Åë„Åß„ÅØ„Ç§„É≥„Éï„É¨„Å´Ë≤†„Åë„Å¶„Åó„Åæ„ÅÜÁêÜÁî±„ÇíÁêÜËß£„Åô„Çã„Åì„Å®„ÅåÁ¨¨‰∏ÄÊ≠©„Åß„Åô„ÄÇ',
                    2: 'ÂõΩÂÇµ„ÇÑÂÆöÊúüÈ†êÈáë„ÅÆ‰ªïÁµÑ„Åø„ÇíÊ∑±Êéò„Çä„Åó„ÄÅ„Å§„Åø„Åü„Å¶NISA„ÅÆÈùûË™≤Á®é„É°„É™„ÉÉ„Éà„ÇÇÊ§úË®é„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                    3: 'ÂÆà„Çä„ÅÆË≥áÁî£„Å®Êîª„ÇÅ„ÅÆË≥áÁî£„ÅÆ„Éê„É©„É≥„Çπ„ÇíË¶ãÁõ¥„Åó„ÄÅÂ∞ë„Åó„Åö„Å§„É™„Çπ„ÇØË≥áÁî£„Å∏„ÅÆÈÖçÂàÜ„ÇÇÊ§úË®é„Åó„Å¶„Åø„Å¶„ÅØ„ÄÇ'
                },
                traits: ['ÊÖéÈáçÊ¥æ', 'Èï∑ÊúüÂÆâÂÆöÂøóÂêë', '‰Ωé„É™„Çπ„ÇØ'],
                allocation: { safe: 80, balanced: 15, growth: 5 },
                recommended: ['ÂõΩÂÜÖÂÇµÂà∏', 'ÂÆöÊúüÈ†êÈáë', '„Éê„É©„É≥„Çπ„Éï„Ç°„É≥„Éâ']
            },
            {
                id: 'custodian',
                name: 'The Custodian',
                nameJp: 'ÁÆ°ÁêÜ‰∫∫',
                icon: 'ü¶â',
                description: 'Ë≥áÁî£„ÅÆ‰øùÂÖ®„ÇíÈáçË¶ñ„Åó„Å§„Å§„ÄÅ„Ç§„É≥„Éï„É¨Ë≤†„Åë„Åó„Å™„ÅÑÁ®ãÂ∫¶„ÅÆÈÅãÁî®„ÇíÁõÆÊåá„Åó„Åæ„Åô„ÄÇÂ†ÖÂÆü„Å™ÁÆ°ÁêÜ„ÅßË≥áÁî£„ÇíÂÆà„ÇäËÇ≤„Å¶„Åæ„Åô„ÄÇ',
                detailedDescription: '„ÅÇ„Å™„Åü„ÅØ„ÄåË≥áÁî£„ÇíË≥¢„ÅèÁÆ°ÁêÜ„Åô„Çã„Äç„Åì„Å®„Å´Èï∑„Åë„Å¶„ÅÑ„Åæ„Åô„ÄÇ„É™„Çπ„ÇØ„ÇíÊäë„Åà„Å™„Åå„Çâ„ÇÇ„ÄÅ„Åü„Å†Áú†„Çâ„Åõ„Å¶„Åä„Åè„ÅÆ„Åß„ÅØ„Å™„Åè„ÄÅ„Ç§„É≥„Éï„É¨Áéá„Çí‰∏äÂõû„ÇãÈÅãÁî®„ÇíÁõÆÊåá„Åó„Åæ„Åô„ÄÇË®àÁîªÁöÑ„Åß„ÄÅÁÑ°ÈßÑÈÅ£„ÅÑ„ÇíÂ´å„ÅÑ„ÄÅÁùÄÂÆü„Å´Ë≥áÁî£„ÇíÁ©ç„Åø‰∏ä„Åí„Å¶„ÅÑ„Åè„Çø„Ç§„Éó„Åß„Åô„ÄÇ',
                strengths: ['Ë®àÁîªÁöÑ„Å™Ë≥áÁî£ÁÆ°ÁêÜ„Åå„Åß„Åç„Çã', 'ÊÑüÊÉÖ„Å´ÊµÅ„Åï„Çå„Å´„Åè„ÅÑÊäïË≥áÂà§Êñ≠', 'Èï∑ÊúüÁöÑ„Å™Ë¶ñÁÇπ„ÇíÊåÅ„Å¶„Çã'],
                watchOut: ['ÊÖéÈáç„Åô„Åé„Å¶ÊäïË≥á„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„ÇíÈÄÉ„Åô„Åì„Å®„Åå„ÅÇ„Çã', 'ÈÅéÂ∫¶„Å™ÁØÄÁ¥ÑÂøóÂêë„ÅåQOL„Çí‰∏ã„Åí„ÇãÂèØËÉΩÊÄß'],
                levelAdvice: {
                    1: 'Ë§áÂà©„ÅÆÂäõ„ÇíÂ≠¶„Å≥„Åæ„Åó„Çá„ÅÜ„ÄÇ„Äå72„ÅÆÊ≥ïÂâá„Äç„ÇíÁü•„Çã„Å®„ÄÅÊôÇÈñì„ÇíÂë≥Êñπ„Å´„Å§„Åë„ÇãÈáçË¶ÅÊÄß„Åå„Çè„Åã„Çä„Åæ„Åô„ÄÇ',
                    2: 'ÂõΩÂÇµ„Å®Á§æÂÇµ„ÅÆÈÅï„ÅÑ„ÄÅÊäïË≥á‰ø°Ë®ó„ÅÆ‰ªïÁµÑ„Åø„ÇíÁêÜËß£„Åó„ÄÅÊâãÊï∞Êñô„ÅÆ‰Ωé„ÅÑÂïÜÂìÅ„ÇíÈÅ∏„Å∂ÁõÆ„ÇíÈ§ä„ÅÑ„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                    3: '„Éù„Éº„Éà„Éï„Ç©„É™„Ç™ÁêÜË´ñ„ÅÆÂü∫Á§é„ÇíÂ≠¶„Å≥„ÄÅÂàÜÊï£ÊäïË≥á„ÅÆÂäπÊûú„ÇíÊúÄÂ§ßÂåñ„Åô„ÇãÈÖçÂàÜ„ÇíËÄÉ„Åà„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ'
                },
                traits: ['ÁÆ°ÁêÜÈáçË¶ñ', 'Â†ÖÂÆü', 'Èò≤Ë°õÁöÑ'],
                allocation: { safe: 70, balanced: 25, growth: 5 },
                recommended: ['ÂõΩÂÇµ', 'È´òÊ†º‰ªòÁ§æÂÇµ', 'ÂÆà„Çä„ÅÆÊäï‰ø°']
            },
            {
                id: 'conservative',
                name: 'The Conservative',
                nameJp: 'Â†ÖÂÆüÂÆ∂',
                icon: 'üèõÔ∏è',
                description: 'ÂÆâÂÆö„ÇíÈáçË¶ñ„Åó„Å§„Å§„ÇÇ„ÄÅÂ∞ë„Åó„Åö„Å§Ë≥áÁî£„ÇíÂ¢ó„ÇÑ„Åó„Åü„ÅÑ„ÄÇ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊäïË≥á„ÇíËª∏„Å´„ÄÅÁùÄÂÆü„Å™ÊàêÈï∑„ÇíÁõÆÊåá„Åó„Åæ„Åô„ÄÇ',
                detailedDescription: '„ÅÇ„Å™„Åü„ÅØ„ÄåÂÆâÂÆö„Äç„Å®„ÄåÊàêÈï∑„Äç„ÅÆ„Éê„É©„É≥„Çπ„ÇíÂ§ßÂàá„Å´„Åó„Åæ„Åô„ÄÇ‰∏ÄÁô∫ÈÄÜËª¢„ÇíÁãô„ÅÜ„ÅÆ„Åß„ÅØ„Å™„Åè„ÄÅ„Ç≥„ÉÑ„Ç≥„ÉÑ„Å®Á©ç„ÅøÁ´ã„Å¶„Çã„Åì„Å®„ÅßÁ¢∫ÂÆü„Å´Ë≥áÁî£„ÇíÂ¢ó„ÇÑ„Åó„Å¶„ÅÑ„Åè„Çπ„Çø„Ç§„É´„ÄÇ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Éï„Ç°„É≥„Éâ„ÇÑ„Å§„Åø„Åü„Å¶NISA„Å®„ÅÆÁõ∏ÊÄß„ÅåÊäúÁæ§„Åß„Åô„ÄÇ',
                strengths: ['Â∏ÇÂ†¥Âπ≥Âùá„Å´‰πó„ÇãË≥¢Êòé„Åï', 'ÊÑüÊÉÖÁöÑ„Å™Â£≤Ë≤∑„Çí„Åó„Å´„Åè„ÅÑ', 'Èï∑ÊúüÊäïË≥á„Å´Âêë„ÅÑ„Å¶„ÅÑ„ÇãÊÄßÊ†º'],
                watchOut: ['ÈÄÄÂ±à„Å´ÊÑü„Åò„Çã„Åì„Å®„Åå„ÅÇ„Çã', 'Âë®„Çä„Åå„Éè„Ç§„É™„Çø„Éº„É≥„ÇíÂæó„Å¶„ÅÑ„Çã„Å®ÁÑ¶„ÇãÂèØËÉΩÊÄß'],
                levelAdvice: {
                    1: '„Å§„Åø„Åü„Å¶NISA„ÅÆ‰ªïÁµÑ„Åø„Å®„ÄÅ„Å™„Åú„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊäïË≥á„ÅåÊé®Â•®„Åï„Çå„Çã„ÅÆ„Åã„ÇíÂ≠¶„Å≥„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                    2: 'ÂÖ®‰∏ñÁïåÊ†™Âºè„Å®Á±≥ÂõΩÊ†™Âºè„ÅÆÈÅï„ÅÑ„ÄÅÁÇ∫Êõø„É™„Çπ„ÇØ„Å´„Å§„ÅÑ„Å¶ÁêÜËß£„ÇíÊ∑±„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                    3: '„É™„Éê„É©„É≥„Çπ„ÅÆËÄÉ„ÅàÊñπ„ÇÑ„ÄÅÂÇµÂà∏„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„Åü„Éù„Éº„Éà„Éï„Ç©„É™„Ç™ÊßãÁØâ„ÇíÂ≠¶„Çì„Åß„Åø„Å¶„ÅØ„ÄÇ'
                },
                traits: ['ÂÆâÂÆöÈáçË¶ñ', 'Ë®àÁîªÁöÑ', 'Â†ÖÂÆü'],
                allocation: { safe: 60, balanced: 30, growth: 10 },
                recommended: ['„Å§„Åø„Åü„Å¶NISA', 'ÂÖ®‰∏ñÁïåÊ†™Âºè', 'ÂÇµÂà∏„Éï„Ç°„É≥„Éâ']
            },
            {
                id: 'architect',
                name: 'The Architect',
                nameJp: 'ÊßãÁØâËÄÖ',
                icon: 'üèóÔ∏è',
                description: '„Éê„É©„É≥„Çπ„ÇíÈáçË¶ñ„Åó„ÄÅÈï∑ÊúüÁöÑ„Å™Ë≥áÁî£ÂΩ¢Êàê„ÇíË®≠Ë®à„ÄÇÊ†™Âºè„Å®ÂÇµÂà∏„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„Åü„Éù„Éº„Éà„Éï„Ç©„É™„Ç™„ÅßÂ†ÖÂÆü„Å´Ë≥áÁî£„ÇíËÇ≤„Å¶„Åæ„Åô„ÄÇ',
                detailedDescription: '„ÅÇ„Å™„Åü„ÅØ„ÄåË®≠Ë®àËÄÖ„Äç„ÅÆ„Çà„ÅÜ„Å´„ÄÅÂÖ®‰ΩìÂÉè„ÇíË¶ã„Å™„Åå„ÇâË≥áÁî£ÂΩ¢Êàê„ÇíÈÄ≤„ÇÅ„Åæ„Åô„ÄÇÊ†™Âºè„Å®ÂÇµÂà∏„ÄÅÂõΩÂÜÖ„Å®Êµ∑Â§ñ„ÄÅÊàêÈï∑„Å®„Ç§„É≥„Ç´„É†‚îÄ‚îÄÊßò„ÄÖ„Å™Ë¶ÅÁ¥†„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„Å¶„ÄÅËá™ÂàÜ„Å†„Åë„ÅÆ„Éù„Éº„Éà„Éï„Ç©„É™„Ç™„ÇíÊßãÁØâ„Åô„Çã„Åì„Å®„Å´Âñú„Å≥„ÇíÊÑü„Åò„Çã„Çø„Ç§„Éó„Åß„Åô„ÄÇ',
                strengths: ['Ë´ñÁêÜÁöÑ„Å™„Éù„Éº„Éà„Éï„Ç©„É™„Ç™ÊßãÁØâ„Åå„Åß„Åç„Çã', 'ÂàÜÊï£ÊäïË≥á„ÅÆÂäπÊûú„ÇíÊúÄÂ§ßÂåñ„Åß„Åç„Çã', '„É™„Éê„É©„É≥„Çπ„ÇíË®àÁîªÁöÑ„Å´ÂÆüË°å„Åß„Åç„Çã'],
                watchOut: ['ÂàÜÊûê„Å´ÊôÇÈñì„Çí„Åã„Åë„Åô„Åé„Å¶Ë°åÂãï„ÅåÈÅÖ„Çå„Çã„Åì„Å®„Åå„ÅÇ„Çã', 'ÂÆåÁíß„ÇíÊ±Ç„ÇÅ„Åô„Åé„ÇãÂÇæÂêë'],
                levelAdvice: {
                    1: '„ÄåÂçµ„Çí‰∏Ä„Å§„ÅÆ„Ç´„Ç¥„Å´Áõõ„Çã„Å™„Äç„ÅÆÊÑèÂë≥„ÇíÂÆüÊÑü„Åó„ÄÅÂàÜÊï£ÊäïË≥á„ÅÆÂü∫Êú¨„ÇíË∫´„Å´„Å§„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                    2: 'iDeCo„ÅÆÁ®éÂà∂„É°„É™„ÉÉ„Éà„ÄÅ„Ç¢„Çª„ÉÉ„Éà„Ç¢„É≠„Ç±„Éº„Ç∑„Éß„É≥„ÅÆËÄÉ„ÅàÊñπ„ÇíÊ∑±Êéò„Çä„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                    3: '„Ç∑„É£„Éº„Éó„É¨„Ç∑„Ç™„ÇÑ„É™„Çπ„ÇØË™øÊï¥Âæå„É™„Çø„Éº„É≥„Å™„Å©„ÄÅ„Çà„ÇäÈ´òÂ∫¶„Å™ÊåáÊ®ô„ÇÇÂ≠¶„Çì„Åß„Åø„Å¶„ÅØ„ÄÇ'
                },
                traits: ['„Éê„É©„É≥„ÇπÂûã', 'Ë´ñÁêÜÁöÑ', 'Èï∑ÊúüË¶ñÁÇπ'],
                allocation: { safe: 40, balanced: 40, growth: 20 },
                recommended: ['iDeCo', '„Éê„É©„É≥„Çπ„Éï„Ç°„É≥„Éâ', 'Á±≥ÂõΩÊ†™Âºè']
            },
            {
                id: 'strategist',
                name: 'The Strategist',
                nameJp: 'Êà¶Áï•ÂÆ∂',
                icon: '‚ôüÔ∏è',
                description: 'Â∏ÇÂ†¥„ÅÆÂãï„Åç„ÇíÂàÜÊûê„Åó„ÄÅÊ©üÂãïÁöÑ„Å´„Éù„Éº„Éà„Éï„Ç©„É™„Ç™„ÇíË™øÊï¥„ÄÇÂÆà„Çä„Å®Êîª„ÇÅ„ÇíÂ∑ß„Åø„Å´‰Ωø„ÅÑÂàÜ„Åë„ÄÅË∂ÖÈÅé„É™„Çø„Éº„É≥„ÇíÁãô„ÅÑ„Åæ„Åô„ÄÇ',
                detailedDescription: '„ÅÇ„Å™„Åü„ÅØÂ∏ÇÂ†¥„Çí„ÄåË™≠„ÇÄ„Äç„Åì„Å®„Å´ËààÂë≥„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÁµåÊ∏àÊåáÊ®ô„ÇÑ„Éã„É•„Éº„Çπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÄÅ„Çø„Ç§„Éü„É≥„Ç∞„ÇíË¶ã„Å¶ÊäïË≥áÂà§Êñ≠„Çí‰∏ã„Åô„Åì„Å®„Å´È≠ÖÂäõ„ÇíÊÑü„Åò„Çã„Çø„Ç§„Éó„ÄÇ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™ÈÅãÁî®„Çπ„Çø„Ç§„É´„Åß„ÄÅÂ∏ÇÂ†¥Âπ≥Âùá„Çí‰∏äÂõû„Çã„É™„Çø„Éº„É≥„ÇíÁõÆÊåá„Åó„Åæ„Åô„ÄÇ',
                strengths: ['Â∏ÇÂ†¥ÂãïÂêë„Å∏„ÅÆÈ´ò„ÅÑÊÑüÂ∫¶', 'ÊüîËªü„Å™„Éù„Éº„Éà„Éï„Ç©„É™„Ç™Ë™øÊï¥', '„É™„Çπ„ÇØÁÆ°ÁêÜÊÑèË≠ò„ÅåÈ´ò„ÅÑ'],
                watchOut: ['È†ªÁπÅ„Å™Â£≤Ë≤∑„Åß„Ç≥„Çπ„Éà„Åå„Åã„Åï„ÇÄÂèØËÉΩÊÄß', '„ÄåË™≠„Åø„Äç„ÅåÂ§ñ„Çå„ÅüÊôÇ„ÅÆ„ÉÄ„É°„Éº„Ç∏'],
                levelAdvice: {
                    1: '„Åæ„Åö„ÅØÁµåÊ∏à„Éã„É•„Éº„Çπ„ÇíË™≠„ÇÄÁøíÊÖ£„Çí„Å§„Åë„ÄÅÂ∏ÇÂ†¥„Åå„Å©„ÅÜÂèçÂøú„Åô„Çã„Åã„ÇíË¶≥ÂØü„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                    2: '„Çª„ÇØ„Çø„Éº„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥„ÇÑÊôØÊ∞ó„Çµ„Ç§„ÇØ„É´„ÅÆËÄÉ„ÅàÊñπ„ÇíÂ≠¶„Å≥„ÄÅETF„ÇíÊ¥ªÁî®„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                    3: '„ÉÜ„ÇØ„Éã„Ç´„É´ÂàÜÊûê„ÅÆÂü∫Á§é„ÇÑ„ÄÅ„Ç™„Éó„Ç∑„Éß„É≥Êà¶Áï•„Å™„Å©„ÇÇË¶ñÈáé„Å´ÂÖ•„Çå„Å¶„Åø„Å¶„ÅØ„ÄÇ'
                },
                traits: ['Êà¶Áï•ÁöÑ', 'Ê©üÂãïÊÄß', 'ÂàÜÊûêÈáçË¶ñ'],
                allocation: { safe: 30, balanced: 40, growth: 30 },
                recommended: ['„Çª„ÇØ„Çø„ÉºETF', '„Çπ„Éû„Éº„Éà„Éô„Éº„Çø', '„É™„Éº„Éà']
            },
            {
                id: 'explorer',
                name: 'The Explorer',
                nameJp: 'Êé¢Ê±ÇËÄÖ',
                icon: 'üî≠',
                description: 'ÊàêÈï∑Ê©ü‰ºö„ÇíÁ©çÊ•µÁöÑ„Å´ËøΩÊ±Ç„ÄÇ„É™„Çπ„ÇØ„ÇíÁêÜËß£„Åó„Åü‰∏ä„Åß„ÄÅ„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº„ÇÑÊñ∞ËààÂ∏ÇÂ†¥„Å∏„ÅÆÊäïË≥á„ÇÇÊ§úË®é„Åó„Åæ„Åô„ÄÇ',
                detailedDescription: '„ÅÇ„Å™„Åü„ÅØ„ÄåÊàêÈï∑„Äç„Å´È≠ÖÂäõ„ÇíÊÑü„Åò„Çã„Çø„Ç§„Éó„Åß„Åô„ÄÇÊñ∞„Åó„ÅÑ„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº„ÇÑÊú™ÈñãÊãì„ÅÆÂ∏ÇÂ†¥„Å´ËààÂë≥„Åå„ÅÇ„Çä„ÄÅÂ§ß„Åç„Å™„É™„Çø„Éº„É≥„ÇíÊ±Ç„ÇÅ„Å¶Á©çÊ•µÁöÑ„Å´ÊäïË≥áÂÖà„ÇíÊé¢Ê±Ç„Åó„Åæ„Åô„ÄÇÂ•ΩÂ•áÂøÉÊó∫Áõõ„Åß„ÄÅÂ≠¶„Å∂„Åì„Å®„ÇíÊ•Ω„Åó„ÇÅ„ÇãÊÄßÊ†º„Åß„Åô„ÄÇ',
                strengths: ['ÊàêÈï∑Ê†™„ÇÑ„Éà„É¨„É≥„Éâ„ÇíË¶ã„Å§„Åë„ÇãÂóÖË¶ö', 'Â≠¶ÁøíÊÑèÊ¨≤„ÅåÈ´ò„ÅÑ', 'Â§±Êïó„ÇíÊÅê„Çå„ÅöÊåëÊà¶„Åß„Åç„Çã'],
                watchOut: ['ÈÅéÂ∫¶„Å™ÈõÜ‰∏≠ÊäïË≥á„ÅÆ„É™„Çπ„ÇØ', 'FOMOÔºà‰πó„ÇäÈÅÖ„ÇåÊÅêÊÄñÔºâ„Å´ÈßÜ„Çâ„Çå„ÅüÂà§Êñ≠'],
                levelAdvice: {
                    1: '„ÄåÊàêÈï∑Ê†™„Äç„Å®„ÅØ‰Ωï„Åã„ÄÅ„Å™„Åú„É™„Çπ„ÇØ„ÅåÈ´ò„ÅÑ„ÅÆ„Åã„Çí„Åó„Å£„Åã„ÇäÁêÜËß£„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                    2: 'PER„ÇÑPBR„Å™„Å©„ÅÆÂü∫Êú¨ÁöÑ„Å™„Éê„É™„É•„Ç®„Éº„Ç∑„Éß„É≥ÊåáÊ®ô„ÇíÂ≠¶„Å≥„ÄÅÂâ≤È´ò„ÉªÂâ≤ÂÆâ„ÇíÂà§Êñ≠„Åß„Åç„Çã„Çà„ÅÜ„Å´„ÄÇ',
                    3: 'Êñ∞ËààÂõΩÊäïË≥á„ÅÆ„É™„Çπ„ÇØÔºàÊîøÊ≤ª„ÉªÁÇ∫Êõø„ÉªÊµÅÂãïÊÄßÔºâ„ÇÑ„ÄÅ„ÉÜ„Éº„ÉûÊäïË≥á„ÅÆËêΩ„Å®„ÅóÁ©¥„ÇÇÊäº„Åï„Åà„Å¶„Åä„Åç„Åæ„Åó„Çá„ÅÜ„ÄÇ'
                },
                traits: ['ÊàêÈï∑ÂøóÂêë', 'Â•ΩÂ•áÂøÉÊó∫Áõõ', '‰∏≠„ÄúÈ´ò„É™„Çπ„ÇØ'],
                allocation: { safe: 25, balanced: 35, growth: 40 },
                recommended: ['Á±≥ÂõΩÊ†™Âºè', '„ÉÜ„ÉÉ„ÇØÊ†™', 'Êñ∞ËààÂõΩ„Éï„Ç°„É≥„Éâ']
            },
            {
                id: 'visionary',
                name: 'The Visionary',
                nameJp: 'ÂÖàË¶ãËÄÖ',
                icon: 'ü¶Ö',
                description: 'Ê¨°‰∏ñ‰ª£„ÅÆ„Éà„É¨„É≥„Éâ„Çí„ÅÑ„Å°Êó©„ÅèÊçïÊçâ„ÄÇÈ´ò„ÅÑÊàêÈï∑ÊÄß„ÅåË¶ãËæº„ÇÅ„ÇãÂàÜÈáé„Å∏Á©çÊ•µÁöÑ„Å´Ë≥áÈáë„ÇíÈÖçÂàÜ„Åó„ÄÅÂ§ß„Åç„Å™È£õË∫ç„ÇíÁãô„ÅÑ„Åæ„Åô„ÄÇ',
                detailedDescription: '„ÅÇ„Å™„Åü„ÅØ„ÄåÊú™Êù•„ÇíË¶ã„ÇãÁõÆ„Äç„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇAI„ÇÑÂÆáÂÆôÈñãÁô∫„ÄÅ„ÇØ„É™„Éº„É≥„Ç®„Éç„É´„ÇÆ„Éº„Å™„Å©„ÄÅ„Åì„Çå„Åã„Çâ‰º∏„Å≥„ÇãÂàÜÈáé„ÇíË¶ãÊ•µ„ÇÅ„ÄÅÊó©„ÅÑÊÆµÈöé„ÅßÊäïË≥á„Åô„Çã„Åì„Å®„ÅßÂ§ß„Åç„Å™„É™„Çø„Éº„É≥„ÇíÁãô„ÅÜ„Çø„Ç§„Éó„ÄÇÂÖàË°åËÄÖÂà©Áõä„ÇíÂèñ„Çä„Å´„ÅÑ„Åè„Çπ„Çø„Ç§„É´„Åß„Åô„ÄÇ',
                strengths: ['„Éà„É¨„É≥„Éâ„ÅÆÂàùÊúüÊÆµÈöé„ÅßÂèÇÂÖ•„Åß„Åç„Çã', 'Èï∑ÊúüÁöÑ„Å™„Éì„Ç∏„Éß„É≥„ÇíÊåÅ„Å¶„Çã', 'Â∏ÇÂ†¥„ÅÆÂ§âÂåñ„Å´ÊïèÊÑü'],
                watchOut: ['„ÄåÊó©„Åô„Åé„Åü„ÄçÊäïË≥á„ÅßË≥áÈáë„ÅåÂ°©Êº¨„Åë„Å´„Å™„Çã„É™„Çπ„ÇØ', '„ÉÜ„Éº„ÉûÊ†™„ÅÆÊÄ•ËêΩ'],
                levelAdvice: {
                    1: '„ÉÜ„Éº„ÉûÊäïË≥á„Å®ÂàÜÊï£ÊäïË≥á„ÅÆÈÅï„ÅÑ„ÇíÁêÜËß£„Åó„ÄÅ„É™„Çπ„ÇØÁÆ°ÁêÜ„ÅÆÂü∫Êú¨„ÇíÂ≠¶„Å≥„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                    2: 'Ê•≠ÁïåÂàÜÊûê„ÅÆÊñπÊ≥ï„ÇÑ„ÄÅÊàêÈï∑Áî£Ê•≠„ÇíË¶ãÊ•µ„ÇÅ„Çã„Éï„É¨„Éº„É†„ÉØ„Éº„ÇØ„ÇíË∫´„Å´„Å§„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                    3: 'IPOÊäïË≥á„ÇÑ„Éô„É≥„ÉÅ„É£„ÉºÊäïË≥á„ÅÆ‰∏ñÁïå„ÇÇË¶ó„ÅÑ„Å¶„Åø„Å¶„ÅØ„ÄÇ„Åü„Å†„ÅóË≥áÈáëÁÆ°ÁêÜ„ÅØÂé≥Ê†º„Å´„ÄÇ'
                },
                traits: ['ÂÖàË¶ãÊÄß', '„Éà„É¨„É≥„ÉâÂøóÂêë', 'Á©çÊ•µÁöÑ'],
                allocation: { safe: 15, balanced: 30, growth: 55 },
                recommended: ['„Ç∞„É≠„Éº„ÇπÊ†™', '„ÉÜ„Éº„ÉûÂûãÊäï‰ø°', '„Ç§„Éé„Éô„Éº„Ç∑„Éß„É≥Êû†']
            },
            {
                id: 'pioneer',
                name: 'The Pioneer',
                nameJp: 'ÈñãÊãìËÄÖ',
                icon: 'üöÄ',
                description: '„Éè„Ç§„É™„Çπ„ÇØ„Éª„Éè„Ç§„É™„Çø„Éº„É≥„ÇíÊÅê„Çå„Å™„ÅÑÊåëÊà¶ËÄÖ„ÄÇÊöóÂè∑Ë≥áÁî£„ÇÑIPOÈäòÊüÑ„Å™„Å©„ÄÅÈ´òÊàêÈï∑ÂàÜÈáé„Å´ÊûúÊï¢„Å´Êåë„Åø„Åæ„Åô„ÄÇ',
                detailedDescription: '„ÅÇ„Å™„Åü„ÅØ„ÄåÈñãÊãìËÄÖ„Äç„Åß„Åô„ÄÇ„Åæ„Å†Ë™∞„ÇÇË∂≥„ÇíË∏è„ÅøÂÖ•„Çå„Å¶„ÅÑ„Å™„ÅÑÈ†òÂüü„Å´È£õ„Å≥Ëæº„Åø„ÄÅÂ§ß„Åç„Å™„É™„Çø„Éº„É≥„ÇíÁãô„ÅÜ„Åì„Å®„Å´ËààÂ•Æ„ÇíÊÑü„Åò„Çã„Çø„Ç§„Éó„ÄÇÊöóÂè∑Ë≥áÁî£„ÇÑIPO„ÄÅ„É¨„Éê„É¨„ÉÉ„Ç∏ÂïÜÂìÅ„Å™„Å©„ÄÅ„Éè„Ç§„É™„Çπ„ÇØ„Éª„Éè„Ç§„É™„Çø„Éº„É≥„Å™ÊäïË≥á„Å´„ÇÇËáÜ„Åó„Åæ„Åõ„Çì„ÄÇ',
                strengths: ['È´ò„ÅÑ„É™„Çπ„ÇØË®±ÂÆπÂ∫¶', 'Â§ß„Åç„Å™„É™„Çø„Éº„É≥„ÇíÂæó„ÇãÂèØËÉΩÊÄß', 'Êñ∞„Åó„ÅÑË≥áÁî£„ÇØ„É©„Çπ„Å∏„ÅÆÁêÜËß£'],
                watchOut: ['ÂÖÉÊú¨„ÇíÂ§ß„Åç„ÅèÊØÄÊêç„Åô„Çã„É™„Çπ„ÇØ', 'ÊäïÊ©ü„Å®ÊäïË≥á„ÅÆÂ¢ÉÁïåÁ∑ö„Åå„ÅÇ„ÅÑ„Åæ„ÅÑ„Å´„Å™„Çä„Åå„Å°'],
                levelAdvice: {
                    1: '„Éè„Ç§„É™„Çπ„ÇØÊäïË≥á„ÅØ„Äå‰ΩôÂâ∞Ë≥áÈáë„Äç„ÅßË°å„ÅÜ„Åπ„ÅçÁêÜÁî±„ÇíÁêÜËß£„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇÁîüÊ¥ªË≤ª„ÅØÁµ∂ÂØæ„Å´‰Ωø„Çè„Å™„ÅÑ„Åì„Å®„ÄÇ',
                    2: 'ÊöóÂè∑Ë≥áÁî£„ÅÆ‰ªïÁµÑ„ÅøÔºà„Éñ„É≠„ÉÉ„ÇØ„ÉÅ„Çß„Éº„É≥„ÄÅ„Ç¶„Ç©„É¨„ÉÉ„ÉàÔºâ„ÇÑ„É¨„Éê„É¨„ÉÉ„Ç∏„ÅÆÊú¨ÂΩì„ÅÆ„É™„Çπ„ÇØ„ÇíÂ≠¶„Å≥„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                    3: '„Éù„Ç∏„Ç∑„Éß„É≥„Çµ„Ç§„Ç∏„É≥„Ç∞„ÇÑÊêçÂàá„Çä„É´„Éº„É´„Å™„Å©„ÄÅ„Éó„É≠„ÅÆË≥áÈáëÁÆ°ÁêÜË°ì„ÇíË∫´„Å´„Å§„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ'
                },
                traits: ['ÊåëÊà¶ÁöÑ', 'È´ò„É™„Çπ„ÇØË®±ÂÆπ', '„Ç¢„Ç∞„É¨„ÉÉ„Ç∑„Éñ'],
                allocation: { safe: 10, balanced: 25, growth: 65 },
                recommended: ['ÂÄãÂà•Ê†™', '‰ªÆÊÉ≥ÈÄöË≤®', '„É¨„Éê„É¨„ÉÉ„Ç∏ÂïÜÂìÅ']
            },
        ];

        // ============================================
        // SETTINGS MODAL
        // ============================================
        // ============================================
        // SETTINGS MODAL - Simplified (API keys removed for security)
        // ============================================
        const SettingsModal = ({ isOpen, onClose, onNavigate, userPlan, onUpgrade }) => {
            const [confirmReset, setConfirmReset] = useState(false);

            if (!isOpen) return null;

            const handleReset = () => {
                try {
                    // Update: Reset only learning history, keep plan and settings
                    const saved = localStorage.getItem('invision_state_v1');
                    if (saved) {
                        const state = JSON.parse(saved);
                        const newState = {
                            ...state,
                            // Reset learning progress
                            understoodCards: [],
                            unclearCards: [],
                            learnProgress: 0,
                            dailyCompleted: 0,
                            lastDailyGoalDate: Date.now(),
                            // Keep plan, purchasedBundles, userProfile, userGoals, portfolioSettings, onboardingStep
                        };
                        localStorage.setItem('invision_state_v1', JSON.stringify(newState));
                    }
                    window.location.reload();
                } catch (err) {
                    console.error('Reset failed:', err);
                }
            };

            const planConfig = {
                free: { label: 'FREE', color: 'bg-white/10 text-white/60 border-white/20', accent: 'text-dim' },
                annual: { label: 'ANNUAL', color: 'bg-gold/20 text-gold border-gold/40', accent: 'text-gold' },
                lifetime: { label: 'LIFETIME', color: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/40', accent: 'text-emerald-400' }
            };
            const plan = planConfig[userPlan] || planConfig.free;

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-obsidian/80 backdrop-blur-sm">
                    <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.95 }}
                        className="w-full max-w-md bg-ash border border-white/10 p-8 rounded-sm shadow-2xl relative max-h-[90vh] overflow-y-auto scrollbar-hide">
                        <button onClick={onClose} className="absolute top-4 right-4 text-dim hover:text-white z-10">‚úï</button>
                        <h2 className="text-xl font-bold text-platinum mb-6">Ë®≠ÂÆö</h2>

                        <div className="space-y-6">
                            {/* Plan Section */}
                            <div className="space-y-4">
                                <div className="flex items-center justify-between">
                                    <h3 className="text-sm font-bold text-platinum border-b border-white/10 pb-2 flex-1">„Éó„É©„É≥</h3>
                                </div>
                                <div className="bg-gradient-to-br from-white/[0.03] to-transparent border border-white/10 rounded-sm p-5">
                                    <div className="flex items-center justify-between mb-4">
                                        <span className={`text-[10px] font-black tracking-[0.2em] px-3 py-1 rounded-sm border ${plan.color}`}>{plan.label}</span>
                                        {userPlan === 'lifetime' && <span className="text-[10px] text-emerald-400">‚úì ÂÖ®Ê©üËÉΩËß£ÊîæÊ∏à„Åø</span>}
                                    </div>

                                    {userPlan === 'free' && (
                                        <motion.button
                                            onClick={() => { onClose(); onUpgrade('annual'); }}
                                            whileHover={{ scale: 1.02 }}
                                            whileTap={{ scale: 0.98 }}
                                            className="w-full py-3 bg-gradient-to-r from-gold/20 to-amber-500/10 border border-gold/50 text-gold font-bold text-sm rounded-sm hover:from-gold/30 hover:to-amber-500/20 transition-all"
                                        >
                                            Âπ¥Èñì„Éë„Çπ ¬•3,200/Âπ¥
                                        </motion.button>
                                    )}

                                    {(userPlan === 'free' || userPlan === 'annual') && (
                                        <motion.button
                                            onClick={() => { onClose(); onUpgrade(userPlan === 'annual' ? 'lifetime-upgrade' : 'lifetime'); }}
                                            whileHover={{ scale: 1.02 }}
                                            whileTap={{ scale: 0.98 }}
                                            className={`w-full py-3 border text-sm font-bold rounded-sm transition-all ${userPlan === 'annual'
                                                ? 'bg-gradient-to-r from-emerald-500/20 to-teal-500/10 border-emerald-500/50 text-emerald-400 hover:from-emerald-500/30'
                                                : 'bg-white/5 border-white/20 text-platinum/70 hover:bg-white/10'
                                                } ${userPlan === 'free' ? 'mt-3' : ''}`}
                                        >
                                            {userPlan === 'annual' ? (
                                                <span className="flex items-center justify-center gap-2">
                                                    „É©„Ç§„Éï„Çø„Ç§„É† <span className="line-through text-dim text-xs">¬•9,800</span> <span className="text-emerald-400">¬•6,600</span>
                                                </span>
                                            ) : (
                                                '„É©„Ç§„Éï„Çø„Ç§„É† ¬•9,800'
                                            )}
                                        </motion.button>
                                    )}
                                </div>
                            </div>

                            {/* App Info */}
                            <div className="space-y-3 pt-2 border-t border-white/10">
                                <h3 className="text-sm font-bold text-platinum border-b border-white/10 pb-2">„Ç¢„Éó„É™ÊÉÖÂ†±</h3>
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-dim">„Éê„Éº„Ç∏„Éß„É≥</span>
                                    <span className="text-platinum font-mono">1.0.0</span>
                                </div>
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-dim">„Éì„É´„Éâ</span>
                                    <span className="text-platinum font-mono">2026.02.04</span>
                                </div>
                            </div>

                            {/* Legal */}
                            <div className="space-y-4 pt-4 border-t border-white/10">
                                <h3 className="text-sm font-bold text-platinum border-b border-white/10 pb-2">Ê≥ïÁöÑ‰∫ãÈ†Ö</h3>
                                <button onClick={() => { onClose(); onNavigate('tokushoho'); }}
                                    className="w-full text-left text-sm text-dim hover:text-gold transition-colors py-1 flex items-center justify-between group">
                                    ÁâπÂÆöÂïÜÂèñÂºïÊ≥ï„Å´Âü∫„Å•„ÅèË°®Ë®ò
                                    <span className="text-white/20 group-hover:text-gold">‚Üí</span>
                                </button>
                            </div>

                            {/* Data Reset */}
                            <div className="space-y-4 pt-4 border-t border-white/10">
                                <h3 className="text-sm font-bold text-rose-500 border-b border-rose-500/20 pb-2">Â≠¶Áøí„Éá„Éº„Çø„ÅÆÁÆ°ÁêÜ</h3>
                                <p className="text-xs text-dim leading-relaxed">
                                    Â≠¶Áøí„ÅÆÈÄ≤ÊçóÁä∂Ê≥ÅÔºàÁêÜËß£Â∫¶„ÉªËã¶Êâã„Ç´„Éº„Éâ„Å™„Å©Ôºâ„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÄÇÁèæÂú®Âä†ÂÖ•‰∏≠„ÅÆ„Éó„É©„É≥„ÇÑË≥ºÂÖ•Ê∏à„Åø„Ç¢„Ç§„ÉÜ„É†„ÅØ‰øùÊåÅ„Åï„Çå„Åæ„Åô„ÄÇ
                                </p>

                                {!confirmReset ? (
                                    <button onClick={() => setConfirmReset(true)} className="w-full py-3 bg-rose-500/10 border border-rose-500/50 text-rose-500 text-sm font-bold rounded-sm hover:bg-rose-500 hover:text-white transition-all">
                                        Â≠¶ÁøíÂ±•Ê≠¥„ÇíÂâäÈô§
                                    </button>
                                ) : (
                                    <div className="space-y-3">
                                        <p className="text-sm text-rose-400 font-bold text-center">Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü</p>
                                        <div className="flex gap-2">
                                            <button onClick={() => setConfirmReset(false)} className="flex-1 py-3 bg-ash border border-white/10 text-platinum text-sm font-bold rounded-sm hover:bg-white/10 transition-colors">
                                                „Ç≠„É£„É≥„Çª„É´
                                            </button>
                                            <button onClick={handleReset} className="flex-1 py-3 bg-rose-600 text-white text-sm font-bold rounded-sm hover:bg-rose-500 shadow-lg shadow-rose-900/50 transition-colors">
                                                ÂâäÈô§„Åô„Çã
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="mt-8 pt-4 border-t border-white/10">
                            <button onClick={onClose} className="w-full py-3 bg-white/5 border border-white/10 text-platinum text-sm font-bold rounded-sm hover:bg-white/10 transition-colors">
                                Èñâ„Åò„Çã
                            </button>
                        </div>
                    </motion.div>
                </div>
            );
        };

        // ============================================
        // MARKET COMPONENTS - LUXURY EDITION
        // ============================================
        // Helper: Generate Dynamic User Title
        const getUserTitle = (profile, progress = 0) => {
            if (!profile) return "„Ç≤„Çπ„Éà";

            const levels = {
                1: "ÈßÜ„ÅëÂá∫„Åó",
                2: "Ë¶ãÁøí„ÅÑ",
                3: "ÁÜüÁ∑¥„ÅÆ",
                4: "Ê≠¥Êà¶„ÅÆ",
                5: "‰ºùË™¨„ÅÆ"
            };

            // Base level from diagnosis (initialLevel) + bonus from progress (1 level per 20 cards)
            const currentLevel = Math.min(5, (profile.experienceLevel || 1) + Math.floor(progress / 20));
            const type = profile.nameJp || profile.baseType || "ÊäïË≥áÂÆ∂";

            return `${levels[currentLevel]}${type}`;
        };

        const MarketTicker = ({ items }) => (
            <div className="fixed bottom-0 left-0 right-0 h-10 bg-obsidian/90 backdrop-blur-lg border-t border-white/5 z-50 flex items-center overflow-hidden">
                <div className="flex animate-ticker whitespace-nowrap">
                    {[...items, ...items, ...items].map((item, i) => (
                        <div key={i} className="flex items-center gap-3 mx-8 text-[10px] font-mono">
                            <span className="text-white/40">{item.symbol}</span>
                            <span className="text-white/60">{item.price}</span>
                            <span className={`${item.trend === 'up' ? 'text-emerald-400/60' : 'text-rose-400/60'}`}>{item.change}</span>
                        </div>
                    ))}
                </div>
            </div>
        );

        const MarketIntelligence = ({ onNavigate }) => {
            const [data, setData] = useState({ ticker: [], news: [], grok: [] });
            const [activeTab, setActiveTab] = useState('All');
            const [timeLeft, setTimeLeft] = useState(3600);
            const [isUpdating, setIsUpdating] = useState(false);
            const [isLive, setIsLive] = useState(false);

            useEffect(() => { fetchMarketData(); }, []);
            useEffect(() => { const t = setInterval(() => { setTimeLeft(p => { if (p <= 1) { fetchMarketData(); return 3600; } return p - 1; }); }, 1000); return () => clearInterval(t); }, []);

            const fetchMarketData = async () => {
                setIsUpdating(true);
                let cData = { bitcoin: { usd: 0, usd_24h_change: 0 }, ethereum: { usd: 0, usd_24h_change: 0 } };
                try { const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd,jpy&include_24hr_change=true'); if (r.ok) { cData = await r.json(); setIsLive(true); } } catch (e) { setIsLive(false); }

                const mockTicker = [{ symbol: 'USD/JPY', price: '148.24', change: '+0.15%', trend: 'up' }, { symbol: 'NI225', price: '38,540', change: '-0.32%', trend: 'down' }, { symbol: 'S&P500', price: '5,088', change: '+0.45%', trend: 'up' }, { symbol: 'GOLD', price: '2,035', change: '+0.05%', trend: 'up' }, { symbol: 'NVDA', price: '788.15', change: '+3.50%', trend: 'up' }];
                if (cData.bitcoin.usd !== 0) {
                    const bc = cData.bitcoin.usd_24h_change.toFixed(2); mockTicker.push({ symbol: 'BTC/USD', price: cData.bitcoin.usd.toLocaleString(), change: (bc > 0 ? '+' : '') + bc + '%', trend: bc > 0 ? 'up' : 'down' });
                    const ec = cData.ethereum.usd_24h_change.toFixed(2); mockTicker.push({ symbol: 'ETH/USD', price: cData.ethereum.usd.toLocaleString(), change: (ec > 0 ? '+' : '') + ec + '%', trend: ec > 0 ? 'up' : 'down' });
                }

                const lNews = [
                    { id: 101, source: 'Bloomberg', time: '10m ago', title: 'ECBÁ∑èË£Å„Äå„Ç§„É≥„Éï„É¨Áéá2%ÁõÆÊ®ô„Å∏„ÅÆÁ¢∫‰ø°Âº∑„Åæ„Çã„Äç', summary: '„É©„Ç¨„É´„ÉâÁ∑èË£Å„ÅØ„ÄÅ„É¶„Éº„É≠Âúè„ÅÆ„Ç§„É≥„Éï„É¨ÂúßÂäõ„Åå‰∫àÊÉ≥‰ª•‰∏ä„Å´Êó©„ÅèÁ∑©Âíå„Åó„Å¶„ÅÑ„Çã„ÄÇ', impact: 'High', category: 'Macro' },
                    { id: 102, source: 'Reuters', time: '30m ago', title: 'OpenAI„ÄÅÊñ∞‰ΩúÂãïÁîªÁîüÊàê„É¢„Éá„É´„ÄåSora„Äç„ÇíÂÖ¨Èñã', summary: '„ÉÜ„Ç≠„Çπ„Éà„Åã„ÇâÊúÄÈï∑1ÂàÜ„ÅÆÈ´òÂìÅË≥™ÂãïÁîª„ÇíÁîüÊàê„ÄÇ', impact: 'Medium', category: 'Tech' },
                    { id: 103, source: 'CoinGecko', time: 'Live', title: `BTC: $${cData.bitcoin?.usd?.toLocaleString() || 'N/A'}`, summary: 'CoinGecko Live Price', impact: 'High', category: 'Crypto' }
                ];

                const gData = [
                    { id: 201, topic: '$NVDA', sentiment: 'Bullish', score: 88, volume: '145K', summary: 'AIÈúÄË¶Å„ÅÆÂ∫ïÂ†Ö„Åï„Åã„Çâ„ÄåÊäº„ÅóÁõÆË≤∑„ÅÑ„Äç„ÅÆÂ£∞„ÅåÂúßÂÄíÁöÑÂ§öÊï∞„ÄÇ' },
                    { id: 202, topic: 'CPI Watch', sentiment: 'Bearish', score: 65, volume: '220K', summary: '„Ç§„É≥„Éï„É¨ÂÜçÁáÉ„ÇíË≠¶Êàí„Åô„ÇãÊäïÁ®ø„ÅåÂ¢óÂä†‰∏≠„ÄÇ' },
                    { id: 203, topic: '#Bitcoin', sentiment: 'Bullish', score: 92, volume: '350K', summary: '„ÄåATHÔºàÊúÄÈ´òÂÄ§ÔºâÊõ¥Êñ∞„ÅØÊôÇÈñì„ÅÆÂïèÈ°å„Äç„Å®„ÅÆË¶ãÊñπ„ÅåÊîØÈÖçÁöÑ„ÄÇ' }
                ];

                setData({ ticker: mockTicker, news: lNews, grok: gData });
                setTimeout(() => { setIsUpdating(false); setTimeLeft(3600); }, 800);
            };

            const formatTime = (s) => `${String(Math.floor(s / 60)).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`;
            const filteredNews = activeTab === 'All' ? data.news : data.news.filter(n => n.category === activeTab);

            return (
                <div className="min-h-screen bg-obsidian pt-24 pb-20 px-4 sm:px-8 relative overflow-hidden">
                    {/* Dynamic Background Lighting */}
                    <div className="fixed inset-0 pointer-events-none overflow-hidden">
                        <div className="absolute -top-[20%] -right-[10%] w-[800px] h-[800px] bg-gold/5 rounded-full blur-[150px] opacity-30" />
                        <div className="absolute bottom-[20%] -left-[10%] w-[600px] h-[600px] bg-emerald-500/5 rounded-full blur-[120px] opacity-20" />
                    </div>

                    <div className="max-w-6xl mx-auto relative z-10">
                        {/* Unified Header - Asset Gallery Style */}
                        <div className="mb-16">
                            <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }}>
                                <p className="text-dim text-xs tracking-[0.4em] mb-4 text-gold">MARKET INTELLIGENCE</p>
                                <h2 className="text-4xl md:text-5xl font-black tracking-tighter text-platinum mb-4">Â∏ÇÂ†¥„Çí<span className="text-gold-gradient">Ë¶ã„Å§„ÇÅ„Çã</span></h2>
                                <div className="flex items-center gap-4">
                                    <p className="text-dim text-sm">Â∏ÇÂ†¥„Éá„Éº„Çø„Å®AIÂàÜÊûê</p>
                                    {isLive && <span className="text-[10px] text-emerald-400 bg-emerald-500/10 border border-emerald-500/30 px-3 py-1 rounded-full">‚óè LIVE</span>}
                                    <span className="text-xs text-dim font-mono">{formatTime(timeLeft)}</span>
                                    <button onClick={fetchMarketData} disabled={isUpdating} className={`text-dim hover:text-gold transition-all ${isUpdating ? 'animate-spin' : ''}`}>‚Üª</button>
                                </div>
                            </motion.div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
                            {/* Social Sentiment Panel */}
                            <div className="space-y-6">
                                <div className="flex items-center gap-4 mb-6 p-4 bg-gradient-to-r from-white/5 to-transparent rounded-sm border-l-2 border-gold/50">
                                    <div className="w-10 h-10 rounded-sm bg-gradient-to-br from-white to-gray-300 text-black flex items-center justify-center font-black text-lg">X</div>
                                    <div>
                                        <p className="text-lg font-bold text-platinum">Social Sentiment</p>
                                        <p className="text-xs text-dim">Powered by Grok AI</p>
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    {data.grok.map((item, i) => (
                                        <motion.div key={i} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: i * 0.15 }}
                                            className="bg-gradient-to-br from-ash/80 to-ash/40 border border-white/5 rounded-sm p-6 hover:border-gold/30 transition-all duration-300 group relative overflow-hidden">
                                            {/* Subtle glow on hover */}
                                            <div className={`absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 ${item.sentiment === 'Bullish' ? 'bg-emerald-500/5' : item.sentiment === 'Bearish' ? 'bg-rose-500/5' : 'bg-amber-500/5'}`} />
                                            <div className="relative z-10">
                                                <div className="flex justify-between items-start mb-4">
                                                    <h4 className="text-xl font-bold text-platinum group-hover:text-gold transition-colors">{item.topic}</h4>
                                                    <span className={`text-[10px] tracking-widest font-bold px-3 py-1.5 rounded-sm uppercase ${item.sentiment === 'Bullish' ? 'text-emerald-400 bg-emerald-500/10 border border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)]' : item.sentiment === 'Bearish' ? 'text-rose-400 bg-rose-500/10 border border-rose-500/30 shadow-[0_0_10px_rgba(244,63,94,0.2)]' : 'text-amber-400 bg-amber-500/10 border border-amber-500/30'}`}>
                                                        {item.sentiment === 'Bullish' ? 'BULLISH' : item.sentiment === 'Bearish' ? 'BEARISH' : 'MIXED'} {item.score}%
                                                    </span>
                                                </div>
                                                <div className="w-full h-2 bg-stone/50 rounded-full mb-4 overflow-hidden">
                                                    <motion.div initial={{ width: 0 }} animate={{ width: `${item.score}%` }} transition={{ duration: 1.2, delay: i * 0.2, ease: [0.4, 0, 0.2, 1] }}
                                                        className={`h-full ${item.sentiment === 'Bullish' ? 'bg-gradient-to-r from-emerald-600 to-emerald-400' : item.sentiment === 'Bearish' ? 'bg-gradient-to-r from-rose-600 to-rose-400' : 'bg-gradient-to-r from-amber-600 to-amber-400'}`} />
                                                </div>
                                                <p className="text-sm text-platinum/70 leading-relaxed">{item.summary}</p>
                                            </div>
                                        </motion.div>
                                    ))}
                                </div>
                            </div>

                            {/* News Feed */}
                            <div className="space-y-6">
                                <div className="flex gap-3 mb-6 border-b border-white/5 pb-4">
                                    {['All', 'Macro', 'Crypto', 'Tech'].map(tab => (
                                        <button key={tab} onClick={() => setActiveTab(tab)}
                                            className={`px-4 py-2 rounded-sm text-sm transition-all font-medium ${activeTab === tab ? 'bg-gold/10 text-gold border border-gold/30' : 'text-dim hover:text-platinum'}`}>
                                            {tab}
                                        </button>
                                    ))}
                                </div>
                                <div className="space-y-4">
                                    <AnimatePresence mode="popLayout">
                                        {filteredNews.map((news, i) => (
                                            <motion.div key={i} initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} transition={{ delay: i * 0.08 }}
                                                className="group cursor-pointer p-4 rounded-sm border border-transparent hover:border-white/10 hover:bg-white/[0.02] transition-all duration-300">
                                                <div className="flex items-center gap-3 mb-2">
                                                    <span className="text-xs text-gold font-mono">{news.time}</span>
                                                    <span className="text-[10px] text-dim border border-white/10 px-2 py-0.5 rounded-sm">{news.source}</span>
                                                    {news.impact === 'High' && <span className="text-[10px] text-amber-400 bg-amber-500/10 border border-amber-500/30 px-2 py-0.5 rounded-sm">‚ö° HIGH</span>}
                                                </div>
                                                <h3 className="text-lg font-bold text-platinum mb-2 group-hover:text-gold transition-colors leading-tight">{news.title}</h3>
                                                <p className="text-sm text-platinum/60 leading-relaxed">{news.summary}</p>
                                            </motion.div>
                                        ))}
                                    </AnimatePresence>
                                </div>
                            </div>
                        </div>
                    </div>
                    <MarketTicker items={data.ticker} />
                </div>
            );
        };

        // ============================================
        // CALIBRATION (STEP 1) - WITH PROFILE DISPLAY
        // ============================================
        // ASSET DATA & MODAL
        // ============================================
        const assetDetailData = [
            {
                id: 1, name: 'NISA', nameJp: '„Å§„Åø„Åü„Å¶NISA', tagline: 'ÈùûË™≤Á®é„Åß„ÄÅÊú™Êù•„ÇíÁ©ç„Åø‰∏ä„Åí„Çã', image: 'https://images.unsplash.com/photo-1579621970563-ebec7560ff3e?w=800&q=80', riskLevel: 2,
                knowledge: ['Âπ¥Èñì120‰∏áÂÜÜ„Åæ„ÅßÈùûË™≤Á®é', 'ÊúÄÈï∑20Âπ¥„ÅÆÈÅãÁî®ÊúüÈñì', 'Èï∑Êúü„ÉªÂàÜÊï£„ÉªÁ©çÁ´ã„ÅÆÁéãÈÅì'],
                description: 'ÂõΩ„ÅåÁî®ÊÑè„Åó„Åü„ÄåÊäïË≥á„ÅÆÁ®éÈáë„Åå„Åã„Åã„Çâ„Å™„ÅÑ„Äç„ÅäÂæó„Å™Âà∂Â∫¶„ÄÇÈäÄË°åÈ†êÈáë„ÅÆÂª∂Èï∑„Å®„Åó„Å¶„ÄÅÂàùÂøÉËÄÖ„ÅåÊúÄÂàù„Å´Âßã„ÇÅ„Çã„Åπ„ÅçÊäïË≥á„ÅÆÂÖ•„ÇäÂè£„Åß„Åô„ÄÇ',
                pros: ['ÈÅãÁî®Áõä„ÅåÈùûË™≤Á®éÔºàÈÄöÂ∏∏Á¥Ñ20%„ÅÆÁ®éÈáë„Åå„Çº„É≠Ôºâ', '100ÂÜÜ„Åã„ÇâÂßã„ÇÅ„Çâ„Çå„ÇãË®ºÂà∏‰ºöÁ§æ„ÇÇ', 'ÈÄî‰∏≠„ÅßÂ£≤Âç¥„ÉªÂºï„ÅçÂá∫„Åó„ÇÇËá™Áî±'],
                cons: ['Âπ¥ÈñìÊäïË≥á‰∏äÈôê„Åå120‰∏áÂÜÜ', 'ÂÖÉÊú¨‰øùË®º„ÅØ„Å™„ÅÑ', 'ÈùûË™≤Á®éÊû†„ÅÆÂÜçÂà©Áî®„ÅØÁøåÂπ¥‰ª•Èôç'],
                steps: ['Ë®ºÂà∏Âè£Â∫ß„ÇíÈñãË®≠ÔºàÊ•ΩÂ§©„ÉªSBIÁ≠âÔºâ', 'NISAÂè£Â∫ß„ÇíÁî≥„ÅóËæº„ÇÄ', 'ÊäïË≥á‰ø°Ë®ó„ÇíÈÅ∏„Å∂ÔºàÂÖ®‰∏ñÁïåÊ†™Âºè„Åå‰∫∫Ê∞óÔºâ', 'ÊØéÊúà„ÅÆÁ©çÁ´ãÈáëÈ°ç„ÇíË®≠ÂÆö'],
                glossary: [{ word: 'ÈùûË™≤Á®é', def: 'Âà©Áõä„Å´Á®éÈáë„Åå„Åã„Åã„Çâ„Å™„ÅÑ„Åì„Å®' }, { word: 'ÊäïË≥á‰ø°Ë®ó', def: 'Â∞ÇÈñÄÂÆ∂„ÅåÈÅãÁî®„Åô„ÇãÈáëËûçÂïÜÂìÅ„ÅÆË©∞„ÇÅÂêà„Çè„Åõ' }],
                brokers: [
                    { name: 'SBIË®ºÂà∏', feature: 'Ê•≠ÁïåÊúÄÂÆâ„ÇØ„É©„Çπ„ÅÆÊâãÊï∞Êñô„ÄÇ„ÇØ„É¨„Ç´Á©çÁ´ã„Åß„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ', url: 'https://www.sbisec.co.jp/', recommended: true },
                    { name: 'Ê•ΩÂ§©Ë®ºÂà∏', feature: 'Ê•ΩÂ§©„Éù„Ç§„É≥„Éà„ÅßÊäïË≥áÂèØËÉΩ„ÄÇÊ•ΩÂ§©ÁµåÊ∏àÂúè„Å®„ÅÆÁõ∏ÊÄß‚óé', url: 'https://www.rakuten-sec.co.jp/' },
                    { name: '„Éû„Éç„ÉÉ„ÇØ„ÇπË®ºÂà∏', feature: 'd„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉÁéá„ÅåÈ´ò„ÅÑ„ÄÇÈäòÊüÑÂàÜÊûê„ÉÑ„Éº„É´ÂÖÖÂÆü', url: 'https://www.monex.co.jp/' }
                ]
            },
            {
                id: 2, name: 'JP STOCKS', nameJp: 'ÂõΩÂÜÖÊ†™Âºè', tagline: 'Êó•Êú¨‰ºÅÊ•≠„Å®ÂÖ±„Å´ÊàêÈï∑„Åô„Çã', image: 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&q=80', riskLevel: 3,
                knowledge: ['ÈÖçÂΩìÈáë„ÅßÂÆöÊúüÂèéÂÖ•', 'Ê†™‰∏ªÂÑ™ÂæÖ„Å®„ÅÑ„ÅÜÁâπÂÖ∏', '100Ê†™Âçò‰Ωç„ÅåÂü∫Êú¨'],
                description: '„Éà„É®„Çø„ÄÅ„ÇΩ„Éã„Éº„ÄÅ‰ªªÂ§©Â†Ç„Å™„Å©„ÄÅË∫´Ëøë„Å™Êó•Êú¨‰ºÅÊ•≠„ÅÆ„Ç™„Éº„Éä„Éº„Å´„Å™„Çå„Åæ„Åô„ÄÇÈÖçÂΩìÈáë„ÇÑÊ†™‰∏ªÂÑ™ÂæÖ„ÇÇÈ≠ÖÂäõÁöÑ„Åß„Åô„ÄÇ',
                pros: ['Ê†™‰∏ªÂÑ™ÂæÖ„ÅßÂïÜÂìÅÂà∏„ÇÑÂâ≤Âºï„ÅåË≤∞„Åà„Çã', 'ÈÖçÂΩìÈáë„ÅßÂπ¥1„Äú2Âõû„ÅÆÂèéÂÖ•', '‰ºÅÊ•≠„ÅÆÊàêÈï∑„Å®ÂÖ±„Å´Ë≥áÁî£Â¢óÂä†'],
                cons: ['ÊúÄ‰Ωé100Ê†™Âçò‰Ωç„ÅßÊï∞‰∏á„ÄúÊï∞ÂçÅ‰∏áÂÜÜÂøÖË¶Å', '‰ºÅÊ•≠Ê•≠Á∏æ„Å´Â∑¶Âè≥„Åï„Çå„Çã', 'ÁÇ∫Êõø„É™„Çπ„ÇØ„Åå„Å™„ÅÑÂàÜ„ÄÅÊàêÈï∑ÊÄß„ÅØÈôêÂÆöÁöÑ'],
                steps: ['Ë®ºÂà∏Âè£Â∫ß„ÇíÈñãË®≠', 'Ê∞ó„Å´„Å™„Çã‰ºÅÊ•≠„ÇíÁ†îÁ©∂', '100Ê†™Âçò‰Ωç„ÅßË≥ºÂÖ•', 'Èï∑Êúü‰øùÊúâ„ÅßÈÖçÂΩì„Å®ÂÑ™ÂæÖ„ÇíÊ•Ω„Åó„ÇÄ'],
                glossary: [{ word: 'ÈÖçÂΩìÈáë', def: '‰ºÅÊ•≠„ÅåÂà©Áõä„ÅÆ‰∏ÄÈÉ®„ÇíÊ†™‰∏ª„Å´ÂàÜÈÖç„Åô„Çã„ÅäÈáë' }, { word: 'Ê†™‰∏ªÂÑ™ÂæÖ', def: 'Ê†™‰∏ª„Å∏„ÅÆÊÑüË¨ù„Å®„Åó„Å¶‰ºÅÊ•≠„ÅåË¥à„ÇãÁâπÂÖ∏' }],
                brokers: [
                    { name: 'SBIË®ºÂà∏', feature: 'ÂõΩÂÜÖÊ†™ÂèñÂºïÊâãÊï∞Êñô0ÂÜÜÔºàÊù°‰ª∂„ÅÇ„ÇäÔºâ„ÄÇIPOÂèñÊâ±„ÅÑ„ÅåË±äÂØå', url: 'https://www.sbisec.co.jp/' },
                    { name: 'Ê•ΩÂ§©Ë®ºÂà∏', feature: 'Ê•ΩÂ§©„Éù„Ç§„É≥„ÉàÊäïË≥áÂØæÂøú„ÄÇ„ÅÑ„Å°„Å´„Å°ÂÆöÈ°ç„ÅßÊâãÊï∞ÊñôÁÑ°ÊñôÊû†', url: 'https://www.rakuten-sec.co.jp/' },
                    { name: 'Êùæ‰∫ïË®ºÂà∏', feature: '50‰∏áÂÜÜ„Åæ„ÅßÊâãÊï∞ÊñôÁÑ°Êñô„ÄÇÊ†™‰∏ªÂÑ™ÂæÖÊ§úÁ¥¢„ÉÑ„Éº„É´ÂÖÖÂÆü', url: 'https://www.matsui.co.jp/' }
                ]
            },
            {
                id: 3, name: 'US STOCKS', nameJp: 'Á±≥ÂõΩÊ†™Âºè', tagline: '‰∏ñÁïåÊúÄÂ§ßÂ∏ÇÂ†¥„Å∏„Ç¢„ÇØ„Çª„Çπ', image: 'https://images.unsplash.com/photo-1534430480872-3498386e7856?w=800&q=80', riskLevel: 3,
                knowledge: ['GAFAMÁ≠â„ÅÆÂ∑®Â§ß‰ºÅÊ•≠', '1Ê†™„Åã„ÇâË≥ºÂÖ•ÂèØËÉΩ', 'ÁÇ∫Êõø„É™„Çπ„ÇØ„Å´Ê≥®ÊÑè'],
                description: 'Apple„ÄÅGoogle„ÄÅAmazon„Å™„Å©‰∏ñÁïå„ÇíÂãï„Åã„Åô„ÉÜ„ÉÉ„ÇØ‰ºÅÊ•≠„Å´ÊäïË≥á„ÄÇ1Ê†™„Åã„ÇâË≤∑„Åà„ÇãÊâãËªΩ„Åï„Å®„ÄÅÈ´ò„ÅÑÊàêÈï∑ÊÄß„ÅåÈ≠ÖÂäõ„ÄÇ',
                pros: ['1Ê†™„Åã„ÇâË≥ºÂÖ•ÂèØËÉΩÔºàÊï∞ÂçÉÂÜÜ„Åã„ÇâÔºâ', '‰∏ñÁïåÊúÄÂ§ß„ÅÆÂ∏ÇÂ†¥„ÅßÊµÅÂãïÊÄß„ÅåÈ´ò„ÅÑ', 'ÈÅéÂéª30Âπ¥„ÅßÂπ¥Âπ≥ÂùáÁ¥Ñ10%„ÅÆ„É™„Çø„Éº„É≥'],
                cons: ['ÁÇ∫Êõø„É™„Çπ„ÇØÔºàÂÜÜÈ´ò„ÅßÊêçÂ§±„ÅÆÂèØËÉΩÊÄßÔºâ', 'Á±≥ÂõΩ„ÅÆÁµåÊ∏à„ÉªÊîøÊ≤ªÂãïÂêë„Å´Â∑¶Âè≥„Åï„Çå„Çã', 'ÈÖçÂΩì„Å´Á±≥ÂõΩ„Åß„ÅÆÊ∫êÊ≥âÂæ¥Âèé„ÅÇ„Çä'],
                steps: ['Á±≥ÂõΩÊ†™ÂØæÂøú„ÅÆË®ºÂà∏Âè£Â∫ß„ÇíÈñãË®≠', 'ÁÇ∫ÊõøÊâãÊï∞Êñô„ÇíÁ¢∫Ë™ç', 'Ê∞ó„Å´„Å™„ÇãÈäòÊüÑ„Çí„Éâ„É´Âª∫„Å¶„ÅßË≥ºÂÖ•', 'Á¢∫ÂÆöÁî≥Âëä„ÅßÂ§ñÂõΩÁ®éÈ°çÊéßÈô§„ÇíÊ§úË®é'],
                glossary: [{ word: 'ÁÇ∫Êõø„É™„Çπ„ÇØ', def: 'ÂÜÜ„Å®„Éâ„É´„ÅÆ‰∫§Êèõ„É¨„Éº„ÉàÂ§âÂãï„Å´„Çà„ÇãÊêçÁõä' }, { word: 'S&P500', def: 'Á±≥ÂõΩ‰∏ªË¶Å500Á§æ„ÅÆÊ†™‰æ°ÊåáÊï∞' }],
                brokers: [
                    { name: 'SBIË®ºÂà∏', feature: 'ÁÇ∫ÊõøÊâãÊï∞ÊñôÊúÄÂÆâ„ÄÇÁ±≥ÂõΩÊ†™4000ÈäòÊüÑ‰ª•‰∏äÂèñÊâ±„ÅÑ', url: 'https://www.sbisec.co.jp/', recommended: true },
                    { name: '„Éû„Éç„ÉÉ„ÇØ„ÇπË®ºÂà∏', feature: 'Á±≥ÂõΩÊ†™ÂèñÂºïÊâãÊï∞Êñô„ÅåÂÆâ„ÅÑ„ÄÇÈäòÊüÑ„Çπ„Ç´„Ç¶„Çø„ÉºÂÖÖÂÆü', url: 'https://www.monex.co.jp/' },
                    { name: 'Ê•ΩÂ§©Ë®ºÂà∏', feature: 'ÂÜÜË≤®Ê±∫Ê∏àÂØæÂøú„ÄÇÊ•ΩÂ§©„Éù„Ç§„É≥„Éà„ÅßË≥ºÂÖ•ÂèØËÉΩ', url: 'https://www.rakuten-sec.co.jp/' }
                ]
            },
            {
                id: 4, name: 'FOREX', nameJp: 'FXÂèñÂºï', tagline: 'ÈÄöË≤®„ÅÆÊ≥¢„ÇíË™≠„ÇÄ', image: 'https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=800&q=80', riskLevel: 5,
                knowledge: ['24ÊôÇÈñìÂèñÂºïÂèØËÉΩ', '„É¨„Éê„É¨„ÉÉ„Ç∏„ÅßÂäπÁéáÂåñ', '„É™„Çπ„ÇØÁÆ°ÁêÜ„ÅåÂøÖÈ†à'],
                description: 'ÈÄöË≤®„ÇíÂ£≤Ë≤∑„Åó„Å¶ÁÇ∫ÊõøÂ∑ÆÁõä„ÇíÁãô„ÅÜÂèñÂºï„ÄÇÂ∞ëÈ°ç„ÅßÂ§ß„Åç„Å™ÂèñÂºï„Åå„Åß„Åç„Åæ„Åô„Åå„ÄÅ„Åù„ÅÆÂàÜ„É™„Çπ„ÇØ„ÇÇÈ´ò„ÅÑ‰∏äÁ¥öËÄÖÂêë„Åë„ÄÇ',
                pros: ['24ÊôÇÈñìÂèñÂºïÂèØËÉΩ', '„É¨„Éê„É¨„ÉÉ„Ç∏„ÅßË≥áÈáëÂäπÁéá„ÅåÈ´ò„ÅÑ', '‰∏ãËêΩÁõ∏Â†¥„Åß„ÇÇÂà©Áõä„ÇíÁãô„Åà„Çã'],
                cons: ['„É¨„Éê„É¨„ÉÉ„Ç∏„ÅßÊêçÂ§±„ÇÇÊã°Â§ß', 'Áõ∏Â†¥‰∫àÊ∏¨„ÅåÈùûÂ∏∏„Å´Èõ£„Åó„ÅÑ', 'ÂàùÂøÉËÄÖ„ÅØË≥áÈáë„ÇíÂ§±„ÅÑ„ÇÑ„Åô„ÅÑ'],
                steps: ['FXÂ∞ÇÁî®Âè£Â∫ß„ÇíÈñãË®≠', '„Éá„É¢ÂèñÂºï„ÅßÁ∑¥Áøí', 'ÊúÄÂ∞è„É≠„ÉÉ„Éà„ÅßÂÆüË∑µ', '„É≠„Çπ„Ç´„ÉÉ„Éà„É©„Ç§„É≥„ÇíÂøÖ„ÅöË®≠ÂÆö'],
                glossary: [{ word: '„É¨„Éê„É¨„ÉÉ„Ç∏', def: 'ÊâãÊåÅ„Å°Ë≥áÈáë„ÅÆ‰ΩïÂÄç„ÇÇ„ÅÆÂèñÂºï„Åå„Åß„Åç„Çã‰ªïÁµÑ„Åø' }, { word: '„É≠„Çπ„Ç´„ÉÉ„Éà', def: 'ÊêçÂ§±„Åå‰∏ÄÂÆö‰ª•‰∏ä„Å´„Å™„Çã„Å®Ëá™ÂãïÊ±∫Ê∏à„Åï„Çå„Çã‰ªïÁµÑ„Åø' }],
                brokers: [
                    { name: 'DMM FX', feature: '„Çπ„Éó„É¨„ÉÉ„ÉâÊ•≠ÁïåÊúÄÁã≠Ê∞¥Ê∫ñ„ÄÇ„Çπ„Éû„Éõ„Ç¢„Éó„É™‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑ', url: 'https://fx.dmm.com/', recommended: true },
                    { name: 'GMO„ÇØ„É™„ÉÉ„ÇØË®ºÂà∏', feature: 'ÂèñÂºïÈ´ò‰∏ñÁïå‰∏Ä„ÄÇÈ´òÊ©üËÉΩ„ÉÅ„É£„Éº„Éà„ÉÑ„Éº„É´', url: 'https://www.click-sec.com/' },
                    { name: 'SBI FX„Éà„É¨„Éº„Éâ', feature: '1ÈÄöË≤®„Åã„ÇâÂèñÂºïÂèØËÉΩ„ÄÇÂ∞ëÈ°çÁ∑¥Áøí„Å´ÊúÄÈÅ©', url: 'https://www.sbifxt.co.jp/' }
                ]
            },
            {
                id: 5, name: 'FUNDS', nameJp: 'ÊäïË≥á‰ø°Ë®ó', tagline: '„Éó„É≠„Å´ÈÅãÁî®„Çí‰ªª„Åõ„Çã', image: 'https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=800&q=80', riskLevel: 2,
                knowledge: ['100ÂÜÜ„Åã„ÇâÂàÜÊï£ÊäïË≥á', 'ÊâãÊï∞Êñô„ÅÆÁ¢∫Ë™ç„Çí', '„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂûã„Åå‰∫∫Ê∞ó'],
                description: 'Â∞ÇÈñÄÂÆ∂„Åå„ÅÇ„Å™„Åü„ÅÆ‰ª£„Çè„Çä„Å´ÈÅãÁî®„Åô„Çã„Äå„ÅäÈáë„ÅÆ„Éë„ÉÉ„Ç±„Éº„Ç∏ÂïÜÂìÅ„Äç„ÄÇ1Êú¨„ÅßÊï∞Áôæ„ÄúÊï∞ÂçÉÈäòÊüÑ„Å´ÂàÜÊï£ÊäïË≥á„Åß„Åç„Åæ„Åô„ÄÇ',
                pros: ['100ÂÜÜ„Åã„ÇâÊäïË≥áÂèØËÉΩ', 'ÂàÜÊï£ÊäïË≥á„ÅåËá™Âãï„Åß„Åß„Åç„Çã', 'ÈÅãÁî®„ÅØ„Éó„É≠„Å´„Åä‰ªª„Åõ'],
                cons: ['‰ø°Ë®óÂ†±ÈÖ¨ÔºàÊâãÊï∞ÊñôÔºâ„ÅåÊØéÊó•„Åã„Åã„Çã', 'Ëá™ÂàÜ„ÅßÈäòÊüÑ„ÇíÈÅ∏„Åπ„Å™„ÅÑ', '„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂûã„ÅØÊâãÊï∞Êñô„ÅåÈ´ò„ÇÅ'],
                steps: ['Ë®ºÂà∏Âè£Â∫ß„ÇíÈñãË®≠', '‰Ωé„Ç≥„Çπ„Éà„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Éï„Ç°„É≥„Éâ„ÇíÈÅ∏„Å∂', 'eMAXIS Slim„Ç∑„É™„Éº„Ç∫„Å™„Å©„Åå‰∫∫Ê∞ó', 'ÊØéÊúàÁ©çÁ´ãË®≠ÂÆö„Çí„Åô„Çã'],
                glossary: [{ word: '‰ø°Ë®óÂ†±ÈÖ¨', def: 'ÊäïË≥á‰ø°Ë®ó„ÅÆÈÅãÁî®ÁÆ°ÁêÜ„Å´„Åã„Åã„ÇãÂπ¥ÈñìÊâãÊï∞Êñô' }, { word: '„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ', def: 'Êó•ÁµåÂπ≥Âùá„ÇÑS&P500„Å™„Å©„ÅÆÊåáÊï∞„Å´ÈÄ£Âãï„Åô„ÇãÈÅãÁî®' }],
                brokers: [
                    { name: 'SBIË®ºÂà∏', feature: 'Êäï‰ø°Êú¨Êï∞„ÅåË±äÂØå„ÄÇ„ÇØ„É¨„Ç´Á©çÁ´ã„Åß„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ', url: 'https://www.sbisec.co.jp/' },
                    { name: 'Ê•ΩÂ§©Ë®ºÂà∏', feature: 'Ê•ΩÂ§©„Ç´„Éº„ÉâÁ©çÁ´ã„Åß1%ÈÇÑÂÖÉ„ÄÇ„Éù„Ç§„É≥„ÉàÊäïË≥áÂèØ', url: 'https://www.rakuten-sec.co.jp/' },
                    { name: 'au„Ç´„Éñ„Ç≥„É†Ë®ºÂà∏', feature: 'Ponta„Éù„Ç§„É≥„Éà„ÅßÊäïË≥áÂèØËÉΩ„ÄÇau„É¶„Éº„Ç∂„ÉºÂÑ™ÈÅá', url: 'https://kabu.com/' }
                ]
            },
            {
                id: 6, name: 'CRYPTO', nameJp: '‰ªÆÊÉ≥ÈÄöË≤®', tagline: '„Éá„Ç∏„Çø„É´ÊôÇ‰ª£„ÅÆÊñ∞Ë≥áÁî£', image: 'https://images.unsplash.com/photo-1639762681485-074b7f938ba0?w=800&q=80', riskLevel: 5,
                knowledge: ['È´ò„Éú„É©„ÉÜ„Ç£„É™„ÉÜ„Ç£', '24ÊôÇÈñì365Êó•ÂèñÂºï', 'Á∑èË≥áÁî£„ÅÆ5%‰ª•‰∏ã„ÅåÁõÆÂÆâ'],
                description: '„Éì„ÉÉ„Éà„Ç≥„Ç§„É≥„ÇÑ„Ç§„Éº„Çµ„É™„Ç¢„É†„Å™„Å©„ÄÅ„Éñ„É≠„ÉÉ„ÇØ„ÉÅ„Çß„Éº„É≥ÊäÄË°ì„ÇíÂü∫Áõ§„Å®„Åó„Åü„Éá„Ç∏„Çø„É´Ë≥áÁî£„ÄÇ‰æ°Ê†ºÂ§âÂãï„ÅåÊøÄ„Åó„ÅÑ„Éè„Ç§„É™„Çπ„ÇØÊäïË≥á„ÄÇ',
                pros: ['24ÊôÇÈñì365Êó•ÂèñÂºïÂèØËÉΩ', 'Â∞ëÈ°ç„Åã„ÇâË≥ºÂÖ•ÂèØËÉΩ', 'È´ò„ÅÑ„É™„Çø„Éº„É≥„ÅÆÂèØËÉΩÊÄß'],
                cons: ['‰æ°Ê†ºÂ§âÂãï„ÅåÈùûÂ∏∏„Å´ÊøÄ„Åó„ÅÑ', 'Ë¶èÂà∂„É™„Çπ„ÇØ„Åå„ÅÇ„Çã', '„Éè„ÉÉ„Ç≠„É≥„Ç∞„ÇÑË©êÊ¨∫„ÅÆ„É™„Çπ„ÇØ'],
                steps: ['ÊöóÂè∑Ë≥áÁî£ÂèñÂºïÊâÄ„ÅßÂè£Â∫ßÈñãË®≠', 'Êú¨‰∫∫Á¢∫Ë™ç„ÇíÂÆå‰∫Ü', 'Êó•Êú¨ÂÜÜ„ÇíÂÖ•Èáë', 'BTC/ETH„Å™„Å©‰∏ªË¶ÅÈäòÊüÑ„Åã„ÇâÂ∞ëÈ°çË≥ºÂÖ•'],
                glossary: [{ word: '„Éú„É©„ÉÜ„Ç£„É™„ÉÜ„Ç£', def: '‰æ°Ê†º„ÅÆÂ§âÂãïÂπÖ„ÅÆÂ§ß„Åç„Åï' }, { word: '„Éñ„É≠„ÉÉ„ÇØ„ÉÅ„Çß„Éº„É≥', def: 'ÂèñÂºïÂ±•Ê≠¥„ÇíÂàÜÊï£ÁÆ°ÁêÜ„Åô„ÇãÊäÄË°ì' }],
                brokers: [
                    { name: 'bitFlyer', feature: 'ÂõΩÂÜÖÂ§ßÊâã„ÅÆ‰ªÆÊÉ≥ÈÄöË≤®ÂèñÂºïÊâÄ„ÄÇ„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÂØæÁ≠ñ„Å´Ê≥®Âäõ', url: 'https://bitflyer.com/' },
                    { name: 'Coincheck', feature: '„Ç¢„Éó„É™„Åå„Ç∑„É≥„Éó„É´„ÄÇÂàùÂøÉËÄÖÂêë„ÅëUI', url: 'https://coincheck.com/' },
                    { name: 'GMO„Ç≥„Ç§„É≥', feature: 'ÊâãÊï∞Êñô„ÅåÂÆâ„ÅÑ„ÄÇÁ©çÁ´ã„Çµ„Éº„Éì„ÇπÂÖÖÂÆü', url: 'https://coin.z.com/' }
                ]
            },
            {
                id: 7, name: 'iDeCo', nameJp: 'ÂÄã‰∫∫ÂûãÁ¢∫ÂÆöÊã†Âá∫Âπ¥Èáë', tagline: 'Á®éÂà∂ÂÑ™ÈÅá„ÅßËÄÅÂæå„Å´ÂÇô„Åà„Çã', image: 'https://images.unsplash.com/photo-1553729459-efe14ef6055d?w=800&q=80', riskLevel: 2,
                knowledge: ['ÊéõÈáë„ÅåÂÖ®È°çÊâÄÂæóÊéßÈô§', 'ÈÅãÁî®Áõä„ÇÇÈùûË™≤Á®é', '60Ê≠≥„Åæ„ÅßÂºï„ÅçÂá∫„Åó‰∏çÂèØ'],
                description: 'ËÄÅÂæåË≥áÈáëÂ∞ÇÁî®„ÅÆÁßÅÁöÑÂπ¥ÈáëÂà∂Â∫¶„ÄÇÁ®éÂà∂ÂÑ™ÈÅá„ÅåÈùûÂ∏∏„Å´ÊâãÂéö„Åè„ÄÅÁØÄÁ®é„Åó„Å™„Åå„ÇâË≥áÁî£ÂΩ¢Êàê„Åß„Åç„Åæ„Åô„ÄÇ„Åü„Å†„Åó60Ê≠≥„Åæ„ÅßÂºï„ÅçÂá∫„Åõ„Åæ„Åõ„Çì„ÄÇ',
                pros: ['ÊéõÈáë„ÅåÂÖ®È°çÊâÄÂæóÊéßÈô§', 'ÈÅãÁî®Áõä„ÅåÈùûË™≤Á®é', 'ÂèóÂèñÊôÇ„ÇÇÁ®éÂà∂ÂÑ™ÈÅá'],
                cons: ['60Ê≠≥„Åæ„ÅßÂéüÂâáÂºï„ÅçÂá∫„Åó‰∏çÂèØ', 'Âä†ÂÖ•ËÄÖ„Å´„Çà„Å£„Å¶ÊéõÈáë‰∏äÈôê„ÅåÁï∞„Å™„Çã', 'Âè£Â∫ßÁÆ°ÁêÜÊâãÊï∞Êñô„Åå„Åã„Åã„Çã'],
                steps: ['Âä†ÂÖ•Ë≥áÊ†º„Å®ÊéõÈáë‰∏äÈôê„ÇíÁ¢∫Ë™ç', 'Ë®ºÂà∏‰ºöÁ§æ„ÅßiDeCoÂè£Â∫ß„ÇíÈñãË®≠', 'ÈÅãÁî®ÂïÜÂìÅ„ÇíÈÅ∏Êäû', 'ÊØéÊúà„ÅÆÊéõÈáë„ÇíË®≠ÂÆö'],
                glossary: [{ word: 'ÊâÄÂæóÊéßÈô§', def: 'Ë™≤Á®éÂØæË±°„Å®„Å™„ÇãÊâÄÂæó„Åã„ÇâÂ∑Æ„ÅóÂºï„Åë„ÇãÈáëÈ°ç' }, { word: 'Á¢∫ÂÆöÊã†Âá∫Âπ¥Èáë', def: 'ÊéõÈáë„ÇíËá™ÂàÜ„ÅßÈÅãÁî®„Åô„ÇãÂπ¥ÈáëÂà∂Â∫¶' }],
                brokers: [
                    { name: 'SBIË®ºÂà∏', feature: 'ÈÅãÂñ∂ÁÆ°ÁêÜÊâãÊï∞Êñô„ÅåÁÑ°Êñô„ÄÇÂïÜÂìÅ„É©„Ç§„É≥„Éä„ÉÉ„ÉóË±äÂØå', url: 'https://www.sbisec.co.jp/', recommended: true },
                    { name: 'Ê•ΩÂ§©Ë®ºÂà∏', feature: 'Ê•ΩÂ§©Ë®ºÂà∏iDeCoÂÆöÊúüÈ†êÈáë„ÅÇ„Çä„ÄÇ„Ç∑„É≥„Éó„É´Ë®≠Ë®à', url: 'https://www.rakuten-sec.co.jp/' },
                    { name: '„Éû„Éç„ÉÉ„ÇØ„ÇπË®ºÂà∏', feature: 'eMAXIS SlimÂÖ®‰∏ñÁïåÂèñÊâ±„ÅÑ„ÄÇ‰Ωé„Ç≥„Çπ„ÉàÂïÜÂìÅÂÖÖÂÆü', url: 'https://www.monex.co.jp/' }
                ]
            },
            {
                id: 8, name: 'BONDS', nameJp: 'ÂÇµÂà∏', tagline: 'ÂÆâÂÆöÂèéÁõä„ÅÆÂúüÂè∞„Çí‰Ωú„Çã', image: 'https://images.unsplash.com/photo-1554224155-6726b3ff858f?w=800&q=80', riskLevel: 1,
                knowledge: ['ÂõΩÂÇµ„ÅØÊúÄ„ÇÇÂÆâÂÖ®', 'ÂÆöÊúüÁöÑ„Å™Âà©ÊÅØÂèéÂÖ•', 'ÈáëÂà©„Å®‰æ°Ê†º„ÅØÈÄÜÁõ∏Èñ¢'],
                description: 'ÂõΩ„ÇÑ‰ºÅÊ•≠„Å´„ÅäÈáë„ÇíË≤∏„Åó„ÄÅÂà©ÊÅØ„ÇíÂèó„ÅëÂèñ„ÇãÊäïË≥á„ÄÇÊ†™Âºè„Çà„Çä‰Ωé„É™„Çπ„ÇØ„Éª‰Ωé„É™„Çø„Éº„É≥„Åß„ÄÅ„Éù„Éº„Éà„Éï„Ç©„É™„Ç™„ÅÆÂÆâÂÆöÂâ§„Å®„Åó„Å¶Ê©üËÉΩ„Åó„Åæ„Åô„ÄÇ',
                pros: ['Ê†™Âºè„Çà„Çä‰æ°Ê†ºÂ§âÂãï„ÅåÂ∞è„Åï„ÅÑ', 'ÂÆöÊúüÁöÑ„Å™Âà©ÊÅØÂèéÂÖ•', 'ÂõΩÂÇµ„ÅØÂÖÉÊú¨‰øùË®º„Å´Ëøë„ÅÑÂÆâÂÖ®ÊÄß'],
                cons: ['Ê†™Âºè„Çà„ÇäÊúüÂæÖ„É™„Çø„Éº„É≥„Åå‰Ωé„ÅÑ', 'ÈáëÂà©‰∏äÊòá„ÅßÂÇµÂà∏‰æ°Ê†º„ÅØ‰∏ãËêΩ', '„Ç§„É≥„Éï„É¨„Å´Âº±„ÅÑ'],
                steps: ['Ë®ºÂà∏Âè£Â∫ß„ÇíÈñãË®≠', 'ÂÄã‰∫∫Âêë„ÅëÂõΩÂÇµ„ÅãÂÇµÂà∏„Éï„Ç°„É≥„Éâ„ÇíÈÅ∏Êäû', 'Â§âÂãï10Âπ¥ÂõΩÂÇµ„ÅåÂàùÂøÉËÄÖÂêë„Åë', 'Ë≥ºÂÖ•Âæå„ÅØÊ∫ÄÊúü„Åæ„Åß‰øùÊúâ'],
                glossary: [{ word: 'Âà©Âõû„Çä', def: 'ÊäïË≥áÈ°ç„Å´ÂØæ„Åô„ÇãÂπ¥ÈñìÂèéÁõä„ÅÆÂâ≤Âêà' }, { word: 'ÂÑüÈÇÑ', def: 'ÂÇµÂà∏„ÅÆÊ∫ÄÊúüÊôÇ„Å´ÂÖÉÊú¨„ÅåËøîÊ∏à„Åï„Çå„Çã„Åì„Å®' }],
                brokers: [
                    { name: 'SBIË®ºÂà∏', feature: 'ÂÇµÂà∏„É©„Ç§„É≥„Éä„ÉÉ„ÉóÂÖÖÂÆü„ÄÇÁ§æÂÇµ„ÇÇË≥ºÂÖ•ÂèØËÉΩ', url: 'https://www.sbisec.co.jp/', recommended: true },
                    { name: 'Ê•ΩÂ§©Ë®ºÂà∏', feature: 'ÂÄã‰∫∫Âêë„ÅëÂõΩÂÇµË≥ºÂÖ•„Åß„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ', url: 'https://www.rakuten-sec.co.jp/' },
                    { name: 'Ë≤°ÂãôÁúÅ', feature: 'ÂÄã‰∫∫Âêë„ÅëÂõΩÂÇµ„ÅÆÁõ¥Êé•Ë≥ºÂÖ•„ÄÇÊúÄ„ÇÇÂÆâÂøÉ', url: 'https://www.mof.go.jp/jgbs/individual/' }
                ]
            }
        ];

        const AssetDetailModal = ({ asset, onClose }) => {
            if (!asset) return null;
            return (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="fixed inset-0 z-50 flex items-center justify-center bg-obsidian/95 backdrop-blur-md p-4 pt-10 sm:pt-4" onClick={onClose}>
                    <motion.div initial={{ opacity: 0, scale: 0.95, y: 20 }} animate={{ opacity: 1, scale: 1, y: 0 }} exit={{ opacity: 0, scale: 0.95 }} onClick={e => e.stopPropagation()}
                        className="w-full max-w-2xl max-h-[90vh] overflow-y-auto bg-ash border border-white/10 rounded-sm my-8 custom-shadow custom-scrollbar relative">
                        <div className="relative h-40 overflow-hidden">
                            <img src={asset.image} alt="" className="w-full h-full object-cover filter brightness-50" />
                            <div className="absolute inset-0 bg-gradient-to-t from-ash to-transparent" />
                            <button onClick={onClose} className="absolute top-4 right-4 text-white/70 hover:text-white text-2xl bg-black/50 w-10 h-10 rounded-full flex items-center justify-center">‚úï</button>
                            <div className="absolute bottom-4 left-6">
                                <h3 className="text-4xl font-black text-platinum">{asset.name}</h3>
                                <p className="text-gold font-bold">{asset.nameJp}</p>
                            </div>
                        </div>
                        <div className="p-6 space-y-6">
                            <p className="text-lg text-platinum/90 leading-relaxed">{asset.description}</p>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-sm p-4">
                                    <p className="text-xs text-emerald-500 uppercase tracking-wider mb-2 font-bold">„É°„É™„ÉÉ„Éà</p>
                                    <ul className="space-y-2">{asset.pros.map((p, i) => <li key={i} className="text-sm text-platinum/80 flex items-start gap-2"><span className="text-emerald-500">‚úì</span>{p}</li>)}</ul>
                                </div>
                                <div className="bg-rose-500/10 border border-rose-500/30 rounded-sm p-4">
                                    <p className="text-xs text-rose-500 uppercase tracking-wider mb-2 font-bold">„Éá„É°„É™„ÉÉ„Éà</p>
                                    <ul className="space-y-2">{asset.cons.map((c, i) => <li key={i} className="text-sm text-platinum/80 flex items-start gap-2"><span className="text-rose-500">!</span>{c}</li>)}</ul>
                                </div>
                            </div>

                            <div className="bg-obsidian/50 border border-white/5 rounded-sm p-4">
                                <p className="text-xs text-gold uppercase tracking-wider mb-3 font-bold">Âßã„ÇÅÊñπ„Çπ„ÉÜ„ÉÉ„Éó</p>
                                <div className="space-y-3">
                                    {asset.steps.map((s, i) => (
                                        <div key={i} className="flex items-center gap-4">
                                            <span className="w-8 h-8 rounded-full bg-gold/20 text-gold flex items-center justify-center font-bold text-sm">{i + 1}</span>
                                            <span className="text-sm text-platinum/80">{s}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {asset.glossary.length > 0 && (
                                <div className="border-t border-white/10 pt-4">
                                    <p className="text-xs text-dim uppercase tracking-wider mb-3">Áî®Ë™ûËß£Ë™¨</p>
                                    <div className="flex flex-wrap gap-2">
                                        {asset.glossary.map((g, i) => (
                                            <div key={i} className="bg-obsidian/50 border border-white/5 px-3 py-2 rounded-sm group relative">
                                                <span className="text-gold text-sm cursor-help">{g.word}</span>
                                                <div className="absolute bottom-full left-0 mb-2 hidden group-hover:block bg-ash border border-white/10 p-3 rounded-sm w-48 z-10 shadow-xl">
                                                    <p className="text-xs text-platinum/80">{g.def}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {asset.brokers && (
                                <div className="bg-gradient-to-br from-gold/10 to-amber-500/5 border border-gold/30 rounded-sm p-5">
                                    <p className="text-xs text-gold uppercase tracking-wider mb-4 font-bold flex items-center gap-2">üè¶ ÂèÇËÄÉÂè£Â∫ß</p>
                                    <div className="space-y-3">
                                        {asset.brokers.map((broker, i) => (
                                            <a key={i} href={broker.url} target="_blank" rel="noopener noreferrer"
                                                className="block bg-ash/50 border border-white/10 rounded-sm p-4 hover:border-gold/50 transition-all group">
                                                <div className="flex items-center justify-between mb-2">
                                                    <span className="text-lg font-bold text-platinum group-hover:text-gold transition-colors">{broker.name}</span>
                                                    {broker.recommended && <span className="text-[10px] bg-gold text-black px-2 py-0.5 rounded-sm font-bold">ÂèÇËÄÉ</span>}
                                                </div>
                                                <p className="text-sm text-platinum/70">{broker.feature}</p>
                                                <p className="text-xs text-gold mt-2">Âè£Â∫ßÈñãË®≠„ÅØ„Åì„Å°„Çâ ‚Üí</p>
                                            </a>
                                        ))}
                                    </div>
                                    <p className="text-[10px] text-dim mt-3">
                                        ‚Äª Â§ñÈÉ®„Çµ„Ç§„Éà„Å∏ÈÅ∑Áßª„Åó„Åæ„Åô„ÄÇÊäïË≥áÂãßË™ò„ÇíÁõÆÁöÑ„Å®„Åó„Åü„ÇÇ„ÅÆ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ<br />
                                        ‚Äª Êú¨„É™„É≥„ÇØ„ÅØÊèêÊê∫„Çµ„Éº„Éì„Çπ„Å∏„ÅÆÊ°àÂÜÖ„ÇíÂê´„Åø„Åæ„Åô
                                    </p>
                                </div>
                            )}
                        </div>
                    </motion.div>
                </motion.div>
            );
        };

        const PortfolioCalibration = ({ onComplete, existingProfile, onRediagnose, isOnboarding, onSkip, onNavigate, onSelectAsset }) => {
            const [currentQ, setCurrentQ] = useState(0);
            const [viewingAsset, setViewingAsset] = useState(null);
            const [answers, setAnswers] = useState({});
            const [showResult, setShowResult] = useState(false);
            const [sliderValue, setSliderValue] = useState(30); // Default age 30
            const [isDiagnosing, setIsDiagnosing] = useState(!existingProfile);
            const [showIntro, setShowIntro] = useState(!existingProfile);

            const questions = [
                // PROFILE (1 question) - Now a slider for precise age
                { id: 0, category: 'PROFILE', question: '„ÅÇ„Å™„Åü„ÅÆÂπ¥ÈΩ¢„ÅØÔºü', type: 'slider', min: 18, max: 80, step: 1, unit: 'Ê≠≥' },
                // LIFESTYLE (3 questions)
                { id: 1, category: 'LIFESTYLE', question: '„Çπ„Çø„Éê„ÅÆÊñ∞‰Ωú„ÅåÂá∫„Åü„Çâ„ÄÅ„Åô„ÅêË©¶„ÅôÔºü', type: 'choice', options: [{ label: '„Åô„ÅêË°å„ÅèÔºÅ', value: 4 }, { label: 'SNS„ÅßË©ïÂà§Ë¶ã„Å¶„Åã„Çâ', value: 3 }, { label: 'ÂÆöÁï™„Åó„ÅãÈ†º„Åæ„Å™„ÅÑ', value: 2 }, { label: '„Ç≥„É≥„Éì„Éã„Ç≥„Éº„Éí„ÉºÊ¥æ', value: 1 }] },
                { id: 2, category: 'LIFESTYLE', question: 'Êúç„ÇíË≤∑„ÅÜ„Å®„Åç„ÄÅ‰Ωï„ÇíÈáçË¶ñ„Åô„ÇãÔºü', type: 'choice', options: [{ label: '‰ªäÂ≠£„ÅÆ„Éà„É¨„É≥„ÉâÊúÄÂÑ™ÂÖà', value: 4 }, { label: '„Ç≥„Çπ„Éë„Å®Ë¶ã„ÅüÁõÆ„ÅÆ„Éê„É©„É≥„Çπ', value: 3 }, { label: '10Âπ¥ÁùÄ„Çå„ÇãÂÆöÁï™', value: 2 }, { label: 'ÂøÖË¶ÅÊúÄ‰ΩéÈôê„Åó„ÅãË≤∑„Çè„Å™„ÅÑ', value: 1 }] },
                { id: 3, category: 'LIFESTYLE', question: 'ÊóÖË°å„ÅÆ‰∫àÁ¥Ñ„Çπ„Çø„Ç§„É´„ÅØÔºü', type: 'choice', options: [{ label: 'ÂΩìÊó•„Éé„Éº„Éó„É©„É≥„ÅßÂá∫Áô∫', value: 4 }, { label: 'Â§ß„Åæ„Åã„Å™„Éó„É©„É≥„Å†„ÅëÊ±∫„ÇÅ„Çã', value: 3 }, { label: '‰∫ãÂâç„Å´„Åó„Å£„Åã„ÇäË®àÁîª', value: 2 }, { label: 'ÊóÖË°å„Çà„ÇäÂÆ∂„Åß„ÇÜ„Å£„Åè„Çä', value: 1 }] },
                // FINANCE (4 questions)
                { id: 4, category: 'FINANCE', question: '1„É∂Êúà„ÅßËá™Áî±„Å´Âãï„Åã„Åõ„Çã‰ΩôË£ï„ÅØÔºü', type: 'slider', min: 0, max: 100, step: 1, unit: 'ÂÜÜ' },
                { id: 5, category: 'FINANCE', question: '‰∏á„Åå‰∏Ä„ÅÆÁîüÊ¥ªÈò≤Ë°õË≥áÈáë„ÅØÔºü', type: 'choice', options: [{ label: '6„É∂ÊúàÂàÜ‰ª•‰∏ä„ÅÇ„Çã', value: 1 }, { label: '3„Äú5„É∂ÊúàÂàÜÁ®ãÂ∫¶', value: 2 }, { label: '1„Äú2„É∂ÊúàÂàÜÁ®ãÂ∫¶', value: 3 }, { label: '„Åª„Åº„Å™„ÅÑ or „Åì„Çå„Åã„Çâ', value: 4 }] },
                { id: 6, category: 'FINANCE', question: 'ÊØéÊúà„ÅÆË≤ØËìÑÈ°çÔºàÊäïË≥áÂê´„ÇÄÔºâ„ÅØÔºü', type: 'choice', options: [{ label: 'ÂèéÂÖ•„ÅÆ30%‰ª•‰∏ä', value: 1 }, { label: 'ÂèéÂÖ•„ÅÆ10-30%Á®ãÂ∫¶', value: 2 }, { label: 'ÂèéÂÖ•„ÅÆ10%Êú™Ê∫Ä', value: 3 }, { label: '„Åª„Å®„Çì„Å©Ë≤ØËìÑ„Åß„Åç„Å¶„ÅÑ„Å™„ÅÑ', value: 4 }] },
                { id: 7, category: 'FINANCE', question: '„Éú„Éº„Éä„Çπ„ÅÆ‰Ωø„ÅÑÊñπ„ÅØÔºü', type: 'choice', options: [{ label: 'ÂÖ®È°çÊäïË≥á„ÉªË≤ØËìÑ', value: 1 }, { label: 'ÂçäÂàÜ‰ª•‰∏ä„ÇíË≤ØËìÑ', value: 2 }, { label: 'ÂøÖË¶Å„Å™„ÇÇ„ÅÆ„Å´‰Ωø„ÅÜ', value: 3 }, { label: 'Áâπ„Å´Ê±∫„ÇÅ„Å¶„ÅÑ„Å™„ÅÑ', value: 4 }] },
                // RISK (4 questions)
                { id: 8, category: 'RISK', question: '100‰∏áÂÜÜÊäïË≥á„Åó„Å¶50‰∏áÂÜÜ„Å´„Å™„Å£„Åü„ÇâÔºü', type: 'choice', options: [{ label: 'ÊÄñ„ÅÑ„ÄÅ„ÇÑ„ÇÅ„Åü„ÅÑ', value: 1 }, { label: 'Â∞ë„Åó‰∏çÂÆâ„Å†„ÅåËÄê„Åà„Çã', value: 2 }, { label: 'Èï∑Êúü„Å™„ÇâÂïèÈ°å„Å™„Åó', value: 3 }, { label: '„ÇÄ„Åó„ÇçË≤∑„ÅÑÂ¢ó„Åó„ÉÅ„É£„É≥„Çπ', value: 4 }] },
                { id: 9, category: 'RISK', question: '„Äå„Éè„Ç§„É™„Çπ„ÇØ„Éª„Éè„Ç§„É™„Çø„Éº„É≥„Äç„Å®„ÅÑ„ÅÜË®ÄËëâ„ÅÆÂç∞Ë±°„ÅØÔºü', type: 'choice', options: [{ label: 'Âç±Èô∫„ÄÅÈÅø„Åë„Åü„ÅÑ', value: 1 }, { label: 'ÁêÜËß£„ÅØ„Åô„Çã„ÅåÊÖéÈáç„Å´', value: 2 }, { label: '‰∏ÄÈÉ®„Å™„ÇâÊ§úË®é„Åô„Çã', value: 3 }, { label: '„ÉØ„ÇØ„ÉØ„ÇØ„Åô„Çã', value: 4 }] },
                { id: 10, category: 'RISK', question: 'Âèã‰∫∫„Åå„ÄåÂÑ≤„Åã„ÇãË©±„Åå„ÅÇ„Çã„Äç„Å®Ë®Ä„Å£„Å¶„Åç„Åü„ÇâÔºü', type: 'choice', options: [{ label: 'Áµ∂ÂØæ„Å´Êñ≠„Çã', value: 1 }, { label: 'Ë©≥„Åó„ÅèËÅû„ÅÑ„Å¶ÊÖéÈáç„Å´Âà§Êñ≠', value: 2 }, { label: 'Â∞ëÈ°ç„Å™„ÇâË©¶„Åó„Å¶„Åø„Çã', value: 3 }, { label: 'Èù¢ÁôΩ„Åù„ÅÜ„Å™„Çâ‰πó„Å£„Å¶„Åø„Çã', value: 4 }] },
                { id: 11, category: 'RISK', question: 'ÊäïË≥á„Åß‰∏ÄÁï™ÈÅø„Åë„Åü„ÅÑ„Åì„Å®„ÅØÔºü', type: 'choice', options: [{ label: 'ÂÖÉÊú¨Ââ≤„Çå', value: 1 }, { label: 'ÊúüÂæÖ„Çà„Çä‰Ωé„ÅÑ„É™„Çø„Éº„É≥', value: 2 }, { label: 'ÊäïË≥áÊ©ü‰ºö„ÅÆÈÄÉ„Åó', value: 3 }, { label: 'ÂÑ≤„Åë„ÇíÈÄÉ„Åô„Åì„Å®', value: 4 }] },
                // KNOWLEDGE (3 questions)
                { id: 12, category: 'KNOWLEDGE', question: 'ÊäïË≥áÁµåÈ®ì„ÅØ„Å©„ÅÆ„Åè„Çâ„ÅÑÔºü', type: 'choice', options: [{ label: 'ÂÖ®„Åè„ÅÆÂàùÂøÉËÄÖ', value: 1 }, { label: 'NISAÂè£Â∫ß„ÇíÈñãË®≠„Åó„ÅüÁ®ãÂ∫¶', value: 2 }, { label: '1Âπ¥‰ª•‰∏äÈÅãÁî®‰∏≠', value: 3 }, { label: 'Ë§áÊï∞Ë≥áÁî£„ÇíÈÅãÁî®‰∏≠', value: 4 }] },
                { id: 13, category: 'KNOWLEDGE', question: '„ÄåË§áÂà©„Äç„Å£„Å¶Ë™¨Êòé„Åß„Åç„ÇãÔºü', type: 'choice', options: [{ label: 'ËÅû„ÅÑ„Åü„Åì„Å®„Å™„ÅÑ', value: 1 }, { label: 'ËÅû„ÅÑ„Åü„Åì„Å®„ÅØ„ÅÇ„Çã', value: 2 }, { label: '„Å™„Çì„Å®„Å™„Åè„Çè„Åã„Çã', value: 3 }, { label: 'ÂÆåÁíß„Å´ÁêÜËß£„Åó„Å¶„ÅÑ„Çã', value: 4 }] },
                { id: 14, category: 'KNOWLEDGE', question: '„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊäïË≥á„Å®ÂÄãÂà•Ê†™„ÅÆÈÅï„ÅÑ„ÅØÔºü', type: 'choice', options: [{ label: '„Çè„Åã„Çâ„Å™„ÅÑ', value: 1 }, { label: '„Å™„Çì„Å®„Å™„Åè„Ç§„É°„Éº„Ç∏„ÅØ„ÅÇ„Çã', value: 2 }, { label: 'Ë™¨Êòé„Åß„Åç„Çã', value: 3 }, { label: '‰∏°ÊñπÈÅãÁî®„Åó„ÅüÁµåÈ®ì„Åå„ÅÇ„Çã', value: 4 }] },
                // GOALS (2 questions)
                { id: 15, category: 'GOALS', question: 'ÊäïË≥á„ÅßÈÅîÊàê„Åó„Åü„ÅÑ‰∏ÄÁï™„ÅÆÁõÆÊ®ô„ÅØÔºü', type: 'choice', options: [{ label: 'ËÄÅÂæåË≥áÈáë„ÅÆÁ¢∫‰øù', value: 1 }, { label: 'ÊïôËÇ≤Ë≥áÈáë„Éª‰ΩèÂÆÖË≥áÈáë', value: 2 }, { label: 'ÁµåÊ∏àÁöÑËá™Áî±ÔºàFIREÔºâ', value: 3 }, { label: 'Ë≥áÁî£„ÇíÂ§ß„Åç„ÅèÂ¢ó„ÇÑ„Åô', value: 4 }] },
                { id: 16, category: 'GOALS', question: '‰ΩïÂπ¥„Åè„Çâ„ÅÑ„ÅÆÊúüÈñì„ÅßÊäïË≥á„ÇíËÄÉ„Åà„Å¶„ÅÑ„ÇãÔºü', type: 'choice', options: [{ label: '20Âπ¥‰ª•‰∏ä„ÅÆË∂ÖÈï∑Êúü', value: 1 }, { label: '10-20Âπ¥Á®ãÂ∫¶', value: 2 }, { label: '5-10Âπ¥Á®ãÂ∫¶', value: 3 }, { label: '5Âπ¥‰ª•ÂÜÖ', value: 4 }] },
            ];

            const mapFinanceValue = (val) => {
                if (val <= 50) return Math.round((val / 50) * 50000 / 1000) * 1000;
                const t = (val - 50) / 50;
                return Math.round((50000 + Math.pow(t, 2.5) * 2950000) / 10000) * 10000;
            };

            const handleAnswer = (val) => {
                // If it's the finance slider (ID 4), map the 0-100 value to yen first
                const actualValue = questions[currentQ].id === 4 ? mapFinanceValue(val) : val;

                // Normalize age slider value to risk score (1-4)
                let normalizedVal = actualValue;
                if (questions[currentQ].type === 'slider' && questions[currentQ].id === 0) {
                    // Age-based risk scoring: younger = higher risk tolerance
                    if (actualValue < 30) normalizedVal = 4;
                    else if (actualValue < 40) normalizedVal = 3;
                    else if (actualValue < 60) normalizedVal = 2;
                    else normalizedVal = 1;
                } else if (questions[currentQ].id === 4) {
                    // Normalize finance value: 50k=2, 100k=3, 200k+=4
                    if (actualValue >= 200000) normalizedVal = 4;
                    else if (actualValue >= 100000) normalizedVal = 3;
                    else if (actualValue >= 50000) normalizedVal = 2;
                    else normalizedVal = 1;
                }
                setAnswers({ ...answers, [questions[currentQ].id]: normalizedVal });
                if (currentQ < questions.length - 1) {
                    setTimeout(() => {
                        const nextQ = questions[currentQ + 1];
                        if (nextQ.type === 'slider') {
                            setSliderValue(nextQ.id === 0 ? 30 : 50); // Age: 30, Finance: 50 (center)
                        }
                        setCurrentQ(currentQ + 1);
                    }, 300);
                }
                else setTimeout(() => setShowResult(true), 300);
            };

            const calculateProfile = () => {
                // Category-based weighted scoring system
                // RISK: 40%, FINANCE: 25%, KNOWLEDGE: 15%, LIFESTYLE: 10%, GOALS: 10%
                const categoryWeights = {
                    PROFILE: 0,      // Age is used for adjustment, not direct score
                    LIFESTYLE: 0.10,
                    FINANCE: 0.25,
                    RISK: 0.40,
                    KNOWLEDGE: 0.15,
                    GOALS: 0.10
                };

                // Group answers by category
                const categoryScores = {};
                const categoryCounts = {};

                questions.forEach(q => {
                    const cat = q.category;
                    const answer = answers[q.id];
                    if (answer !== undefined && cat !== 'PROFILE') {
                        if (!categoryScores[cat]) {
                            categoryScores[cat] = 0;
                            categoryCounts[cat] = 0;
                        }
                        categoryScores[cat] += answer;
                        categoryCounts[cat] += 1;
                    }
                });

                // Calculate normalized score per category (0-100)
                const normalizedCategoryScores = {};
                Object.keys(categoryScores).forEach(cat => {
                    const maxPossible = categoryCounts[cat] * 4;
                    normalizedCategoryScores[cat] = Math.round((categoryScores[cat] / maxPossible) * 100);
                });

                // Calculate weighted total score (0-100)
                let weightedScore = 0;
                Object.keys(normalizedCategoryScores).forEach(cat => {
                    weightedScore += normalizedCategoryScores[cat] * (categoryWeights[cat] || 0);
                });
                weightedScore = Math.round(weightedScore);

                // Age adjustment: younger investors can tolerate slightly more risk
                const age = answers[0] || 30;
                let ageAdjustment = 0;
                if (age < 30) ageAdjustment = 5;
                else if (age < 40) ageAdjustment = 2;
                else if (age >= 60) ageAdjustment = -5;

                const finalScore = Math.max(0, Math.min(100, weightedScore + ageAdjustment));

                // Profile selection based on clear thresholds
                // Score < 20: Guardian (ÊúÄ„ÇÇ‰øùÂÆàÁöÑ)
                // Score 20-34: Custodian
                // Score 35-44: Conservative
                // Score 45-54: Architect
                // Score 55-64: Strategist
                // Score 65-74: Explorer
                // Score 75-84: Visionary
                // Score >= 85: Pioneer (ÊúÄ„ÇÇÁ©çÊ•µÁöÑ)
                let selected;
                let profileReason;

                if (finalScore < 20) {
                    selected = profiles[0]; // Guardian
                    profileReason = 'Ë≥áÁî£‰øùÂÖ®„ÇíÊúÄÂÑ™ÂÖà„Å®„Åó„ÄÅÂÖÉÊú¨Ââ≤„Çå„É™„Çπ„ÇØ„ÇíÊ•µÂäõÈÅø„Åë„ÇãÂÇæÂêë„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ';
                } else if (finalScore < 35) {
                    selected = profiles[1]; // Custodian
                    profileReason = 'Â†ÖÂÆü„Å™Ë≥áÁî£ÁÆ°ÁêÜ„ÇíÂ•Ω„Åø„ÄÅ„Ç§„É≥„Éï„É¨„Å´Ë≤†„Åë„Å™„ÅÑÁ®ãÂ∫¶„ÅÆÈÅãÁî®„ÇíÁõÆÊåá„Åó„Åæ„Åô„ÄÇ';
                } else if (finalScore < 45) {
                    selected = profiles[2]; // Conservative
                    profileReason = 'ÂÆâÂÆöÊÄß„ÇíÈáçË¶ñ„Åó„Å§„Å§„ÄÅÁùÄÂÆü„Å™Ë≥áÁî£ÂΩ¢Êàê„ÇíÁõÆÊåá„Åô„Éê„É©„É≥„ÇπÂøóÂêë„Åß„Åô„ÄÇ';
                } else if (finalScore < 55) {
                    selected = profiles[3]; // Architect
                    profileReason = 'Èï∑ÊúüÁöÑ„Å™Ë¶ñÁÇπ„ÅßË≥áÁî£„ÇíË®≠Ë®à„Åó„ÄÅ„É™„Çπ„ÇØ„Å®„É™„Çø„Éº„É≥„ÅÆ„Éê„É©„É≥„Çπ„ÇíÈáçË¶ñ„Åó„Åæ„Åô„ÄÇ';
                } else if (finalScore < 65) {
                    selected = profiles[4]; // Strategist
                    profileReason = 'Â∏ÇÂ†¥„ÅÆÂãï„Åç„ÇíÂàÜÊûê„Åó„ÄÅÊ©üÂãïÁöÑ„Å™„Éù„Éº„Éà„Éï„Ç©„É™„Ç™Ë™øÊï¥„ÇíÂ•Ω„Åø„Åæ„Åô„ÄÇ';
                } else if (finalScore < 75) {
                    selected = profiles[5]; // Explorer
                    profileReason = 'Êñ∞„Åó„ÅÑÊäïË≥áÊ©ü‰ºö„ÇíÁ©çÊ•µÁöÑ„Å´Êé¢Ê±Ç„Åó„ÄÅÂ§öÊßò„Å™Ë≥áÁî£„Å∏„ÅÆÂàÜÊï£„ÇíÂøóÂêë„Åó„Åæ„Åô„ÄÇ';
                } else if (finalScore < 85) {
                    selected = profiles[6]; // Visionary
                    profileReason = 'Â∞ÜÊù•„ÅÆ„Éà„É¨„É≥„Éâ„ÇíË¶ãÊçÆ„Åà„ÄÅÊàêÈï∑ÊÄß„ÅÆÈ´ò„ÅÑË≥áÁî£„Å∏„ÅÆÊäïË≥á„ÇíÂ•Ω„Åø„Åæ„Åô„ÄÇ';
                } else {
                    selected = profiles[7]; // Pioneer
                    profileReason = 'È´ò„ÅÑ„É™„Çπ„ÇØ„ÇíË®±ÂÆπ„Åó„ÄÅÁ©çÊ•µÁöÑ„Å™„É™„Çø„Éº„É≥„ÇíËøΩÊ±Ç„Åô„ÇãÊäïË≥á„Çπ„Çø„Ç§„É´„Åß„Åô„ÄÇ';
                }

                // Experience level from knowledge questions
                const knowledgeScore = normalizedCategoryScores['KNOWLEDGE'] || 0;
                let expLevel = 1;
                if (knowledgeScore >= 75) expLevel = 3;      // ÁÜüÁ∑¥
                else if (knowledgeScore >= 50) expLevel = 2; // Ë¶ãÁøí„ÅÑ
                else expLevel = 1;                            // ÈßÜ„ÅëÂá∫„Åó

                return {
                    ...selected,
                    baseType: selected.nameJp,
                    initialLevel: expLevel,
                    experienceLevel: expLevel,
                    // Extended diagnostic data
                    diagnosticData: {
                        finalScore,
                        categoryScores: normalizedCategoryScores,
                        ageAdjustment,
                        profileReason,
                        timestamp: Date.now()
                    }
                };
            };
            const profile = showResult ? calculateProfile() : existingProfile;

            const startRediagnose = () => {
                setCurrentQ(0);
                setAnswers({});
                setShowResult(false);
                setIsDiagnosing(true);
            };

            // Show existing profile if not diagnosing
            if (!isDiagnosing && existingProfile) {
                const expLevel = existingProfile.experienceLevel || 1;
                const levelNames = { 1: 'ÈßÜ„ÅëÂá∫„Åó', 2: 'Ë¶ãÁøí„ÅÑ', 3: 'ÁÜüÁ∑¥' };
                const levelColors = { 1: 'text-dim', 2: 'text-emerald-400', 3: 'text-gold' };

                return (
                    <div className="min-h-screen bg-obsidian px-8 py-24 overflow-y-auto">
                        <motion.div className="max-w-2xl mx-auto" initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                            <p className="text-dim text-sm tracking-[0.3em] mb-6">YOUR PROFILE</p>

                            {/* Header */}
                            <div className="flex items-center gap-4 mb-6">
                                <span className="text-7xl">{existingProfile.icon}</span>
                                <div>
                                    <h2 className="text-4xl font-black">{existingProfile.name}</h2>
                                    <p className="text-2xl text-gold">{getUserTitle(existingProfile, 0)}</p>
                                </div>
                            </div>

                            {/* Knowledge Level Badge */}
                            <div className="flex items-center gap-3 mb-6">
                                <span className={`text-sm font-bold ${levelColors[expLevel]}`}>üìö Áü•Ë≠ò„É¨„Éô„É´: {levelNames[expLevel]}</span>
                                <div className="flex gap-1">
                                    {[1, 2, 3].map(l => (
                                        <div key={l} className={`w-3 h-3 rounded-full ${l <= expLevel ? 'bg-gold' : 'bg-stone'}`} />
                                    ))}
                                </div>
                            </div>

                            {/* Short Description */}
                            <p className="text-lg text-platinum/80 mb-4">{existingProfile.description}</p>

                            {/* Detailed Description */}
                            {existingProfile.detailedDescription && (
                                <div className="bg-ash/30 border border-white/5 rounded-sm p-5 mb-6">
                                    <p className="text-sm text-platinum/70 leading-relaxed">{existingProfile.detailedDescription}</p>
                                </div>
                            )}

                            {/* Traits */}
                            <div className="flex flex-wrap gap-2 mb-8">
                                {existingProfile.traits.map((t, i) => <span key={i} className="text-xs bg-ash border border-white/10 px-3 py-1 rounded-full text-platinum/70">{t}</span>)}
                            </div>

                            {/* Strengths & Watch Out */}
                            <div className="grid md:grid-cols-2 gap-4 mb-8">
                                {existingProfile.strengths && (
                                    <div className="bg-emerald-500/10 border border-emerald-500/20 rounded-sm p-5">
                                        <p className="text-xs text-emerald-400 uppercase tracking-wider mb-3 font-bold">üí™ Âº∑„Åø</p>
                                        <ul className="space-y-2">
                                            {existingProfile.strengths.map((s, i) => (
                                                <li key={i} className="text-sm text-platinum/80 flex items-start gap-2">
                                                    <span className="text-emerald-400 mt-0.5">‚úì</span>
                                                    <span>{s}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                                {existingProfile.watchOut && (
                                    <div className="bg-amber-500/10 border border-amber-500/20 rounded-sm p-5">
                                        <p className="text-xs text-amber-400 uppercase tracking-wider mb-3 font-bold">‚ö†Ô∏è Ê≥®ÊÑèÁÇπ</p>
                                        <ul className="space-y-2">
                                            {existingProfile.watchOut.map((w, i) => (
                                                <li key={i} className="text-sm text-platinum/80 flex items-start gap-2">
                                                    <span className="text-amber-400 mt-0.5">!</span>
                                                    <span>{w}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                            </div>

                            {/* Level-based Advice */}
                            {existingProfile.levelAdvice && existingProfile.levelAdvice[expLevel] && (
                                <div className="bg-gradient-to-r from-gold/10 to-amber-500/5 border border-gold/20 rounded-sm p-5 mb-8">
                                    <p className="text-xs text-gold uppercase tracking-wider mb-2 font-bold">üí° {levelNames[expLevel]}„ÅÆ„ÅÇ„Å™„Åü„Å∏„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ</p>
                                    <p className="text-sm text-platinum/90 leading-relaxed">{existingProfile.levelAdvice[expLevel]}</p>
                                </div>
                            )}

                            {/* Allocation */}
                            <div className="bg-ash/50 border border-white/5 rounded-sm p-6 mb-8">
                                <p className="text-xs text-dim uppercase tracking-wider mb-4">„Ç¢„É≠„Ç±„Éº„Ç∑„Éß„É≥‰æã</p>
                                <div className="flex h-3 rounded-full overflow-hidden mb-4">
                                    <div className="bg-emerald-500" style={{ width: `${existingProfile.allocation.safe}%` }} />
                                    <div className="bg-amber-500" style={{ width: `${existingProfile.allocation.balanced}%` }} />
                                    <div className="bg-rose-500" style={{ width: `${existingProfile.allocation.growth}%` }} />
                                </div>
                                <div className="flex justify-between text-xs text-dim">
                                    <span>üõ°Ô∏è ÂÆâÂÖ® {existingProfile.allocation.safe}%</span>
                                    <span>‚öñÔ∏è „Éê„É©„É≥„Çπ {existingProfile.allocation.balanced}%</span>
                                    <span>üöÄ ÊàêÈï∑ {existingProfile.allocation.growth}%</span>
                                </div>
                            </div>

                            {/* Recommended Products */}
                            <div className="mb-10">
                                <p className="text-xs text-dim uppercase tracking-wider mb-3">ÂèÇËÄÉ„Éó„É≠„ÉÄ„ÇØ„Éà</p>
                                <div className="flex flex-wrap gap-2">
                                    {existingProfile.recommended.map((r, i) => {
                                        const assetMapping = {
                                            '„Å§„Åø„Åü„Å¶NISA': 1, 'NISA': 1,
                                            'ÂõΩÂÜÖÊ†™Âºè': 2, 'Êó•Êú¨Ê†™': 2,
                                            'Á±≥ÂõΩÊ†™Âºè': 3, '„ÉÜ„ÉÉ„ÇØÊ†™': 3, '„Ç∞„É≠„Éº„ÇπÊ†™': 3, '„Ç§„Éé„Éô„Éº„Ç∑„Éß„É≥Êû†': 3, 'ÂÄãÂà•Ê†™': 3,
                                            'FX': 4,
                                            'ÊäïË≥á‰ø°Ë®ó': 5, 'ÂÖ®‰∏ñÁïåÊ†™Âºè': 5, '„Éê„É©„É≥„Çπ„Éï„Ç°„É≥„Éâ': 5, 'ÂÆà„Çä„ÅÆÊäï‰ø°': 5, 'Êñ∞ËààÂõΩ„Éï„Ç°„É≥„Éâ': 5, '„ÉÜ„Éº„ÉûÂûãÊäï‰ø°': 5, '„Çª„ÇØ„Çø„ÉºETF': 5, '„Çπ„Éû„Éº„Éà„Éô„Éº„Çø': 5,
                                            '‰ªÆÊÉ≥ÈÄöË≤®': 6,
                                            'iDeCo': 7,
                                            'ÂÇµÂà∏': 8, 'ÂõΩÂÜÖÂÇµÂà∏': 8, 'ÂõΩÂÇµ': 8, 'È´òÊ†º‰ªòÁ§æÂÇµ': 8, 'ÂÇµÂà∏„Éï„Ç°„É≥„Éâ': 8,
                                            '„É™„Éº„Éà': 9,
                                            '„Ç≥„É¢„Éá„Ç£„ÉÜ„Ç£': 10, 'Èáë': 10, '„Ç¥„Éº„É´„Éâ': 10,
                                            'ÂÆöÊúüÈ†êÈáë': 8, '„É¨„Éê„É¨„ÉÉ„Ç∏ÂïÜÂìÅ': 6
                                        };
                                        const aid = assetMapping[r] || (Object.keys(assetMapping).find(k => r.includes(k)) ? assetMapping[Object.keys(assetMapping).find(k => r.includes(k))] : null);

                                        return (
                                            <button key={i} onClick={() => {
                                                if (aid) {
                                                    const asset = assetDetailData.find(a => a.id === aid);
                                                    if (asset) setViewingAsset(asset);
                                                }
                                            }} className={`text-sm px-4 py-2 rounded-sm border transition-all ${aid ? 'bg-gold/10 border-gold/30 text-gold hover:bg-gold hover:text-black cursor-pointer' : 'bg-white/5 border-white/10 text-dim cursor-default'}`}>
                                                {r}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            <button onClick={startRediagnose} className="btn-sharp px-8 py-4 rounded-sm border-dim text-dim w-full text-lg font-bold hover:border-gold hover:text-gold transition-all">
                                ÂÜçË®∫Êñ≠
                            </button>
                        </motion.div>
                        <AnimatePresence>
                            {viewingAsset && <AssetDetailModal asset={viewingAsset} onClose={() => setViewingAsset(null)} />}
                        </AnimatePresence>
                    </div>
                );
            }

            if (showResult && profile) {
                // Broker Database
                const brokerPool = {
                    sbi: { name: 'SBIË®ºÂà∏', feature: 'ÂπÖÂ∫É„ÅÑÂïÜÂìÅ„É©„Ç§„É≥„Éä„ÉÉ„Éó„ÄÇNISA„ÉªiDeCo„ÉªÁ±≥ÂõΩÊ†™„Å´ÂØæÂøú', url: 'https://www.sbisec.co.jp/' },
                    rakuten: { name: 'Ê•ΩÂ§©Ë®ºÂà∏', feature: 'Ê•ΩÂ§©„Éù„Ç§„É≥„ÉàÊäïË≥á„ÄÇÊ•ΩÂ§©ÁµåÊ∏àÂúè„Å®„ÅÆÁõ∏ÊÄßÊäúÁæ§', url: 'https://www.rakuten-sec.co.jp/' },
                    monex: { name: '„Éû„Éç„ÉÉ„ÇØ„ÇπË®ºÂà∏', feature: 'ÂàÜÊûê„ÉÑ„Éº„É´ÂÖÖÂÆü„ÄÇÁ±≥ÂõΩÊ†™„Å´Âº∑„ÅÑ', url: 'https://www.monex.co.jp/' },
                    matsui: { name: 'Êùæ‰∫ïË®ºÂà∏', feature: 'ËÄÅËàó„ÅÆÂÆâÂøÉÊÑü„ÄÇÈõªË©±Áõ∏Ë´á„Çµ„Éù„Éº„Éà„ÅåÂÖÖÂÆü', url: 'https://www.matsui.co.jp/' },
                    wealthnavi: { name: 'WealthNavi', feature: 'ÂÖ®Ëá™Âãï„É≠„Éú„Ç¢„Éâ„Éê„Ç§„Ç∂„Éº„ÄÇ„Åª„Å£„Åü„Çâ„Åã„ÅóÈÅãÁî®', url: 'https://www.wealthnavi.com/' },
                    coincheck: { name: 'Coincheck', feature: '„Ç∑„É≥„Éó„É´„Å™UI„Åß‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑ„ÄÇÂàùÂøÉËÄÖÂêë„Åë„ÅÆ‰ªÆÊÉ≥ÈÄöË≤®ÂèñÂºïÊâÄ', url: 'https://coincheck.com/' },
                    au: { name: 'au„Ç´„Éñ„Ç≥„É†Ë®ºÂà∏', feature: 'Ponta„Éù„Ç§„É≥„Éà„ÅåË≤Ø„Åæ„Çã„ÄÇau„É¶„Éº„Ç∂„Éº„Å´„É°„É™„ÉÉ„Éà„ÅÇ„Çä', url: 'https://kabu.com/' }
                };

                // Profile-based Recommendations
                const getBrokers = (pid) => {
                    switch (pid) {
                        case 'guardian': return [brokerPool.wealthnavi, brokerPool.matsui, brokerPool.sbi];
                        case 'custodian': return [brokerPool.wealthnavi, brokerPool.sbi, brokerPool.rakuten];
                        case 'conservative': return [brokerPool.rakuten, brokerPool.sbi, brokerPool.au];
                        case 'architect': return [brokerPool.sbi, brokerPool.rakuten, brokerPool.monex];
                        case 'strategist': return [brokerPool.monex, brokerPool.sbi, brokerPool.rakuten];
                        case 'explorer': return [brokerPool.sbi, brokerPool.monex, brokerPool.rakuten];
                        case 'visionary': return [brokerPool.monex, brokerPool.sbi, brokerPool.coincheck];
                        case 'pioneer': return [brokerPool.coincheck, brokerPool.sbi, brokerPool.monex];
                        default: return [brokerPool.sbi, brokerPool.rakuten, brokerPool.monex];
                    }
                };
                const recommendedBrokers = getBrokers(profile.id);

                return (
                    <div className="min-h-screen bg-obsidian px-8 py-24 overflow-y-auto">
                        <motion.div className="max-w-2xl mx-auto" initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                            <p className="text-dim text-sm tracking-[0.3em] mb-6">STEP 1: DIAGNOSIS COMPLETE</p>
                            <div className="flex items-center gap-4 mb-4">
                                <span className="text-6xl">{profile.icon}</span>
                                <div>
                                    <h2 className="text-4xl font-black">{profile.name}</h2>
                                    <p className="text-2xl text-gold">{getUserTitle(profile, 0)}</p>
                                </div>
                            </div>
                            <p className="text-lg text-platinum/80 mb-4">{profile.description}</p>
                            <p className="text-dim text-xs leading-loose mb-8">Ëá™Â∑±ÂàÜÊûê„Å®ÊäïË≥áÁü•Ë≠ò„ÅÆÂ≠¶Áøí„Çí„ÇÇ„Å®„Å´„ÄÅË≥áÁî£ÈÖçÂàÜ„ÅÆËÄÉ„ÅàÊñπ„ÇíÂ≠¶„Å≥„Åæ„Åô„ÄÇ<br />‚Äª „Åì„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„ÅØÂ≠¶ÁøíÁõÆÁöÑ„ÅÆÂèÇËÄÉÂÄ§„Åß„ÅÇ„Çä„ÄÅÂÆüÈöõ„ÅÆÈÅãÁî®ÁµêÊûú„Çí‰øùË®º„Åô„Çã„ÇÇ„ÅÆ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                            <div className="flex flex-wrap gap-2 mb-8">
                                {profile.traits.map((t, i) => <span key={i} className="text-xs bg-ash border border-white/10 px-3 py-1 rounded-full text-platinum/70">{t}</span>)}
                            </div>
                            <div className="bg-ash/50 border border-white/5 rounded-sm p-6 mb-8">
                                <p className="text-xs text-dim uppercase tracking-wider mb-4">„Ç¢„É≠„Ç±„Éº„Ç∑„Éß„É≥‰æã</p>
                                <div className="flex h-3 rounded-full overflow-hidden mb-4">
                                    <div className="bg-emerald-500" style={{ width: `${profile.allocation.safe}%` }} />
                                    <div className="bg-amber-500" style={{ width: `${profile.allocation.balanced}%` }} />
                                    <div className="bg-rose-500" style={{ width: `${profile.allocation.growth}%` }} />
                                </div>
                                <div className="flex justify-between text-xs text-dim">
                                    <span>üõ°Ô∏è ÂÆâÂÖ® {profile.allocation.safe}%</span>
                                    <span>‚öñÔ∏è „Éê„É©„É≥„Çπ {profile.allocation.balanced}%</span>
                                    <span>üöÄ ÊàêÈï∑ {profile.allocation.growth}%</span>
                                </div>
                            </div>
                            <div className="mb-8">
                                <p className="text-xs text-dim uppercase tracking-wider mb-3">ÂèÇËÄÉ„Éó„É≠„ÉÄ„ÇØ„Éà</p>
                                <div className="flex flex-wrap gap-2">
                                    {profile.recommended.map((r, i) => {
                                        const assetMapping = {
                                            '„Å§„Åø„Åü„Å¶NISA': 1, 'NISA': 1,
                                            'ÂõΩÂÜÖÊ†™Âºè': 2, 'Êó•Êú¨Ê†™': 2,
                                            'Á±≥ÂõΩÊ†™Âºè': 3, '„ÉÜ„ÉÉ„ÇØÊ†™': 3, '„Ç∞„É≠„Éº„ÇπÊ†™': 3, '„Ç§„Éé„Éô„Éº„Ç∑„Éß„É≥Êû†': 3, 'ÂÄãÂà•Ê†™': 3,
                                            'FX': 4,
                                            'ÊäïË≥á‰ø°Ë®ó': 5, 'ÂÖ®‰∏ñÁïåÊ†™Âºè': 5, '„Éê„É©„É≥„Çπ„Éï„Ç°„É≥„Éâ': 5, 'ÂÆà„Çä„ÅÆÊäï‰ø°': 5, 'Êñ∞ËààÂõΩ„Éï„Ç°„É≥„Éâ': 5, '„ÉÜ„Éº„ÉûÂûãÊäï‰ø°': 5, '„Çª„ÇØ„Çø„ÉºETF': 5, '„Çπ„Éû„Éº„Éà„Éô„Éº„Çø': 5,
                                            '‰ªÆÊÉ≥ÈÄöË≤®': 6,
                                            'iDeCo': 7,
                                            'ÂÇµÂà∏': 8, 'ÂõΩÂÜÖÂÇµÂà∏': 8, 'ÂõΩÂÇµ': 8, 'È´òÊ†º‰ªòÁ§æÂÇµ': 8, 'ÂÇµÂà∏„Éï„Ç°„É≥„Éâ': 8,
                                            '„É™„Éº„Éà': 9,
                                            '„Ç≥„É¢„Éá„Ç£„ÉÜ„Ç£': 10,
                                            'ÂÆöÊúüÈ†êÈáë': 8, '„É¨„Éê„É¨„ÉÉ„Ç∏ÂïÜÂìÅ': 6
                                        };
                                        const aid = assetMapping[r] || (Object.keys(assetMapping).find(k => r.includes(k)) ? assetMapping[Object.keys(assetMapping).find(k => r.includes(k))] : null);

                                        return (
                                            <button key={i} onClick={() => {
                                                if (aid) {
                                                    onSelectAsset(aid);
                                                    onNavigate('gallery');
                                                }
                                            }} className={`text-sm px-4 py-2 rounded-sm border transition-all ${aid ? 'bg-gold/10 border-gold/30 text-gold hover:bg-gold hover:text-black cursor-pointer' : 'bg-white/5 border-white/10 text-dim cursor-default'}`}>
                                                {r}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Recommended Brokers Section */}
                            <div className="bg-gradient-to-br from-gold/10 to-amber-500/5 border border-gold/30 rounded-sm p-6 mb-8">
                                <p className="text-xs text-gold uppercase tracking-wider mb-4 font-bold">üè¶ „Åæ„Åö„ÅØ„Åì„Åì„ÅßÂè£Â∫ßÈñãË®≠</p>
                                <p className="text-sm text-platinum/70 mb-4">ÊäïË≥á„ÇíÂßã„ÇÅ„Çã„Å´„ÅØË®ºÂà∏Âè£Â∫ß„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ„ÅîËá™Ë∫´„ÅßÈÅ∏„Çì„ÅßÈñãË®≠„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ</p>
                                <div className="space-y-3">
                                    {recommendedBrokers.map((broker, i) => (
                                        <a key={i} href={broker.url} target="_blank" rel="noopener noreferrer"
                                            className="block bg-ash/50 border border-white/10 rounded-sm p-4 hover:border-gold/50 transition-all group">
                                            <div className="flex items-center justify-between mb-1">
                                                <span className="text-lg font-bold text-platinum group-hover:text-gold transition-colors">{broker.name}</span>
                                                {broker.recommended && <span className="text-[10px] bg-gold text-black px-2 py-0.5 rounded-sm font-bold">ÂèÇËÄÉ</span>}
                                            </div>
                                            <p className="text-sm text-platinum/60">{broker.feature}</p>
                                        </a>
                                    ))}
                                </div>
                                <p className="text-[10px] text-dim mt-3">‚Äª Â§ñÈÉ®„Çµ„Ç§„Éà„Å∏ÈÅ∑Áßª„Åó„Åæ„Åô„ÄÇÂè£Â∫ßÈñãË®≠„ÅØ„Åô„Åπ„Å¶ÁÑ°Êñô„Åß„Åô„ÄÇ</p>
                                <p className="text-[10px] text-dim">‚Äª Êú¨ÊÉÖÂ†±„ÅØÊäïË≥áÂãßË™ò„ÇíÁõÆÁöÑ„Å®„Åó„Åü„ÇÇ„ÅÆ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊúÄÁµÇÁöÑ„Å™ÊäïË≥áÂà§Êñ≠„ÅØ„ÅîËá™Ë∫´„Åß„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ</p>
                            </div>

                            <div className="flex gap-4">
                                <button onClick={startRediagnose} className="btn-sharp px-6 py-4 rounded-sm border-dim text-dim flex-1 font-bold hover:border-gold hover:text-gold transition-all">
                                    „ÇÑ„ÇäÁõ¥„Åô
                                </button>
                                <button onClick={() => onComplete(profile)} className="btn-sharp px-6 py-4 rounded-sm border-gold text-gold flex-[2] text-lg font-bold hover:bg-gold hover:text-black transition-all">
                                    „Éù„Éº„Éà„Éï„Ç©„É™„Ç™„Å´ÂèçÊò†„Åô„Çã
                                </button>
                            </div>
                        </motion.div>
                        <AnimatePresence>
                            {viewingAsset && <AssetDetailModal asset={viewingAsset} onClose={() => setViewingAsset(null)} />}
                        </AnimatePresence>
                    </div>
                );
            }

            // Intro View
            if (showIntro && !existingProfile) {
                return (
                    <div className="min-h-screen bg-obsidian flex flex-col justify-center items-center px-8 relative overflow-hidden">
                        {/* Background ambience */}
                        <div className="absolute inset-0 pointer-events-none">
                            <div className="absolute top-1/4 left-1/4 w-[500px] h-[500px] bg-gold/5 rounded-full blur-[120px] opacity-30" />
                        </div>

                        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="max-w-xl w-full text-center relative z-10">
                            <p className="text-dim text-xs tracking-[0.4em] mb-6 text-gold">START YOUR JOURNEY</p>
                            <h2 className="text-4xl md:text-5xl font-black tracking-tighter text-platinum mb-6">
                                „ÅÇ„Å™„Åü„ÅÆ<span className="text-gold-gradient">ÊäïË≥á„Çø„Ç§„Éó</span>„ÇíË®∫Êñ≠
                            </h2>
                            <p className="text-lg text-platinum/70 leading-relaxed mb-12">
                                Á∞°Âçò„Å™Ë≥™Âïè„Å´Á≠î„Åà„Å¶„ÄÅ<br />„ÅÇ„Å™„Åü„Å´ÊúÄÈÅ©„Å™ÊäïË≥áÊà¶Áï•„ÇíË¶ã„Å§„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ
                            </p>

                            <div className="space-y-4 max-w-sm mx-auto">
                                <button onClick={() => setShowIntro(false)} className="btn-sharp w-full py-4 bg-gold text-black font-bold text-lg rounded-sm hover:bg-amber-400 transition-colors custom-shadow">
                                    Ë®∫Êñ≠„ÇíÂßã„ÇÅ„Çã
                                </button>
                                <p className="text-[10px] text-dim text-center">
                                    ‚Äª Ë®∫Êñ≠ÁµêÊûú„ÅØËá™Â∑±ÂàÜÊûê„ÅÆÂèÇËÄÉ„Å®„Åó„Å¶„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ
                                </p>

                                {isOnboarding && onSkip && (
                                    <button onClick={onSkip} className="text-dim text-xs hover:text-white transition-colors">
                                        „Éõ„Éº„É†„Å∏
                                    </button>
                                )}
                            </div>
                        </motion.div>
                    </div>
                );
            }

            const handleBack = () => {
                if (currentQ > 0) {
                    const prevQ = questions[currentQ - 1];
                    if (prevQ.type === 'slider') {
                        // Restore previous answer if it exists, otherwise use default
                        const prevAnswer = answers[prevQ.id];
                        // Note: handleAnswer might have normalized the value, 
                        // but for sliders we usually want the raw value if possible.
                        // However, current implementation only stores normalized risk scores for some sliders.
                        // For simplicity, we use the default or the last known raw value if we were to track it.
                        // Since we don't track raw value in state yet, we use defaults for now.
                        setSliderValue(prevQ.id === 0 ? 30 : 50);
                    }
                    setCurrentQ(currentQ - 1);
                }
            };

            const q = questions[currentQ];
            const p = ((currentQ + 1) / questions.length) * 100;

            return (
                <div className="min-h-screen bg-obsidian flex flex-col justify-center px-8 py-24">
                    <div className="max-w-2xl mx-auto w-full">
                        <div className="mb-12">
                            <div className="flex justify-between items-center text-dim text-sm mb-2">
                                <div className="flex items-center gap-4">
                                    <span>STEP 1: CALIBRATION</span>
                                    {currentQ > 0 && (
                                        <button onClick={handleBack} className="text-platinum/50 hover:text-gold transition-colors flex items-center gap-1">
                                            <span>‚Üê</span> Êàª„Çã
                                        </button>
                                    )}
                                </div>
                                <span>{currentQ + 1}/{questions.length}</span>
                            </div>
                            <div className="h-px bg-stone"><motion.div className="h-full bg-gold" animate={{ width: `${p}%` }} /></div>
                        </div>
                        <AnimatePresence mode="wait">
                            <motion.div key={q.id} initial={{ opacity: 0, x: 30 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -30 }}>
                                <h2 className="text-3xl font-bold mb-12">{q.question}</h2>
                                {q.type === 'choice' ?
                                    <div className="flex flex-col gap-3">{q.options.map((o, i) => <button key={i} onClick={() => handleAnswer(o.value)} className="btn-sharp text-left px-6 py-5 rounded-sm text-lg hover:bg-ash/50">{o.label}</button>)}</div>
                                    : <div className="space-y-8">
                                        <p className="text-5xl font-bold text-gold text-center">
                                            {(q.id === 4 ? mapFinanceValue(sliderValue) : sliderValue).toLocaleString()}
                                            <span className="text-lg text-dim ml-2">{q.unit}</span>
                                        </p>
                                        <input type="range" min={q.min} max={q.max} step={q.step} value={sliderValue} onChange={e => setSliderValue(Number(e.target.value))} className="w-full h-2 bg-stone rounded-full appearance-none cursor-pointer [&::-webkit-slider-thumb]:bg-gold" />
                                        <button onClick={() => handleAnswer(sliderValue)} className="btn-sharp w-full py-5 border-gold text-gold">Ê±∫ÂÆö</button>
                                    </div>
                                }
                            </motion.div>
                        </AnimatePresence>
                    </div>
                </div>
            );
        };



        // ============================================
        // PERSONALIZED BRIEFING - LUXURY COLLECTION
        // Cards now loaded from external cards.js file
        // Total: 230 cards (200 standard + 30 Pro chart patterns)
        // ============================================
        // briefingCards is loaded from cards.js via window.briefingCards


        // ============================================
        // TINDER-STYLE LEARNING WITH ROADMAPS
        // ============================================
        const assetRoadmaps = {
            'NISA': [
                { id: 'nisa-1', title: 'NISA„ÅÆÂü∫Êú¨„ÇíÁêÜËß£', cards: [4, 87, 103], level: 1 },
                { id: 'nisa-2', title: 'Êñ∞NISA„ÅÆÊ¥ªÁî®', cards: [181, 182, 183], level: 1 },
                { id: 'nisa-3', title: 'Âè£Â∫ßÈñãË®≠„Å®Âà∂Â∫¶Ê¥ªÁî®', cards: [106, 107, 88], level: 2 },
                { id: 'nisa-4', title: 'ÈäòÊüÑÈÅ∏ÂÆö„Å®Á©çÁ´ãË®≠ÂÆö', cards: [108, 109, 110], level: 3 },
                { id: 'nisa-5', title: 'Èï∑ÊúüÈÅãÁî®„ÅÆ„Éû„Ç§„É≥„Éâ', cards: [67, 68, 85], level: 4 }
            ],
            'ÂõΩÂÜÖÊ†™Âºè': [
                { id: 'jp-1', title: 'Ê†™ÂºèÊäïË≥á„ÅÆÂü∫Á§é', cards: [26, 31, 7], level: 1 },
                { id: 'jp-2', title: 'ÈäòÊüÑÂàÜÊûê„ÅÆÂü∫Êú¨', cards: [39, 40, 42], level: 2 },
                { id: 'jp-3', title: 'Â∏ÇÂ†¥„Å®ÊåáÊ®ô', cards: [141, 142, 143], level: 2 },
                { id: 'jp-4', title: 'ÈÖçÂΩì„Å®ÂÑ™ÂæÖ', cards: [38, 45, 117], level: 3 },
                { id: 'jp-5', title: 'Á®éÈáë„Å®Á¢∫ÂÆöÁî≥Âëä', cards: [86, 90, 91], level: 4 }
            ],
            'Á±≥ÂõΩÊ†™Âºè': [
                { id: 'us-1', title: 'Á±≥ÂõΩÂ∏ÇÂ†¥„ÅÆÂü∫Á§é', cards: [32, 254, 26], level: 1 },
                { id: 'us-2', title: '‰∏ªË¶ÅÊåáÊï∞„Å®ÁâπÂæ¥', cards: [33, 144, 258], level: 2 },
                { id: 'us-3', title: 'ÁÇ∫Êõø„Å®Êµ∑Â§ñÊäïË≥á', cards: [29, 112, 93], level: 2 },
                { id: 'us-4', title: 'ÊäïË≥áÊà¶Áï•', cards: [54, 260, 49], level: 3 },
                { id: 'us-5', title: 'ETFÊ¥ªÁî®Ë°ì', cards: [28, 34, 111], level: 4 }
            ],
            'ÊäïË≥á‰ø°Ë®ó': [
                { id: 'fund-1', title: 'Ë§áÂà©„Å®ÂàÜÊï£„ÅÆÂü∫Á§é', cards: [1, 3, 252], level: 1 },
                { id: 'fund-2', title: '„Éï„Ç°„É≥„Éâ„ÅÆÁ®ÆÈ°û', cards: [248, 251, 261], level: 2 },
                { id: 'fund-3', title: '„Éï„Ç°„É≥„Éâ„ÅÆÈÅ∏„Å≥Êñπ', cards: [110, 21, 20], level: 3 },
                { id: 'fund-4', title: 'Á©çÁ´ãÊäïË≥á„ÅÆÂÆüË∑µ', cards: [46, 63, 109], level: 3 },
                { id: 'fund-5', title: 'Èï∑ÊúüÈÅãÁî®„ÅÆ„Éû„Ç§„É≥„Éâ', cards: [67, 77, 85], level: 4 }
            ],
            'ÂÇµÂà∏„ÉªÈáëÂà©': [
                { id: 'bonds-1', title: 'ÂÇµÂà∏„ÅÆÂü∫Á§é', cards: [27, 246, 249], level: 1 },
                { id: 'bonds-2', title: 'ÂÆöÊúüÈ†êÈáë„Å®ÂõΩÂÇµ', cards: [247, 49, 19], level: 1 },
                { id: 'bonds-3', title: 'ÈáëÂà©„Å®„É™„Çπ„ÇØ', cards: [12, 44, 37], level: 2 },
                { id: 'bonds-4', title: 'Á§æÂÇµ„Å®„Éï„Ç°„É≥„Éâ', cards: [250, 253, 48], level: 3 },
                { id: 'bonds-5', title: 'ÂÆüË∑µÁöÑ„Å™ÂÇµÂà∏ÊäïË≥á', cards: [28, 35, 115], level: 4 }
            ],
            '‰∏çÂãïÁî£(REIT)': [
                { id: 'reit-1', title: 'REIT„ÅÆÂü∫Á§é', cards: [35, 257, 19], level: 1 },
                { id: 'reit-2', title: '„É°„É™„ÉÉ„Éà„Å®„É™„Çπ„ÇØ', cards: [7, 60, 61], level: 2 },
                { id: 'reit-3', title: 'ÂàÜÈÖçÈáë„Å®Âà©Âõû„Çä', cards: [38, 46, 126], level: 3 },
                { id: 'reit-4', title: '„Éù„Éº„Éà„Éï„Ç©„É™„Ç™Ê¥ªÁî®', cards: [3, 47, 48], level: 4 }
            ],
            'È´òÂ∫¶„Å™Êà¶Áï•': [
                { id: 'strategy-1', title: '„Çπ„Éû„Éº„Éà„Éô„Éº„Çø', cards: [256, 115, 28], level: 3, isPro: true },
                { id: 'strategy-2', title: '„Çª„ÇØ„Çø„Éº„Éª„ÉÜ„Éº„Éû', cards: [255, 261, 262], level: 3, isPro: true },
                { id: 'strategy-3', title: 'Êñ∞ËààÂõΩÊäïË≥á', cards: [30, 259, 29], level: 4, isPro: true },
                { id: 'strategy-4', title: '„É¨„Éê„É¨„ÉÉ„Ç∏„Å®„É™„Çπ„ÇØ', cards: [265, 49, 16], level: 5, isPro: true }
            ],
            'FX': [
                { id: 'fx-1', title: 'FX„ÅÆÂü∫Á§é', cards: [301, 302, 303], level: 1, isPro: true },
                { id: 'fx-2', title: 'ÂèñÂºï„ÅÆ‰ªïÁµÑ„Åø', cards: [304, 305, 306], level: 2, isPro: true },
                { id: 'fx-3', title: '„É™„Çπ„ÇØÁÆ°ÁêÜ', cards: [307, 308, 60], level: 2, isPro: true },
                { id: 'fx-4', title: 'Áõ∏Â†¥„ÇíÂãï„Åã„ÅôË¶ÅÂõ†', cards: [309, 310, 311], level: 3, isPro: true },
                { id: 'fx-5', title: '„Éà„É¨„Éº„ÉâÊà¶Áï•', cards: [312, 313, 314], level: 4, isPro: true }
            ],
            '‰ªÆÊÉ≥ÈÄöË≤®': [
                { id: 'crypto-1', title: '„Éñ„É≠„ÉÉ„ÇØ„ÉÅ„Çß„Éº„É≥„ÅÆÂü∫Á§é', cards: [351, 352, 353], level: 1, isPro: true },
                { id: 'crypto-2', title: '‰ªïÁµÑ„Åø„ÇíÁêÜËß£„Åô„Çã', cards: [354, 355, 361], level: 2, isPro: true },
                { id: 'crypto-3', title: '‰øùÁÆ°„Å®ÈÄÅÈáë', cards: [356, 364, 362], level: 2, isPro: true },
                { id: 'crypto-4', title: 'DeFi„Å®NFT', cards: [357, 358, 360], level: 3, isPro: true },
                { id: 'crypto-5', title: 'Êú™Êù•„ÅÆÈáëËûç', cards: [359, 365, 264], level: 4, isPro: true }
            ],
            'iDeCo': [
                { id: 'ideco-1', title: 'iDeCo„ÅÆÂü∫Êú¨', cards: [8, 89, 88], level: 1, isPro: true },
                { id: 'ideco-2', title: 'ÊéõÈáë„Å®ÁØÄÁ®éÂäπÊûú', cards: [90, 91, 101], level: 2, isPro: true },
                { id: 'ideco-3', title: 'ÈÅãÁî®ÂïÜÂìÅ„ÅÆÈÅ∏„Å≥Êñπ', cards: [110, 21, 47], level: 3, isPro: true },
                { id: 'ideco-4', title: 'Âá∫Âè£Êà¶Áï•', cards: [50, 118, 105], level: 4, isPro: true }
            ],
            '„ÉÅ„É£„Éº„ÉàÂàÜÊûê': [
                { id: 'chart-1', title: '„É≠„Éº„ÇΩ„ÇØË∂≥„ÅÆË™≠„ÅøÊñπ', cards: [213, 214, 215], level: 1, isPro: true },
                { id: 'chart-2', title: 'ÂèçËª¢„Éë„Çø„Éº„É≥', cards: [201, 203, 204], level: 2, isPro: true },
                { id: 'chart-3', title: 'Á∂ôÁ∂ö„Éë„Çø„Éº„É≥', cards: [207, 211, 212], level: 3, isPro: true },
                { id: 'chart-4', title: '„ÉÜ„ÇØ„Éã„Ç´„É´ÊåáÊ®ô', cards: [219, 220, 222], level: 4, isPro: true },
                { id: 'chart-5', title: '‰∏ÄÁõÆÂùáË°°Ë°®„ÇíÊ•µ„ÇÅ„Çã', cards: [231, 232, 233], level: 5, isPro: true },
                { id: 'chart-6', title: 'Ê≥¢ÂãïË´ñ„Å®„Çµ„Ç§„ÇØ„É´', cards: [234, 243, 236], level: 5, isPro: true },
                { id: 'chart-7', title: 'ÈÖíÁî∞‰∫îÊ≥ï„Å®‰πñÈõ¢', cards: [244, 245, 241], level: 6, isPro: true },
                { id: 'chart-8', title: '„Åù„ÅÆ‰ªñ„ÅÆÈáçË¶Å„Éë„Çø„Éº„É≥', cards: [238, 239, 242], level: 6, isPro: true }
            ]
        };

        // ============================================
        // COURSE BUNDLES (Purchasable Roadmaps)
        // ============================================
        const courseBundles = {
            'index-beginner': {
                id: 'index-beginner',
                title: 'ÊäïË≥áÂàùÂøÉËÄÖ„ÅÆ„Åü„ÇÅ„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊäïË≥á„É≠„Éº„Éâ„Éû„ÉÉ„Éó',
                subtitle: 'Âè£Â∫ßÈñãË®≠„Åã„ÇâÁ©çÁ´ãË®≠ÂÆö„Åæ„ÅßÂÆåÂÖ®„Ç¨„Ç§„Éâ',
                price: 600,
                icon: 'üìà',
                shortTitle: 'INDEXÊäïË≥á',
                description: 'ÊäïË≥áÂàùÂøÉËÄÖÂêë„Åë„ÄÇ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊäïË≥á„ÅÆÂü∫Á§é„ÄÅNISAÊ¥ªÁî®„ÄÅÂè£Â∫ßÈñãË®≠„ÄÅÁ©çÁ´ãË®≠ÂÆö„ÄÅÂá∫Âè£Êà¶Áï•„Åæ„Åß„ÇíÁ∂≤ÁæÖ„Åó„ÅüÂÆåÂÖ®„É≠„Éº„Éâ„Éû„ÉÉ„Éó„ÄÇÂÖ®62Êûö„ÅÆ„Ç´„Éº„Éâ„Åß‰ΩìÁ≥ªÁöÑ„Å´Â≠¶„Åπ„Åæ„Åô„ÄÇ',
                features: [
                    'ÂÖ®62Êûö„ÅÆÂ≠¶Áøí„Ç´„Éº„Éâ',
                    '„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊäïË≥á„ÅÆÂü∫Á§é',
                    'Êñ∞NISAÂÆåÂÖ®ÂØæÂøú',
                    'Âè£Â∫ßÈñãË®≠„Å®Á©çÁ´ãË®≠ÂÆö',
                    '„É™„Çπ„ÇØÁÆ°ÁêÜ„Å®Âá∫Âè£Êà¶Áï•'
                ],
                steps: [
                    {
                        id: 'idx-1',
                        title: 'Step 1: „Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊäïË≥á„ÇíÁü•„Çã',
                        subtitle: 'ÊäïË≥á„ÅÆÂúüÂè∞„ÇíÁØâ„Åè',
                        cards: [5001, 5002, 5003, 5004, 5005, 5006, 5007],
                        level: 1,
                        description: '„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊäïË≥á„ÅÆÊú¨Ë≥™„ÄÅ„Å™„ÅúÈÅ∏„Å∞„Çå„Çã„ÅÆ„Åã„ÄÅ„É°„É™„ÉÉ„Éà„Éª„Éá„É°„É™„ÉÉ„Éà„ÇíÊ∑±„ÅèÁêÜËß£„Åó„Åæ„Åô„ÄÇ'
                    },
                    {
                        id: 'idx-2',
                        title: 'Step 2: „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Éï„Ç°„É≥„Éâ„ÇíÁêÜËß£„Åô„Çã',
                        subtitle: 'ÂïÜÂìÅ„ÅÆ‰ªïÁµÑ„Åø„ÇíÁü•„Çã',
                        cards: [5008, 5009, 5010, 5011, 5012, 5013, 5014],
                        level: 1,
                        description: 'ÊäïË≥á‰ø°Ë®ó„ÅÆ‰ªïÁµÑ„Åø„ÄÅETF„Å®„ÅÆÈÅï„ÅÑ„ÄÅ‰∏ªË¶ÅÊåáÊï∞„ÄÅ„Ç≥„Çπ„ÉàÊØîËºÉ„Å™„Å©ÂïÜÂìÅÈÅ∏„Å≥„ÅÆÂü∫Á§é„ÇíÂ≠¶„Å≥„Åæ„Åô„ÄÇ'
                    },
                    {
                        id: 'idx-3',
                        title: 'Step 3: NISAÂà∂Â∫¶„ÇíÊ¥ªÁî®„Åô„Çã',
                        subtitle: 'Á®éÂà∂ÂÑ™ÈÅá„ÇíÊúÄÂ§ßÂåñ',
                        cards: [5015, 5016, 5017, 5018, 5019, 5020],
                        level: 2,
                        description: 'Êñ∞NISAÂà∂Â∫¶„ÅÆÂÖ®‰ΩìÂÉè„ÄÅ„Å§„Åø„Åü„Å¶ÊäïË≥áÊû†„Å®ÊàêÈï∑ÊäïË≥áÊû†„ÄÅiDeCo„Å®„ÅÆ‰Ωø„ÅÑÂàÜ„Åë„ÇíÂ≠¶„Å≥„Åæ„Åô„ÄÇ'
                    },
                    {
                        id: 'idx-4',
                        title: 'Step 4: Ë®ºÂà∏Âè£Â∫ß„ÇíÈñãË®≠„Åô„Çã',
                        subtitle: 'ÂÆüÈöõ„Å´„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíËµ∑„Åì„Åô',
                        cards: [5021, 5022, 5023, 5024, 5025, 5026],
                        level: 2,
                        description: '„Éç„ÉÉ„ÉàË®ºÂà∏„ÅÆ„É°„É™„ÉÉ„Éà„ÄÅÂè£Â∫ßÈñãË®≠ÊâãÈ†Ü„ÄÅÁâπÂÆöÂè£Â∫ß„Å®NISAÂè£Â∫ß„ÅÆÈÅï„ÅÑ„ÇíËß£Ë™¨„Åó„Åæ„Åô„ÄÇ'
                    },
                    {
                        id: 'idx-5',
                        title: 'Step 5: „Éï„Ç°„É≥„Éâ„ÇíÈÅ∏„Çì„ÅßÁ©çÁ´ãË®≠ÂÆö',
                        subtitle: 'Ëá™ÂãïÂåñ„ÅßÁ∂ôÁ∂ö„Åô„Çã‰ªïÁµÑ„Åø',
                        cards: [5027, 5028, 5029, 5030, 5031, 5032, 5033],
                        level: 3,
                        description: '‰∫∫Ê∞ó„Éï„Ç°„É≥„Éâ„ÅÆÊØîËºÉ„ÄÅÁ©çÁ´ãÈáëÈ°ç„ÅÆÊ±∫„ÇÅÊñπ„ÄÅ„Éâ„É´„Ç≥„Çπ„ÉàÂπ≥ÂùáÊ≥ï„ÅÆÂäπÊûú„ÇíÂ≠¶„Å≥„Åæ„Åô„ÄÇ'
                    },
                    {
                        id: 'idx-6',
                        title: 'Step 6: ÈÅãÁî®„ÇíÁ∂ôÁ∂ö„Åô„Çã',
                        subtitle: 'Êö¥ËêΩ„Åó„Å¶„ÇÇÊÖå„Å¶„Å™„ÅÑ',
                        cards: [5034, 5035, 5036, 5037, 5038],
                        level: 3,
                        description: 'ÈÅãÁî®Áä∂Ê≥Å„ÅÆÁ¢∫Ë™çÈ†ªÂ∫¶„ÄÅÊö¥ËêΩÊôÇ„ÅÆÂøÉÊßã„Åà„ÄÅÊäïË≥á„ÇíÁ∂ö„Åë„Çã„Ç≥„ÉÑ„ÇíË∫´„Å´„Å§„Åë„Åæ„Åô„ÄÇ'
                    },
                    {
                        id: 'idx-7',
                        title: 'Step 7: Âá∫Âè£Êà¶Áï•„ÇíËÄÉ„Åà„Çã',
                        subtitle: 'Ë≥áÁî£„ÅÆ‰Ωø„ÅÑÊñπ„ÇíË®àÁîª',
                        cards: [5039, 5040, 5041, 5042],
                        level: 4,
                        description: 'Âèñ„ÇäÂ¥©„Åó„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„ÄÅ4%„É´„Éº„É´„ÄÅÊ¨°‰∏ñ‰ª£„Å∏„ÅÆË≥áÁî£ÊâøÁ∂ô„ÇíÂ≠¶„Å≥„Åæ„Åô„ÄÇ'
                    }
                ],
                totalCards: 62,
                estimatedTime: 'Á¥Ñ5ÊôÇÈñì',
                targetAudience: 'ÊäïË≥áÊú™ÁµåÈ®ìËÄÖ„ÄúÂàùÂøÉËÄÖ'
            },
            'crypto-beginner': {
                id: 'crypto-beginner',
                title: '‰ªÆÊÉ≥ÈÄöË≤®„Éª„Éñ„É≠„ÉÉ„ÇØ„ÉÅ„Çß„Éº„É≥ÂÆåÂÖ®ÂÖ•ÈñÄ„É≠„Éº„Éâ„Éû„ÉÉ„Éó',
                subtitle: '„Éì„ÉÉ„Éà„Ç≥„Ç§„É≥„Åã„ÇâDeFi„ÉªNFT„Åæ„Åß‰ΩìÁ≥ªÁöÑ„Å´Â≠¶„Å∂',
                price: 800,
                icon: '‚Çø',
                shortTitle: '‰ªÆÊÉ≥ÈÄöË≤®',
                description: '‰ªÆÊÉ≥ÈÄöË≤®„ÅÆÂü∫Á§é„Åã„ÇâDeFi„ÄÅNFT„ÄÅ„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Åæ„Åß„ÄÇÂÖ®50Êûö„ÅÆ„Ç´„Éº„Éâ„ÅßÊöóÂè∑Ë≥áÁî£„ÅÆ‰∏ñÁïå„Çí‰ΩìÁ≥ªÁöÑ„Å´Â≠¶„Åπ„Åæ„Åô„ÄÇ',
                features: [
                    'ÂÖ®50Êûö„ÅÆÂ≠¶Áøí„Ç´„Éº„Éâ',
                    '„Éñ„É≠„ÉÉ„ÇØ„ÉÅ„Çß„Éº„É≥„ÅÆÂü∫Á§é',
                    '„Éì„ÉÉ„Éà„Ç≥„Ç§„É≥„Éª„Ç§„Éº„Çµ„É™„Ç¢„É†',
                    'DeFi„ÉªNFT„ÅÆÁêÜËß£',
                    '„Ç¶„Ç©„É¨„ÉÉ„ÉàÁÆ°ÁêÜ„Å®„Çª„Ç≠„É•„É™„ÉÜ„Ç£'
                ],
                steps: [
                    {
                        id: 'cry-1',
                        title: 'Step 1: „Éñ„É≠„ÉÉ„ÇØ„ÉÅ„Çß„Éº„É≥„ÇíÁêÜËß£„Åô„Çã',
                        subtitle: 'ÊäÄË°ì„ÅÆÂü∫Á§é„ÇíÂ≠¶„Å∂',
                        cards: [6001, 6002, 6003, 6004, 6005, 6006],
                        level: 1,
                        description: '„Éñ„É≠„ÉÉ„ÇØ„ÉÅ„Çß„Éº„É≥„ÅÆ‰ªïÁµÑ„Åø„ÄÅÂàÜÊï£ÂûãÂè∞Â∏≥„ÄÅ„Ç≥„É≥„Çª„É≥„Çµ„Çπ„Ç¢„É´„Ç¥„É™„Ç∫„É†„ÇíÁêÜËß£„Åó„Åæ„Åô„ÄÇ'
                    },
                    {
                        id: 'cry-2',
                        title: 'Step 2: „Éì„ÉÉ„Éà„Ç≥„Ç§„É≥„ÇíÁü•„Çã',
                        subtitle: 'ÊúÄÂàù„ÅÆÊöóÂè∑Ë≥áÁî£',
                        cards: [6007, 6008, 6009, 6010, 6011, 6012],
                        level: 1,
                        description: '„Éì„ÉÉ„Éà„Ç≥„Ç§„É≥„ÅÆÊ≠¥Âè≤„ÄÅÁâπÂæ¥„ÄÅÂçäÊ∏õÊúü„ÄÅ„Éû„Ç§„Éã„É≥„Ç∞„ÅÆ‰ªïÁµÑ„Åø„ÇíÂ≠¶„Å≥„Åæ„Åô„ÄÇ'
                    },
                    {
                        id: 'cry-3',
                        title: 'Step 3: „Ç§„Éº„Çµ„É™„Ç¢„É†„Å®„Çπ„Éû„Éº„Éà„Ç≥„É≥„Éà„É©„ÇØ„Éà',
                        subtitle: '„Éó„É≠„Ç∞„É©„É†ÂèØËÉΩ„Å™„Éñ„É≠„ÉÉ„ÇØ„ÉÅ„Çß„Éº„É≥',
                        cards: [6013, 6014, 6015, 6016, 6017],
                        level: 2,
                        description: '„Ç§„Éº„Çµ„É™„Ç¢„É†„ÅÆÁâπÂæ¥„ÄÅ„Çπ„Éû„Éº„Éà„Ç≥„É≥„Éà„É©„ÇØ„Éà„ÄÅ„Ç¨„Çπ‰ª£„ÅÆ‰ªïÁµÑ„Åø„ÇíÂ≠¶„Å≥„Åæ„Åô„ÄÇ'
                    },
                    {
                        id: 'cry-4',
                        title: 'Step 4: „Ç¢„É´„Éà„Ç≥„Ç§„É≥„ÅÆ‰∏ñÁïå',
                        subtitle: 'Â§öÊßò„Å™ÊöóÂè∑Ë≥áÁî£„ÇíÁü•„Çã',
                        cards: [6018, 6019, 6020, 6021, 6022],
                        level: 2,
                        description: '‰∏ªË¶Å„Å™„Ç¢„É´„Éà„Ç≥„Ç§„É≥„ÄÅ„Çπ„ÉÜ„Éº„Éñ„É´„Ç≥„Ç§„É≥„ÄÅ„É¨„Ç§„É§„Éº2„ÇΩ„É™„É•„Éº„Ç∑„Éß„É≥„ÇíÁ¥π‰ªã„Åó„Åæ„Åô„ÄÇ'
                    },
                    {
                        id: 'cry-5',
                        title: 'Step 5: „Ç¶„Ç©„É¨„ÉÉ„Éà„Å®ÂèñÂºïÊâÄ',
                        subtitle: 'Ë≥áÁî£„ÇíÁÆ°ÁêÜ„Åô„Çã',
                        cards: [6023, 6024, 6025, 6026, 6027, 6028],
                        level: 2,
                        description: '„Éõ„ÉÉ„Éà„Ç¶„Ç©„É¨„ÉÉ„Éà„ÄÅ„Ç≥„Éº„É´„Éâ„Ç¶„Ç©„É¨„ÉÉ„Éà„ÄÅÂèñÂºïÊâÄ„ÅÆ‰Ωø„ÅÑÊñπ„ÇíÂ≠¶„Å≥„Åæ„Åô„ÄÇ'
                    },
                    {
                        id: 'cry-6',
                        title: 'Step 6: DeFiÔºàÂàÜÊï£ÂûãÈáëËûçÔºâÂÖ•ÈñÄ',
                        subtitle: 'ÈäÄË°å„Å™„Åó„ÅÆÈáëËûç',
                        cards: [6029, 6030, 6031, 6032, 6033, 6034],
                        level: 3,
                        description: 'DEX„ÄÅ„É¨„É≥„Éá„Ç£„É≥„Ç∞„ÄÅ„Ç§„Éº„É´„Éâ„Éï„Ç°„Éº„Éü„É≥„Ç∞„ÄÅÊµÅÂãïÊÄßÊèê‰æõ„ÇíÂ≠¶„Å≥„Åæ„Åô„ÄÇ'
                    },
                    {
                        id: 'cry-7',
                        title: 'Step 7: NFT„Å®„Éá„Ç∏„Çø„É´Ë≥áÁî£',
                        subtitle: 'ÂîØ‰∏ÄÁÑ°‰∫å„ÅÆ„Éà„Éº„ÇØ„É≥',
                        cards: [6035, 6036, 6037, 6038, 6039],
                        level: 3,
                        description: 'NFT„ÅÆ‰ªïÁµÑ„Åø„ÄÅÊ¥ªÁî®‰∫ã‰æã„ÄÅ„Éû„Éº„Ç±„ÉÉ„Éà„Éó„É¨„Ç§„Çπ„ÇíÂ≠¶„Å≥„Åæ„Åô„ÄÇ'
                    },
                    {
                        id: 'cry-8',
                        title: 'Step 8: „Çª„Ç≠„É•„É™„ÉÜ„Ç£„Å®Ë©êÊ¨∫ÂØæÁ≠ñ',
                        subtitle: 'Ë≥áÁî£„ÇíÂÆà„Çã',
                        cards: [6040, 6041, 6042, 6043, 6044, 6045],
                        level: 2,
                        description: '„Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÅÆÂü∫Êú¨„ÄÅË©êÊ¨∫„ÅÆÊâãÂè£„ÄÅËá™Â∑±ÁÆ°ÁêÜ„ÅÆÈáçË¶ÅÊÄß„ÇíÂ≠¶„Å≥„Åæ„Åô„ÄÇ'
                    },
                    {
                        id: 'cry-9',
                        title: 'Step 9: Á®éÈáë„ÉªË¶èÂà∂„ÉªÊú™Êù•',
                        subtitle: '„É´„Éº„É´„ÇíÁü•„ÇäÊú™Êù•„ÇíË¶ãÊçÆ„Åà„Çã',
                        cards: [6046, 6047, 6048, 6049, 6050],
                        level: 3,
                        description: 'Êó•Êú¨„ÅÆÁ®éÂà∂„ÄÅË¶èÂà∂ÂãïÂêë„ÄÅWeb3.0„ÅÆÊú™Êù•„Å´„Å§„ÅÑ„Å¶Â≠¶„Å≥„Åæ„Åô„ÄÇ'
                    }
                ],
                totalCards: 50,
                estimatedTime: 'Á¥Ñ4ÊôÇÈñì',
                targetAudience: '‰ªÆÊÉ≥ÈÄöË≤®ÂàùÂøÉËÄÖ„Äú‰∏≠Á¥öËÄÖ'
            }
        };


        const TheBriefing = ({ onNavigate, userProfile, userGoals, onProgressUpdate, userPlan, onUpgrade, understoodCards, setUnderstoodCards, unclearCards, setUnclearCards, purchasedBundles, onPurchaseBundle, freeLimit, nextReplenishTime, onUpdateLimits, dailyCompleted, onUpdateDailyCompleted }) => {
            const [viewMode, setViewMode] = useState('swipe'); // 'swipe', 'roadmap', 'subscription', 'roadmap-purchase'
            const [purchaseTargetRoadmap, setPurchaseTargetRoadmap] = useState(null);
            const [currentCardIndex, setCurrentCardIndex] = useState(0);
            // understoodCards and unclearCards now come from props (App level) for persistence
            // dailyCompleted now comes from props (App level) for persistence and daily reset
            const [selectedRoadmap, setSelectedRoadmap] = useState(null);
            const [swipeDir, setSwipeDir] = useState(null);
            const [userLevel, setUserLevel] = useState(1);
            // userPlan is now a prop, setSubscriptionPlan removed
            const [activeRoadmapFilter, setActiveRoadmapFilter] = useState(null); // Pro feature: filter cards to specific roadmap
            const [sessionSkippedCards, setSessionSkippedCards] = useState(new Set()); // Cards left-swiped this session (hidden until reload)

            const basicLimit = 360; // Updated to match actual card count
            const hasFullAccess = userPlan === 'annual' || userPlan === 'lifetime';
            const isLifetime = userPlan === 'lifetime';
            const hasRoadmapAccess = (name) => hasFullAccess || purchasedBundles.includes(name);
            const hasBundleAccess = (bundleId) => isLifetime || purchasedBundles.includes(bundleId);
            const DAILY_REPLENISH_AMOUNT = 5;
            const REPLENISH_INTERVAL = 24 * 60 * 60 * 1000; // 24 hours

            // Free-tier roadmap trial: steps 1-2 of NISA and ÂõΩÂÜÖÊ†™Âºè are free
            const FREE_TRIAL_ROADMAPS = { 'NISA': 2, 'ÂõΩÂÜÖÊ†™Âºè': 2 }; // roadmap name -> free step count
            const freeTrialCardIds = useMemo(() => {
                const ids = new Set();
                Object.entries(FREE_TRIAL_ROADMAPS).forEach(([name, freeSteps]) => {
                    const roadmap = assetRoadmaps[name];
                    if (roadmap) {
                        roadmap.slice(0, freeSteps).forEach(step => {
                            step.cards.forEach(cardId => ids.add(cardId));
                        });
                    }
                });
                return ids;
            }, []);

            // Safe reference to cards - prevents ReferenceError if cards.js not loaded
            const allCards = useMemo(() => {
                const briefing = Array.isArray(window.briefingCards) ? window.briefingCards : [];
                const indexBundle = Array.isArray(window.indexBundleCards) ? window.indexBundleCards : [];
                const cryptoBundle = Array.isArray(window.cryptoBundleCards) ? window.cryptoBundleCards : [];
                return [...briefing, ...indexBundle, ...cryptoBundle];
            }, []);

            // Get all card IDs from purchased bundles + free trial (for unlimited access)
            const purchasedBundleCardIds = useMemo(() => {
                const ids = new Set(freeTrialCardIds); // Always include free trial cards
                if (!purchasedBundles || purchasedBundles.length === 0) return ids;
                purchasedBundles.forEach(bundleId => {
                    // Check courseBundles (e.g. 'index', 'crypto')
                    const bundle = courseBundles[bundleId];
                    if (bundle) {
                        bundle.steps.forEach(step => {
                            step.cards.forEach(cardId => ids.add(cardId));
                        });
                    }

                    // Check assetRoadmaps (e.g. 'NISA', 'ÂõΩÂÜÖÊ†™Âºè') - NEW FIX
                    const roadmap = assetRoadmaps[bundleId];
                    if (roadmap && Array.isArray(roadmap)) {
                        roadmap.forEach(step => {
                            step.cards.forEach(cardId => ids.add(cardId));
                        });
                    }
                });
                return ids;
            }, [purchasedBundles, freeTrialCardIds]);

            const proCards = useMemo(() => allCards.filter(c => c.isPro), [allCards]);
            const basicCards = useMemo(() => allCards.filter(c => !c.isPro), [allCards]);


            // Replenish Logic
            const [now, setNow] = useState(Date.now());

            // Timer for real-time countdown
            useEffect(() => {
                const timer = setInterval(() => setNow(Date.now()), 1000);
                return () => clearInterval(timer);
            }, []);

            // Replenish Logic - synced with 'now'
            // Replenish Logic - synced with 'now'
            useEffect(() => {
                if (nextReplenishTime && now >= nextReplenishTime) {
                    onUpdateLimits({ freeLimit: freeLimit + DAILY_REPLENISH_AMOUNT, nextReplenishTime: null });
                }
            }, [now, nextReplenishTime]);

            // Trigger limit timer when reached
            // Trigger limit timer when reached
            useEffect(() => {
                const totalCardsViewed = understoodCards.length + unclearCards.length;
                if (userPlan === 'free' && totalCardsViewed >= freeLimit && !nextReplenishTime) {
                    onUpdateLimits({ nextReplenishTime: Date.now() + REPLENISH_INTERVAL });
                }
            }, [understoodCards, unclearCards, freeLimit, userPlan, nextReplenishTime]);

            // Chart Pattern SVG Helper Component
            const ChartPatternSVG = ({ pattern }) => {
                const patterns = {
                    head_and_shoulders: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,50 20,40 30,25 40,40 55,15 70,40 80,25 90,40 115,50" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <line x1="20" y1="40" x2="90" y2="40" stroke="#DAA520" strokeWidth="1" strokeDasharray="3,3" opacity="0.5" />
                            <text x="55" y="8" fill="#DAA520" fontSize="6" textAnchor="middle">H</text>
                            <text x="30" y="20" fill="#888" fontSize="5" textAnchor="middle">S</text>
                            <text x="80" y="20" fill="#888" fontSize="5" textAnchor="middle">S</text>
                        </svg>
                    ),
                    double_top: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,50 25,20 45,40 65,20 85,50 115,55" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <line x1="25" y1="20" x2="65" y2="20" stroke="#DAA520" strokeWidth="1" strokeDasharray="2,2" opacity="0.5" />
                        </svg>
                    ),
                    double_bottom: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,10 25,50 45,25 65,50 85,10 115,5" fill="none" stroke="#10B981" strokeWidth="2" />
                            <line x1="25" y1="50" x2="65" y2="50" stroke="#10B981" strokeWidth="1" strokeDasharray="2,2" opacity="0.5" />
                        </svg>
                    ),
                    golden_cross: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,50 30,45 50,35 70,25 90,18 115,10" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <polyline points="5,40 30,42 50,40 70,35 90,28 115,20" fill="none" stroke="#888" strokeWidth="1.5" strokeDasharray="4,2" />
                            <circle cx="60" cy="37" r="4" fill="#DAA520" opacity="0.8" />
                            <text x="60" y="52" fill="#DAA520" fontSize="6" textAnchor="middle">GC</text>
                        </svg>
                    ),
                    dead_cross: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,10 30,18 50,30 70,40 90,48 115,55" fill="none" stroke="#F43F5E" strokeWidth="2" />
                            <polyline points="5,20 30,22 50,28 70,35 90,42 115,48" fill="none" stroke="#888" strokeWidth="1.5" strokeDasharray="4,2" />
                            <circle cx="55" cy="30" r="4" fill="#F43F5E" opacity="0.8" />
                            <text x="55" y="45" fill="#F43F5E" fontSize="6" textAnchor="middle">DC</text>
                        </svg>
                    ),
                    symmetrical_triangle: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,15 25,45 45,20 65,40 85,28 100,35 115,10" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <line x1="5" y1="15" x2="85" y2="35" stroke="#888" strokeWidth="1" strokeDasharray="2,2" opacity="0.5" />
                            <line x1="25" y1="45" x2="85" y2="28" stroke="#888" strokeWidth="1" strokeDasharray="2,2" opacity="0.5" />
                        </svg>
                    ),
                    doji: (
                        <svg viewBox="0 0 60 60" className="w-16 h-16 mx-auto">
                            <line x1="30" y1="10" x2="30" y2="50" stroke="#DAA520" strokeWidth="1.5" />
                            <line x1="22" y1="30" x2="38" y2="30" stroke="#DAA520" strokeWidth="3" />
                        </svg>
                    ),
                    hammer: (
                        <svg viewBox="0 0 60 60" className="w-16 h-16 mx-auto">
                            <line x1="30" y1="20" x2="30" y2="50" stroke="#DAA520" strokeWidth="1.5" />
                            <rect x="24" y="12" width="12" height="10" fill="#10B981" stroke="#10B981" />
                        </svg>
                    ),
                    engulfing: (
                        <svg viewBox="0 0 80 60" className="w-20 h-16 mx-auto">
                            <rect x="20" y="25" width="10" height="15" fill="#F43F5E" />
                            <rect x="40" y="15" width="15" height="30" fill="#10B981" />
                        </svg>
                    ),
                    bollinger_bands: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <path d="M5,30 Q30,10 60,30 T115,30" fill="none" stroke="#888" strokeWidth="1" strokeDasharray="2,2" />
                            <path d="M5,40 Q30,35 60,40 T115,40" fill="none" stroke="#DAA520" strokeWidth="1.5" />
                            <path d="M5,50 Q30,55 60,50 T115,50" fill="none" stroke="#888" strokeWidth="1" strokeDasharray="2,2" />
                            <polyline points="10,42 30,38 50,45 70,35 90,42 110,38" fill="none" stroke="#10B981" strokeWidth="1.5" />
                        </svg>
                    ),
                    rsi: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <rect x="5" y="5" width="110" height="50" fill="none" stroke="#333" strokeWidth="0.5" />
                            <line x1="5" y1="15" x2="115" y2="15" stroke="#F43F5E" strokeWidth="0.5" strokeDasharray="2,2" opacity="0.5" />
                            <line x1="5" y1="45" x2="115" y2="45" stroke="#10B981" strokeWidth="0.5" strokeDasharray="2,2" opacity="0.5" />
                            <polyline points="10,35 25,28 40,38 55,22 70,30 85,12 100,25 110,32" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <text x="5" y="12" fill="#F43F5E" fontSize="6">70</text>
                            <text x="5" y="50" fill="#10B981" fontSize="6">30</text>
                        </svg>
                    ),
                    macd: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <line x1="5" y1="35" x2="115" y2="35" stroke="#333" strokeWidth="0.5" />
                            <polyline points="10,40 30,32 50,38 70,28 90,35 110,25" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <polyline points="10,42 30,38 50,40 70,33 90,38 110,30" fill="none" stroke="#F43F5E" strokeWidth="1.5" strokeDasharray="3,2" />
                            {[15, 25, 35, 45, 55, 65, 75, 85, 95, 105].map((x, i) => (
                                <rect key={i} x={x} y={35 - (i % 2 === 0 ? 5 : -2)} width="3" height={Math.abs((i % 2 === 0 ? 5 : -2))} fill={i % 2 === 0 ? "#10B981" : "#F43F5E"} opacity="0.5" />
                            ))}
                        </svg>
                    ),
                    moving_average: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,45 20,38 35,42 50,35 65,40 80,30 95,35 110,25" fill="none" stroke="#888" strokeWidth="1" />
                            <polyline points="5,50 30,42 55,45 80,38 110,30" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <polyline points="5,52 40,48 75,45 110,38" fill="none" stroke="#10B981" strokeWidth="1.5" strokeDasharray="4,2" />
                        </svg>
                    ),
                    candlestick_basics: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <g>
                                <line x1="20" y1="12" x2="20" y2="50" stroke="#10B981" strokeWidth="1" />
                                <rect x="15" y="20" width="10" height="20" fill="#10B981" />
                            </g>
                            <g>
                                <line x1="50" y1="8" x2="50" y2="45" stroke="#F43F5E" strokeWidth="1" />
                                <rect x="45" y="15" width="10" height="22" fill="#F43F5E" />
                            </g>
                            <g>
                                <line x1="80" y1="18" x2="80" y2="55" stroke="#10B981" strokeWidth="1" />
                                <rect x="75" y="25" width="10" height="18" fill="#10B981" />
                            </g>
                            <g>
                                <line x1="105" y1="5" x2="105" y2="40" stroke="#F43F5E" strokeWidth="1" />
                                <rect x="100" y="10" width="10" height="25" fill="#F43F5E" />
                            </g>
                        </svg>
                    ),
                    ichimoku_base: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            {/* Cloud */}
                            <path d="M10,40 Q40,30 60,35 Q90,30 115,25 L115,35 Q90,40 60,45 Q40,40 10,50 Z" fill="#10B981" opacity="0.2" />
                            {/* Conversion Line (Tenkan) */}
                            <polyline points="10,45 30,35 60,40 90,20 115,15" fill="none" stroke="#3B82F6" strokeWidth="1.5" />
                            {/* Base Line (Kijun) */}
                            <polyline points="10,48 40,40 70,38 100,25 115,22" fill="none" stroke="#EF4444" strokeWidth="1.5" />
                        </svg>
                    ),
                    ichimoku_cloud_break: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <path d="M10,35 Q60,30 115,25 L115,45 Q60,50 10,55 Z" fill="#10B981" opacity="0.2" />
                            <polyline points="10,50 40,45 60,20 80,15 115,10" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <circle cx="60" cy="20" r="3" fill="#DAA520" />
                        </svg>
                    ),
                    sanyaku_kouten: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <defs>
                                <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
                                    <path d="M0,0 L0,6 L9,3 z" fill="#DAA520" />
                                </marker>
                            </defs>
                            <path d="M10,40 Q60,35 115,30 L115,50 Q60,55 10,60 Z" fill="#10B981" opacity="0.1" />
                            <polyline points="10,55 40,45 60,25 90,15 115,10" fill="none" stroke="#DAA520" strokeWidth="2" markerEnd="url(#arrow)" />
                            <text x="60" y="20" fill="#DAA520" fontSize="8" fontWeight="bold" textAnchor="middle">BUY!</text>
                        </svg>
                    ),
                    elliott_wave_impulse: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,50 25,30 40,40 70,10 90,25 115,5" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <text x="25" y="25" fill="#888" fontSize="6">1</text>
                            <text x="40" y="48" fill="#888" fontSize="6">2</text>
                            <text x="70" y="5" fill="#888" fontSize="6">3</text>
                            <text x="90" y="32" fill="#888" fontSize="6">4</text>
                            <text x="115" y="15" fill="#888" fontSize="6">5</text>
                        </svg>
                    ),
                    stochastic: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <rect x="5" y="10" width="110" height="40" fill="none" stroke="#333" strokeWidth="0.5" />
                            <line x1="5" y1="15" x2="115" y2="15" stroke="#F43F5E" strokeDasharray="2,2" opacity="0.5" />
                            <line x1="5" y1="45" x2="115" y2="45" stroke="#10B981" strokeDasharray="2,2" opacity="0.5" />
                            <path d="M5,40 Q30,50 50,20 Q80,10 115,30" fill="none" stroke="#DAA520" strokeWidth="1.5" />
                            <path d="M5,45 Q30,55 55,25 Q80,15 115,35" fill="none" stroke="#F43F5E" strokeWidth="1" strokeDasharray="3,2" />
                        </svg>
                    ),
                    parabolic: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <path d="M5,50 Q60,10 115,40" fill="none" stroke="#888" strokeWidth="1" opacity="0.5" />
                            {[10, 20, 30, 40, 50].map((x, i) => (
                                <circle key={i} cx={x} cy={55 - i * 8} r="1.5" fill="#10B981" />
                            ))}
                            {[60, 70, 80, 90, 100, 110].map((x, i) => (
                                <circle key={i + 5} cx={x} cy={20 + i * 5} r="1.5" fill="#F43F5E" />
                            ))}
                        </svg>
                    ),
                    v_bottom: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="10,10 60,50 110,10" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <circle cx="60" cy="50" r="3" fill="#DAA520" />
                        </svg>
                    ),
                    rounding_bottom: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <path d="M10,10 C10,10 20,50 60,50 C100,50 110,10 110,10" fill="none" stroke="#DAA520" strokeWidth="2" />
                        </svg>
                    ),
                    diamond_top: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polygon points="10,30 60,10 110,30 60,50" fill="rgba(218,165,32,0.1)" stroke="#DAA520" strokeWidth="1.5" />
                            <polyline points="20,40 40,20 60,40 80,20 100,40" fill="none" stroke="#888" strokeWidth="1" opacity="0.6" />
                        </svg>
                    ),
                    rectangle: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <rect x="10" y="15" width="100" height="30" fill="rgba(255,255,255,0.05)" stroke="#DAA520" strokeWidth="1" strokeDasharray="3,3" />
                            <polyline points="10,30 30,15 50,45 70,15 90,45 110,30" fill="none" stroke="#888" strokeWidth="1.5" />
                        </svg>
                    ),
                    divergence: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <line x1="10" y1="25" x2="110" y2="15" stroke="#DAA520" strokeWidth="1.5" markerEnd="url(#arrow)" />
                            <line x1="10" y1="45" x2="110" y2="55" stroke="#F43F5E" strokeWidth="1.5" markerEnd="url(#arrow)" />
                            <text x="60" y="35" fill="#888" fontSize="8" textAnchor="middle">DIVERGENCE</text>
                        </svg>
                    ),
                };
                return patterns[pattern] || (
                    <svg viewBox="0 0 120 60" className="w-full h-20">
                        <polyline points="5,50 30,35 55,45 80,25 105,30 115,15" fill="none" stroke="#DAA520" strokeWidth="2" />
                    </svg>
                );
            };

            const dailyGoal = 5;
            const cardRef = useRef(null);

            // Sync progress with parent
            useEffect(() => {
                if (onProgressUpdate) onProgressUpdate(understoodCards.length);
            }, [understoodCards, onProgressUpdate]);

            // Check if paywall should be shown (not for roadmap viewing or purchased bundle cards)
            const totalCardsViewed = understoodCards.length + unclearCards.length;
            const cardLimit = userPlan === 'free' ? freeLimit : allCards.length;

            // Check if currently viewing bundle cards (unlimited access for purchased bundles)
            const isViewingBundleCards = useMemo(() => {
                if (!activeRoadmapFilter || activeRoadmapFilter.length === 0) return false;
                return activeRoadmapFilter.some(cardId => purchasedBundleCardIds.has(cardId));
            }, [activeRoadmapFilter, purchasedBundleCardIds]);

            // Don't show paywall if viewing purchased bundle cards
            const shouldShowPaywall = userPlan === 'free' && totalCardsViewed >= freeLimit && viewMode === 'swipe' && !isViewingBundleCards;
            const isPro = hasFullAccess;


            // Randomized order for Today's Learning (shuffled once per session/load)
            const shuffledCardIds = useMemo(() => {
                return allCards.map(c => c.id).sort(() => Math.random() - 0.5);
            }, [allCards]);

            // Personalize cards based on profile and understanding
            const getPersonalizedCards = () => {
                // Include all cards for paid users, basic only for free
                const accessibleCards = hasFullAccess ? allCards : basicCards;

                // If filtering by roadmap (Pro feature)
                if (activeRoadmapFilter && activeRoadmapFilter.length > 0) {
                    // Start roadmap mode: Return ALL cards in the roadmap, regardless of 'understood' status
                    // This creates a continuous flow (1->2->3)
                    const roadmapCards = accessibleCards.filter(c => activeRoadmapFilter.includes(c.id));
                    // Sort based on the order in activeRoadmapFilter to match roadmap steps
                    return roadmapCards.sort((a, b) => activeRoadmapFilter.indexOf(a.id) - activeRoadmapFilter.indexOf(b.id));
                }

                // Today's Learning Mode (Random Order)
                // Filter cards based on user plan and roadmap access

                // Identify basic cards (from briefingCards)
                const basicCardIds = (window.briefingCards || []).map(c => c.id);

                // Get card IDs from non-Pro roadmaps (NISA~‰∏çÂãïÁî£)
                const nonProRoadmapCardIds = new Set();
                Object.entries(assetRoadmaps).forEach(([name, steps]) => {
                    const isProRM = steps.some(s => s.isPro);
                    if (!isProRM) {
                        steps.forEach(step => step.cards.forEach(id => nonProRoadmapCardIds.add(id)));
                    }
                });

                // Check if card is from premium bundles (index, crypto)
                const isPremiumBundleCard = (id) => {
                    return (window.indexBundleCards || []).some(c => c.id === id) ||
                        (window.cryptoBundleCards || []).some(c => c.id === id);
                };

                // Plan-based card filtering
                let cards = accessibleCards.filter(c => {
                    if (userPlan === 'free') {
                        // Free: only cards from non-Pro roadmaps (NISA~‰∏çÂãïÁî£), no bundles
                        if (!basicCardIds.includes(c.id)) return false;
                        return nonProRoadmapCardIds.has(c.id);
                    } else if (userPlan === 'annual') {
                        // Annual: all briefing cards (non-Pro + Pro roadmaps), no bundles
                        if (isPremiumBundleCard(c.id)) return false;
                        if (!basicCardIds.includes(c.id)) return false;
                        return true;
                    } else {
                        // Lifetime: everything including bundle cards
                        return true;
                    }
                });

                // Use shuffled order
                cards.sort((a, b) => shuffledCardIds.indexOf(a.id) - shuffledCardIds.indexOf(b.id));

                // Move unclear cards to front for review (but exclude those skipped this session)
                const unclearFirst = cards.filter(c => unclearCards.includes(c.id) && !sessionSkippedCards.has(c.id));

                // Get unlearned cards (exclude understood, unclear, and session-skipped)
                const rest = cards.filter(c => !unclearCards.includes(c.id) && !understoodCards.includes(c.id) && !sessionSkippedCards.has(c.id));

                return [...unclearFirst, ...rest];
            };

            const availableCards = getPersonalizedCards();
            const currentCard = availableCards[currentCardIndex];

            const handleSwipe = (direction) => {
                if (!currentCard) return;
                setSwipeDir(direction);

                setTimeout(() => {
                    if (direction === 'right') {
                        // Understood
                        const newUnderstood = [...understoodCards.filter(id => id !== currentCard.id), currentCard.id];
                        setUnderstoodCards(newUnderstood);

                        // Remove from unclear if present
                        const newUnclear = unclearCards.filter(id => id !== currentCard.id);
                        if (newUnclear.length !== unclearCards.length) {
                            setUnclearCards(newUnclear);
                        }

                        // Level up check
                    } else {
                        // Unclear - add for review
                        // Avoid duplicates if already in unclear
                        if (!unclearCards.includes(currentCard.id)) {
                            setUnclearCards([...unclearCards, currentCard.id]);
                        }
                        // Hide from current session's random mode (will reappear on reload)
                        if (!activeRoadmapFilter) {
                            setSessionSkippedCards(prev => new Set([...prev, currentCard.id]));
                        }
                    }

                    // Update Progress for daily goal (persisted in App)
                    if (direction === 'right' || direction === 'left') {
                        onUpdateDailyCompleted({ dailyCompleted: dailyCompleted + 1 });
                    }

                    // Logic Update:
                    // If Roadmap Mode: Advance index to show next card in fixed list
                    // If Today's Learning (Random): Always advance index
                    // For left swipe: card goes to unclearFirst at front of list,
                    // so we need to advance past it to avoid showing same card
                    if (activeRoadmapFilter) {
                        setCurrentCardIndex(prev => prev + 1);
                    } else {
                        if (direction === 'left') {
                            // Left-swiped card will be at front of unclearFirst,
                            // advance index to skip past it
                            setCurrentCardIndex(prev => prev + 1);
                        } else {
                            // Right-swiped card is removed from list (understood),
                            // reset to 0 since list shrinks
                            setCurrentCardIndex(0);
                        }
                    }

                    setSwipeDir(null);
                }, 300);
            };

            // Drag handlers for swipe
            const handleDrag = (e, info) => {
                if (Math.abs(info.offset.x) > 80) {
                    handleSwipe(info.offset.x > 0 ? 'right' : 'left');
                }
            };

            const getRoadmapProgress = (roadmap) => {
                const userExp = userProfile?.experienceLevel || 1;
                // Filter steps that are relevant for the user's level (hide/exclude basic steps from progress)
                const relevantSteps = roadmap.filter(step => step.level >= userExp);

                // If all steps are below user level (e.g. Expert user on Basic roadmap), considered 100% complete
                if (relevantSteps.length === 0) return 100;

                const totalCards = relevantSteps.reduce((sum, step) => sum + step.cards.length, 0);
                if (totalCards === 0) return 100;

                const completedCards = relevantSteps.reduce((sum, step) => sum + step.cards.filter(id => understoodCards.includes(id)).length, 0);
                return Math.round((completedCards / totalCards) * 100);
            };

            const levelLabels = { 1: '‚òÖ', 2: '‚òÖ‚òÖ', 3: '‚òÖ‚òÖ‚òÖ' };

            // Roadmap Purchase Paywall (individual roadmap ¬•600)
            if (viewMode === 'roadmap-purchase' && purchaseTargetRoadmap) {
                const targetRoadmap = assetRoadmaps[purchaseTargetRoadmap];
                const targetCardCount = targetRoadmap ? targetRoadmap.reduce((sum, step) => sum + step.cards.length, 0) : 0;
                return (
                    <div className="min-h-screen bg-obsidian pt-24 pb-20 px-6 sm:px-8 relative overflow-hidden">
                        {/* Dynamic Background */}
                        <div className="fixed inset-0 pointer-events-none overflow-hidden">
                            <div className="absolute top-[5%] left-1/4 w-[600px] h-[600px] bg-gold/10 rounded-full blur-[150px] opacity-40" />
                            <div className="absolute bottom-[10%] right-1/4 w-[500px] h-[500px] bg-amber-500/10 rounded-full blur-[120px] opacity-30" />
                        </div>

                        <div className="max-w-xl mx-auto relative z-10">
                            {/* Header */}
                            <div className="mb-10 text-center">
                                <motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }}>
                                    <p className="text-dim text-xs tracking-[0.4em] mb-4 text-gold">UNLOCK ROADMAP</p>
                                    <h2 className="text-3xl md:text-4xl font-black tracking-tighter text-platinum mb-3">
                                        „Äå<span className="text-gold-gradient">{purchaseTargetRoadmap}</span>„Äç„Çí<br />Â≠¶Áøí„Åô„Çã
                                    </h2>
                                    <p className="text-dim text-sm">„Åì„ÅÆ„É≠„Éº„Éâ„Éû„ÉÉ„Éó„ÅÆÂÖ®„Ç´„Éº„Éâ„Å´„Ç¢„ÇØ„Çª„Çπ</p>
                                </motion.div>
                            </div>

                            {/* ‚òÖ Target Roadmap Purchase ‚Äî Primary CTA */}
                            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }}
                                className="mb-6">
                                <div className="bg-gradient-to-br from-gold/20 to-amber-500/10 border-2 border-gold rounded-sm p-6 relative overflow-hidden">
                                    <div className="absolute top-4 right-4 text-[10px] bg-gold text-black px-3 py-1 rounded-sm font-bold">„Åä„Åô„Åô„ÇÅ</div>
                                    <h3 className="text-xl font-black text-platinum mb-1">{purchaseTargetRoadmap} „É≠„Éº„Éâ„Éû„ÉÉ„Éó</h3>
                                    <p className="text-xs text-dim mb-3">{targetCardCount}Êûö„ÅÆ„Ç´„Éº„Éâ„Åß‰ΩìÁ≥ªÁöÑ„Å´Â≠¶„Å∂</p>
                                    <div className="flex items-end gap-2 mb-4">
                                        <span className="text-4xl font-black text-gold">¬•600</span>
                                        <span className="text-dim text-sm mb-1">/ Ë≤∑„ÅÑÂàá„Çä</span>
                                    </div>

                                    <button onClick={() => { onPurchaseBundle(purchaseTargetRoadmap); setSelectedRoadmap(purchaseTargetRoadmap); setViewMode('roadmap'); setPurchaseTargetRoadmap(null); }}
                                        className="w-full py-4 bg-gold text-black font-bold text-lg rounded-sm hover:bg-amber-400 transition-colors shadow-lg shadow-gold/20">
                                        ¬•600„ÅßË≥ºÂÖ•„Åô„Çã
                                    </button>
                                </div>
                            </motion.div>

                            {/* Divider */}
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.3 }}
                                className="flex items-center gap-4 mb-6">
                                <div className="flex-1 h-px bg-white/10" />
                                <p className="text-xs text-dim whitespace-nowrap">„ÇÇ„Å£„Å®„ÅäÂæó„Å™„Éó„É©„É≥</p>
                                <div className="flex-1 h-px bg-white/10" />
                            </motion.div>

                            {/* Other Plans */}
                            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.4 }}
                                className="space-y-4 mb-8">

                                {/* Annual Plan */}
                                <div className="bg-gradient-to-br from-white/5 to-white/[0.02] border border-white/20 rounded-sm p-6 relative overflow-hidden group hover:border-gold/40 transition-all duration-300">
                                    <div className="absolute top-4 right-4 text-[10px] bg-emerald-500/80 text-white px-3 py-1 rounded-sm font-bold">‰∫∫Ê∞óNo.1</div>
                                    <h3 className="text-lg font-bold text-platinum mb-1">Âπ¥Èñì„Éë„Çπ</h3>
                                    <p className="text-xs text-dim mb-3">ÂÖ®„É≠„Éº„Éâ„Éû„ÉÉ„Éó + È´òÂ∫¶„Å™Êà¶Áï•„ÇíËß£Êîæ</p>
                                    <div className="flex items-end gap-2 mb-1">
                                        <span className="text-3xl font-bold text-platinum">¬•3,200</span>
                                        <span className="text-dim text-sm mb-1">/ Âπ¥</span>
                                    </div>
                                    <p className="text-xs text-emerald-400 mb-4">Êúà„ÅÇ„Åü„Çä <span className="font-bold">¬•267</span> ‚Äî ÂÖ®{Object.keys(assetRoadmaps).length}„É≠„Éº„Éâ„Éû„ÉÉ„ÉóÂê´„ÇÄ</p>
                                    <ul className="space-y-2 mb-5">
                                        <li className="flex items-center gap-3 text-sm text-platinum/70"><span className="text-gold">‚úì</span>ÂÖ®{allCards.length}Êûö„ÅÆÂ≠¶Áøí„Ç´„Éº„Éâ</li>
                                        <li className="flex items-center gap-3 text-sm text-platinum/70"><span className="text-gold">‚úì</span>ÂÖ®„É≠„Éº„Éâ„Éû„ÉÉ„ÉóËß£ÊîæÔºà„Éê„É≥„Éâ„É´Èô§„ÅèÔºâ</li>
                                        <li className="flex items-center gap-3 text-sm text-platinum/70"><span className="text-gold">‚úì</span>È´òÂ∫¶„Å™Êà¶Áï•„ÉªFX„Éª‰ªÆÊÉ≥ÈÄöË≤®Á≠â„ÇíÂ≠¶„Åπ„Çã</li>
                                    </ul>
                                    <button onClick={() => { onUpgrade('annual'); setViewMode('swipe'); setPurchaseTargetRoadmap(null); }}
                                        className="w-full py-3 border border-gold/50 text-gold font-bold rounded-sm hover:bg-gold/10 transition-colors">
                                        Âπ¥Èñì„Éë„Çπ„ÇíÂßã„ÇÅ„Çã
                                    </button>
                                </div>

                                {/* Lifetime Plan */}
                                <div className="bg-ash/30 border border-white/10 rounded-sm p-5 relative overflow-hidden">
                                    <div className="absolute top-4 right-4 text-[10px] bg-white/10 text-platinum px-3 py-1 rounded-sm font-bold">BEST VALUE</div>
                                    <h3 className="text-lg font-bold text-platinum mb-1">„É©„Ç§„Éï„Çø„Ç§„É†</h3>
                                    <p className="text-xs text-dim mb-2">ÂÖ®Ê©üËÉΩ + ÂÖ®„Éê„É≥„Éâ„É´Ê∞∏‰πÖËß£Êîæ</p>
                                    <div className="flex items-end gap-2 mb-4">
                                        <span className="text-2xl font-bold text-platinum">¬•9,800</span>
                                        <span className="text-dim text-sm mb-1">/ Ë≤∑„ÅÑÂàá„Çä</span>
                                    </div>
                                    <button onClick={() => { onUpgrade('lifetime'); setViewMode('swipe'); setPurchaseTargetRoadmap(null); }}
                                        className="w-full py-3 bg-white/5 border border-white/20 text-platinum text-sm font-bold rounded-sm hover:bg-white/10 transition-colors">
                                        Ê∞∏‰πÖ„Ç¢„ÇØ„Çª„Çπ„ÇíÊâã„Å´ÂÖ•„Çå„Çã
                                    </button>
                                </div>
                            </motion.div>

                            {/* Back Button */}
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.5 }}
                                className="text-center">
                                <button onClick={() => { setViewMode('roadmap'); setPurchaseTargetRoadmap(null); }}
                                    className="text-sm text-dim hover:text-platinum transition-colors underline underline-offset-4">
                                    ‚Üê „É≠„Éº„Éâ„Éû„ÉÉ„Éó„Å´Êàª„Çã
                                </button>
                            </motion.div>
                        </div>
                    </div>
                );
            }

            // Subscription Paywall
            if (viewMode === 'subscription' || shouldShowPaywall) {
                return (
                    <div className="min-h-screen bg-obsidian pt-24 pb-20 px-6 sm:px-8 relative overflow-hidden">
                        {/* Dynamic Background Lighting */}
                        <div className="fixed inset-0 pointer-events-none overflow-hidden">
                            <div className="absolute top-[5%] left-1/4 w-[600px] h-[600px] bg-gold/10 rounded-full blur-[150px] opacity-40" />
                            <div className="absolute bottom-[10%] right-1/4 w-[500px] h-[500px] bg-amber-500/10 rounded-full blur-[120px] opacity-30" />
                        </div>

                        <div className="max-w-xl mx-auto relative z-10">
                            {/* Header */}
                            <div className="mb-12 text-center">
                                <motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }}>
                                    <p className="text-dim text-xs tracking-[0.4em] mb-4 text-gold">INVISION PREMIUM</p>
                                    <h2 className="text-4xl md:text-5xl font-black tracking-tighter text-platinum mb-4">ÊäïË≥áÂ≠¶Áøí„Çí<span className="text-gold-gradient">Âä†ÈÄü</span>„Åô„Çã</h2>
                                    <p className="text-dim text-lg">ÁÑ°Êñô„Åß{freeLimit}Êûö„ÅÆÂ≠¶Áøí„Ç´„Éº„Éâ„Çí‰ΩìÈ®ì„Åó„Åæ„Åó„Åü</p>
                                    {nextReplenishTime && (
                                        <p className="text-sm text-gold mt-2 bg-gold/10 inline-block px-3 py-1 rounded-sm border border-gold/30 font-mono">
                                            Ê¨°„ÅÆ{DAILY_REPLENISH_AMOUNT}Êûö„Åæ„Åß<br />
                                            {Math.max(0, Math.floor((nextReplenishTime - now) / 1000 / 60 / 60)).toString().padStart(2, '0')}:
                                            {Math.max(0, Math.floor(((nextReplenishTime - now) / 1000 / 60) % 60)).toString().padStart(2, '0')}:
                                            {Math.max(0, Math.floor(((nextReplenishTime - now) / 1000) % 60)).toString().padStart(2, '0')}
                                        </p>
                                    )}
                                </motion.div>
                            </div>

                            {/* Progress Display */}
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.2 }}
                                className="bg-ash/50 border border-white/10 rounded-sm p-6 mb-8 text-center">
                                <p className="text-4xl font-black text-gold mb-2">{allCards.length > 0 ? Math.round((totalCardsViewed / allCards.length) * 100) : 0}%</p>
                                <p className="text-sm text-dim">Â≠¶ÁøíÈÄ≤ÊçóÁéá</p>
                            </motion.div>

                            {/* Subscription Plans - 3 Tier */}
                            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.3 }}
                                className="space-y-4 mb-8">

                                {/* Annual Plan ‚òÖÊú¨ÂëΩ */}
                                <div className="bg-gradient-to-br from-gold/20 to-amber-500/10 border-2 border-gold rounded-sm p-6 relative overflow-hidden">
                                    <div className="absolute top-4 right-4 text-[10px] bg-gold text-black px-3 py-1 rounded-sm font-bold">‰∫∫Ê∞óNo.1</div>
                                    <h3 className="text-2xl font-black text-platinum mb-1">Âπ¥Èñì„Éë„Çπ</h3>
                                    <p className="text-xs text-dim mb-3">ÂÖ®„Ç≥„É≥„ÉÜ„É≥„ÉÑÂÆåÂÖ®„Ç¢„ÇØ„Çª„Çπ</p>
                                    <div className="flex items-end gap-2 mb-1">
                                        <span className="text-4xl font-black text-gold">¬•3,200</span>
                                        <span className="text-dim text-sm mb-1">/ Âπ¥</span>
                                    </div>
                                    <p className="text-xs text-emerald-400 mb-4">Êúà„ÅÇ„Åü„Çä <span className="font-bold">¬•267</span></p>
                                    <ul className="space-y-3 mb-6">
                                        <li className="flex items-center gap-3 text-sm text-platinum/80"><span className="text-gold">‚úì</span>ÂÖ®{allCards.length}Êûö„ÅÆÂ≠¶Áøí„Ç´„Éº„Éâ</li>
                                        <li className="flex items-center gap-3 text-sm text-platinum/80"><span className="text-gold">‚úì</span>ÂÖ®„É≠„Éº„Éâ„Éû„ÉÉ„ÉóËß£ÊîæÔºà„Éê„É≥„Éâ„É´Èô§„ÅèÔºâ</li>
                                        <li className="flex items-center gap-3 text-sm text-platinum/80"><span className="text-gold">‚úì</span>È´òÂ∫¶„Å™Êà¶Áï•„ÉªFX„Éª‰ªÆÊÉ≥ÈÄöË≤®Á≠â„ÇíÂ≠¶„Åπ„Çã</li>
                                    </ul>
                                    <button onClick={() => { onUpgrade('annual'); setViewMode('swipe'); }}
                                        className="w-full py-4 bg-gold text-black font-bold text-lg rounded-sm hover:bg-amber-400 transition-colors shadow-lg shadow-gold/20">
                                        Âπ¥Èñì„Éë„Çπ„ÇíÂßã„ÇÅ„Çã
                                    </button>
                                </div>

                                {/* Lifetime Plan */}
                                <div className="bg-gradient-to-br from-white/5 to-white/[0.02] border border-white/20 rounded-sm p-6 relative overflow-hidden group hover:border-gold/40 transition-all duration-300">
                                    <div className="absolute top-4 right-4 text-[10px] bg-emerald-500 text-white px-3 py-1 rounded-sm font-bold">BEST VALUE</div>
                                    <h3 className="text-xl font-bold text-platinum mb-1">„É©„Ç§„Éï„Çø„Ç§„É†</h3>
                                    <p className="text-xs text-dim mb-3">‰∏ÄÂ∫¶„Åç„Çä„ÅÆÊäïË≥á„ÅßÊ∞∏‰πÖ„Ç¢„ÇØ„Çª„Çπ</p>
                                    <div className="flex items-end gap-2 mb-4">
                                        <span className="text-3xl font-bold text-platinum">¬•9,800</span>
                                        <span className="text-dim text-sm mb-1">/ Ë≤∑„ÅÑÂàá„Çä</span>
                                    </div>
                                    <ul className="space-y-2 mb-6">
                                        <li className="flex items-center gap-3 text-sm text-platinum/70"><span className="text-emerald-400">‚úì</span>Âπ¥Èñì„Éë„Çπ„ÅÆÂÖ®Ê©üËÉΩ</li>
                                        <li className="flex items-center gap-3 text-sm text-platinum/70"><span className="text-emerald-400">‚úì</span>ÂÖ®„Éê„É≥„Éâ„É´„Ç≥„Éº„ÇπËß£Êîæ</li>
                                        <li className="flex items-center gap-3 text-sm text-platinum/70"><span className="text-emerald-400">‚úì</span>Â∞ÜÊù•„ÅÆ„Ç¢„ÉÉ„Éó„Éá„Éº„ÉàÊ∞∏‰πÖ‰øùË®º</li>
                                    </ul>
                                    <button onClick={() => { onUpgrade('lifetime'); setViewMode('swipe'); }}
                                        className="w-full py-3 border border-white/30 text-platinum font-bold rounded-sm hover:border-gold hover:text-gold transition-colors">
                                        Ê∞∏‰πÖ„Ç¢„ÇØ„Çª„Çπ„ÇíÊâã„Å´ÂÖ•„Çå„Çã
                                    </button>
                                </div>

                                {/* Single Roadmap */}
                                <div className="bg-ash/30 border border-white/10 rounded-sm p-6">
                                    <h3 className="text-lg font-bold text-platinum mb-1">„É≠„Éº„Éâ„Éû„ÉÉ„ÉóÂçò‰Ωì</h3>
                                    <p className="text-xs text-dim mb-3">NISA„Äú‰∏çÂãïÁî£„ÅÆ„ÉÜ„Éº„Éû„ÇíÂÄãÂà•Â≠¶Áøí</p>
                                    <div className="flex items-end gap-2 mb-2">
                                        <span className="text-2xl font-bold text-platinum">¬•600</span>
                                        <span className="text-dim text-sm mb-1">/ 1„É≠„Éº„Éâ„Éû„ÉÉ„Éó</span>
                                    </div>
                                    <p className="text-[10px] text-dim mb-4">‚Äª È´òÂ∫¶„Å™Êà¶Áï•‰ª•‰∏ä„ÅØÂπ¥Èñì„Éë„Çπ or „É©„Ç§„Éï„Çø„Ç§„É†„ÅßËß£Êîæ</p>
                                    <button onClick={() => { setViewMode('roadmap'); }}
                                        className="w-full py-3 bg-white/5 border border-white/20 text-platinum text-sm font-bold rounded-sm hover:bg-white/10 transition-colors">
                                        „É≠„Éº„Éâ„Éû„ÉÉ„Éó„ÇíÈÅ∏„Å∂ ‚Üí
                                    </button>
                                </div>
                            </motion.div>

                            {/* Benefits */}
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.5 }}
                                className="text-center">
                                <p className="text-xs text-dim mb-2">üí≥ „ÅÑ„Å§„Åß„ÇÇ„Ç≠„É£„É≥„Çª„É´ÂèØËÉΩÔºàÂπ¥Èñì„Éë„ÇπÔºâ</p>
                                <p className="text-xs text-dim">üì± ÂÖ®„Éá„Éê„Ç§„ÇπÂØæÂøú</p>
                            </motion.div>

                            {/* Back Button */}
                            <div className="mt-8 text-center">
                                <button onClick={() => onNavigate('gallery')} className="text-dim text-sm hover:text-gold transition-colors">
                                    ‚Üê „Ç¢„Çª„ÉÉ„Éà‰∏ÄË¶ß„Å´Êàª„Çã
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (viewMode === 'roadmap') {
                return (
                    <div className="h-screen bg-obsidian pt-24 pb-20 px-8 relative overflow-y-auto custom-scrollbar">
                        {/* Dynamic Background Lighting */}
                        <div className="fixed inset-0 pointer-events-none overflow-hidden">
                            <div className="absolute top-[5%] -right-[15%] w-[700px] h-[700px] bg-gold/5 rounded-full blur-[150px] opacity-25" />
                            <div className="absolute bottom-[20%] -left-[10%] w-[500px] h-[500px] bg-emerald-500/5 rounded-full blur-[120px] opacity-15" />
                        </div>

                        <div className="max-w-4xl mx-auto relative z-10">
                            {/* Unified Header - Asset Gallery Style */}
                            <div className="mb-12">
                                <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }}>
                                    <p className="text-dim text-xs tracking-[0.4em] mb-4 text-gold">LEARNING ROADMAP</p>
                                    <h2 className="text-4xl md:text-5xl font-black tracking-tighter text-platinum mb-4">ÊäïË≥á„Å∏„ÅÆ<span className="text-gold-gradient">ÈÅì„ÅÆ„Çä</span></h2>
                                    <div className="flex items-center gap-4">
                                        <p className="text-dim text-sm">ÂêÑ„Ç¢„Çª„ÉÉ„Éà„ÅÆ„É≠„Éº„Éâ„Éû„ÉÉ„Éó„ÇíÂÆå‰∫Ü„Åô„Çã„Å®„ÄÅÊäïË≥á„ÇíÂßã„ÇÅ„ÇãÊ∫ñÂÇô„ÅåÊï¥„ÅÑ„Åæ„Åô</p>
                                        <button onClick={() => setViewMode('swipe')} className="text-xs text-gold hover:text-gold/80 transition-colors border border-gold/30 px-3 py-1 rounded-sm">
                                            ‚Üê Â≠¶Áøí„Å´Êàª„Çã
                                        </button>
                                    </div>
                                </motion.div>
                            </div>


                            {/* Learned Archive */}
                            {understoodCards.length > 0 && (
                                <div className="mb-12 opacity-60 hover:opacity-100 transition-opacity">
                                    <div className="flex items-center justify-between mb-4">
                                        <p className="text-dim text-xs tracking-[0.2em]">LEARNED ARCHIVE</p>
                                        <span className="text-xs text-emerald-400 font-mono">{understoodCards.length} Cards</span>
                                    </div>
                                    <div className="overflow-x-auto pb-4 scrollbar-hide flex gap-4 snap-x snap-mandatory">
                                        {understoodCards.map(id => {
                                            const card = allCards.find(c => c.id === id);
                                            if (!card) return null;
                                            return (
                                                <div key={id} className="min-w-[200px] bg-white/5 border border-white/10 rounded-sm p-4 snap-center cursor-pointer hover:bg-white/10 transition-colors"
                                                    onClick={() => { setActiveRoadmapFilter([id]); setCurrentCardIndex(0); setViewMode('swipe'); }}>
                                                    <div className="text-[10px] text-emerald-400 mb-2 font-bold flex items-center gap-1">
                                                        <span>‚úì</span> LEARNED
                                                    </div>
                                                    <h4 className="text-sm font-bold text-platinum line-clamp-2">{card.title}</h4>
                                                    <p className="text-[10px] text-dim mt-2">{card.category}</p>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {unclearCards.length > 0 && (
                                    <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }}
                                        onClick={() => setSelectedRoadmap('weakness')}
                                        className="cursor-pointer bg-gradient-to-br from-rose-950/20 to-rose-900/5 border border-rose-500/30 rounded-sm p-6 transition-all duration-300 hover:border-rose-400 group relative overflow-hidden">
                                        <div className="absolute inset-0 bg-rose-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500" />
                                        <div className="relative z-10">
                                            <div className="flex items-center justify-between mb-4">
                                                <h3 className="text-xl font-bold text-rose-400 group-hover:text-rose-300 transition-colors">Ëã¶ÊâãÂÖãÊúç</h3>
                                                <span className="text-xs bg-rose-500/20 text-rose-400 px-2 py-1 rounded-sm font-bold">{unclearCards.length} Review</span>
                                            </div>
                                            <p className="text-sm text-platinum/60 mb-6">„Çπ„ÉØ„Ç§„Éó„Åß„Äå„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Äç„Å®„Åó„Åü„Ç´„Éº„Éâ„ÇíÂæ©Áøí„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ</p>
                                            <div className="grid grid-cols-2 gap-2">
                                                {unclearCards.slice(0, 4).map(id => {
                                                    const card = allCards.find(c => c.id === id);
                                                    return card ? (
                                                        <div key={id} className="text-[10px] text-platinum/40 bg-white/5 p-2 rounded-sm line-clamp-1">{card.title}</div>
                                                    ) : null;
                                                })}
                                                {unclearCards.length > 4 && <div className="text-[10px] text-rose-400 p-2">+ {unclearCards.length - 4} more</div>}
                                            </div>
                                        </div>
                                    </motion.div>
                                )}

                                {/* Course Bundles Section - Luxury Safe Style */}
                                <div className="md:col-span-2 mb-8">
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="text-gold text-sm">üîê</span>
                                        <p className="text-[10px] text-gold/60 tracking-[0.3em] font-medium uppercase">Premium Bundles</p>
                                    </div>
                                    <div className="flex gap-4 flex-wrap">
                                        {Object.values(courseBundles).map((bundle, idx) => {
                                            const isPurchased = purchasedBundles?.includes(bundle.id);
                                            const bundleProgress = isPurchased
                                                ? Math.round((bundle.steps.flatMap(s => s.cards).filter(id => understoodCards.includes(id)).length / bundle.totalCards) * 100)
                                                : 0;
                                            const isComplete = bundleProgress === 100;

                                            return (
                                                <motion.div
                                                    key={bundle.id}
                                                    initial={{ opacity: 0, scale: 0.9 }}
                                                    animate={{ opacity: 1, scale: 1 }}
                                                    transition={{ delay: idx * 0.1, type: "spring", stiffness: 200 }}
                                                    onClick={() => setSelectedRoadmap(`bundle:${bundle.id}`)}
                                                    className="cursor-pointer group"
                                                >
                                                    {/* Luxury Safe/Vault Design */}
                                                    <div className="relative w-[120px] h-[120px]">
                                                        {/* 3D Shadow Layer */}
                                                        <div className="absolute inset-0 translate-x-1 translate-y-1 bg-black/40 rounded-lg blur-sm" />

                                                        {/* Safe Body - 3D Effect with multiple layers */}
                                                        <div className={`absolute inset-0 rounded-lg border-2 transition-all duration-300 ${isPurchased
                                                            ? 'bg-gradient-to-br from-emerald-900 via-emerald-800 to-emerald-950 border-emerald-500/50 group-hover:border-emerald-400 group-hover:shadow-[0_0_20px_rgba(52,211,153,0.3)]'
                                                            : 'bg-gradient-to-br from-stone-800 via-stone-700 to-stone-900 border-gold/30 group-hover:border-gold group-hover:shadow-[0_0_25px_rgba(218,165,32,0.4)]'
                                                            }`}>

                                                            {/* Inner bevel effect */}
                                                            <div className="absolute inset-[3px] rounded-md bg-gradient-to-br from-white/10 via-transparent to-black/20" />

                                                            {/* Safe door frame */}
                                                            <div className="absolute inset-[8px] rounded border border-white/10 bg-gradient-to-br from-black/20 to-transparent" />

                                                            {/* Lock dial / progress indicator */}
                                                            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                                                                {isPurchased ? (
                                                                    <div className="relative">
                                                                        {/* Circular progress */}
                                                                        <svg className="w-10 h-10 -rotate-90" viewBox="0 0 36 36">
                                                                            <circle cx="18" cy="18" r="14" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="2" />
                                                                            <circle cx="18" cy="18" r="14" fill="none" stroke="url(#progressGradient)" strokeWidth="2"
                                                                                strokeDasharray={`${bundleProgress * 0.88} 88`} strokeLinecap="round" />
                                                                            <defs>
                                                                                <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                                                                    <stop offset="0%" stopColor="#10b981" />
                                                                                    <stop offset="100%" stopColor="#34d399" />
                                                                                </linearGradient>
                                                                            </defs>
                                                                        </svg>
                                                                        <span className="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-emerald-400">
                                                                            {isComplete ? '‚úì' : `${bundleProgress}%`}
                                                                        </span>
                                                                    </div>
                                                                ) : (
                                                                    <div className="w-10 h-10 rounded-full border-2 border-gold/50 bg-gradient-to-br from-gold/20 to-amber-900/30 flex items-center justify-center group-hover:border-gold group-hover:scale-110 transition-all">
                                                                        <span className="text-gold text-lg group-hover:rotate-12 transition-transform">üîí</span>
                                                                    </div>
                                                                )}
                                                            </div>

                                                            {/* Handle bolts decorations */}
                                                            <div className="absolute top-2 left-2 w-2 h-2 rounded-full bg-gradient-to-br from-white/20 to-transparent border border-white/10" />
                                                            <div className="absolute top-2 right-2 w-2 h-2 rounded-full bg-gradient-to-br from-white/20 to-transparent border border-white/10" />
                                                            <div className="absolute bottom-2 left-2 w-2 h-2 rounded-full bg-gradient-to-br from-white/20 to-transparent border border-white/10" />
                                                            <div className="absolute bottom-2 right-2 w-2 h-2 rounded-full bg-gradient-to-br from-white/20 to-transparent border border-white/10" />
                                                        </div>

                                                        {/* Hover glow effect */}
                                                        <div className={`absolute -inset-2 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity duration-500 blur-xl ${isPurchased ? 'bg-emerald-500/20' : 'bg-gold/20'
                                                            }`} />
                                                    </div>

                                                    {/* Label - Abbreviated title only */}
                                                    <div className="mt-3 text-center">
                                                        <p className={`text-xs font-bold tracking-wide transition-colors ${isPurchased
                                                            ? 'text-emerald-400 group-hover:text-emerald-300'
                                                            : 'text-platinum/70 group-hover:text-gold'
                                                            }`}>
                                                            {bundle.shortTitle || 'INDEXÊäïË≥á'}
                                                        </p>
                                                        {!isPurchased && (
                                                            <p className="text-[10px] text-gold/60 mt-0.5">¬•{bundle.price}</p>
                                                        )}
                                                        {isPurchased && !isComplete && (
                                                            <p className="text-[9px] text-emerald-400/60 mt-0.5">Â≠¶Áøí‰∏≠</p>
                                                        )}
                                                        {isComplete && (
                                                            <p className="text-[9px] text-emerald-400 mt-0.5">‚úì ÂÆå‰∫Ü</p>
                                                        )}
                                                    </div>
                                                </motion.div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {Object.entries(assetRoadmaps).map(([assetName, roadmap], idx) => {
                                    const progress = getRoadmapProgress(roadmap);
                                    const isComplete = progress === 100;
                                    const isProRoadmap = roadmap.some(step => step.isPro);

                                    // Access control logic:
                                    // Free: Non-Pro roadmaps purchasable for ¬•600, Pro roadmaps locked
                                    // Free Trial: NISA/ÂõΩÂÜÖÊ†™Âºè steps 1-2 are free (no purchase needed)
                                    // Purchased: Individual non-Pro roadmaps unlocked via purchasedBundles
                                    // Annual: All roadmaps unlocked (not bundles)
                                    // Lifetime: Everything including bundles
                                    const isFree = userPlan === 'free';
                                    const isPurchased = purchasedBundles.includes(assetName);
                                    const canAccess = hasFullAccess || isPurchased;
                                    const isProLocked = isProRoadmap && !hasFullAccess;
                                    const hasFreeTrial = FREE_TRIAL_ROADMAPS[assetName] !== undefined;
                                    const freeStepCount = FREE_TRIAL_ROADMAPS[assetName] || 0;
                                    const isNonProUnpurchased = !isProRoadmap && isFree && !isPurchased && !hasFreeTrial;
                                    const shouldBlurItems = (isProLocked || (isFree && !isPurchased && !hasFreeTrial)) && !isComplete;

                                    return (
                                        <motion.div key={assetName} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: idx * 0.15 }}
                                            onClick={() => {
                                                if (isProLocked) {
                                                    // Pro roadmaps ‚Üí subscription page
                                                    setViewMode('subscription');
                                                } else if (isNonProUnpurchased) {
                                                    // Non-Pro, free, not purchased ‚Üí roadmap purchase paywall
                                                    setPurchaseTargetRoadmap(assetName);
                                                    setViewMode('roadmap-purchase');
                                                } else {
                                                    setSelectedRoadmap(assetName);
                                                }
                                            }}
                                            className={`cursor-pointer bg-gradient-to-br from-ash/60 to-ash/20 border rounded-sm p-6 transition-all duration-300 hover:border-gold/30 group relative overflow-hidden ${isComplete ? 'border-emerald-500/30' : isProRoadmap ? 'border-amber-500/30' : 'border-white/5'}`}>
                                            {/* Subtle glow on hover */}
                                            <div className={`absolute inset-0 ${isProRoadmap ? 'bg-amber-500/5' : 'bg-gold/5'} opacity-0 group-hover:opacity-100 transition-opacity duration-500`} />
                                            {/* Pro Badge */}
                                            {isProRoadmap && (
                                                <div className="absolute top-3 right-3 flex items-center gap-1 bg-gradient-to-r from-amber-600 to-amber-400 text-black text-[10px] font-bold px-2 py-0.5 rounded-sm">
                                                    <span>üëë</span> PRO
                                                </div>
                                            )}
                                            {/* Price badge for unpurchased non-Pro roadmaps */}
                                            {isNonProUnpurchased && (
                                                <div className="absolute top-3 right-3 flex items-center gap-1 bg-gold/20 border border-gold/40 text-gold text-[10px] font-bold px-2 py-0.5 rounded-sm">
                                                    ¬•600
                                                </div>
                                            )}
                                            {/* Free trial badge */}
                                            {hasFreeTrial && isFree && !isPurchased && !hasFullAccess && (
                                                <div className="absolute top-3 right-3 flex items-center gap-1 bg-emerald-500/20 border border-emerald-500/40 text-emerald-400 text-[10px] font-bold px-2 py-0.5 rounded-sm">
                                                    Step {freeStepCount}„Åæ„ÅßÁÑ°Êñô
                                                </div>
                                            )}
                                            {/* Purchased badge */}
                                            {isPurchased && !isComplete && !hasFullAccess && (
                                                <div className="absolute top-3 right-3 flex items-center gap-1 bg-emerald-500/20 border border-emerald-500/40 text-emerald-400 text-[10px] font-bold px-2 py-0.5 rounded-sm">
                                                    Ë≥ºÂÖ•Ê∏à„Åø
                                                </div>
                                            )}
                                            {/* Lock overlay for Pro roadmaps */}
                                            {isProLocked && (
                                                <div className="absolute inset-0 bg-obsidian/60 backdrop-blur-[1px] flex items-center justify-center z-20">
                                                    <div className="text-center">
                                                        <span className="text-2xl">üîí</span>
                                                        <p className="text-xs text-amber-400 mt-1 font-medium">Âπ¥Èñì„Éë„Çπ or „É©„Ç§„Éï„Çø„Ç§„É†„ÅßËß£Êîæ</p>
                                                    </div>
                                                </div>
                                            )}
                                            <div className="relative z-10">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h3 className={`text-xl font-bold ${isProRoadmap ? 'text-amber-400' : 'text-platinum'} group-hover:text-gold transition-colors`}>{assetName}</h3>
                                                    {isComplete && <span className="text-xs bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded-sm font-bold">Â≠¶ÁøíÂÆå‰∫Ü</span>}
                                                </div>
                                                <div className="flex items-center gap-4 mb-4">
                                                    <div className="flex-1 h-2 bg-stone rounded-full overflow-hidden">
                                                        <motion.div initial={{ width: 0 }} animate={{ width: `${progress}%` }} transition={{ duration: 1, delay: idx * 0.2 }}
                                                            className={`h-full ${isComplete ? 'bg-gradient-to-r from-emerald-600 to-emerald-400' : isProRoadmap ? 'bg-gradient-to-r from-amber-600 to-amber-400' : 'bg-gradient-to-r from-gold to-amber-500'}`} />
                                                    </div>
                                                    <span className="text-sm font-bold text-gold">{progress}%</span>
                                                </div>
                                                <div className={`space-y-2`}>
                                                    {roadmap.map((step, i) => {
                                                        const userExp = userProfile?.experienceLevel || 1;
                                                        const isBasic = step.level < userExp;
                                                        const stepComplete = step.cards.every(id => understoodCards.includes(id));
                                                        // Per-step blur: free trial roadmaps show steps 1-freeStepCount, blur the rest
                                                        const isStepLocked = hasFreeTrial && isFree && !isPurchased && !hasFullAccess && i >= freeStepCount;
                                                        const isAllBlurred = shouldBlurItems && !isProRoadmap;

                                                        return (
                                                            <div key={step.id} className={`flex items-center gap-3 text-sm ${isBasic ? 'opacity-50' : ''} ${isStepLocked || isAllBlurred ? 'blur-[3px] select-none' : ''}`}>
                                                                <span className={`w-5 h-5 rounded-full flex items-center justify-center text-xs ${stepComplete ? 'bg-emerald-500 text-white' : isProRoadmap ? 'bg-amber-900/50 text-amber-400' : 'bg-stone text-dim'}`}>
                                                                    {stepComplete ? '‚úì' : (isBasic ? '-' : i + 1)}
                                                                </span>
                                                                <span className={stepComplete ? 'text-platinum/60 line-through' : 'text-platinum/80'}>
                                                                    {step.title}
                                                                </span>
                                                                {isBasic && <span className="text-[10px] border border-white/20 px-1 rounded text-dim">Âæ©Áøí</span>}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                {/* Upgrade hint for Free users on non-Pro roadmaps */}
                                                {isFree && !isProRoadmap && !isPurchased && (
                                                    <div className="mt-4 pt-3 border-t border-white/10 text-center">
                                                        <p className="text-xs text-gold/70">üí∞ ¬•600„ÅßÂçò‰ΩìË≥ºÂÖ•ÂèØËÉΩ</p>
                                                    </div>
                                                )}
                                            </div>
                                        </motion.div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Roadmap Detail Modal */}
                        <AnimatePresence>
                            {selectedRoadmap && (
                                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="fixed inset-0 z-50 flex items-center justify-center bg-obsidian/95 backdrop-blur-lg p-4" onClick={() => setSelectedRoadmap(null)}>
                                    <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} onClick={e => e.stopPropagation()}
                                        className="w-full max-w-md glass-panel rounded-sm p-10 max-h-[90vh] overflow-y-auto custom-scrollbar">
                                        {/* Modal Header - Dynamic based on type */}
                                        {(() => {
                                            const isBundle = selectedRoadmap?.startsWith('bundle:');
                                            // Handle bundle:ID:confirm format
                                            const parts = selectedRoadmap?.split(':') || [];
                                            const bundleId = isBundle ? parts[1] : null;
                                            const isConfirming = isBundle && parts[2] === 'confirm';

                                            const bundle = isBundle ? courseBundles[bundleId] : null;
                                            const isPurchased = isBundle && purchasedBundles?.includes(bundleId);
                                            const displayTitle = isBundle ? bundle?.title : selectedRoadmap;

                                            // If bundle is not purchased, show purchase UI
                                            if (isBundle && bundle && !isPurchased) {
                                                if (isConfirming) {
                                                    return (
                                                        <div className="text-center py-10">
                                                            <div className="w-16 h-16 mx-auto mb-6 bg-gold/10 rounded-full flex items-center justify-center border border-gold/30">
                                                                <span className="text-3xl">ü§î</span>
                                                            </div>
                                                            <h3 className="text-xl font-bold text-platinum mb-2">Ë≥ºÂÖ•„ÅÆÁ¢∫Ë™ç</h3>
                                                            <p className="text-sm text-platinum/70 mb-8">
                                                                „Äå{bundle.title}„Äç<br />
                                                                „Çí <span className="text-gold font-bold">¬•{bundle.price}</span> „ÅßË≥ºÂÖ•„Åó„Åæ„Åô„ÅãÔºü
                                                            </p>
                                                            <div className="flex gap-3">
                                                                <button
                                                                    onClick={() => setSelectedRoadmap(`bundle:${bundleId}`)}
                                                                    className="flex-1 py-3 bg-white/5 border border-white/10 text-platinum/70 hover:bg-white/10 rounded-sm transition-colors"
                                                                >
                                                                    „Ç≠„É£„É≥„Çª„É´
                                                                </button>
                                                                <button
                                                                    onClick={() => {
                                                                        onPurchaseBundle(bundleId);
                                                                        // Verify purchase usually updates state, so no need to clean up selectedRoadmap specifically if we want to stay, 
                                                                        // but usually onPurchase updates state and re-renders.
                                                                        // We should probably stay on the bundle page which will now show as purchased.
                                                                        setSelectedRoadmap(`bundle:${bundleId}`);
                                                                    }}
                                                                    className="flex-1 py-3 bg-gradient-to-r from-gold to-amber-500 text-black font-bold rounded-sm hover:from-amber-400 hover:to-gold transition-all shadow-lg shadow-gold/20"
                                                                >
                                                                    Ë≥ºÂÖ•„Åô„Çã
                                                                </button>
                                                            </div>
                                                        </div>
                                                    );
                                                }

                                                return (
                                                    <div className="text-center">
                                                        {/* Close button */}
                                                        <button onClick={() => setSelectedRoadmap(null)} className="absolute top-4 right-4 text-white/30 hover:text-white/60 transition-colors text-lg">‚úï</button>

                                                        {/* Safe icon */}
                                                        <div className="w-20 h-20 mx-auto mb-6 relative">
                                                            <div className="absolute inset-0 rounded-lg bg-gradient-to-br from-stone-700 via-stone-600 to-stone-800 border-2 border-gold/40 shadow-xl">
                                                                <div className="absolute inset-[4px] rounded bg-gradient-to-br from-white/10 to-black/20" />
                                                                <div className="absolute inset-0 flex items-center justify-center">
                                                                    <span className="text-3xl">{bundle.icon}</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Title */}
                                                        <h3 className="text-xl font-bold text-platinum mb-2">{bundle.title}</h3>
                                                        <p className="text-xs text-gold mb-6">{bundle.subtitle}</p>

                                                        {/* Description */}
                                                        <p className="text-sm text-platinum/70 leading-relaxed mb-6">{bundle.description}</p>

                                                        {/* Features */}
                                                        <div className="space-y-2 mb-8 text-left">
                                                            {bundle.features.map((feature, i) => (
                                                                <div key={i} className="flex items-center gap-3 text-sm text-platinum/80">
                                                                    <span className="text-gold">‚úì</span>
                                                                    <span>{feature}</span>
                                                                </div>
                                                            ))}
                                                        </div>

                                                        {/* Stats */}
                                                        <div className="flex justify-center gap-6 mb-8">
                                                            <div className="text-center">
                                                                <p className="text-2xl font-bold text-gold">{bundle.totalCards}</p>
                                                                <p className="text-[10px] text-dim">„Ç´„Éº„Éâ</p>
                                                            </div>
                                                            <div className="text-center">
                                                                <p className="text-2xl font-bold text-platinum">{bundle.steps.length}</p>
                                                                <p className="text-[10px] text-dim">„Çπ„ÉÜ„ÉÉ„Éó</p>
                                                            </div>
                                                            <div className="text-center">
                                                                <p className="text-lg font-bold text-platinum">{bundle.estimatedTime}</p>
                                                                <p className="text-[10px] text-dim">Â≠¶ÁøíÊôÇÈñì</p>
                                                            </div>
                                                        </div>

                                                        {/* Purchase Button */}
                                                        <button
                                                            onClick={() => setSelectedRoadmap(`bundle:${bundle.id}:confirm`)}
                                                            className="w-full py-4 bg-gradient-to-r from-gold to-amber-500 text-black font-bold text-lg rounded-sm hover:from-amber-400 hover:to-gold transition-all shadow-lg shadow-gold/30 mb-3"
                                                        >
                                                            üîì ¬•{bundle.price}„ÅßË≥ºÂÖ•„Åô„Çã
                                                        </button>
                                                    </div>
                                                );
                                            }

                                            return (
                                                <>
                                                    <div className="flex justify-between items-start mb-8">
                                                        <div>
                                                            <h3 className="text-xl font-light text-platinum tracking-wide">{displayTitle}</h3>
                                                            {isBundle && bundle && (
                                                                <p className="text-xs text-dim mt-1">{bundle.subtitle}</p>
                                                            )}
                                                        </div>
                                                        <button onClick={() => setSelectedRoadmap(null)} className="text-white/30 hover:text-white/60 transition-colors">‚úï</button>
                                                    </div>
                                                    <div className="space-y-8">
                                                        {selectedRoadmap === 'weakness' ? (
                                                            <div className="space-y-4 max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar">
                                                                {unclearCards.map(id => {
                                                                    const card = allCards.find(c => c.id === id);
                                                                    if (!card) return null;
                                                                    return (
                                                                        <div key={id}
                                                                            onClick={() => {
                                                                                setActiveRoadmapFilter([id]);
                                                                                setCurrentCardIndex(0);
                                                                                setSelectedRoadmap(null);
                                                                                setViewMode('swipe');
                                                                            }}
                                                                            className="bg-white/5 border border-white/10 rounded-sm p-4 flex justify-between items-center gap-4 cursor-pointer hover:bg-white/10 transition-all group">
                                                                            <div>
                                                                                <p className="text-sm text-platinum/90 font-medium mb-1 group-hover:text-gold transition-colors">{card.title}</p>
                                                                                <p className="text-[10px] text-dim">{card.category}</p>
                                                                            </div>
                                                                            <button onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                setUnclearCards(unclearCards.filter(c => c !== id));
                                                                                setUnderstoodCards([...understoodCards, id]);
                                                                            }} className="px-3 py-1.5 bg-emerald-500/10 border border-emerald-500/30 text-emerald-400 text-[10px] font-bold rounded-sm hover:bg-emerald-500 hover:text-white transition-all">
                                                                                ÁêÜËß£„Åó„Åü
                                                                            </button>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        ) : isBundle && bundle ? (
                                                            /* Bundle Course Steps */
                                                            bundle.steps.map((step, i) => {
                                                                const stepComplete = step.cards.every(id => understoodCards.includes(id));
                                                                const stepProgress = Math.round((step.cards.filter(id => understoodCards.includes(id)).length / step.cards.length) * 100);

                                                                return (
                                                                    <div key={step.id} className={`border-l-2 pl-6 ${stepComplete ? 'border-emerald-500' : 'border-emerald-500/30'}`}>
                                                                        <div className="flex items-center gap-2 mb-2">
                                                                            <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${stepComplete ? 'bg-emerald-500 text-white' : 'bg-emerald-500/10 text-emerald-400'}`}>
                                                                                {stepComplete ? '‚úì' : i + 1}
                                                                            </span>
                                                                            <p className="text-[9px] text-gold/60 tracking-widest uppercase">{step.title}</p>
                                                                        </div>
                                                                        <p className="text-xs text-dim mb-2">{step.subtitle}</p>
                                                                        <p className="text-sm text-platinum/60 mb-4">{step.description}</p>
                                                                        {/* Step Progress */}
                                                                        <div className="flex items-center gap-3 mb-3">
                                                                            <div className="flex-1 h-1.5 bg-stone rounded-full overflow-hidden">
                                                                                <div className={`h-full ${stepComplete ? 'bg-emerald-500' : 'bg-emerald-500'}`} style={{ width: `${stepProgress}%` }} />
                                                                            </div>
                                                                            <span className="text-[10px] text-dim font-mono">{stepProgress}%</span>
                                                                        </div>
                                                                        <div className="flex flex-wrap gap-2">
                                                                            {step.cards.map(cardId => {
                                                                                const card = allCards.find(c => c.id === cardId);
                                                                                const done = understoodCards.includes(cardId);
                                                                                return card ? (
                                                                                    <span key={cardId}
                                                                                        onClick={() => {
                                                                                            setActiveRoadmapFilter([cardId]);
                                                                                            setCurrentCardIndex(0);
                                                                                            setSelectedRoadmap(null);
                                                                                            setViewMode('swipe');
                                                                                        }}
                                                                                        className={`cursor-pointer transition-colors hover:bg-gold/20 text-[10px] px-3 py-1 rounded-full border flex items-center gap-1 ${done ? 'border-emerald-500/30 text-emerald-400/80 bg-emerald-500/5' : 'border-white/5 text-white/30'}`}>
                                                                                        {done && <span>‚úì</span>}
                                                                                        {card.title}
                                                                                    </span>
                                                                                ) : null;
                                                                            })}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })
                                                        ) : (
                                                            /* Asset Roadmap Steps */
                                                            assetRoadmaps[selectedRoadmap]?.map((step, i) => {
                                                                const userExp = userProfile?.experienceLevel || 1;
                                                                const isBasic = step.level < userExp;
                                                                const isTrialRoadmap = FREE_TRIAL_ROADMAPS[selectedRoadmap] !== undefined;
                                                                const trialStepCount = FREE_TRIAL_ROADMAPS[selectedRoadmap] || 0;
                                                                const isStepFree = isTrialRoadmap && i < trialStepCount;
                                                                const isStepLocked = isTrialRoadmap && userPlan === 'free' && !purchasedBundles.includes(selectedRoadmap) && !hasFullAccess && i >= trialStepCount;

                                                                return (
                                                                    <div key={step.id} className={`border-l pl-6 ${isBasic ? 'border-white/5 opacity-60' : 'border-white/10'} ${isStepLocked ? 'relative' : ''}`}>
                                                                        <div className="flex items-center gap-2 mb-2">
                                                                            <p className="text-[9px] text-gold/60 tracking-widest uppercase">Step {i + 1}</p>
                                                                            {isBasic && <span className="text-[9px] border border-white/20 px-1.5 py-0.5 rounded text-dim">BASIC / REVIEW</span>}
                                                                            {isStepFree && userPlan === 'free' && !hasFullAccess && <span className="text-[9px] bg-emerald-500/20 border border-emerald-500/30 px-1.5 py-0.5 rounded text-emerald-400 font-bold">FREE</span>}
                                                                            {isStepLocked && <span className="text-[9px] text-amber-400/60">üîí</span>}
                                                                        </div>
                                                                        <p className={`text-sm mb-4 ${isStepLocked ? 'text-platinum/30' : 'text-platinum/80'}`}>{step.title}</p>
                                                                        <div className={`flex flex-wrap gap-2 ${isStepLocked ? 'blur-[4px] select-none pointer-events-none' : ''}`}>
                                                                            {step.cards.map(cardId => {
                                                                                const card = allCards.find(c => c.id === cardId);
                                                                                const done = understoodCards.includes(cardId);
                                                                                return card ? (
                                                                                    <span key={cardId}
                                                                                        onClick={() => {
                                                                                            if (!isStepLocked) {
                                                                                                setActiveRoadmapFilter([cardId]);
                                                                                                setCurrentCardIndex(0);
                                                                                                setSelectedRoadmap(null);
                                                                                                setViewMode('swipe');
                                                                                            }
                                                                                        }}
                                                                                        className={`${isStepLocked ? '' : 'cursor-pointer hover:bg-gold/20'} transition-colors text-[10px] px-3 py-1 rounded-full border flex items-center gap-1 ${done ? 'border-emerald-500/30 text-emerald-400/80 bg-emerald-500/5' : 'border-white/5 text-white/30'}`}>
                                                                                        {done && <span>‚úì</span>}
                                                                                        {card.title}
                                                                                    </span>
                                                                                ) : null;
                                                                            })}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })
                                                        )}
                                                    </div>
                                                    {/* Learning Button */}
                                                    <div className="mt-8 pt-6 border-t border-white/10">
                                                        {selectedRoadmap === 'weakness' ? (
                                                            <button onClick={() => {
                                                                setActiveRoadmapFilter(unclearCards);
                                                                setCurrentCardIndex(0);
                                                                setSelectedRoadmap(null);
                                                                setViewMode('swipe');
                                                            }} className="w-full py-3 bg-rose-500 text-white font-bold rounded-sm hover:bg-rose-400 transition-colors">
                                                                üî• Ëã¶Êâã„Å™„Ç´„Éº„Éâ„ÇíÁ∑èÂæ©Áøí
                                                            </button>
                                                        ) : isBundle && bundle ? (
                                                            <button onClick={() => {
                                                                const bundleCards = bundle.steps.flatMap(step => step.cards);
                                                                setActiveRoadmapFilter(bundleCards);
                                                                const firstUnreadIndex = bundleCards.findIndex(id => !understoodCards.includes(id));
                                                                setCurrentCardIndex(firstUnreadIndex !== -1 ? firstUnreadIndex : 0);
                                                                setSelectedRoadmap(null);
                                                                setViewMode('swipe');
                                                            }} className="w-full py-3 bg-gradient-to-r from-emerald-600 to-teal-500 text-white font-bold rounded-sm hover:from-emerald-500 hover:to-teal-400 transition-all shadow-lg shadow-emerald-900/30">
                                                                üìà „Åì„ÅÆ„Ç≥„Éº„Çπ„ÇíÂ≠¶Áøí„Åô„Çã
                                                            </button>
                                                        ) : (
                                                            (() => {
                                                                const isTrialRoadmap = FREE_TRIAL_ROADMAPS[selectedRoadmap] !== undefined;
                                                                const trialStepCount = FREE_TRIAL_ROADMAPS[selectedRoadmap] || 0;
                                                                const canLearn = hasFullAccess || purchasedBundles.includes(selectedRoadmap);
                                                                const canLearnTrial = isTrialRoadmap && userPlan === 'free' && !canLearn;

                                                                if (canLearn) {
                                                                    return (
                                                                        <button onClick={() => {
                                                                            const roadmapCards = assetRoadmaps[selectedRoadmap].flatMap(step => step.cards);
                                                                            setActiveRoadmapFilter(roadmapCards);
                                                                            const firstUnreadIndex = roadmapCards.findIndex(id => !understoodCards.includes(id));
                                                                            setCurrentCardIndex(firstUnreadIndex !== -1 ? firstUnreadIndex : 0);
                                                                            setSelectedRoadmap(null);
                                                                            setViewMode('swipe');
                                                                        }} className="w-full py-3 bg-gold text-black font-bold rounded-sm hover:bg-amber-400 transition-colors">
                                                                            üÇ¥ „Åì„ÅÆ„É≠„Éº„Éâ„Éû„ÉÉ„Éó„ÇíÂ≠¶Áøí
                                                                        </button>
                                                                    );
                                                                } else if (canLearnTrial) {
                                                                    // Free trial: learn only free steps
                                                                    const freeCards = assetRoadmaps[selectedRoadmap].slice(0, trialStepCount).flatMap(step => step.cards);
                                                                    return (
                                                                        <div className="space-y-3">
                                                                            <button onClick={() => {
                                                                                setActiveRoadmapFilter(freeCards);
                                                                                const firstUnreadIndex = freeCards.findIndex(id => !understoodCards.includes(id));
                                                                                setCurrentCardIndex(firstUnreadIndex !== -1 ? firstUnreadIndex : 0);
                                                                                setSelectedRoadmap(null);
                                                                                setViewMode('swipe');
                                                                            }} className="w-full py-3 bg-gold text-black font-bold rounded-sm hover:bg-amber-400 transition-colors">
                                                                                üÇ¥ Step {trialStepCount}„Åæ„ÅßÁÑ°Êñô„ÅßÂ≠¶Áøí
                                                                            </button>
                                                                            <p className="text-[10px] text-dim text-center">Step {trialStepCount + 1}‰ª•Èôç„ÅØË≥ºÂÖ•„Åæ„Åü„ÅØ„Éó„É©„É≥„ÅßËß£Êîæ</p>
                                                                        </div>
                                                                    );
                                                                } else {
                                                                    return (
                                                                        <div className="text-center">
                                                                            <p className="text-xs text-dim mb-3">„É≠„Éº„Éâ„Éû„ÉÉ„ÉóÂà•„Çπ„ÉØ„Ç§„ÉóÂ≠¶Áøí„ÅØPro„Éó„É©„É≥ÈôêÂÆö</p>
                                                                            <button onClick={() => setViewMode('subscription')} className="w-full py-3 border border-gold/50 text-gold font-bold rounded-sm hover:bg-gold/10 transition-colors">
                                                                                üîì Pro„Å´„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ
                                                                            </button>
                                                                        </div>
                                                                    );
                                                                }
                                                            })()
                                                        )}
                                                    </div>
                                                </>
                                            );
                                        })()}
                                    </motion.div>
                                </motion.div>
                            )}
                        </AnimatePresence>
                    </div>
                );
            }

            // Swipe Mode (Tinder-style) - LUXURY EDITION
            return (
                <div className="min-h-screen bg-obsidian pt-24 pb-20 px-4 sm:px-8 relative overflow-hidden">
                    {/* Dynamic Background Lighting */}
                    <div className="fixed inset-0 pointer-events-none overflow-hidden">
                        <div className="absolute -top-[10%] left-1/3 w-[700px] h-[700px] bg-gold/5 rounded-full blur-[150px] opacity-25" />
                        <div className="absolute bottom-[10%] -right-[10%] w-[500px] h-[500px] bg-amber-500/5 rounded-full blur-[120px] opacity-20" />
                    </div>

                    <div className="max-w-xl mx-auto relative z-10">
                        {/* Unified Header - Asset Gallery Style */}
                        <div className="mb-12">
                            <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }}>
                                <p className="text-dim text-xs tracking-[0.4em] mb-4 text-gold">TODAY'S LEARNING</p>
                                <h2 className="text-4xl md:text-5xl font-black tracking-tighter text-platinum mb-4">„Çπ„ÉØ„Ç§„Éó„Åß<span className="text-gold-gradient">Â≠¶„Å∂</span></h2>
                                <div className="flex items-center gap-4">
                                    <p className="text-dim text-sm">ÁêÜËß£Â∫¶„Çí„ÉÅ„Çß„ÉÉ„ÇØ</p>
                                    <button onClick={() => setViewMode('roadmap')}
                                        className="group relative overflow-hidden bg-gold/10 hover:bg-gold/20 text-gold text-xs font-bold px-4 py-2 rounded-full border border-gold/40 transition-all duration-300 hover:shadow-[0_0_15px_rgba(218,165,32,0.3)] flex items-center gap-2">
                                        <span className="relative z-10">üìç Â≠¶Áøí„É≠„Éº„Éâ„Éû„ÉÉ„Éó„ÇíË¶ã„Çã</span>
                                        {hasFullAccess && <span className="bg-gradient-to-r from-amber-600 to-amber-400 text-black text-[9px] px-1.5 py-0.5 rounded-sm font-black relative z-10">PRO</span>}
                                        <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700" />
                                    </button>
                                </div>
                            </motion.div>
                        </div>

                        {/* Roadmap Mode Indicator - Always show if active */}
                        {activeRoadmapFilter && (
                            <motion.div initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }}
                                className="bg-gold/10 border border-gold/30 rounded-sm p-3 mb-6 flex items-center justify-between">
                                <span className="text-xs text-gold font-bold">üìç „É≠„Éº„Éâ„Éû„ÉÉ„Éó„É¢„Éº„Éâ</span>
                                <button onClick={() => { setActiveRoadmapFilter(null); setCurrentCardIndex(0); }} className="text-xs text-dim hover:text-platinum transition-colors">√ó ÁµÇ‰∫Ü</button>
                            </motion.div>
                        )}

                        {/* Daily Progress - Only show if goal not reached */}
                        {dailyCompleted < dailyGoal && (
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.2 }}
                                className="bg-gradient-to-r from-gold/10 to-amber-500/5 border border-gold/20 rounded-sm p-5 mb-10">
                                <div className="flex items-center justify-between mb-3">
                                    <span className="text-sm text-platinum font-bold">‰ªäÊó•„ÅÆÁõÆÊ®ô</span>
                                    <span className="text-gold font-bold">{dailyCompleted}/{dailyGoal}</span>
                                </div>
                                <div className="flex gap-2">
                                    {[...Array(dailyGoal)].map((_, i) => (
                                        <motion.div key={i} initial={{ scale: 0 }} animate={{ scale: 1 }} transition={{ delay: 0.3 + i * 0.1 }}
                                            className={`flex-1 h-2 rounded-full ${i < dailyCompleted ? 'bg-gold' : 'bg-stone'}`} />
                                    ))}
                                </div>
                            </motion.div>
                        )}

                        {/* Swipe Card */}
                        {currentCard ? (
                            <div className="relative h-[360px] sm:h-[420px] md:h-[480px] mb-10">
                                <AnimatePresence mode="wait">
                                    <motion.div
                                        key={currentCard.id}
                                        ref={cardRef}
                                        drag="x"
                                        dragConstraints={{ left: -1000, right: 1000 }}
                                        dragElastic={0.7}
                                        dragTransition={{ bounceStiffness: 300, bounceDamping: 20 }}
                                        onDragEnd={handleDrag}
                                        initial={{ opacity: 0, y: 30, scale: 0.95 }}
                                        animate={{
                                            opacity: 1,
                                            y: 0,
                                            scale: 1,
                                            x: swipeDir === 'right' ? 400 : swipeDir === 'left' ? -400 : 0,
                                            rotate: swipeDir === 'right' ? 12 : swipeDir === 'left' ? -12 : 0
                                        }}
                                        exit={{ opacity: 0, scale: 0.9, y: -20 }}
                                        transition={{
                                            type: 'spring',
                                            stiffness: 260,
                                            damping: 25,
                                            mass: 0.8,
                                            opacity: { duration: 0.3 },
                                            exit: { duration: 0.4, ease: [0.22, 1, 0.36, 1] }
                                        }}
                                        className="absolute inset-0 glass-panel rounded-sm p-6 sm:p-10 cursor-grab active:cursor-grabbing touch-none luxury-glow"
                                    >
                                        {/* Swipe Indicators - More subtle */}
                                        <motion.div
                                            className="absolute top-8 left-8 pointer-events-none"
                                            animate={{ opacity: swipeDir === 'left' ? 0.8 : 0 }}
                                        >
                                            <span className="text-rose-400/80 text-sm font-medium border border-rose-400/40 rounded-full px-4 py-2">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</span>
                                        </motion.div>
                                        <motion.div
                                            className="absolute top-8 right-8 pointer-events-none"
                                            animate={{ opacity: swipeDir === 'right' ? 0.8 : 0 }}
                                        >
                                            <span className="text-emerald-400/80 text-sm font-medium border border-emerald-400/40 rounded-full px-4 py-2">ÁêÜËß£„Åó„Åü</span>
                                        </motion.div>

                                        {/* Card Content */}
                                        <div className="h-full flex flex-col pt-8">
                                            <div className="flex items-start justify-between mb-8">
                                                <span className="text-4xl opacity-80">{currentCard.icon}</span>
                                                <span className="text-[10px] text-white/30 tracking-widest">{levelLabels[currentCard.level]}</span>
                                            </div>
                                            <h3 className="text-xl font-medium text-platinum mb-4 tracking-wide">{currentCard.title}</h3>
                                            {/* Chart Pattern Visualization for Pro Cards */}
                                            {currentCard.pattern && (
                                                <div className="mb-4 bg-white/5 rounded-sm p-3 border border-gold/10">
                                                    <ChartPatternSVG pattern={currentCard.pattern} />
                                                </div>
                                            )}
                                            <p className="text-sm text-white/50 leading-[1.8] flex-1">{currentCard.content}</p>
                                            {currentCard.terms.length > 0 && (
                                                <div className="mt-6 pt-6 border-t border-white/5">
                                                    <div className="flex flex-wrap gap-2">
                                                        {currentCard.terms.map((t, i) => (
                                                            <span key={i} className="text-[10px] text-gold/60 border border-white/5 px-3 py-1 rounded-full">{t.word}</span>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </motion.div>
                                </AnimatePresence>
                            </div>
                        ) : (
                            <div className="h-[360px] sm:h-[420px] md:h-[480px] flex items-center justify-center glass-panel rounded-sm">
                                <div className="text-center">
                                    <p className="text-white/30 text-sm mb-4">
                                        {activeRoadmapFilter ? "„Åì„ÅÆ„É≠„Éº„Éâ„Éû„ÉÉ„Éó„ÅØÂÆå‰∫Ü„Åß„Åô" : "„Åô„Åπ„Å¶ÂÆå‰∫Ü„Åó„Åæ„Åó„Åü"}
                                    </p>
                                    {activeRoadmapFilter && (
                                        <button onClick={() => { setActiveRoadmapFilter(null); setViewMode('roadmap'); }} className="px-6 py-3 bg-gold text-black font-bold rounded-sm">
                                            „É≠„Éº„Éâ„Éû„ÉÉ„Éó„Å´Êàª„Çã
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Swipe Buttons - Enhanced Luxury */}
                        {currentCard && (
                            <div className="flex justify-center gap-20">
                                <motion.button
                                    onClick={() => handleSwipe('left')}
                                    whileHover={{ scale: 1.15, boxShadow: '0 0 30px rgba(244, 63, 94, 0.3)' }}
                                    whileTap={{ scale: 0.95 }}
                                    className="w-16 h-16 rounded-full border-2 border-white/10 text-white/50 flex items-center justify-center text-xl hover:border-rose-400/50 hover:text-rose-400 transition-colors duration-300 bg-gradient-to-br from-rose-500/5 to-transparent backdrop-blur-sm"
                                >‚úï</motion.button>
                                <motion.button
                                    onClick={() => handleSwipe('right')}
                                    whileHover={{ scale: 1.15, boxShadow: '0 0 30px rgba(52, 211, 153, 0.3)' }}
                                    whileTap={{ scale: 0.95 }}
                                    className="w-16 h-16 rounded-full border-2 border-white/10 text-white/50 flex items-center justify-center text-xl hover:border-emerald-400/50 hover:text-emerald-400 transition-colors duration-300 bg-gradient-to-br from-emerald-500/5 to-transparent backdrop-blur-sm"
                                >‚úì</motion.button>
                            </div>
                        )}

                        {/* Minimal Stats */}
                        <div className="mt-12 flex justify-center gap-12">
                            <div className="text-center">
                                <p className="text-xl font-light text-platinum/80">{understoodCards.length}</p>
                                <p className="text-[9px] text-white/20 tracking-widest uppercase mt-1">Learned</p>
                            </div>
                            <div className="text-center">
                                <p className="text-xl font-light text-white/40">{unclearCards.length}</p>
                                <p className="text-[9px] text-white/20 tracking-widest uppercase mt-1">Review</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================
        // ASSET GALLERY WITH DETAIL MODALS
        // ============================================


        const LuxuryCard = ({ asset, index, onSelect }) => {
            const [isHovered, setIsHovered] = useState(false);
            const riskColors = { 1: 'bg-emerald-500', 2: 'bg-emerald-400', 3: 'bg-amber-500', 4: 'bg-orange-500', 5: 'bg-rose-500' };
            return (
                <motion.div onClick={() => onSelect(asset)} className="relative flex-shrink-0 w-[260px] h-[420px] sm:w-[300px] sm:h-[500px] md:w-[380px] md:h-[580px] snap-center group cursor-pointer" initial={{ opacity: 0, x: 50 }} whileInView={{ opacity: 1, x: 0 }} viewport={{ once: true }} transition={{ duration: 0.8, delay: index * 0.1 }} onHoverStart={() => setIsHovered(true)} onHoverEnd={() => setIsHovered(false)}>
                    <div className="absolute inset-0 overflow-hidden rounded-sm border border-white/10 bg-ash custom-shadow transition-all duration-500 hover:border-gold/50">
                        <motion.div className="absolute inset-0 z-0 bg-obsidian" animate={{ scale: isHovered ? 1.05 : 1 }} transition={{ duration: 0.8 }}>
                            <div className="absolute inset-0 z-10 grain opacity-40 mix-blend-overlay pointer-events-none" />
                            <div className="absolute inset-0 bg-gradient-to-t from-obsidian via-transparent to-transparent z-20 opacity-90" />
                            <img src={asset.image} alt="" className="w-full h-full object-cover filter grayscale-[30%] contrast-125 opacity-60" />
                        </motion.div>
                        <div className="absolute inset-0 z-40 p-8 flex flex-col justify-between">
                            <div className="flex justify-between items-start">
                                <span className="text-xs font-bold tracking-[0.2em] text-gold/80 border border-gold/20 px-2 py-1">0{index + 1}</span>
                                <div className="flex items-center gap-1">
                                    <span className="text-[10px] text-dim">RISK</span>
                                    {[1, 2, 3, 4, 5].map(l => <div key={l} className={`w-2 h-2 rounded-full ${l <= asset.riskLevel ? riskColors[asset.riskLevel] : 'bg-stone'}`} />)}
                                </div>
                            </div>
                            <div>
                                <h3 className="text-5xl font-black tracking-tighter text-platinum mb-2">{asset.name}</h3>
                                <p className="text-sm font-bold tracking-widest text-gold mb-4 border-b border-gold/30 pb-2 inline-block">{asset.nameJp}</p>
                                <p className="text-platinum/80 text-sm leading-relaxed mb-4">{asset.tagline}</p>
                                <motion.div className="space-y-2 overflow-hidden" initial={{ height: 0, opacity: 0 }} animate={{ height: isHovered ? 'auto' : 0, opacity: isHovered ? 1 : 0 }} transition={{ duration: 0.4 }}>
                                    {asset.knowledge.map((item, i) => (<div key={i} className="flex items-start gap-2 text-xs text-platinum/70 bg-obsidian/60 p-2 rounded-sm border border-white/5"><span className="text-gold">‚óè</span>{item}</div>))}
                                    <div className="text-center pt-2 text-gold text-sm font-bold">„Çø„ÉÉ„Éó„ÅßË©≥Á¥∞„ÇíË¶ã„Çã ‚Üí</div>
                                </motion.div>
                            </div>
                        </div>
                    </div>
                </motion.div>
            );
        };

        const AssetGallery = ({ onNavigate, preSelectedAssetId, onClearPreSelection }) => {
            const [selectedAsset, setSelectedAsset] = useState(null);

            useEffect(() => {
                if (preSelectedAssetId) {
                    const asset = assetDetailData.find(a => a.id === preSelectedAssetId);
                    if (asset) setSelectedAsset(asset);
                    if (onClearPreSelection) onClearPreSelection();
                }
            }, [preSelectedAssetId, onClearPreSelection]);
            return (
                <div className="min-h-screen bg-obsidian relative flex flex-col justify-center py-20 pb-32">
                    <div className="fixed inset-0 pointer-events-none overflow-hidden">
                        <div className="absolute -top-[20%] -right-[10%] w-[1000px] h-[1000px] bg-gold/5 rounded-full blur-[150px] opacity-20" />
                        <div className="absolute bottom-[-10%] left-[-10%] w-[800px] h-[800px] bg-platinum/5 rounded-full blur-[120px] opacity-10" />
                    </div>
                    <div className="relative z-10 w-full max-w-[1400px] mx-auto">
                        <div className="px-8 md:px-16 mb-12">
                            <motion.div initial={{ opacity: 0, x: -20 }} whileInView={{ opacity: 1, x: 0 }} viewport={{ once: true }}>
                                <p className="text-dim text-xs tracking-[0.4em] mb-4 text-gold">ASSET GALLERY</p>
                                <h2 className="text-4xl md:text-6xl font-black tracking-tighter text-platinum mb-6">ÊäïË≥áÂÖà„Çí<span className="text-gold-gradient">ÈÅ∏„Å∂</span></h2>
                                <p className="text-dim max-w-xl text-sm leading-loose">„Ç´„Éº„Éâ„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ë©≥Á¥∞„ÇíÁ¢∫Ë™ç„ÄÇÂàùÂøÉËÄÖÂêë„Åë„ÅÆËß£Ë™¨‰ªò„Åç„Åß„Åô„ÄÇ</p>
                            </motion.div>
                        </div>
                        <div className="overflow-x-auto pb-16 px-4 sm:px-8 md:px-16 scrollbar-hide flex gap-4 sm:gap-8 snap-x snap-mandatory" style={{ scrollbarWidth: 'none' }}>
                            {assetDetailData.map((asset, i) => <LuxuryCard key={asset.id} asset={asset} index={i} onSelect={setSelectedAsset} />)}
                        </div>
                    </div>

                    {/* Footer Disclaimer */}
                    <footer className="w-full py-16 px-8 border-t border-white/5 bg-obsidian text-center mt-20 relative z-10">
                        <div className="max-w-4xl mx-auto space-y-6">
                            <h3 className="text-gold text-lg font-bold tracking-widest uppercase mb-4">INVISION</h3>
                            <p className="text-xs text-dim leading-loose">
                                INVISION„ÅØ„ÄÅÊäïË≥á„ÇíÂßã„ÇÅ„ÇãÂâç„Å´„ÄåËá™ÂàÜ„ÇíÁü•„Çã„Äç„Åü„ÇÅ„ÅÆ„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†„Åß„Åô„ÄÇ<br />
                                „Åì„ÅÆ„Çµ„Ç§„Éà„ÅØÂ≠¶Áøí„ÉªËá™Â∑±ÂàÜÊûê„ÇíÁõÆÁöÑ„Å®„Åó„Å¶„Åä„Çä„ÄÅÁâπÂÆö„ÅÆÂïÜÂìÅ„ÅÆË≥ºÂÖ•„ÇíÂãß„ÇÅ„Çã„ÇÇ„ÅÆ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ<br />
                                Ë®∫Êñ≠„ÇÑ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„ÅÆÁµêÊûú„ÅØ„ÅÇ„Åè„Åæ„ÅßÂèÇËÄÉÊÉÖÂ†±„Åß„ÅÇ„Çä„ÄÅÂ∞ÜÊù•„ÅÆÊàêÊûú„ÇíÁ¥ÑÊùü„Åô„Çã„ÇÇ„ÅÆ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ<br />
                                ÊäïË≥á„ÅÆÊúÄÁµÇÂà§Êñ≠„ÅØ„ÅîËá™Ë∫´„ÅÆË≤¨‰ªª„Å®„Å™„Çä„Åæ„Åô„ÄÇÂÖÉÊú¨„ÅåÊ∏õ„Çã„É™„Çπ„ÇØ„Åå„ÅÇ„Çã„Åì„Å®„Çí„ÅîÁêÜËß£„Åè„Å†„Åï„ÅÑ„ÄÇ
                            </p>
                            <p className="text-[10px] text-white/20 mt-8">
                                ¬© 2024 INVISION. All Rights Reserved. Used for demonstration purposes.
                                <br />
                                <button onClick={() => { sessionStorage.removeItem('visited'); window.location.reload(); }} className="mt-2 text-rose-500 hover:text-rose-400 underline">
                                    [Debug] Reset First Visit Status
                                </button>
                            </p>
                        </div>
                    </footer>

                    {/* Asset Detail Modal */}
                    <AnimatePresence>
                        {selectedAsset && <AssetDetailModal asset={selectedAsset} onClose={() => setSelectedAsset(null)} />}
                    </AnimatePresence>
                </div>
            );
        };

        const PortfolioCreator = ({ userProfile, onNavigate, userPlan, onUpgrade, portfolioSettings, onSave }) => {
            const hasFullAccess = userPlan === 'annual' || userPlan === 'lifetime';
            const [principal, setPrincipal] = useState(portfolioSettings?.principal || 1000000);
            const [monthly, setMonthly] = useState(portfolioSettings?.monthly || 30000);
            const [allocation, setAllocation] = useState(portfolioSettings?.allocation || userProfile?.allocation || { safe: 30, balanced: 40, growth: 30 });
            const [isSaved, setIsSaved] = useState(false);

            // Stable auto-balance logic with clamping and proper redistribution
            const updateAllocation = (type, rawValue) => {
                // Clamp the input value to 0-100
                const value = Math.max(0, Math.min(100, rawValue));
                const diff = value - allocation[type];
                if (diff === 0) return;

                const otherTypes = Object.keys(allocation).filter(k => k !== type);
                const othersTotal = otherTypes.reduce((sum, k) => sum + allocation[k], 0);

                let newAlloc = { ...allocation, [type]: value };

                if (othersTotal === 0) {
                    // If others are all 0, distribute remaining equally
                    const remaining = 100 - value;
                    otherTypes.forEach(k => newAlloc[k] = remaining / otherTypes.length);
                } else {
                    // Proportional redistribution
                    const remaining = 100 - value;
                    otherTypes.forEach(k => {
                        const ratio = allocation[k] / othersTotal;
                        newAlloc[k] = remaining * ratio;
                    });
                }

                // Clamp all values to 0-100
                Object.keys(newAlloc).forEach(k => {
                    newAlloc[k] = Math.max(0, Math.min(100, newAlloc[k]));
                });

                // Round for display
                Object.keys(newAlloc).forEach(k => newAlloc[k] = Math.round(newAlloc[k]));

                // Ensure sum is exactly 100 after rounding
                const roundedSum = Object.values(newAlloc).reduce((a, b) => a + b, 0);
                if (roundedSum !== 100) {
                    // Adjust the largest 'other' value to compensate
                    const maxOther = otherTypes.reduce((max, k) => newAlloc[k] > newAlloc[max] ? k : max, otherTypes[0]);
                    newAlloc[maxOther] += (100 - roundedSum);
                    // Final clamp
                    newAlloc[maxOther] = Math.max(0, Math.min(100, newAlloc[maxOther]));
                }

                setAllocation(newAlloc);
                setIsSaved(false);
            };

            const handleSave = () => {
                onSave({ principal, monthly, allocation });
                setIsSaved(true);
                setTimeout(() => setIsSaved(false), 3000);
            };

            useEffect(() => {
                setIsSaved(false);
            }, [principal, monthly]);

            const projection = useMemo(() => {
                // More realistic return assumptions: Safe 0.5% (Deposits/Bonds), Balanced 4% (Global/Balance), Growth 7% (Stocks)
                // Inflation is not adjusted here for simplicity, but nominal returns are set more conservatively.
                const r = ((allocation.safe * 0.5) + (allocation.balanced * 4.0) + (allocation.growth * 7.0)) / 100; // Weighted Return
                const data = [];
                let currentAmount = principal;
                for (let i = 0; i <= 20; i++) {
                    data.push({ year: i, amount: Math.round(currentAmount) });
                    currentAmount = currentAmount * (1 + r / 100) + (monthly * 12);
                }
                return data;
            }, [allocation, principal, monthly]);

            return (
                <div className="min-h-screen bg-obsidian pt-28 pb-32 px-4 sm:px-8 relative overflow-hidden">
                    {/* Atmospheric Background - Matching AssetGallery */}
                    <div className="fixed inset-0 pointer-events-none overflow-hidden">
                        <div className="absolute -top-[20%] -right-[10%] w-[1000px] h-[1000px] bg-gold/5 rounded-full blur-[150px] opacity-20" />
                        <div className="absolute bottom-[-10%] left-[-10%] w-[800px] h-[800px] bg-platinum/5 rounded-full blur-[120px] opacity-10" />
                    </div>

                    <div className="max-w-6xl mx-auto relative z-10">
                        <div className="mb-16">
                            <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }}>
                                <div className="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-6">
                                    <h2 className="text-4xl md:text-6xl font-black tracking-tighter text-platinum">Êú™Êù•„Çí<span className="text-gold-gradient">Ë®≠Ë®à</span>„Åô„Çã</h2>
                                    <button
                                        onClick={handleSave}
                                        className={`px-4 py-2 rounded-sm font-bold text-xs transition-all duration-300 flex items-center gap-2 border ${isSaved
                                            ? 'bg-white/10 border-white/20 text-platinum'
                                            : 'bg-white/5 text-dim border-white/10 hover:bg-white/10 hover:text-platinum'
                                            }`}
                                    >
                                        {isSaved ? (
                                            <>
                                                <span className="text-sm">‚úì</span> ‰øùÂ≠òÊ∏à„Åø
                                            </>
                                        ) : (
                                            "‰øùÂ≠ò"
                                        )}
                                    </button>
                                </div>
                                <p className="text-dim text-sm max-w-xl leading-loose">Ëá™Â∑±ÂàÜÊûê„Å®ÊäïË≥áÁü•Ë≠ò„ÅÆÂ≠¶Áøí„Çí„ÇÇ„Å®„Å´„ÄÅË≥áÁî£ÈÖçÂàÜ„ÅÆËÄÉ„ÅàÊñπ„ÇíÂ≠¶„Å≥„Åæ„Åô„ÄÇ<br />‚Äª „Åì„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„ÅØÂ≠¶ÁøíÁõÆÁöÑ„ÅÆÂèÇËÄÉÂÄ§„Åß„ÅÇ„Çä„ÄÅÂÆüÈöõ„ÅÆÈÅãÁî®ÁµêÊûú„Çí‰øùË®º„Åô„Çã„ÇÇ„ÅÆ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                            </motion.div>
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-16">
                            {/* Controls Panel */}
                            <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.1 }} className="space-y-8">
                                {/* Compact Investment Inputs Row */}
                                <div className="bg-gradient-to-br from-ash/80 to-ash/40 backdrop-blur-sm border border-white/5 rounded-sm p-6 custom-shadow hover:border-gold/30 transition-all duration-500 group">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                        {/* Initial Investment */}
                                        <div>
                                            <label className="block text-[9px] text-gold uppercase tracking-[0.15em] mb-2 font-bold">
                                                ÂàùÊúüÊäïË≥áÈ°ç
                                            </label>
                                            <div className="flex items-center gap-2">
                                                <span className="text-lg text-gold font-serif italic">¬•</span>
                                                <input type="number" value={principal} onChange={e => setPrincipal(Number(e.target.value))}
                                                    className="w-full bg-transparent border-b border-white/10 text-2xl font-serif text-platinum placeholder-dim focus:border-gold outline-none transition-all tracking-wider text-right py-1" />
                                            </div>
                                        </div>
                                        {/* Monthly Contribution */}
                                        <div>
                                            <label className="block text-[9px] text-gold uppercase tracking-[0.15em] mb-2 font-bold">
                                                ÊØéÊúà„ÅÆÁ©çÁ´ãÈ°ç
                                            </label>
                                            <div className="flex items-center gap-2">
                                                <span className="text-lg text-gold font-serif italic">¬•</span>
                                                <input type="number" value={monthly} onChange={e => setMonthly(Number(e.target.value))}
                                                    className="w-full bg-transparent border-b border-white/10 text-2xl font-serif text-platinum placeholder-dim focus:border-gold outline-none transition-all tracking-wider text-right py-1" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gradient-to-br from-ash/80 to-ash/40 backdrop-blur-sm border border-white/5 rounded-sm p-10 space-y-10 custom-shadow">
                                    <div className="flex justify-between items-end mb-6">
                                        <label className="text-[10px] text-gold uppercase tracking-[0.2em] font-bold">„Ç¢„É≠„Ç±„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö</label>
                                        <span className="text-xs text-dim">ALLOCATION</span>
                                    </div>

                                    {/* Safe */}
                                    <div className="group">
                                        <div className="flex justify-between mb-3 border-l-2 border-emerald-500 pl-3 transition-all group-hover:border-l-4">
                                            <span className="text-platinum font-bold text-lg">ÂÆà„Çä</span>
                                            <span className="text-emerald-400 font-mono text-xl">{allocation.safe}%</span>
                                        </div>
                                        <input type="range" min="0" max="100" value={allocation.safe} onChange={(e) => updateAllocation('safe', Number(e.target.value))}
                                            className="w-full h-1 bg-stone/50 rounded-lg appearance-none cursor-pointer accent-emerald-500 hover:h-2 transition-all" />
                                        <p className="text-xs text-dim mt-2 pl-3">ÂõΩÂÇµ„ÉªÁèæÈáë„Å™„Å©„ÄÇ‰Ωé„É™„Çπ„ÇØ„ÅßÁùÄÂÆü„Å™ÈÅãÁî®„ÄÇ</p>
                                    </div>

                                    {/* Balanced */}
                                    <div className="group">
                                        <div className="flex justify-between mb-3 border-l-2 border-amber-500 pl-3 transition-all group-hover:border-l-4">
                                            <span className="text-platinum font-bold text-lg">„Éê„É©„É≥„Çπ</span>
                                            <span className="text-amber-500 font-mono text-xl">{allocation.balanced}%</span>
                                        </div>
                                        <input type="range" min="0" max="100" value={allocation.balanced} onChange={(e) => updateAllocation('balanced', Number(e.target.value))}
                                            className="w-full h-1 bg-stone/50 rounded-lg appearance-none cursor-pointer accent-amber-500 hover:h-2 transition-all" />
                                        <p className="text-xs text-dim mt-2 pl-3">ÊäïË≥á‰ø°Ë®ó„ÉªREIT„Å™„Å©„ÄÇÊàêÈï∑„Å®ÂÆâÂÆö„ÅÆ„Éê„É©„É≥„Çπ„ÄÇ</p>
                                    </div>

                                    {/* Growth */}
                                    <div className="group">
                                        <div className="flex justify-between mb-3 border-l-2 border-rose-500 pl-3 transition-all group-hover:border-l-4">
                                            <span className="text-platinum font-bold text-lg">Êîª„ÇÅ</span>
                                            <span className="text-rose-500 font-mono text-xl">{allocation.growth}%</span>
                                        </div>
                                        <input type="range" min="0" max="100" value={allocation.growth} onChange={(e) => updateAllocation('growth', Number(e.target.value))}
                                            className="w-full h-1 bg-stone/50 rounded-lg appearance-none cursor-pointer accent-rose-500 hover:h-2 transition-all" />
                                        <p className="text-xs text-dim mt-2 pl-3">Ê†™Âºè„Éª‰ªÆÊÉ≥ÈÄöË≤®„Å™„Å©„ÄÇÈ´ò„ÅÑ„É™„Çø„Éº„É≥„ÇíÁãô„ÅÜ„ÄÇ</p>
                                    </div>
                                </div>
                            </motion.div>

                            {/* Visualization */}
                            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="space-y-8">
                                {/* Pie Chart */}
                                <div className="bg-gradient-to-br from-ash/80 to-ash/40 backdrop-blur-sm border border-white/5 rounded-sm p-8 flex flex-col items-center justify-center relative min-h-[400px] custom-shadow hover:border-gold/30 transition-all duration-500 group">
                                    <div className="relative w-64 h-64 rounded-full custom-shadow"
                                        style={{
                                            background: `conic-gradient(
                                                #10b981 0% ${allocation.safe}%, 
                                                #f59e0b ${allocation.safe}% ${allocation.safe + allocation.balanced}%, 
                                                #f43f5e ${allocation.safe + allocation.balanced}% 100%
                                            )`
                                        }}>
                                        <div className="absolute inset-4 bg-ash rounded-full flex flex-col items-center justify-center">
                                            <span className="text-dim text-xs tracking-widest uppercase">PORTFOLIO</span>
                                            <span className="text-3xl font-black text-platinum">100%</span>
                                        </div>
                                    </div>

                                    {/* Legend */}
                                    <div className="flex gap-8 mt-8">
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-emerald-500 rounded-full" /><span className="text-sm text-platinum">ÂÆà„Çä</span></div>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-amber-500 rounded-full" /><span className="text-sm text-platinum">„Éê„É©„É≥„Çπ</span></div>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-rose-500 rounded-full" /><span className="text-sm text-platinum">Êîª„ÇÅ</span></div>
                                    </div>
                                </div>

                                {/* Projection */}
                                <div className="bg-ash/50 border border-white/10 rounded-sm p-8 relative overflow-hidden group">
                                    <div className={`relative transition-all duration-500 ${!hasFullAccess ? 'filter blur-sm opacity-50 grayscale-[0.5]' : ''}`}>
                                        <h3 className="text-lg font-bold text-platinum mb-2">Ë≥áÁî£Êé®Áßª„Ç§„É°„Éº„Ç∏ÔºàÂèÇËÄÉÂÄ§Ôºâ</h3>
                                        <p className="text-[10px] text-dim mb-6">‚Äª ‰ª•‰∏ã„ÅØÈÅéÂéª„ÅÆÂπ≥Âùá„É™„Çø„Éº„É≥„Å´Âü∫„Å•„Åè‰ªÆÊÉ≥„ÅÆË®àÁÆó‰æã„Åß„ÅÇ„Çä„ÄÅÂ∞ÜÊù•„ÅÆÈÅãÁî®ÁµêÊûú„Çí‰øùË®º„Åô„Çã„ÇÇ„ÅÆ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                                        <div className="flex items-end justify-between mb-8">
                                            <div>
                                                <p className="text-xs text-dim mb-1">ÁèæÂú®„ÅÆÂÖÉÈáë</p>
                                                <p className="text-xl font-mono text-platinum">¬•{principal.toLocaleString()}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xs text-gold mb-1">ÂèÇËÄÉÂÄ§Ôºà‰∏çÁ¢∫ÂÆüÔºâ</p>
                                                <p className="text-4xl font-black text-gold">¬•{projection[20].amount.toLocaleString()}</p>
                                                <p className="text-xs text-emerald-400">+{((projection[20].amount - (principal + monthly * 12 * 20)) / (principal + monthly * 12 * 20) * 100).toFixed(0)}% return</p>
                                            </div>
                                        </div>

                                        {/* Simple Bar Chart */}
                                        <div className="flex items-end gap-1 h-32 md:gap-2">
                                            {projection.map((p, i) => (
                                                <div key={i} className="flex-1 bg-gradient-to-t from-gold/20 to-gold/60 rounded-t-sm relative group"
                                                    style={{ height: `${(p.amount / projection[20].amount) * 100}%` }}>
                                                    <div className="absolute bottom-0 left-0 right-0 h-[1px] bg-gold/50" />
                                                </div>
                                            ))}
                                        </div>
                                        <div className="flex justify-between text-[10px] text-dim mt-2">
                                            <span>Now</span>
                                            <span>10 Years</span>
                                            <span>20 Years</span>
                                        </div>
                                    </div>

                                    {/* Pro Overlay */}
                                    {!hasFullAccess && (
                                        <div className="absolute inset-0 z-20 flex flex-col items-center justify-center p-6 text-center">
                                            <div className="bg-black/40 backdrop-blur-md border border-gold/30 p-8 rounded-sm max-w-sm w-full shadow-2xl">
                                                <p className="text-gold text-[10px] tracking-[0.3em] uppercase mb-4">PREMIUM INSIGHT</p>
                                                <h3 className="text-xl font-serif text-platinum mb-6 leading-relaxed">
                                                    „Ç¢„É≠„Ç±„Éº„Ç∑„Éß„É≥„ÅÆËÄÉ„ÅàÊñπ„Çí<br />
                                                    <span className="text-gold-gradient">Ê∑±„Åè</span>Â≠¶„Å∂„ÄÇ
                                                </h3>
                                                <button onClick={onUpgrade} className="group relative px-8 py-3 bg-transparent overflow-hidden rounded-sm border border-gold/50 transition-all hover:border-gold">
                                                    <div className="absolute inset-0 w-0 bg-gold/10 transition-all duration-[250ms] ease-out group-hover:w-full opacity-0 group-hover:opacity-100"></div>
                                                    <span className="relative text-xs tracking-widest text-gold font-medium group-hover:text-white transition-colors">UNLOCK PRO</span>
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Recommended Brokers based on Allocation */}
                                <div className="mt-8 pt-8 border-t border-white/10">
                                    <h3 className="text-sm font-bold text-platinum mb-4 flex items-center gap-2">
                                        <span>üè¶</span> „Åì„ÅÆ„Éù„Éº„Éà„Éï„Ç©„É™„Ç™„Å∏„ÅÆÂèÇËÄÉÂè£Â∫ß
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {(() => {
                                            const recs = [];
                                            // Base recommendation
                                            recs.push({ name: 'SBIË®ºÂà∏', desc: 'Á∑èÂêàÂäõNo.1„ÉªÂàùÂøÉËÄÖ„Å´ÊúÄÈÅ©', url: 'https://www.sbisec.co.jp/' });

                                            // Dynamic recommendations based on allocation
                                            if (allocation.growth >= 40) {
                                                recs.push({ name: '„Éû„Éç„ÉÉ„ÇØ„ÇπË®ºÂà∏', desc: 'Á±≥ÂõΩÊ†™„ÉªÂàÜÊûêÊ©üËÉΩ„ÅåÂÖÖÂÆü', url: 'https://www.monex.co.jp/' });
                                                recs.push({ name: 'DMMÊ†™', desc: 'Á±≥ÂõΩÊ†™ÂèñÂºïÊâãÊï∞Êñô„ÅåÂúßÂÄíÁöÑ', url: 'https://kabu.dmm.com/' });
                                                recs.push({ name: 'GMO„ÇØ„É™„ÉÉ„ÇØË®ºÂà∏', desc: 'È´òÊ©üËÉΩ„ÉÑ„Éº„É´„ÉªCFDÂØæÂøú', url: 'https://www.click-sec.com/' });
                                            } else if (allocation.safe >= 50) {
                                                recs.push({ name: 'Ê•ΩÂ§©Ë®ºÂà∏', desc: '„Éù„Ç§„É≥„ÉàÊäïË≥á„ÉªË¶ã„ÇÑ„Åô„ÅÑÁîªÈù¢', url: 'https://www.rakuten-sec.co.jp/' });
                                                recs.push({ name: 'WealthNavi', desc: 'ÂÖ®Ëá™Âãï„Åß„Åä„Åæ„Åã„ÅõË≥áÁî£ÈÅãÁî®', url: 'https://www.wealthnavi.com/' });
                                                recs.push({ name: 'PayPayË®ºÂà∏', desc: '„Çπ„Éû„Éõ„Åß1000ÂÜÜ„Åã„ÇâÊâãËªΩ„Å´', url: 'https://www.paypay-sec.co.jp/' });
                                            } else {
                                                // Balanced
                                                recs.push({ name: 'Ê•ΩÂ§©Ë®ºÂà∏', desc: '„Éù„Ç§„É≥„ÉàÊäïË≥á„ÉªNISAÂØæÂøú', url: 'https://www.rakuten-sec.co.jp/' });
                                                recs.push({ name: 'au„Ç´„Éñ„Ç≥„É†Ë®ºÂà∏', desc: 'Ponta„Éù„Ç§„É≥„Éà„Éª„ÇØ„É¨„Ç´Á©çÁ´ã', url: 'https://kabu.com/' });
                                                recs.push({ name: 'PayPayË®ºÂà∏', desc: '„Çπ„Éû„Éõ„ÅßÂ∞ëÈ°ç„Åã„ÇâÈñãÂßã', url: 'https://www.paypay-sec.co.jp/' });
                                            }

                                            return recs.slice(0, 4).map((b, i) => (
                                                <a key={i} href={b.url} target="_blank" rel="noopener noreferrer"
                                                    className="bg-ash/50 border border-white/5 p-4 rounded-sm hover:border-gold/30 hover:bg-white/5 transition-all flex justify-between items-center group">
                                                    <div>
                                                        <p className="font-bold text-platinum group-hover:text-gold transition-colors text-sm">{b.name}</p>
                                                        <p className="text-[10px] text-dim">{b.desc}</p>
                                                    </div>
                                                    <span className="text-gold opacity-0 group-hover:opacity-100 transition-opacity translate-x-[-10px] group-hover:translate-x-0 duration-300">‚Üí</span>
                                                </a>
                                            ));
                                        })()}
                                    </div>
                                    <p className="text-[10px] text-dim mt-3">‚Äª „É™„É≥„ÇØÂÖà„ÅØÂêÑË®ºÂà∏‰ºöÁ§æ„ÅÆÂÖ¨Âºè„Çµ„Ç§„Éà„Åß„Åô„ÄÇ</p>
                                </div>
                            </motion.div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================
        // BROKER COMPARISON PAGE
        // ============================================
        const BrokerComparison = ({ onNavigate }) => {
            const [selectedCategory, setSelectedCategory] = useState('all');
            const [selectedBroker, setSelectedBroker] = useState(null);
            const [tipsOpen, setTipsOpen] = useState(false);

            const brokers = [
                {
                    id: 'sbi',
                    name: 'SBIË®ºÂà∏',
                    category: 'general',
                    logo: 'üè¶',
                    tagline: 'ÂπÖÂ∫É„ÅÑÂïÜÂìÅ„É©„Ç§„É≥„Éä„ÉÉ„Éó',
                    ratings: { fees: 5, products: 5, ease: 3, support: 3, tools: 4 },
                    features: ['ÂõΩÂÜÖÊ†™ÂèñÂºïÊâãÊï∞Êñô0ÂÜÜ„Éó„É©„É≥„ÅÇ„Çä', 'NISA„ÉªiDeCoÂØæÂøú', 'Á±≥ÂõΩÊ†™„ÉªÊäïË≥á‰ø°Ë®óÂÖÖÂÆü', 'T„Éù„Ç§„É≥„Éà/V„Éù„Ç§„É≥„ÉàÈÄ£Êê∫'],
                    fees: { stock: '0ÂÜÜ„Äú', fund: '0ÂÜÜ„Äú', us: '0.495%' },
                    pros: ['ÂïÜÂìÅÊï∞„ÅåË±äÂØå', 'IPOÂèñÊâ±„ÅÑ„ÅåÂ§ö„ÅÑ', '„ÇØ„É¨„Ç´Á©çÁ´ãÂØæÂøú'],
                    cons: ['„Çµ„Ç§„Éà„ÅåË§áÈõë', '„Ç¢„Éó„É™„ÅåÂàÜÊï£'],
                    bestFor: ['ÂπÖÂ∫É„ÅÑÂïÜÂìÅ„ÇíÊâ±„ÅÑ„Åü„ÅÑÊñπ', 'Á±≥ÂõΩÊ†™„Å´ËààÂë≥„Åå„ÅÇ„ÇãÊñπ'],
                    url: 'https://www.sbisec.co.jp/'
                },
                {
                    id: 'rakuten',
                    name: 'Ê•ΩÂ§©Ë®ºÂà∏',
                    category: 'general',
                    logo: 'üõí',
                    tagline: 'Ê•ΩÂ§©ÁµåÊ∏àÂúè„Å®„ÅÆÈÄ£Êê∫',
                    ratings: { fees: 5, products: 4, ease: 5, support: 3, tools: 4 },
                    features: ['Ê•ΩÂ§©„Éù„Ç§„É≥„ÉàÊäïË≥á', 'Ê•ΩÂ§©„Ç´„Éº„ÉâÁ©çÁ´ã„ÅßÈÇÑÂÖÉ', 'Ê•ΩÂ§©ÈäÄË°åÈÄ£Êê∫„ÅßÈáëÂà©ÂÑ™ÈÅá', 'Êó•Áµå„ÉÜ„É¨„Ç≥„É≥ÁÑ°Êñô'],
                    fees: { stock: '0ÂÜÜ„Äú', fund: '0ÂÜÜ„Äú', us: '0.495%' },
                    pros: ['Ê•ΩÂ§©„Éù„Ç§„É≥„Éà„Åå‰Ωø„Åà„Çã', '„Ç¢„Éó„É™„Åå‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑ', '„Éû„Éç„Éº„Éñ„É™„ÉÉ„Ç∏„ÅßÈáëÂà©UP'],
                    cons: ['„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉÁéá„ÅåÂ§âÂãï', 'Ê•ΩÂ§©ÂúèÂ§ñ„Å†„Å®„É°„É™„ÉÉ„ÉàËñÑ'],
                    bestFor: ['Ê•ΩÂ§©„É¶„Éº„Ç∂„Éº', '„Éù„Ç§„É≥„ÉàÊäïË≥á„Çí„Åó„Åü„ÅÑÊñπ'],
                    url: 'https://www.rakuten-sec.co.jp/'
                },
                {
                    id: 'matsui',
                    name: 'Êùæ‰∫ïË®ºÂà∏',
                    category: 'general',
                    logo: 'üèØ',
                    tagline: 'ËÄÅËàó„ÅÆÂÆâÂøÉÊÑü„Å®„Çµ„Éù„Éº„Éà',
                    ratings: { fees: 4, products: 3, ease: 4, support: 5, tools: 3 },
                    features: ['50‰∏áÂÜÜ„Åæ„ÅßÊâãÊï∞ÊñôÁÑ°Êñô', 'ÈõªË©±„Çµ„Éù„Éº„ÉàÂÖÖÂÆü', 'Ê†™‰∏ªÂÑ™ÂæÖÊ§úÁ¥¢„ÉÑ„Éº„É´', 'ÊäïË≥á‰ø°Ë®ó100ÂÜÜ„Åã„Çâ'],
                    fees: { stock: '0ÂÜÜÔºà50‰∏á„Åæ„ÅßÔºâ', fund: '0ÂÜÜ„Äú', us: '0.495%' },
                    pros: ['„Çµ„Éù„Éº„Éà„ÅåÊâãÂéö„ÅÑ', 'ÂàùÂøÉËÄÖÂêë„Åë„ÉÑ„Éº„É´ÂÖÖÂÆü', '25Ê≠≥‰ª•‰∏ãÊâãÊï∞ÊñôÁÑ°Êñô'],
                    cons: ['Á±≥ÂõΩÊ†™„ÅÆ„É©„Ç§„É≥„Éä„ÉÉ„Éó„ÅåÂ∞ë„Å™„ÅÑ', '„Éù„Ç§„É≥„ÉàÂà∂Â∫¶„ÅåÂº±„ÅÑ'],
                    bestFor: ['„Çµ„Éù„Éº„ÉàÈáçË¶ñ„ÅÆÊñπ', 'Ê†™‰∏ªÂÑ™ÂæÖ„Å´ËààÂë≥„Åå„ÅÇ„ÇãÊñπ'],
                    url: 'https://www.matsui.co.jp/'
                },
                {
                    id: 'monex',
                    name: '„Éû„Éç„ÉÉ„ÇØ„ÇπË®ºÂà∏',
                    category: 'general',
                    logo: 'üìä',
                    tagline: 'Á±≥ÂõΩÊ†™„ÉªÂàÜÊûê„ÉÑ„Éº„É´„Å´Âº∑„Åø',
                    ratings: { fees: 3, products: 5, ease: 3, support: 3, tools: 5 },
                    features: ['Á±≥ÂõΩÊ†™ÂèñÊâ±„ÅÑÈäòÊüÑÊï∞„ÅåÂ§ö„ÅÑ', 'ÈäòÊüÑ„Çπ„Ç´„Ç¶„Çø„ÉºÁÑ°Êñô', 'd„Éù„Ç§„É≥„ÉàÈÄ£Êê∫', '„ÉØ„É≥Ê†™„Åß1Ê†™ÊäïË≥á'],
                    fees: { stock: '50‰∏á„Åæ„Åß0ÂÜÜ', fund: '0ÂÜÜ„Äú', us: 'Á¥ÑÂÆö‰ª£Èáë„ÅÆ0.495%' },
                    pros: ['Á±≥ÂõΩÊ†™„Å´Âº∑„ÅÑ', 'ÂàÜÊûê„ÉÑ„Éº„É´„ÅåÂÖÖÂÆü', 'IPOÊäΩÈÅ∏„ÅåÂπ≥Á≠â'],
                    cons: ['ÂõΩÂÜÖÊ†™ÊâãÊï∞Êñô„Åå„ÇÑ„ÇÑÈ´ò„ÇÅ', '„Ç¢„Éó„É™„ÅÆÊìç‰ΩúÊÄß'],
                    bestFor: ['Á±≥ÂõΩÊ†™„É°„Ç§„É≥„ÅÆÊñπ', 'ÈäòÊüÑÂàÜÊûê„Çí„Åó„Åü„ÅÑÊñπ'],
                    url: 'https://www.monex.co.jp/'
                },
                {
                    id: 'au',
                    name: 'au„Ç´„Éñ„Ç≥„É†Ë®ºÂà∏',
                    category: 'general',
                    logo: 'üì±',
                    tagline: 'au„É¶„Éº„Ç∂„ÉºÂêë„ÅëÁâπÂÖ∏ÂÖÖÂÆü',
                    ratings: { fees: 4, products: 4, ease: 4, support: 3, tools: 3 },
                    features: ['Ponta„Éù„Ç§„É≥„ÉàÊäïË≥á', 'au PAY„Ç´„Éº„ÉâÁ©çÁ´ã', '„Éó„ÉÅÊ†™„Åß1Ê†™ÊäïË≥á', 'NISAÊâãÊï∞ÊñôÁÑ°Êñô'],
                    fees: { stock: '0ÂÜÜÔºàÊù°‰ª∂„ÅÇ„ÇäÔºâ', fund: '0ÂÜÜ„Äú', us: '0.495%' },
                    pros: ['Ponta„Éù„Ç§„É≥„Éà„ÅåË≤Ø„Åæ„Çã', 'au„É¶„Éº„Ç∂„ÉºÂÑ™ÈÅá', '„Éó„ÉÅÊ†™„ÅåÊâãËªΩ'],
                    cons: ['auÂúèÂ§ñ„Å†„Å®„É°„É™„ÉÉ„ÉàËñÑ', 'Á±≥ÂõΩÊ†™„ÅØÁÇ∫Êõø„Çπ„Éó„É¨„ÉÉ„Éâ„ÅÇ„Çä'],
                    bestFor: ['au„É¶„Éº„Ç∂„Éº', 'Ponta„Éù„Ç§„É≥„Éà„ÇíÊ¥ªÁî®„Åó„Åü„ÅÑÊñπ'],
                    url: 'https://kabu.com/'
                },
                {
                    id: 'paypay',
                    name: 'PayPayË®ºÂà∏',
                    category: 'mobile',
                    logo: 'üì±',
                    tagline: '„Çπ„Éû„Éõ„Åß1000ÂÜÜ„Åã„ÇâÊäïË≥á',
                    ratings: { fees: 3, products: 3, ease: 5, support: 3, tools: 3 },
                    features: ['1000ÂÜÜ„Åã„ÇâÊ†™Ë≥ºÂÖ•', 'PayPay„Éú„Éº„Éä„ÇπÈÅãÁî®', 'Á±≥ÂõΩÊ†™„ÇÇÈáëÈ°çÊåáÂÆö', '„Éû„É≥„Ç¨„ÅßÂ≠¶„Å∂ÊäïË≥á'],
                    fees: { stock: 'ÈáëÈ°çÊåáÂÆö', fund: '0ÂÜÜ„Äú', us: 'ÈáëÈ°çÊåáÂÆö' },
                    pros: ['Â∞ëÈ°ç„Åã„ÇâÂßã„ÇÅ„Çâ„Çå„Çã', 'PayPayÈÄ£Êê∫', '„Ç¢„Éó„É™„ÅåË∂Ö„Ç∑„É≥„Éó„É´'],
                    cons: ['ÊåáÂÄ§Ê≥®Êñá‰∏çÂèØ', 'ÂèñÊâ±ÈäòÊüÑ„ÅåÈôêÂÆöÁöÑ'],
                    bestFor: ['ÊäïË≥áÂàùÂøÉËÄÖ', 'Â∞ëÈ°ç„ÅßË©¶„Åó„Åü„ÅÑÊñπ'],
                    url: 'https://www.paypay-sec.co.jp/'
                },
                {
                    id: 'gmo',
                    name: 'GMO„ÇØ„É™„ÉÉ„ÇØË®ºÂà∏',
                    category: 'trader',
                    logo: 'üíª',
                    tagline: 'Ê•≠ÁïåÊúÄÂÆâÂÄ§Ê∞¥Ê∫ñ„ÅÆÊâãÊï∞Êñô',
                    ratings: { fees: 5, products: 4, ease: 3, support: 3, tools: 5 },
                    features: ['ÊâãÊï∞Êñô„ÅåÂÆâ„ÅÑ', 'È´òÊ©üËÉΩ„ÉÑ„Éº„É´„Äå„ÅØ„Å£„Å°„ÇÖ„ÅÜÂêõ„Äç', 'CFD/FXÊúÄÂº∑', 'APIÁí∞Â¢ÉÂÖÖÂÆü'],
                    fees: { stock: 'Ê•≠ÁïåÊúÄÂÆâ', fund: '0ÂÜÜ„Äú', us: 'Ê•≠ÁïåÊúÄÂÆâÊ∞¥Ê∫ñ' },
                    pros: ['„Ç≥„Çπ„Éà„Åå‰Ωé„ÅÑ', '„Éà„É¨„Éº„Éá„Ç£„É≥„Ç∞„ÉÑ„Éº„É´„ÅåÈ´òÊÄßËÉΩ', 'CFD„ÅåÂÖÖÂÆü'],
                    cons: ['ÂàùÂøÉËÄÖ„Å´„ÅØ„ÉÑ„Éº„É´„ÅåÈõ£„Åó„ÅÑ„Åã„ÇÇ', 'ÊäïË≥á‰ø°Ë®ó„ÅØÂ∞ë„Å™„ÇÅ'],
                    bestFor: ['„Ç≥„Çπ„ÉàÈáçË¶ñ„ÅÆÊñπ', '„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éà„É¨„Éº„ÉÄ„Éº'],
                    url: 'https://www.click-sec.com/'
                },
                {
                    id: 'dmm',
                    name: 'DMMÊ†™',
                    category: 'general',
                    logo: '‚ö°',
                    tagline: 'Á±≥ÂõΩÊ†™ÊâãÊï∞Êñô0ÂÜÜ„Äú',
                    ratings: { fees: 5, products: 3, ease: 4, support: 3, tools: 4 },
                    features: ['Á±≥ÂõΩÊ†™ÂèñÂºïÊâãÊï∞Êñô0ÂÜÜ', 'DMM„Éù„Ç§„É≥„ÉàÈÄ£Êê∫', 'ÊúÄÁü≠Âç≥Êó•Âè£Â∫ßÈñãË®≠', '„É¢„Éº„ÉâÂàáÊõø„Ç¢„Éó„É™'],
                    fees: { stock: 'Ê•≠ÁïåÊúÄÂÆâÊ∞¥Ê∫ñ', fund: '-', us: '0ÂÜÜ' },
                    pros: ['Á±≥ÂõΩÊ†™„Ç≥„Çπ„Éà„ÅåÂúßÂÄíÁöÑ', '„Ç¢„Éó„É™„Åå‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑÔºà„Åã„Çì„Åü„Çì/„Éé„Éº„Éû„É´Ôºâ', 'Âè£Â∫ßÈñãË®≠„ÅåÊó©„ÅÑ'],
                    cons: ['ÊäïË≥á‰ø°Ë®ó„ÅÆÊâ±„ÅÑ„ÅåÂ∞ë„Å™„ÅÑ', 'NISA„ÅÆÈÅ∏ÊäûËÇ¢„ÅåÂ∞ë„Å™„ÇÅ'],
                    bestFor: ['Á±≥ÂõΩÊ†™„É°„Ç§„É≥„ÅÆÊñπ', 'ÊâãÊï∞Êñô„ÇíÊäë„Åà„Åü„ÅÑÊñπ'],
                    url: 'https://kabu.dmm.com/'
                },
                {
                    id: 'wealthnavi',
                    name: 'WealthNavi',
                    category: 'robo',
                    logo: 'ü§ñ',
                    tagline: 'ÂÖ®Ëá™Âãï„ÅÆ„Åä„Åæ„Åã„ÅõË≥áÁî£ÈÅãÁî®',
                    ratings: { fees: 2, products: 3, ease: 5, support: 4, tools: 4 },
                    features: ['„É≠„Éú„Ç¢„Éâ„Éê„Ç§„Ç∂„Éº', 'Ëá™Âãï„É™„Éê„É©„É≥„Çπ', 'Á®éÈáëÊúÄÈÅ©ÂåñÊ©üËÉΩ', 'NISA„Å´„ÇÇÂØæÂøú'],
                    fees: { stock: '-', fund: '-', us: 'Âπ¥Áéá1.1%ÔºàÁ®éËæºÔºâ' },
                    pros: ['ÂÆåÂÖ®Ëá™Âãï„ÅßÊâãÈñì„Å™„Åó', '„É™„Éê„É©„É≥„Çπ‰∏çË¶Å', 'ÂàùÂøÉËÄÖ„Åß„ÇÇÂÆâÂøÉ'],
                    cons: ['ÊâãÊï∞Êñô„ÅåÊØîËºÉÁöÑÈ´ò„ÅÑ', 'Ëá™ÂàÜ„ÅßÈäòÊüÑ„ÇíÈÅ∏„Åπ„Å™„ÅÑ'],
                    bestFor: ['ÊäïË≥á„Å´ÊôÇÈñì„Çí„Åã„Åë„Åü„Åè„Å™„ÅÑÊñπ', 'ÂÆåÂÖ®„Åä„Åæ„Åã„Åõ„ÇíÂ∏åÊúõ„Åô„ÇãÊñπ'],
                    url: 'https://www.wealthnavi.com/'
                },
                {
                    id: 'bitflyer',
                    name: 'bitFlyer',
                    category: 'crypto',
                    logo: '‚Çø',
                    tagline: 'ÂõΩÂÜÖÂ§ßÊâã„ÅÆ‰ªÆÊÉ≥ÈÄöË≤®ÂèñÂºïÊâÄ',
                    ratings: { fees: 3, products: 3, ease: 4, support: 4, tools: 3 },
                    features: ['„Éì„ÉÉ„Éà„Ç≥„Ç§„É≥ÂèñÊâ±„ÅÑ', 'T„Éù„Ç§„É≥„ÉàÈÄ£Êê∫', 'Á©çÁ´ã„Çµ„Éº„Éì„Çπ', 'bitFlyer„ÇØ„É¨„Ç´'],
                    fees: { stock: '-', fund: '-', us: '„Çπ„Éó„É¨„ÉÉ„ÉâÔºàÂ§âÂãïÔºâ' },
                    pros: ['„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Å´Ê≥®Âäõ', '1ÂÜÜ„Åã„ÇâË≥ºÂÖ•ÂèØËÉΩ', '„Éù„Ç§„É≥„ÉàÊäïË≥áÂØæÂøú'],
                    cons: ['ÊâãÊï∞Êñô„ÅåÈ´ò„ÇÅ', '„Ç¢„É´„Éà„Ç≥„Ç§„É≥Êï∞„ÅåÂ∞ë„Å™„ÇÅ'],
                    bestFor: ['‰ªÆÊÉ≥ÈÄöË≤®ÂàùÂøÉËÄÖ', '„Éì„ÉÉ„Éà„Ç≥„Ç§„É≥„ÇíÂßã„ÇÅ„Åü„ÅÑÊñπ'],
                    url: 'https://bitflyer.com/'
                },
                {
                    id: 'coincheck',
                    name: 'Coincheck',
                    category: 'crypto',
                    logo: 'ü™ô',
                    tagline: '„Ç∑„É≥„Éó„É´„Åß‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑUI',
                    ratings: { fees: 3, products: 4, ease: 5, support: 3, tools: 3 },
                    features: ['„Ç∑„É≥„Éó„É´„Å™„Ç¢„Éó„É™', '„Å§„Åø„Åü„Å¶Ê©üËÉΩ', 'NFTÂèñÊâ±„ÅÑ', 'ÈõªÊ∞ó‰ª£„ÇíBTC„Åß'],
                    fees: { stock: '-', fund: '-', us: '„Çπ„Éó„É¨„ÉÉ„ÉâÔºàÂ§âÂãïÔºâ' },
                    pros: ['„Ç¢„Éó„É™„Åå‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑ', 'ÈäòÊüÑÊï∞„ÅåÂ§ö„ÅÑ', '500ÂÜÜ„Åã„ÇâË≥ºÂÖ•ÂèØËÉΩ'],
                    cons: ['„Çπ„Éó„É¨„ÉÉ„Éâ„ÅåÂ∫É„ÇÅ', 'ÈÅéÂéª„Å´„Éè„ÉÉ„Ç≠„É≥„Ç∞Ë¢´ÂÆ≥'],
                    bestFor: ['‰ªÆÊÉ≥ÈÄöË≤®ÂàùÂøÉËÄÖ', '„Ç∑„É≥„Éó„É´„Å™UI„ÇíÂ•Ω„ÇÄÊñπ'],
                    url: 'https://coincheck.com/'
                }
            ];

            const categories = [
                { id: 'all', label: '„Åô„Åπ„Å¶' },
                { id: 'general', label: 'Á∑èÂêàË®ºÂà∏' },
                { id: 'robo', label: '„É≠„Éú„Ç¢„Éâ' },
                { id: 'crypto', label: '‰ªÆÊÉ≥ÈÄöË≤®' }
            ];

            const filteredBrokers = selectedCategory === 'all' ? brokers : brokers.filter(b => b.category === selectedCategory);

            // Radar Chart Component - Glass Edition
            const RadarChart = ({ ratings, size = 100, showLabels = false }) => {
                const center = size / 2;
                const radius = size * (showLabels ? 0.3 : 0.38);
                const axes = ['fees', 'products', 'ease', 'support', 'tools'];
                const axisLabels = ['ÊâãÊï∞Êñô', 'ÂïÜÂìÅ', 'Á∞°Âçò„Åï', '„Çµ„Éù„Éº„Éà', '„ÉÑ„Éº„É´'];
                const angleStep = (Math.PI * 2) / axes.length;
                const chartId = useMemo(() => `radar-${Math.random().toString(36).substr(2, 9)}`, []);

                const getPoint = (value, index) => {
                    const angle = index * angleStep - Math.PI / 2;
                    const r = (value / 5) * radius;
                    return { x: center + r * Math.cos(angle), y: center + r * Math.sin(angle) };
                };

                const points = axes.map((axis, i) => getPoint(ratings[axis], i));
                const polygonPoints = points.map(p => `${p.x},${p.y}`).join(' ');

                // Grid lines (5 levels)
                const gridLines = [1, 2, 3, 4, 5].map(level => {
                    const gridPoints = axes.map((_, i) => getPoint(level, i));
                    return { points: gridPoints.map(p => `${p.x},${p.y}`).join(' '), level };
                });

                return (
                    <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
                        <defs>
                            {/* Glass fill gradient */}
                            <linearGradient id={`${chartId}-glass`} x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stopColor="rgba(255,255,255,0.15)" />
                                <stop offset="40%" stopColor="rgba(201,162,39,0.08)" />
                                <stop offset="100%" stopColor="rgba(255,255,255,0.12)" />
                            </linearGradient>
                            {/* Soft inner glow */}
                            <radialGradient id={`${chartId}-inner`} cx="50%" cy="40%" r="60%">
                                <stop offset="0%" stopColor="rgba(232,208,104,0.15)" />
                                <stop offset="100%" stopColor="rgba(0,0,0,0)" />
                            </radialGradient>
                            <filter id={`${chartId}-blur`}>
                                <feGaussianBlur stdDeviation="1.5" result="blur" />
                                <feMerge>
                                    <feMergeNode in="blur" />
                                    <feMergeNode in="SourceGraphic" />
                                </feMerge>
                            </filter>
                        </defs>

                        {/* Background ambient glow */}
                        <circle cx={center} cy={center} r={radius * 1.05} fill={`url(#${chartId}-inner)`} />

                        {/* Grid ‚Äî clean concentric pentagons */}
                        {gridLines.map(({ points: line, level }) => (
                            <polygon key={level} points={line} fill="none"
                                stroke={`rgba(255,255,255,${level === 5 ? 0.12 : 0.04 + level * 0.01})`}
                                strokeWidth={level === 5 ? '0.8' : '0.4'} />
                        ))}

                        {/* Axis lines */}
                        {axes.map((_, i) => {
                            const endPoint = getPoint(5, i);
                            return <line key={i} x1={center} y1={center} x2={endPoint.x} y2={endPoint.y}
                                stroke="rgba(255,255,255,0.06)" strokeWidth="0.4" />
                        })}

                        {/* Data polygon ‚Äî frosted glass */}
                        <polygon points={polygonPoints}
                            fill={`url(#${chartId}-glass)`}
                            stroke="rgba(255,255,255,0.35)"
                            strokeWidth={showLabels ? '1.5' : '1'}
                            strokeLinejoin="round" />

                        {/* Data points ‚Äî refined dots */}
                        {points.map((p, i) => (
                            <g key={i}>
                                <circle cx={p.x} cy={p.y} r={showLabels ? '4' : '2.5'}
                                    fill="rgba(255,255,255,0.08)" stroke="rgba(255,255,255,0.25)" strokeWidth="0.5" />
                                <circle cx={p.x} cy={p.y} r={showLabels ? '2' : '1.5'}
                                    fill="rgba(232,208,104,0.9)" />
                            </g>
                        ))}

                        {/* Labels */}
                        {showLabels && axes.map((axis, i) => {
                            const angle = i * angleStep - Math.PI / 2;
                            const labelRadius = radius * 1.45;
                            const x = center + labelRadius * Math.cos(angle);
                            const y = center + labelRadius * Math.sin(angle);
                            const score = ratings[axis];
                            return (
                                <g key={i}>
                                    <text x={x} y={y - 6} fill="rgba(255,255,255,0.75)" fontSize="10" fontWeight="500"
                                        textAnchor="middle" dominantBaseline="middle"
                                        style={{ letterSpacing: '0.04em' }}>
                                        {axisLabels[i]}
                                    </text>
                                    <text x={x} y={y + 7} fill="rgba(232,208,104,0.8)" fontSize="9" fontWeight="600"
                                        textAnchor="middle" dominantBaseline="middle" fontFamily="monospace">
                                        {score.toFixed(1)}
                                    </text>
                                </g>
                            );
                        })}
                    </svg>
                );
            };


            return (
                <div className="min-h-screen bg-obsidian pt-28 pb-32 px-4 sm:px-8 relative overflow-hidden">
                    {/* Atmospheric Background */}
                    <div className="fixed inset-0 pointer-events-none overflow-hidden">
                        <div className="absolute -top-[20%] -right-[10%] w-[1000px] h-[1000px] bg-gold/5 rounded-full blur-[150px] opacity-20" />
                        <div className="absolute bottom-[-10%] left-[-10%] w-[800px] h-[800px] bg-emerald-500/5 rounded-full blur-[120px] opacity-10" />
                    </div>

                    <div className="max-w-6xl mx-auto relative z-10">
                        {/* Header */}
                        <div className="mb-16">
                            <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }}>
                                <div className="flex items-center justify-between mb-2">
                                    <p className="text-dim text-xs tracking-[0.4em] text-gold uppercase">Broker Comparison</p>
                                    <button onClick={() => setTipsOpen(!tipsOpen)} className="text-gold hover:scale-110 transition-transform text-lg" title="Áî®Ë™ûËß£Ë™¨">
                                        ‚ùï
                                    </button>
                                </div>
                                <h2 className="text-4xl md:text-5xl font-black tracking-tighter text-platinum mb-4">Ë®ºÂà∏‰ºöÁ§æ„Çí<span className="text-gold-gradient">ÊØîËºÉ</span>„Åô„Çã</h2>
                                <p className="text-dim text-sm max-w-xl leading-loose">
                                    ÂêÑË®ºÂà∏‰ºöÁ§æ„ÅÆÁâπÂæ¥„ÇíÊØîËºÉ„Åó„Å¶„ÄÅ„ÅÇ„Å™„Åü„Å´Âêà„Å£„ÅüÂè£Â∫ß„ÇíË¶ã„Å§„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ<br />
                                    ‚Äª Êú¨ÊÉÖÂ†±„ÅØ‰∏ÄËà¨ÁöÑ„Å™ÊØîËºÉ„Åß„ÅÇ„Çä„ÄÅÁâπÂÆö„ÅÆ‰ºöÁ§æ„ÇíÊé®Â•®„Åô„Çã„ÇÇ„ÅÆ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
                                </p>
                            </motion.div>
                        </div>

                        {/* Tips Section */}
                        <AnimatePresence>
                            {tipsOpen && (
                                <motion.div initial={{ height: 0, opacity: 0 }} animate={{ height: 'auto', opacity: 1 }} exit={{ height: 0, opacity: 0 }} className="overflow-hidden mb-10">
                                    <div className="bg-gold/5 border border-gold/20 rounded-sm p-6">
                                        <h3 className="text-gold font-bold mb-4 flex items-center gap-2"><span>üí°</span> Ë®ºÂà∏„ÉªË®ºÂà∏‰ºöÁ§æ„Å£„Å¶‰ΩïÔºü</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                                            <div>
                                                <h4 className="text-platinum font-bold mb-2">Ë®ºÂà∏„Å®„ÅØÔºü</h4>
                                                <p className="text-dim leading-relaxed">Ê†™„ÇÑÊäïË≥á‰ø°Ë®ó„Å™„Å©„Äå„ÅäÈáë„ÇíÂ¢ó„ÇÑ„Åô„Åü„ÇÅ„ÅÆÂïÜÂìÅ„Äç„ÅÆ„Åì„Å®„ÄÇË≤∑„ÅÜ„Åì„Å®„Åß„ÄÅ‰ºÅÊ•≠„ÅÆÊàêÈï∑„ÇÑÂõΩ„ÅÆ‰ø°Áî®„Å´ÊäïË≥á„Åó„ÄÅÂà©Áõä„ÇíÂæó„ÇãÊ®©Âà©„ÇíÊåÅ„Å¶„Åæ„Åô„ÄÇ</p>
                                            </div>
                                            <div>
                                                <h4 className="text-platinum font-bold mb-2">Ë®ºÂà∏‰ºöÁ§æ„Å®„ÅØÔºü</h4>
                                                <p className="text-dim leading-relaxed">Ë®ºÂà∏„ÇíÂ£≤Ë≤∑„Åô„Çã„Åü„ÇÅ„ÅÆ„ÅäÂ∫ó„Åß„Åô„ÄÇ„Çπ„Éº„Éë„Éº„ÅßÈ£üÂìÅ„ÇíË≤∑„ÅÜ„Çà„ÅÜ„Å´„ÄÅË®ºÂà∏‰ºöÁ§æ„ÅßÊ†™„ÇÑÊäïË≥á‰ø°Ë®ó„ÇíË≤∑„ÅÑ„Åæ„Åô„ÄÇÈäÄË°å„Åå„ÅäÈáë„ÇíÈ†ê„Åã„ÇãÂ†¥ÊâÄ„Å™„Çâ„ÄÅË®ºÂà∏‰ºöÁ§æ„ÅØ„ÅäÈáë„Çí„ÄåÂÉç„Åã„Åõ„Çã„ÄçÂ†¥ÊâÄ„Åß„Åô„ÄÇ</p>
                                            </div>
                                        </div>
                                    </div>
                                </motion.div>
                            )}
                        </AnimatePresence>

                        {/* Category Filter */}
                        <div className="flex gap-3 mb-10 flex-wrap">
                            {categories.map(cat => (
                                <button key={cat.id} onClick={() => setSelectedCategory(cat.id)}
                                    className={`px-5 py-2 rounded-sm text-sm transition-all font-medium ${selectedCategory === cat.id ? 'bg-gold/10 text-gold border border-gold/30' : 'text-dim border border-white/10 hover:text-platinum hover:border-white/20'}`}>
                                    {cat.label}
                                </button>
                            ))}
                        </div>

                        {/* Broker Cards - Compact Radar Chart Design */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-12">
                            <AnimatePresence mode="popLayout">
                                {filteredBrokers.map((broker, i) => (
                                    <motion.div key={broker.id}
                                        initial={{ opacity: 0, scale: 0.9 }}
                                        animate={{ opacity: 1, scale: 1 }}
                                        exit={{ opacity: 0, scale: 0.9 }}
                                        transition={{ delay: i * 0.05, type: 'spring', stiffness: 300 }}
                                        onClick={() => setSelectedBroker(broker)}
                                        className="bg-gradient-to-br from-ash/80 to-ash/40 border border-white/5 rounded-sm p-4 cursor-pointer hover:border-gold/30 hover:scale-105 transition-all duration-300 group flex flex-col items-center">
                                        {/* Radar Chart */}
                                        <div className="mb-3 relative">
                                            <RadarChart ratings={broker.ratings} size={110} />
                                            <div className="absolute inset-0 flex items-center justify-center">
                                                <span className="text-2xl">{broker.logo}</span>
                                            </div>
                                        </div>
                                        {/* Name & Tagline */}
                                        <h3 className="text-sm font-bold text-platinum group-hover:text-gold transition-colors text-center">{broker.name}</h3>
                                        <p className="text-[10px] text-dim text-center mt-1 line-clamp-1">{broker.tagline}</p>
                                        <span className="text-[10px] text-gold mt-2 opacity-0 group-hover:opacity-100 transition-opacity">„Çø„ÉÉ„Éó„ÅßË©≥Á¥∞</span>
                                    </motion.div>
                                ))}
                            </AnimatePresence>
                        </div>

                        {/* Disclaimer */}
                        <div className="text-center">
                            <p className="text-[10px] text-dim leading-relaxed">
                                ‚Äª ÊâãÊï∞Êñô„Éª„Çµ„Éº„Éì„ÇπÂÜÖÂÆπ„ÅØÂ§âÊõ¥„Åï„Çå„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊúÄÊñ∞ÊÉÖÂ†±„ÅØÂêÑÁ§æÂÖ¨Âºè„Çµ„Ç§„Éà„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ<br />
                                ‚Äª Êú¨„Éö„Éº„Ç∏„ÅØÊÉÖÂ†±Êèê‰æõ„ÇíÁõÆÁöÑ„Å®„Åó„Å¶„Åä„Çä„ÄÅÊäïË≥áÂãßË™ò„ÇíÁõÆÁöÑ„Å®„Åó„Åü„ÇÇ„ÅÆ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
                            </p>
                        </div>
                    </div>

                    {/* Detail Modal */}
                    <AnimatePresence>
                        {selectedBroker && (
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
                                className="fixed inset-0 z-50 flex items-center justify-center bg-obsidian/90 backdrop-blur-lg p-4"
                                onClick={() => setSelectedBroker(null)}>
                                <motion.div initial={{ opacity: 0, scale: 0.95, y: 20 }} animate={{ opacity: 1, scale: 1, y: 0 }} exit={{ opacity: 0, scale: 0.95 }}
                                    onClick={e => e.stopPropagation()}
                                    className="w-full max-w-2xl max-h-[85vh] overflow-y-auto bg-ash border border-white/10 rounded-sm">
                                    {/* Modal Header */}
                                    <div className="sticky top-0 bg-ash/95 backdrop-blur-sm border-b border-white/10 p-6 flex justify-between items-start">
                                        <div className="flex items-center gap-4">
                                            <div className="w-14 h-14 rounded-sm bg-gradient-to-br from-gold/20 to-amber-500/10 flex items-center justify-center text-3xl">{selectedBroker.logo}</div>
                                            <div>
                                                <h2 className="text-2xl font-bold text-platinum">{selectedBroker.name}</h2>
                                                <p className="text-sm text-dim">{selectedBroker.tagline}</p>
                                            </div>
                                        </div>
                                        <button onClick={() => setSelectedBroker(null)} className="text-dim hover:text-white text-2xl">√ó</button>
                                    </div>

                                    {/* Modal Content */}
                                    <div className="p-6 space-y-6">
                                        {/* Detailed Radar Chart */}
                                        <div className="flex justify-center py-4 bg-gradient-to-br from-white/5 to-transparent rounded-sm border border-white/5">
                                            <RadarChart ratings={selectedBroker.ratings} size={280} showLabels={true} />
                                        </div>
                                        {/* Features */}
                                        <div>
                                            <h3 className="text-sm text-gold uppercase tracking-wider mb-3">‰∏ª„Å™ÁâπÂæ¥</h3>
                                            <div className="flex flex-wrap gap-2">
                                                {selectedBroker.features.map((f, i) => (
                                                    <span key={i} className="text-sm text-platinum bg-gold/10 border border-gold/20 px-3 py-1.5 rounded-sm">{f}</span>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Fees */}
                                        <div className="bg-white/5 border border-white/10 rounded-sm p-4">
                                            <h3 className="text-sm text-gold uppercase tracking-wider mb-3">ÊâãÊï∞ÊñôÔºàÁ®éËæº„ÉªÁõÆÂÆâÔºâ</h3>
                                            <div className="grid grid-cols-3 gap-4 text-center">
                                                <div>
                                                    <p className="text-xs text-dim mb-1">ÂõΩÂÜÖÊ†™</p>
                                                    <p className="text-lg font-bold text-platinum">{selectedBroker.fees.stock}</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs text-dim mb-1">ÊäïË≥á‰ø°Ë®ó</p>
                                                    <p className="text-lg font-bold text-platinum">{selectedBroker.fees.fund}</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs text-dim mb-1">Á±≥ÂõΩÊ†™/„Åù„ÅÆ‰ªñ</p>
                                                    <p className="text-lg font-bold text-platinum">{selectedBroker.fees.us}</p>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Pros & Cons */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="bg-emerald-500/5 border border-emerald-500/20 rounded-sm p-4">
                                                <h3 className="text-sm text-emerald-400 uppercase tracking-wider mb-3">„É°„É™„ÉÉ„Éà</h3>
                                                <ul className="space-y-2">
                                                    {selectedBroker.pros.map((p, i) => (
                                                        <li key={i} className="text-sm text-platinum/80 flex items-start gap-2">
                                                            <span className="text-emerald-400">‚úì</span>{p}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                            <div className="bg-rose-500/5 border border-rose-500/20 rounded-sm p-4">
                                                <h3 className="text-sm text-rose-400 uppercase tracking-wider mb-3">„Éá„É°„É™„ÉÉ„Éà</h3>
                                                <ul className="space-y-2">
                                                    {selectedBroker.cons.map((c, i) => (
                                                        <li key={i} className="text-sm text-platinum/80 flex items-start gap-2">
                                                            <span className="text-rose-400">‚ñ≥</span>{c}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        </div>

                                        {/* Best For */}
                                        <div>
                                            <h3 className="text-sm text-gold uppercase tracking-wider mb-3">„Åì„Çì„Å™‰∫∫„Å´Âêë„ÅÑ„Å¶„ÅÑ„Çã</h3>
                                            <div className="flex flex-wrap gap-2">
                                                {selectedBroker.bestFor.map((b, i) => (
                                                    <span key={i} className="text-sm text-platinum/80 bg-white/5 border border-white/10 px-3 py-1.5 rounded-sm">üë§ {b}</span>
                                                ))}
                                            </div>
                                        </div>

                                        {/* CTA */}
                                        <div className="pt-4 border-t border-white/10">
                                            <a href={selectedBroker.url} target="_blank" rel="noopener noreferrer"
                                                className="block w-full py-4 bg-gold/10 border border-gold/30 text-gold text-center font-bold rounded-sm hover:bg-gold hover:text-black transition-all">
                                                {selectedBroker.name}„ÅÆÂÖ¨Âºè„Çµ„Ç§„Éà„Å∏ ‚Üí
                                            </a>
                                            <p className="text-[10px] text-dim text-center mt-3">
                                                ‚Äª Â§ñÈÉ®„Çµ„Ç§„Éà„Å∏ÈÅ∑Áßª„Åó„Åæ„Åô„ÄÇÊäïË≥áÂãßË™ò„ÇíÁõÆÁöÑ„Å®„Åó„Åü„ÇÇ„ÅÆ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ<br />
                                                ‚Äª Êú¨„É™„É≥„ÇØ„ÅØÊèêÊê∫„Çµ„Éº„Éì„Çπ„Å∏„ÅÆÊ°àÂÜÖ„ÇíÂê´„Åø„Åæ„Åô
                                            </p>
                                        </div>
                                    </div>
                                </motion.div>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const Tokushoho = ({ onNavigate }) => {
            const tableRows = [
                { label: "Ë≤©Â£≤‰∫ãÊ•≠ËÄÖ", value: "Áî∞‰∏≠ Êªâ‰∏ÄÈÉé" },
                { label: "ÊâÄÂú®Âú∞ / ÈÄ£Áµ°ÂÖà", value: "Ê∂àË≤ªËÄÖÂ∫Å„ÅÆË¶èÂÆö„Å´Âü∫„Å•„Åç„ÄÅË´ãÊ±Ç„Åå„ÅÇ„Å£„ÅüÂ†¥Âêà„Å´„ÅØÈÅÖÊªû„Å™„ÅèÈñãÁ§∫„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ\n„ÅîÂ∏åÊúõ„ÅÆÊñπ„ÅØ‰∏ãË®ò„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åæ„Åß„ÅîÈÄ£Áµ°„Åè„Å†„Åï„ÅÑ„ÄÇ\nsupport@invision-app.com" },
                { label: "Ë≤©Â£≤‰æ°Ê†º", value: "ÂêÑÂïÜÂìÅ„Éö„Éº„Ç∏„Å´Ë®òËºâÔºàË°®Á§∫‰æ°Ê†º„ÅØÊ∂àË≤ªÁ®é„ÇíÂê´„Åø„Åæ„ÅôÔºâ" },
                { label: "ÂïÜÂìÅ‰ª£Èáë‰ª•Â§ñ„ÅÆÂøÖË¶ÅÊñôÈáë", value: "„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂öÊñôÈáë„Åù„ÅÆ‰ªñ„ÅÆÈõªÊ∞óÈÄö‰ø°ÂõûÁ∑ö„ÅÆÈÄö‰ø°„Å´Èñ¢„Åô„ÇãË≤ªÁî®„ÅØ„ÅäÂÆ¢Êßò„ÅÆË≤†ÊãÖ„Å®„Å™„Çä„Åæ„Åô„ÄÇ" },
                { label: "„ÅäÊîØÊâï„ÅÑÊñπÊ≥ï", value: "„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„ÉâÊ±∫Ê∏àÔºàVisa, Mastercard, JCB, Amex, DinersÔºâ\nApple Pay, Google Pay" },
                { label: "„ÅäÊîØÊâï„ÅÑÊôÇÊúü", value: "ÂïÜÂìÅË≥ºÂÖ•ÊôÇ„Å´„ÅäÊîØÊâï„ÅÑ„ÅåÁ¢∫ÂÆö„Åó„Åæ„Åô„ÄÇ" },
                { label: "ÂïÜÂìÅ„ÅÆÂºïÊ∏°ÊôÇÊúü", value: "Ê±∫Ê∏àÂÆå‰∫ÜÂæå„ÄÅÁõ¥„Å°„Å´„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÄÇ" },
                { label: "ËøîÂìÅ„Éª‰∫§Êèõ", value: "„Éá„Ç∏„Çø„É´„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÊÄßË≥™‰∏ä„ÄÅË≥ºÂÖ•Á¢∫ÂÆöÂæå„ÅÆËøîÂìÅ„Éª‰∫§Êèõ„Éª„Ç≠„É£„É≥„Çª„É´„ÅØ„ÅäÂèó„Åë„Åß„Åç„Åæ„Åõ„Çì„ÄÇ‰∫à„ÇÅ„Åî‰∫ÜÊâø„Åè„Å†„Åï„ÅÑ„ÄÇ" },
                { label: "Âãï‰ΩúÁí∞Â¢É", value: "iOS 15.0‰ª•‰∏ä / Android 10.0‰ª•‰∏ä\nÊé®Â•®„Éñ„É©„Ç¶„Ç∂ÔºöSafari, Chrome„ÅÆÊúÄÊñ∞Áâà" },
            ];

            return (
                <div className="min-h-screen bg-obsidian py-24 px-8 relative overflow-hidden">
                    <div className="fixed inset-0 pointer-events-none">
                        <div className="absolute top-[10%] left-[10%] w-[500px] h-[500px] bg-gold/5 rounded-full blur-[120px] opacity-20" />
                        <div className="absolute bottom-[10%] right-[10%] w-[400px] h-[400px] bg-amber-500/5 rounded-full blur-[100px] opacity-10" />
                    </div>

                    <div className="max-w-3xl mx-auto relative z-10">
                        <button onClick={() => onNavigate('gallery')} className="text-dim hover:text-gold transition-colors mb-8 flex items-center gap-2 text-sm group">
                            <span className="group-hover:-translate-x-1 transition-transform">‚Üê</span> Êàª„Çã
                        </button>

                        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }}>
                            <p className="text-dim text-xs tracking-[0.3em] mb-4 text-gold font-bold">LEGAL INFORMATION</p>
                            <h2 className="text-3xl md:text-4xl font-black text-platinum mb-10 tracking-tight">ÁâπÂÆöÂïÜÂèñÂºïÊ≥ï„Å´Âü∫„Å•„ÅèË°®Ë®ò</h2>

                            <div className="bg-ash/50 border border-white/10 rounded-sm overflow-hidden backdrop-blur-sm">
                                {tableRows.map((row, i) => (
                                    <div key={i} className={`flex flex-col md:flex-row border-b border-white/5 last:border-0 ${i % 2 === 0 ? 'bg-white/[0.02]' : ''}`}>
                                        <div className="md:w-1/3 p-4 md:p-6 text-sm text-platinum/60 font-medium md:border-r border-white/5">
                                            {row.label}
                                        </div>
                                        <div className="md:w-2/3 p-4 md:p-6 text-sm text-platinum leading-relaxed whitespace-pre-wrap font-light">
                                            {row.value}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="mt-12 p-6 bg-white/5 border border-white/10 rounded-sm">
                                <h3 className="text-sm font-bold text-gold mb-2">„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Å´„Å§„ÅÑ„Å¶</h3>
                                <p className="text-xs text-dim leading-relaxed">
                                    Êú¨„Çµ„Éº„Éì„Çπ„Å´Èñ¢„Åô„Çã„ÅäÂïè„ÅÑÂêà„Çè„Åõ„ÅØ„ÄÅ‰∏äË®ò„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åæ„Åß„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ<br />
                                    ÂéüÂâá„Å®„Åó„Å¶2Âñ∂Ê•≠Êó•‰ª•ÂÜÖ„Å´„ÅîËøî‰ø°„ÅÑ„Åü„Åó„Åæ„Åô„Åå„ÄÅÂÜÖÂÆπ„Å´„Çà„Å£„Å¶„ÅØ„ÅäÊôÇÈñì„Çí„ÅÑ„Åü„Å†„ÅèÂ†¥Âêà„Åå„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ<br />
                                    „Å™„Åä„ÄÅÊäïË≥áÂä©Ë®Ä„Å´Ë©≤ÂΩì„Åô„ÇãÂÄãÂà•ÂÖ∑‰ΩìÁöÑ„Å™„ÅîË≥™Âïè„Å´„ÅØ„ÅäÁ≠î„Åà„Åß„Åç„Åæ„Åõ„Çì„ÅÆ„Åß‰∫à„ÇÅ„Åî‰∫ÜÊâø„Åè„Å†„Åï„ÅÑ„ÄÇ
                                </p>
                            </div>
                        </motion.div>
                    </div>
                </div>
            );
        };

        // ============================================
        // FIREBASE AUTH UTILS
        // ============================================
        const LoginButton = ({ user, onLogin, onLogout }) => {
            if (!isFirebaseReady) return null;

            return (
                <button
                    onClick={user ? onLogout : onLogin}
                    className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all border flex-shrink-0 ${user
                        ? 'bg-white/5 border-white/10 text-dim hover:bg-white/10 hover:text-white'
                        : 'bg-gold/10 border-gold/30 text-gold hover:bg-gold hover:text-black shadow-[0_0_10px_rgba(201,162,39,0.2)]'
                        }`}
                >
                    {user ? '„É≠„Ç∞„Ç¢„Ç¶„Éà' : '„É≠„Ç∞„Ç§„É≥'}
                </button>
            );
        };

        // ============================================
        // HEADER & APP ROOT
        // ============================================
        const Header = ({ currentPage, onNavigate, onOpenSettings, showNav, userProfile, progress, firebaseUser, onLogin, onLogout }) => (
            <header className="fixed top-0 left-0 right-0 z-40 bg-obsidian/80 backdrop-blur-sm border-b border-white/5">
                <div className="max-w-7xl mx-auto px-4 md:px-8 py-4 flex items-center justify-between">
                    <div className="flex items-center gap-4 flex-shrink-0">
                        <button onClick={() => onNavigate('gallery')} className="text-xl font-black tracking-tighter cursor-pointer">
                            <span className="text-gold-gradient">IN</span><span className="text-platinum">VISION</span>
                        </button>
                        {userProfile && (
                            <div className="hidden md:flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10">
                                <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse" />
                                <span className="text-xs font-mono text-platinum/80 tracking-wider">
                                    {getUserTitle(userProfile, progress)}
                                </span>
                            </div>
                        )}
                    </div>
                    {/* Always show nav, scrollable on mobile */}
                    <div className="flex items-center gap-4 md:gap-8 flex-1 justify-end min-w-0">
                        <LoginButton user={firebaseUser} onLogin={onLogin} onLogout={onLogout} />
                        <nav className="flex items-center gap-4 md:gap-6 overflow-x-auto no-scrollbar mask-gradient-right pr-4">
                            {[{ id: 'gallery', label: '„Ç¢„Çª„ÉÉ„Éà' }, { id: 'brokers', label: 'Ë®ºÂà∏' }, { id: 'briefing', label: 'Â≠¶Áøí' }, { id: 'portfolio', label: '„Éù„Éº„Éà„Éï„Ç©„É™„Ç™' }, { id: 'diagnosis', label: 'Ë®∫Êñ≠' }].map(item => (
                                <button key={item.id} onClick={() => onNavigate(item.id)} className={`text-xs md:text-sm whitespace-nowrap transition-colors ${currentPage === item.id ? 'text-gold font-bold' : 'text-dim hover:text-platinum'}`}>{item.label}</button>
                            ))}
                        </nav>
                        <button onClick={onOpenSettings} className="text-dim hover:text-gold transition-colors flex-shrink-0">‚öôÔ∏è</button>
                    </div>
                </div>
            </header>
        );

        const DisclaimerModal = ({ onAccept }) => (
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 sm:p-6">
                <motion.div initial={{ scale: 0.9, y: 20 }} animate={{ scale: 1, y: 0 }} className="w-full max-w-lg bg-obsidian border border-gold/30 rounded-sm p-6 sm:p-8 shadow-2xl relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-gold to-transparent" />
                    <h2 className="text-2xl font-black text-platinum mb-6 text-center">„ÅîÂà©Áî®„Å´„ÅÇ„Åü„Å£„Å¶</h2>
                    <div className="space-y-4 text-sm text-platinum/80 leading-relaxed max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                        <p>
                            INVISION„ÅØ„ÄÅÊäïË≥á„ÇíÂßã„ÇÅ„ÇãÂâç„Å´„ÄåËá™ÂàÜ„ÇíÁü•„Çã„Äç„Åü„ÇÅ„ÅÆ„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†„Åß„Åô„ÄÇ<br />
                            „Åì„ÅÆ„Çµ„Ç§„Éà„ÅØÂ≠¶Áøí„ÉªËá™Â∑±ÂàÜÊûê„ÇíÁõÆÁöÑ„Å®„Åó„Å¶„Åä„Çä„ÄÅÁâπÂÆö„ÅÆÂïÜÂìÅ„ÅÆË≥ºÂÖ•„ÇíÂãß„ÇÅ„Çã„ÇÇ„ÅÆ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
                        </p>
                        <ul className="list-disc pl-5 space-y-2 marker:text-gold">
                            <li>
                                Ë®∫Êñ≠„ÇÑ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„ÅÆÁµêÊûú„ÅØ„ÅÇ„Åè„Åæ„ÅßÂèÇËÄÉÊÉÖÂ†±„Åß„ÅÇ„Çä„ÄÅÂ∞ÜÊù•„ÅÆÊàêÊûú„ÇíÁ¥ÑÊùü„Åô„Çã„ÇÇ„ÅÆ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
                            </li>
                            <li>
                                ÊäïË≥á„ÅÆÊúÄÁµÇÂà§Êñ≠„ÅØ„ÅîËá™Ë∫´„ÅÆË≤¨‰ªª„Å®„Å™„Çä„Åæ„Åô„ÄÇÂÖÉÊú¨„ÅåÊ∏õ„Çã„É™„Çπ„ÇØ„Åå„ÅÇ„Çã„Åì„Å®„Çí„ÅîÁêÜËß£„Åè„Å†„Åï„ÅÑ„ÄÇ
                            </li>
                            <li>
                                Á¥π‰ªã„Åó„Å¶„ÅÑ„ÇãË®ºÂà∏‰ºöÁ§æ„ÇÑÈáëËûç„Çµ„Éº„Éì„Çπ„ÅÆÊù°‰ª∂„ÅØÂ§âÊõ¥„Åï„Çå„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊúÄÊñ∞ÊÉÖÂ†±„ÅØÂêÑÁ§æÂÖ¨Âºè„Çµ„Ç§„Éà„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ
                            </li>
                        </ul>
                    </div>
                    <div className="mt-8 pt-6 border-t border-white/10 flex flex-col gap-4">
                        <button onClick={onAccept} className="w-full py-4 bg-gold text-black font-bold text-lg rounded-sm hover:bg-amber-400 transition-colors shadow-[0_0_20px_rgba(218,165,32,0.3)]">
                            ÂêåÊÑè„Åó„Å¶Âßã„ÇÅ„Çã
                        </button>
                    </div>
                </motion.div>
            </motion.div>
        );

        const SplashScreen = ({ onComplete }) => {
            useEffect(() => { setTimeout(onComplete, 2500); }, [onComplete]);
            return (<motion.div className="fixed inset-0 bg-obsidian z-50 flex items-center justify-center" exit={{ opacity: 0 }}><motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}><h1 className="text-6xl font-black tracking-tighter"><span className="text-gold-gradient">IN</span><span className="text-platinum">VISION</span></h1><motion.div className="h-px bg-gold/50 mt-4" initial={{ scaleX: 0 }} animate={{ scaleX: 1 }} transition={{ duration: 2 }} /></motion.div></motion.div>);
        };

        // iOS Home Screen Install Prompt
        const IOSInstallPrompt = ({ onDismiss }) => {
            const [step, setStep] = useState(0);
            const steps = [
                { icon: '‚ñ°‚Üë', title: 'ÂÖ±Êúâ„Éú„Çø„É≥„Çí„Çø„ÉÉ„Éó', desc: 'ÁîªÈù¢‰∏ãÈÉ®„ÅÆÂÖ±Êúâ„Ç¢„Ç§„Ç≥„É≥Ôºà‚ñ°„Å´‚ÜëÔºâ„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ', visual: '‚¨ÜÔ∏è' },
                { icon: 'Ôºã', title: '„Äå„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Äç„Çí„Çø„ÉÉ„Éó', desc: '„É°„Éã„É•„Éº„Çí„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶„Äå„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Äç„ÇíÈÅ∏Êäû', visual: 'üì±' },
                { icon: '‚úì', title: '„ÄåËøΩÂä†„Äç„Çí„Çø„ÉÉ„Éó', desc: 'Âè≥‰∏ä„ÅÆ„ÄåËøΩÂä†„Äç„Éú„Çø„É≥„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÂÆå‰∫ÜÔºÅ', visual: '‚úÖ' }
            ];
            return (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/90 backdrop-blur-md p-0 sm:p-6">
                    <motion.div initial={{ y: 100, opacity: 0 }} animate={{ y: 0, opacity: 1 }} transition={{ type: 'spring', stiffness: 300, damping: 30 }}
                        className="w-full sm:max-w-md bg-obsidian border border-gold/30 rounded-t-2xl sm:rounded-sm p-6 sm:p-8 shadow-2xl relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-gold to-transparent" />

                        {/* Drag handle for mobile */}
                        <div className="flex justify-center mb-4 sm:hidden">
                            <div className="w-10 h-1 bg-white/20 rounded-full" />
                        </div>

                        <div className="text-center mb-6">
                            <div className="w-16 h-16 mx-auto mb-4 bg-gold/10 rounded-2xl flex items-center justify-center border border-gold/30">
                                <span className="text-3xl">üì≤</span>
                            </div>
                            <h2 className="text-xl font-black text-platinum mb-2">„Ç¢„Éó„É™„ÅÆ„Çà„ÅÜ„Å´‰Ωø„ÅÜ</h2>
                            <p className="text-xs text-dim leading-relaxed">„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åó„Å¶„ÄÅ„Éç„Ç§„ÉÜ„Ç£„Éñ„Ç¢„Éó„É™„ÅÆ„Çà„ÅÜ„Å´Âø´ÈÅ©„Å´„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åë„Åæ„Åô</p>
                        </div>

                        {/* Steps */}
                        <div className="space-y-3 mb-6">
                            {steps.map((s, i) => (
                                <motion.div key={i}
                                    initial={{ opacity: 0, x: -20 }}
                                    animate={{ opacity: 1, x: 0 }}
                                    transition={{ delay: 0.2 + i * 0.15 }}
                                    className={`flex items-center gap-4 p-3 rounded-sm border transition-all duration-300 ${step === i ? 'bg-gold/10 border-gold/40 shadow-[0_0_15px_rgba(201,162,39,0.1)]' : 'bg-white/3 border-white/5'
                                        }`}
                                    onClick={() => setStep(i)}>
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold flex-shrink-0 ${step === i ? 'bg-gold text-black' : 'bg-white/5 text-white/40'
                                        }`}>
                                        {i + 1}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <p className={`text-sm font-bold ${step === i ? 'text-gold' : 'text-platinum/60'}`}>{s.title}</p>
                                        {step === i && (
                                            <motion.p initial={{ opacity: 0, height: 0 }} animate={{ opacity: 1, height: 'auto' }}
                                                className="text-xs text-dim mt-1 leading-relaxed">{s.desc}</motion.p>
                                        )}
                                    </div>
                                    <span className="text-xl flex-shrink-0">{s.visual}</span>
                                </motion.div>
                            ))}
                        </div>

                        {/* Safari bottom bar illustration */}
                        <div className="bg-white/5 border border-white/10 rounded-sm p-3 mb-6">
                            <div className="flex items-center justify-center gap-6">
                                <span className="text-white/20">‚óÅ</span>
                                <span className="text-white/20">‚ñ∑</span>
                                <div className="ios-share-icon">
                                    <span>‚Üë</span>
                                </div>
                                <span className="text-white/20">‚ò∞</span>
                                <span className="text-white/20">‚ñ£</span>
                            </div>
                            <p className="text-center text-[10px] text-gold/60 mt-2">‚Üë „Åì„ÅÆÂÖ±Êúâ„Éú„Çø„É≥„Çí„Çø„ÉÉ„Éó</p>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={onDismiss} className="flex-1 py-3 bg-white/5 border border-white/10 text-platinum/70 rounded-sm text-sm font-bold hover:bg-white/10 transition-colors">
                                „ÅÇ„Å®„Åß
                            </button>
                            <button onClick={onDismiss} className="flex-1 py-3 bg-gold text-black font-bold text-sm rounded-sm hover:bg-amber-400 transition-colors shadow-[0_0_15px_rgba(218,165,32,0.2)]">
                                OK
                            </button>
                        </div>
                    </motion.div>
                </motion.div>
            );
        };

        const App = () => {
            // localStorage key for state persistence
            const STORAGE_KEY = 'invision_state_v1';

            // Load initial state from localStorage
            const loadSavedState = () => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved) : null;
                } catch (e) {
                    console.warn('Failed to load saved state:', e);
                    return null;
                }
            };

            const savedState = useMemo(() => loadSavedState(), []);

            // ============================================
            // UNIFIED STATE WITH useReducer
            // ============================================
            const initialState = {
                // Persisted state
                onboardingStep: savedState?.onboardingStep ?? 0,
                currentPage: savedState?.currentPage ?? 'gallery',
                userProfile: savedState?.userProfile ?? null,
                userGoals: savedState?.userGoals ?? null,
                learnProgress: savedState?.learnProgress ?? 0,
                userPlan: savedState?.userPlan ?? 'free',
                understoodCards: savedState?.understoodCards ?? [],
                unclearCards: savedState?.unclearCards ?? [],
                purchasedBundles: savedState?.purchasedBundles ?? [],
                freeLimit: savedState?.freeLimit ?? 5,
                nextReplenishTime: savedState?.nextReplenishTime ?? null,
                dailyCompleted: savedState?.dailyCompleted ?? 0,
                lastDailyGoalDate: savedState?.lastDailyGoalDate ?? Date.now(),
                portfolioSettings: savedState?.portfolioSettings ?? null,
                // UI-only state (not persisted)
                showSplash: true,
                showSettings: false,
                showDisclaimer: true,
                showIOSPrompt: false,
                pageParams: null
            };

            // Action types for clear state transitions
            const ACTION_TYPES = {
                FINISH_SPLASH: 'FINISH_SPLASH',
                ACCEPT_DISCLAIMER: 'ACCEPT_DISCLAIMER',
                SHOW_IOS_PROMPT: 'SHOW_IOS_PROMPT',
                DISMISS_IOS_PROMPT: 'DISMISS_IOS_PROMPT',
                SET_PAGE: 'SET_PAGE',
                SET_PROFILE: 'SET_PROFILE',
                SET_GOALS: 'SET_GOALS',
                SET_PROGRESS: 'SET_PROGRESS',
                SET_PLAN: 'SET_PLAN',
                SET_ONBOARDING: 'SET_ONBOARDING',
                TOGGLE_SETTINGS: 'TOGGLE_SETTINGS',
                UPDATE_CARDS: 'UPDATE_CARDS',
                SET_PAGE_PARAMS: 'SET_PAGE_PARAMS',
                PURCHASE_BUNDLE: 'PURCHASE_BUNDLE',
                UPDATE_LIMITS: 'UPDATE_LIMITS',
                SET_DAILY_COMPLETED: 'SET_DAILY_COMPLETED',
                RESET_DAILY_GOAL: 'RESET_DAILY_GOAL',
                UPDATE_PORTFOLIO_SETTINGS: 'UPDATE_PORTFOLIO_SETTINGS'
            };

            const appReducer = (state, action) => {
                switch (action.type) {
                    case ACTION_TYPES.FINISH_SPLASH:
                        return { ...state, showSplash: false };
                    case ACTION_TYPES.ACCEPT_DISCLAIMER:
                        return { ...state, showDisclaimer: false, currentPage: state.onboardingStep === 0 ? 'diagnosis' : state.currentPage };
                    case ACTION_TYPES.SHOW_IOS_PROMPT:
                        return { ...state, showIOSPrompt: true };
                    case ACTION_TYPES.DISMISS_IOS_PROMPT:
                        return { ...state, showIOSPrompt: false };
                    case ACTION_TYPES.SET_PAGE:
                        return {
                            ...state,
                            currentPage: action.payload.page,
                            pageParams: action.payload.params || null,
                            onboardingStep: action.payload.page === 'gallery' && state.onboardingStep < 3
                                ? 3 : state.onboardingStep
                        };
                    case ACTION_TYPES.SET_PROFILE:
                        return { ...state, userProfile: action.payload };
                    case ACTION_TYPES.SET_GOALS:
                        return { ...state, userGoals: action.payload };
                    case ACTION_TYPES.SET_PROGRESS:
                        return { ...state, learnProgress: action.payload };
                    case ACTION_TYPES.SET_PLAN:
                        return { ...state, userPlan: action.payload };
                    case ACTION_TYPES.SET_ONBOARDING:
                        return { ...state, onboardingStep: action.payload };
                    case ACTION_TYPES.TOGGLE_SETTINGS:
                        return { ...state, showSettings: action.payload ?? !state.showSettings };
                    case ACTION_TYPES.UPDATE_CARDS:
                        return {
                            ...state,
                            understoodCards: action.payload.understood ?? state.understoodCards,
                            unclearCards: action.payload.unclear ?? state.unclearCards
                        };
                    case ACTION_TYPES.SET_PAGE_PARAMS:
                        return { ...state, pageParams: action.payload };
                    case ACTION_TYPES.PURCHASE_BUNDLE:
                        return {
                            ...state,
                            purchasedBundles: state.purchasedBundles.includes(action.payload)
                                ? state.purchasedBundles
                                : [...state.purchasedBundles, action.payload]
                        };
                    case ACTION_TYPES.UPDATE_LIMITS:
                        return {
                            ...state,
                            freeLimit: action.payload.freeLimit !== undefined ? action.payload.freeLimit : state.freeLimit,
                            nextReplenishTime: action.payload.nextReplenishTime !== undefined ? action.payload.nextReplenishTime : state.nextReplenishTime
                        };
                    case ACTION_TYPES.SET_DAILY_COMPLETED:
                        return {
                            ...state,
                            dailyCompleted: action.payload,
                            lastDailyGoalDate: Date.now()
                        };
                    case ACTION_TYPES.RESET_DAILY_GOAL:
                        return {
                            ...state,
                            dailyCompleted: 0,
                            lastDailyGoalDate: Date.now()
                        };
                    case ACTION_TYPES.UPDATE_PORTFOLIO_SETTINGS:
                        return {
                            ...state,
                            portfolioSettings: action.payload
                        };
                    default:
                        return state;
                }
            };

            const [state, dispatch] = useReducer(appReducer, initialState);

            // ============================================
            // FIREBASE & STRIPE INTEGRATION
            // ============================================
            const [firebaseUser, setFirebaseUser] = useState(null);

            // 1. Auth Listener
            useEffect(() => {
                if (!isFirebaseReady) return;
                const unsubscribe = auth.onAuthStateChanged(u => setFirebaseUser(u));
                return () => unsubscribe();
            }, []);

            // 2. Purchase Sync Listener (Firestore -> App)
            useEffect(() => {
                if (!isFirebaseReady || !firebaseUser) return;

                // (A) Annual Subscriptions
                const subUnsub = db.collection('customers').doc(firebaseUser.uid).collection('subscriptions')
                    .where('status', 'in', ['active', 'trialing'])
                    .onSnapshot(snap => {
                        // In this app, any active sub means 'annual' plan (unless we have tiers)
                        if (!snap.empty) {
                            dispatch({ type: ACTION_TYPES.SET_PLAN, payload: 'annual' });
                        }
                    });

                // (B) One-time Payments (Lifetime / Single)
                const payUnsub = db.collection('customers').doc(firebaseUser.uid).collection('payments')
                    .where('status', '==', 'succeeded')
                    .onSnapshot(snap => {
                        snap.docs.forEach(doc => {
                            const data = doc.data();
                            const meta = data.metadata || {};

                            if (meta.firebaseRole === 'lifetime' || meta.firebaseRole === 'lifetime-upgrade') {
                                dispatch({ type: ACTION_TYPES.SET_PLAN, payload: 'lifetime' });
                            } else if (meta.firebaseRole === 'roadmap' && meta.targetRoadmap) {
                                dispatch({ type: ACTION_TYPES.PURCHASE_BUNDLE, payload: meta.targetRoadmap });
                            }
                        });
                    });

                return () => { subUnsub(); payUnsub(); };
            }, [firebaseUser]);

            // 3. Actions
            const handleFirebaseLogin = async () => {
                if (!isFirebaseReady) return;
                try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
                catch (e) { alert("„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº: " + e.message); }
            };

            const handleFirebaseLogout = async () => {
                if (!isFirebaseReady) return;
                await auth.signOut();
            };

            const createCheckoutSession = async (role, targetRoadmap = null) => {
                if (!isFirebaseReady) return;
                if (!firebaseUser) {
                    if (confirm("Ë≥ºÂÖ•„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åô„ÅãÔºü")) handleFirebaseLogin();
                    return;
                }

                alert("StripeÊ±∫Ê∏à„ÇíÈñãÂßã„Åó„Åæ„Åô...Â∞ë„ÄÖ„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ");

                try {
                    // Find product by metadata
                    const productsSnap = await db.collection('products').where('active', '==', true).where('metadata.firebaseRole', '==', role).get();
                    if (productsSnap.empty) throw new Error("ÂïÜÂìÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì (metadata: " + role + ")");

                    const priceSnap = await productsSnap.docs[0].ref.collection('prices').where('active', '==', true).limit(1).get();
                    if (priceSnap.empty) throw new Error("‰æ°Ê†ºË®≠ÂÆö„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");

                    // Determine Stripe Checkout Mode
                    // annual -> subscription
                    // lifetime / roadmap -> payment
                    const mode = (role === 'annual') ? 'subscription' : 'payment';

                    // Create Session
                    const docRef = await db.collection('customers').doc(firebaseUser.uid).collection('checkout_sessions').add({
                        price: priceSnap.docs[0].id,
                        mode: mode,
                        success_url: window.location.href,
                        cancel_url: window.location.href,
                        metadata: { firebaseRole: role, targetRoadmap }
                    });

                    // Wait for redirect URL
                    docRef.onSnapshot(snap => {
                        const { url, error } = snap.data() || {};
                        if (error) alert("„Ç®„É©„Éº: " + error.message);
                        if (url) window.location.assign(url);
                    });
                } catch (e) {
                    alert("„Ç®„É©„Éº: " + e.message);
                }
            };

            // Destructure for convenience (read-only)
            const {
                showSplash, showSettings, showDisclaimer, showIOSPrompt, pageParams,
                onboardingStep, currentPage, userProfile, userGoals,
                learnProgress, userPlan, understoodCards, unclearCards,
                purchasedBundles, freeLimit, nextReplenishTime, dailyCompleted,
                portfolioSettings
            } = state;

            // Save persisted state to localStorage (debounced)
            useEffect(() => {
                const saveTimeout = setTimeout(() => {
                    try {
                        const stateToSave = {
                            onboardingStep: state.onboardingStep,
                            currentPage: state.currentPage,
                            userProfile: state.userProfile,
                            userGoals: state.userGoals,
                            learnProgress: state.learnProgress,
                            userPlan: state.userPlan,
                            understoodCards: state.understoodCards,
                            unclearCards: state.unclearCards,
                            purchasedBundles: state.purchasedBundles,
                            freeLimit: state.freeLimit,
                            nextReplenishTime: state.nextReplenishTime,
                            dailyCompleted: state.dailyCompleted,
                            lastDailyGoalDate: state.lastDailyGoalDate,
                            portfolioSettings: state.portfolioSettings
                        };
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
                    } catch (e) {
                        console.warn('Failed to save state:', e);
                    }
                }, 500);
                return () => clearTimeout(saveTimeout);
            }, [state]);

            // Check for new day to reset daily goal
            useEffect(() => {
                const lastDate = new Date(state.lastDailyGoalDate);
                const today = new Date();
                // If last goal date is not today (different day), reset
                if (lastDate.toDateString() !== today.toDateString()) {
                    dispatch({ type: ACTION_TYPES.RESET_DAILY_GOAL });
                }
            }, [state.lastDailyGoalDate]); // Run once on mount

            // ============================================
            // ACTION DISPATCHERS (memoized)
            // ============================================
            const acceptDisclaimer = useCallback(() => {
                dispatch({ type: ACTION_TYPES.ACCEPT_DISCLAIMER });
                // Check if iOS Safari and not already installed as PWA
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                const isStandalone = window.navigator.standalone === true;
                const hasSeenPrompt = sessionStorage.getItem('ios_prompt_seen');
                if (isIOS && !isStandalone && !hasSeenPrompt) {
                    dispatch({ type: ACTION_TYPES.SHOW_IOS_PROMPT });
                    sessionStorage.setItem('ios_prompt_seen', 'true');
                }
            }, []);

            const dismissIOSPrompt = useCallback(() => {
                dispatch({ type: ACTION_TYPES.DISMISS_IOS_PROMPT });
            }, []);

            const finishSplash = useCallback(() => {
                dispatch({ type: ACTION_TYPES.FINISH_SPLASH });
            }, []);

            const handleNavigate = useCallback((page, params) => {
                dispatch({ type: ACTION_TYPES.SET_PAGE, payload: { page, params } });
                if (page === 'gallery') {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }, []);

            const finishCalibration = useCallback((profile) => {
                dispatch({ type: ACTION_TYPES.SET_PROFILE, payload: profile });
                dispatch({ type: ACTION_TYPES.SET_ONBOARDING, payload: 3 });
                dispatch({ type: ACTION_TYPES.SET_PAGE, payload: { page: 'portfolio' } });
            }, []);

            const skipOnboarding = useCallback(() => {
                dispatch({ type: ACTION_TYPES.SET_ONBOARDING, payload: 3 });
                dispatch({ type: ACTION_TYPES.SET_PAGE, payload: { page: 'gallery' } });
            }, []);

            const handleDiagnosisComplete = useCallback((profile) => {
                dispatch({ type: ACTION_TYPES.SET_PROFILE, payload: profile });
                dispatch({ type: ACTION_TYPES.SET_PAGE, payload: { page: 'portfolio' } });
            }, []);

            const handleSkip = useCallback(() => {
                dispatch({ type: ACTION_TYPES.SET_PAGE, payload: { page: 'gallery' } });
            }, []);

            const handleSetProfile = useCallback((profile) => {
                dispatch({ type: ACTION_TYPES.SET_PROFILE, payload: profile });
            }, []);

            const handleSetPlan = (plan) => {
                if (isFirebaseReady) {
                    // Only trigger checkout for paid plans
                    if (plan === 'annual' || plan === 'lifetime' || plan === 'lifetime-upgrade') {
                        createCheckoutSession(plan);
                        return;
                    }
                }
                dispatch({ type: ACTION_TYPES.SET_PLAN, payload: plan });
            };

            const handleSetProgress = useCallback((progress) => {
                dispatch({ type: ACTION_TYPES.SET_PROGRESS, payload: progress });
            }, []);

            const handleUpdateCards = useCallback((cards) => {
                dispatch({ type: ACTION_TYPES.UPDATE_CARDS, payload: cards });
            }, []);

            const handleOpenSettings = useCallback(() => {
                dispatch({ type: ACTION_TYPES.TOGGLE_SETTINGS, payload: true });
            }, []);

            const handleCloseSettings = useCallback(() => {
                dispatch({ type: ACTION_TYPES.TOGGLE_SETTINGS, payload: false });
            }, []);

            const handleClearPreSelection = useCallback(() => {
                dispatch({ type: ACTION_TYPES.SET_PAGE_PARAMS, payload: null });
            }, []);

            const handlePurchaseBundle = (bundleId) => {
                if (isFirebaseReady) {
                    createCheckoutSession('roadmap', bundleId);
                } else {
                    dispatch({ type: ACTION_TYPES.PURCHASE_BUNDLE, payload: bundleId });
                }
            };

            const handleUpdateLimits = useCallback((limits) => {
                dispatch({ type: ACTION_TYPES.UPDATE_LIMITS, payload: limits });
                // If limits are being replenished (implied by adding to freeLimit or resetting time),
                // we should also reset the daily goal for the new "session"
                if (limits.freeLimit && limits.freeLimit > state.freeLimit) {
                    dispatch({ type: ACTION_TYPES.RESET_DAILY_GOAL });
                }
            }, [state.freeLimit]); // Add state.freeLimit dependency to compare

            const handleUpdateDailyCompleted = useCallback(({ dailyCompleted }) => {
                dispatch({ type: ACTION_TYPES.SET_DAILY_COMPLETED, payload: dailyCompleted });
            }, []);

            const handleUpdatePortfolioSettings = useCallback((settings) => {
                dispatch({ type: ACTION_TYPES.UPDATE_PORTFOLIO_SETTINGS, payload: settings });
            }, []);

            // ============================================
            // CONTENT RENDERER
            // ============================================
            const renderContent = () => {
                if (onboardingStep === 1) {
                    return <PortfolioCalibration onComplete={finishCalibration} isOnboarding={true} onSkip={skipOnboarding} onNavigate={handleNavigate} />;
                }

                switch (currentPage) {
                    case 'diagnosis':
                        return <PortfolioCalibration onComplete={handleDiagnosisComplete} onSkip={handleSkip} existingProfile={userProfile} isOnboarding={onboardingStep === 1} onNavigate={handleNavigate} />;
                    case 'portfolio':
                        return <PortfolioCreator
                            userProfile={userProfile}
                            onNavigate={handleNavigate}
                            userPlan={userPlan}
                            onUpgrade={() => handleSetPlan('annual')}
                            portfolioSettings={portfolioSettings}
                            onSave={handleUpdatePortfolioSettings}
                        />;
                    case 'market':
                        return <MarketIntelligence onNavigate={handleNavigate} />;
                    case 'briefing':
                        return <TheBriefing
                            onNavigate={handleNavigate}
                            userProfile={userProfile}
                            userGoals={userGoals}
                            onProgressUpdate={handleSetProgress}
                            userPlan={userPlan}
                            onUpgrade={handleSetPlan}
                            understoodCards={understoodCards}
                            unclearCards={unclearCards}
                            dailyCompleted={dailyCompleted}
                            setUnderstoodCards={(cards) => handleUpdateCards({ understood: cards })}
                            setUnclearCards={(cards) => handleUpdateCards({ unclear: cards })}
                            purchasedBundles={purchasedBundles}
                            onPurchaseBundle={handlePurchaseBundle}
                            freeLimit={freeLimit}
                            nextReplenishTime={nextReplenishTime}
                            onUpdateLimits={handleUpdateLimits}
                            onUpdateDailyCompleted={handleUpdateDailyCompleted}
                        />;
                    case 'calibration':
                        return <PortfolioCalibration existingProfile={userProfile} onComplete={(p) => { handleSetProfile(p); handleNavigate('gallery'); }} onNavigate={handleNavigate} />;
                    case 'brokers':
                        return <BrokerComparison onNavigate={handleNavigate} />;
                    case 'tokushoho':
                        return <Tokushoho onNavigate={handleNavigate} />;
                    default:
                        return <AssetGallery onNavigate={handleNavigate} preSelectedAssetId={pageParams?.assetId} onClearPreSelection={handleClearPreSelection} />;
                }
            };

            // ============================================
            // RENDER
            // ============================================
            return (
                <div className="font-sans text-platinum selection:bg-gold/30">
                    {showSplash && <SplashScreen onComplete={finishSplash} />}

                    {showDisclaimer && !showSplash && <DisclaimerModal onAccept={acceptDisclaimer} />}

                    {showIOSPrompt && !showSplash && !showDisclaimer && <IOSInstallPrompt onDismiss={dismissIOSPrompt} />}

                    {!showSplash && !showDisclaimer && !showIOSPrompt && (
                        <motion.div key="main" initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                            <Header
                                currentPage={currentPage}
                                onNavigate={handleNavigate}
                                onOpenSettings={handleOpenSettings}
                                showNav={true}
                                userProfile={userProfile}
                                progress={learnProgress}
                                firebaseUser={firebaseUser}
                                onLogin={handleFirebaseLogin}
                                onLogout={handleFirebaseLogout}
                            />
                            {renderContent()}
                            <AnimatePresence>
                                <SettingsModal isOpen={showSettings} onClose={handleCloseSettings} onNavigate={handleNavigate} userPlan={userPlan} onUpgrade={handleSetPlan} />
                            </AnimatePresence>
                        </motion.div>
                    )}
                </div>
            );
        };


        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>