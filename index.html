<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invision - æŠ•è³‡æˆ¦ç•¥ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </title>
    <meta name="description" content="æŠ•è³‡ã‚’å§‹ã‚ã‚‹å‰ã«ã€è‡ªåˆ†ã‚’çŸ¥ã‚‹ã€‚Invisionã¯ã€ã‚ãªãŸã«æœ€é©ãªæŠ•è³‡æˆ¦ç•¥ã‚’å°ãé«˜å“è³ªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/framer-motion@11/dist/framer-motion.js"></script>
    <script src="cards.js?v=2"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        obsidian: '#050505',
                        matte: '#0a0a0a',
                        carbon: '#111111',
                        ash: '#1a1a1a',
                        stone: '#2a2a2a',
                        gold: '#C9A227',
                        platinum: '#E8E8E8',
                        dim: '#666666',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'ticker': 'ticker 40s linear infinite',
                    },
                    keyframes: {
                        ticker: {
                            '0%': { transform: 'translateX(0)' },
                            '100%': { transform: 'translateX(-100%)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* ============================================
           DESIGN TOKENS
           ============================================ */
        :root {
            /* Colors - Primary */
            --color-gold: #C9A227;
            --color-gold-light: #E8D068;
            --color-gold-dark: #9A7B1E;

            /* Colors - Neutral */
            --color-obsidian: #050505;
            --color-ash: #1A1A1A;
            --color-platinum: #E8E8E8;
            --color-dim: #6B7280;

            /* Colors - Semantic */
            --color-success: #10B981;
            --color-warning: #F59E0B;
            --color-error: #EF4444;
            --color-info: #3B82F6;

            /* Spacing Scale (4px base) */
            --space-1: 0.25rem;
            /* 4px */
            --space-2: 0.5rem;
            /* 8px */
            --space-3: 0.75rem;
            /* 12px */
            --space-4: 1rem;
            /* 16px */
            --space-5: 1.25rem;
            /* 20px */
            --space-6: 1.5rem;
            /* 24px */
            --space-8: 2rem;
            /* 32px */
            --space-10: 2.5rem;
            /* 40px */
            --space-12: 3rem;
            /* 48px */
            --space-16: 4rem;
            /* 64px */

            /* Typography Scale */
            --text-xs: 0.75rem;
            /* 12px */
            --text-sm: 0.875rem;
            /* 14px */
            --text-base: 1rem;
            /* 16px */
            --text-lg: 1.125rem;
            /* 18px */
            --text-xl: 1.25rem;
            /* 20px */
            --text-2xl: 1.5rem;
            /* 24px */
            --text-3xl: 1.875rem;
            /* 30px */
            --text-4xl: 2.25rem;
            /* 36px */

            /* Border Radius */
            --radius-sm: 2px;
            --radius-md: 4px;
            --radius-lg: 8px;
            --radius-full: 9999px;

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 300ms ease;
            --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 50px rgba(0, 0, 0, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background: var(--color-obsidian);
            color: var(--color-platinum);
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
        }

        /* ============================================
           SCROLLBAR STYLES
           ============================================ */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: var(--color-obsidian);
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-gold);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-full);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(201, 162, 39, 0.3);
            border-radius: var(--radius-full);
        }

        /* ============================================
           BUTTON STYLES
           ============================================ */
        .btn-sharp {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all var(--transition-slow);
            cursor: pointer;
            font-weight: 600;
        }

        .btn-sharp:hover {
            border-color: rgba(201, 162, 39, 0.4);
            color: var(--color-gold);
            background: rgba(201, 162, 39, 0.03);
        }

        .btn-primary {
            background: var(--color-gold);
            color: var(--color-obsidian);
            border: none;
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-sm);
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .btn-primary:hover {
            background: var(--color-gold-light);
            box-shadow: 0 0 20px rgba(201, 162, 39, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-platinum);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--color-error);
            border: 1px solid rgba(239, 68, 68, 0.5);
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .btn-danger:hover {
            background: var(--color-error);
            color: white;
        }

        /* ============================================
           INPUT STYLES
           ============================================ */
        .input-base {
            width: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
            padding: var(--space-3) var(--space-4);
            color: var(--color-platinum);
            font-size: var(--text-sm);
            transition: border-color var(--transition-normal);
            outline: none;
        }

        .input-base:focus {
            border-color: var(--color-gold);
        }

        .input-base::placeholder {
            color: var(--color-dim);
        }

        /* ============================================
           TYPOGRAPHY
           ============================================ */
        .text-gold-gradient {
            background: linear-gradient(135deg, var(--color-gold), var(--color-gold-light));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .text-label {
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--color-dim);
        }

        /* ============================================
           EFFECTS
           ============================================ */
        .grain::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.15;
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        .custom-shadow {
            box-shadow: var(--shadow-xl);
        }

        .subtle-border {
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        /* Luxury glow effects */
        .luxury-glow {
            box-shadow:
                0 0 80px rgba(201, 162, 39, 0.1),
                0 0 120px rgba(201, 162, 39, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .luxury-glow::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(105deg,
                    transparent 20%,
                    rgba(255, 255, 255, 0.03) 25%,
                    transparent 30%);
            animation: shimmer 8s infinite;
        }

        .luxury-glow:hover {
            box-shadow:
                0 0 100px rgba(201, 162, 39, 0.15),
                0 0 150px rgba(201, 162, 39, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Frosted glass effect */
        .glass-panel {
            background: linear-gradient(135deg, rgba(28, 28, 28, 0.8), rgba(18, 18, 18, 0.6));
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 0 80px rgba(201, 162, 39, 0.03);
        }

        /* ============================================
           ERROR / FEEDBACK STYLES
           ============================================ */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-sm);
            padding: var(--space-3) var(--space-4);
            color: var(--color-error);
            font-size: var(--text-sm);
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: var(--radius-sm);
            padding: var(--space-3) var(--space-4);
            color: var(--color-success);
            font-size: var(--text-sm);
        }

        .warning-message {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: var(--radius-sm);
            padding: var(--space-3) var(--space-4);
            color: var(--color-warning);
            font-size: var(--text-sm);
        }

        /* Radar Chart Animations */
        @keyframes radarDraw {
            to {
                stroke-dashoffset: 0;
            }
        }

        @keyframes radarFadeIn {
            to {
                opacity: 1;
            }
        }

        /* iOS Install Prompt */
        .ios-share-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border: 2px solid #C9A227;
            border-radius: 6px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback, useReducer } = React;
        const { motion, AnimatePresence } = Motion;

        // ============================================
        // SHARED CONSTANTS
        // ============================================
        const profiles = [
            {
                id: 'guardian',
                name: 'The Guardian',
                nameJp: 'å®ˆè­·è€…',
                icon: 'ğŸ›¡ï¸',
                description: 'è³‡ç”£ã‚’å®ˆã‚‹ã“ã¨ã‚’æœ€å„ªå…ˆã€‚å…ƒæœ¬å‰²ã‚Œãƒªã‚¹ã‚¯ã‚’æ¥µåŠ›é¿ã‘ã€é é‡‘ã‚„å›½å‚µãªã©å®‰å…¨è³‡ç”£ã‚’ä¸­å¿ƒã«é‹ç”¨ã—ã¾ã™ã€‚',
                detailedDescription: 'ã‚ãªãŸã¯è³‡ç”£ã®ã€Œå®ˆã‚Šã€ã‚’é‡è¦–ã™ã‚‹ã‚¿ã‚¤ãƒ—ã§ã™ã€‚å¸‚å ´ã®å¤‰å‹•ã«ä¸€å–œä¸€æ†‚ã›ãšã€ç€å®Ÿã«è³‡ç”£ã‚’å®ˆã‚ŠãªãŒã‚‰ã€ã‚¤ãƒ³ãƒ•ãƒ¬ã«è² ã‘ãªã„ç¨‹åº¦ã®åˆ©å›ã‚Šã‚’ç›®æŒ‡ã—ã¾ã™ã€‚å…ƒæœ¬ä¿è¨¼ã‚„ä½ãƒªã‚¹ã‚¯å•†å“ã‚’å¥½ã¿ã€æŠ•è³‡ã‚ˆã‚Šã‚‚è²¯è“„ã«è¿‘ã„ã‚¹ã‚¿ãƒ³ã‚¹ã§è³‡ç”£å½¢æˆã«å–ã‚Šçµ„ã¿ã¾ã™ã€‚',
                strengths: ['æš´è½æ™‚ã§ã‚‚å†·é™ã«å¯¾å¿œã§ãã‚‹', 'ç„¡ç†ã®ãªã„é‹ç”¨ã§é•·æœŸç¶™ç¶šã—ã‚„ã™ã„', 'ç”Ÿæ´»é˜²è¡›è³‡é‡‘ã‚’ã—ã£ã‹ã‚Šç¢ºä¿ã§ãã‚‹'],
                watchOut: ['ã‚¤ãƒ³ãƒ•ãƒ¬ã«è² ã‘ã¦å®Ÿè³ªçš„ãªè³‡ç”£ä¾¡å€¤ãŒç›®æ¸›ã‚Šã™ã‚‹å¯èƒ½æ€§', 'æ©Ÿä¼šæå¤±ï¼ˆã‚‚ã£ã¨å¢—ã‚„ã›ãŸã‹ã‚‚ï¼‰ã¸ã®å¾Œæ‚”'],
                levelAdvice: {
                    1: 'ã¾ãšã¯ã€ŒãªãœæŠ•è³‡ãŒå¿…è¦ã‹ã€ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚é é‡‘ã ã‘ã§ã¯ã‚¤ãƒ³ãƒ•ãƒ¬ã«è² ã‘ã¦ã—ã¾ã†ç†ç”±ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒç¬¬ä¸€æ­©ã§ã™ã€‚',
                    2: 'å›½å‚µã‚„å®šæœŸé é‡‘ã®ä»•çµ„ã¿ã‚’æ·±æ˜ã‚Šã—ã€ã¤ã¿ãŸã¦NISAã®éèª²ç¨ãƒ¡ãƒªãƒƒãƒˆã‚‚æ¤œè¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚',
                    3: 'å®ˆã‚Šã®è³‡ç”£ã¨æ”»ã‚ã®è³‡ç”£ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è¦‹ç›´ã—ã€å°‘ã—ãšã¤ãƒªã‚¹ã‚¯è³‡ç”£ã¸ã®é…åˆ†ã‚‚æ¤œè¨ã—ã¦ã¿ã¦ã¯ã€‚'
                },
                traits: ['æ…é‡æ´¾', 'é•·æœŸå®‰å®šå¿—å‘', 'ä½ãƒªã‚¹ã‚¯'],
                allocation: { safe: 80, balanced: 15, growth: 5 },
                recommended: ['å›½å†…å‚µåˆ¸', 'å®šæœŸé é‡‘', 'ãƒãƒ©ãƒ³ã‚¹ãƒ•ã‚¡ãƒ³ãƒ‰']
            },
            {
                id: 'custodian',
                name: 'The Custodian',
                nameJp: 'ç®¡ç†äºº',
                icon: 'ğŸ¦‰',
                description: 'è³‡ç”£ã®ä¿å…¨ã‚’é‡è¦–ã—ã¤ã¤ã€ã‚¤ãƒ³ãƒ•ãƒ¬è² ã‘ã—ãªã„ç¨‹åº¦ã®é‹ç”¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚å …å®Ÿãªç®¡ç†ã§è³‡ç”£ã‚’å®ˆã‚Šè‚²ã¦ã¾ã™ã€‚',
                detailedDescription: 'ã‚ãªãŸã¯ã€Œè³‡ç”£ã‚’è³¢ãç®¡ç†ã™ã‚‹ã€ã“ã¨ã«é•·ã‘ã¦ã„ã¾ã™ã€‚ãƒªã‚¹ã‚¯ã‚’æŠ‘ãˆãªãŒã‚‰ã‚‚ã€ãŸã çœ ã‚‰ã›ã¦ãŠãã®ã§ã¯ãªãã€ã‚¤ãƒ³ãƒ•ãƒ¬ç‡ã‚’ä¸Šå›ã‚‹é‹ç”¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚è¨ˆç”»çš„ã§ã€ç„¡é§„é£ã„ã‚’å«Œã„ã€ç€å®Ÿã«è³‡ç”£ã‚’ç©ã¿ä¸Šã’ã¦ã„ãã‚¿ã‚¤ãƒ—ã§ã™ã€‚',
                strengths: ['è¨ˆç”»çš„ãªè³‡ç”£ç®¡ç†ãŒã§ãã‚‹', 'æ„Ÿæƒ…ã«æµã•ã‚Œã«ãã„æŠ•è³‡åˆ¤æ–­', 'é•·æœŸçš„ãªè¦–ç‚¹ã‚’æŒã¦ã‚‹'],
                watchOut: ['æ…é‡ã™ãã¦æŠ•è³‡ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’é€ƒã™ã“ã¨ãŒã‚ã‚‹', 'éåº¦ãªç¯€ç´„å¿—å‘ãŒQOLã‚’ä¸‹ã’ã‚‹å¯èƒ½æ€§'],
                levelAdvice: {
                    1: 'è¤‡åˆ©ã®åŠ›ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚ã€Œ72ã®æ³•å‰‡ã€ã‚’çŸ¥ã‚‹ã¨ã€æ™‚é–“ã‚’å‘³æ–¹ã«ã¤ã‘ã‚‹é‡è¦æ€§ãŒã‚ã‹ã‚Šã¾ã™ã€‚',
                    2: 'å›½å‚µã¨ç¤¾å‚µã®é•ã„ã€æŠ•è³‡ä¿¡è¨—ã®ä»•çµ„ã¿ã‚’ç†è§£ã—ã€æ‰‹æ•°æ–™ã®ä½ã„å•†å“ã‚’é¸ã¶ç›®ã‚’é¤Šã„ã¾ã—ã‚‡ã†ã€‚',
                    3: 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç†è«–ã®åŸºç¤ã‚’å­¦ã³ã€åˆ†æ•£æŠ•è³‡ã®åŠ¹æœã‚’æœ€å¤§åŒ–ã™ã‚‹é…åˆ†ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚'
                },
                traits: ['ç®¡ç†é‡è¦–', 'å …å®Ÿ', 'é˜²è¡›çš„'],
                allocation: { safe: 70, balanced: 25, growth: 5 },
                recommended: ['å›½å‚µ', 'é«˜æ ¼ä»˜ç¤¾å‚µ', 'å®ˆã‚Šã®æŠ•ä¿¡']
            },
            {
                id: 'conservative',
                name: 'The Conservative',
                nameJp: 'å …å®Ÿå®¶',
                icon: 'ğŸ›ï¸',
                description: 'å®‰å®šã‚’é‡è¦–ã—ã¤ã¤ã‚‚ã€å°‘ã—ãšã¤è³‡ç”£ã‚’å¢—ã‚„ã—ãŸã„ã€‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŠ•è³‡ã‚’è»¸ã«ã€ç€å®Ÿãªæˆé•·ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚',
                detailedDescription: 'ã‚ãªãŸã¯ã€Œå®‰å®šã€ã¨ã€Œæˆé•·ã€ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å¤§åˆ‡ã«ã—ã¾ã™ã€‚ä¸€ç™ºé€†è»¢ã‚’ç‹™ã†ã®ã§ã¯ãªãã€ã‚³ãƒ„ã‚³ãƒ„ã¨ç©ã¿ç«‹ã¦ã‚‹ã“ã¨ã§ç¢ºå®Ÿã«è³‡ç”£ã‚’å¢—ã‚„ã—ã¦ã„ãã‚¹ã‚¿ã‚¤ãƒ«ã€‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ãƒ³ãƒ‰ã‚„ã¤ã¿ãŸã¦NISAã¨ã®ç›¸æ€§ãŒæŠœç¾¤ã§ã™ã€‚',
                strengths: ['å¸‚å ´å¹³å‡ã«ä¹—ã‚‹è³¢æ˜ã•', 'æ„Ÿæƒ…çš„ãªå£²è²·ã‚’ã—ã«ãã„', 'é•·æœŸæŠ•è³‡ã«å‘ã„ã¦ã„ã‚‹æ€§æ ¼'],
                watchOut: ['é€€å±ˆã«æ„Ÿã˜ã‚‹ã“ã¨ãŒã‚ã‚‹', 'å‘¨ã‚ŠãŒãƒã‚¤ãƒªã‚¿ãƒ¼ãƒ³ã‚’å¾—ã¦ã„ã‚‹ã¨ç„¦ã‚‹å¯èƒ½æ€§'],
                levelAdvice: {
                    1: 'ã¤ã¿ãŸã¦NISAã®ä»•çµ„ã¿ã¨ã€ãªãœã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŠ•è³‡ãŒæ¨å¥¨ã•ã‚Œã‚‹ã®ã‹ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚',
                    2: 'å…¨ä¸–ç•Œæ ªå¼ã¨ç±³å›½æ ªå¼ã®é•ã„ã€ç‚ºæ›¿ãƒªã‚¹ã‚¯ã«ã¤ã„ã¦ç†è§£ã‚’æ·±ã‚ã¾ã—ã‚‡ã†ã€‚',
                    3: 'ãƒªãƒãƒ©ãƒ³ã‚¹ã®è€ƒãˆæ–¹ã‚„ã€å‚µåˆ¸ã‚’çµ„ã¿åˆã‚ã›ãŸãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæ§‹ç¯‰ã‚’å­¦ã‚“ã§ã¿ã¦ã¯ã€‚'
                },
                traits: ['å®‰å®šé‡è¦–', 'è¨ˆç”»çš„', 'å …å®Ÿ'],
                allocation: { safe: 60, balanced: 30, growth: 10 },
                recommended: ['ã¤ã¿ãŸã¦NISA', 'å…¨ä¸–ç•Œæ ªå¼', 'å‚µåˆ¸ãƒ•ã‚¡ãƒ³ãƒ‰']
            },
            {
                id: 'architect',
                name: 'The Architect',
                nameJp: 'æ§‹ç¯‰è€…',
                icon: 'ğŸ—ï¸',
                description: 'ãƒãƒ©ãƒ³ã‚¹ã‚’é‡è¦–ã—ã€é•·æœŸçš„ãªè³‡ç”£å½¢æˆã‚’è¨­è¨ˆã€‚æ ªå¼ã¨å‚µåˆ¸ã‚’çµ„ã¿åˆã‚ã›ãŸãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã§å …å®Ÿã«è³‡ç”£ã‚’è‚²ã¦ã¾ã™ã€‚',
                detailedDescription: 'ã‚ãªãŸã¯ã€Œè¨­è¨ˆè€…ã€ã®ã‚ˆã†ã«ã€å…¨ä½“åƒã‚’è¦‹ãªãŒã‚‰è³‡ç”£å½¢æˆã‚’é€²ã‚ã¾ã™ã€‚æ ªå¼ã¨å‚µåˆ¸ã€å›½å†…ã¨æµ·å¤–ã€æˆé•·ã¨ã‚¤ãƒ³ã‚«ãƒ â”€â”€æ§˜ã€…ãªè¦ç´ ã‚’çµ„ã¿åˆã‚ã›ã¦ã€è‡ªåˆ†ã ã‘ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã«å–œã³ã‚’æ„Ÿã˜ã‚‹ã‚¿ã‚¤ãƒ—ã§ã™ã€‚',
                strengths: ['è«–ç†çš„ãªãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæ§‹ç¯‰ãŒã§ãã‚‹', 'åˆ†æ•£æŠ•è³‡ã®åŠ¹æœã‚’æœ€å¤§åŒ–ã§ãã‚‹', 'ãƒªãƒãƒ©ãƒ³ã‚¹ã‚’è¨ˆç”»çš„ã«å®Ÿè¡Œã§ãã‚‹'],
                watchOut: ['åˆ†æã«æ™‚é–“ã‚’ã‹ã‘ã™ãã¦è¡Œå‹•ãŒé…ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹', 'å®Œç’§ã‚’æ±‚ã‚ã™ãã‚‹å‚¾å‘'],
                levelAdvice: {
                    1: 'ã€Œåµã‚’ä¸€ã¤ã®ã‚«ã‚´ã«ç››ã‚‹ãªã€ã®æ„å‘³ã‚’å®Ÿæ„Ÿã—ã€åˆ†æ•£æŠ•è³‡ã®åŸºæœ¬ã‚’èº«ã«ã¤ã‘ã¾ã—ã‚‡ã†ã€‚',
                    2: 'iDeCoã®ç¨åˆ¶ãƒ¡ãƒªãƒƒãƒˆã€ã‚¢ã‚»ãƒƒãƒˆã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è€ƒãˆæ–¹ã‚’æ·±æ˜ã‚Šã—ã¾ã—ã‚‡ã†ã€‚',
                    3: 'ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ªã‚„ãƒªã‚¹ã‚¯èª¿æ•´å¾Œãƒªã‚¿ãƒ¼ãƒ³ãªã©ã€ã‚ˆã‚Šé«˜åº¦ãªæŒ‡æ¨™ã‚‚å­¦ã‚“ã§ã¿ã¦ã¯ã€‚'
                },
                traits: ['ãƒãƒ©ãƒ³ã‚¹å‹', 'è«–ç†çš„', 'é•·æœŸè¦–ç‚¹'],
                allocation: { safe: 40, balanced: 40, growth: 20 },
                recommended: ['iDeCo', 'ãƒãƒ©ãƒ³ã‚¹ãƒ•ã‚¡ãƒ³ãƒ‰', 'ç±³å›½æ ªå¼']
            },
            {
                id: 'strategist',
                name: 'The Strategist',
                nameJp: 'æˆ¦ç•¥å®¶',
                icon: 'â™Ÿï¸',
                description: 'å¸‚å ´ã®å‹•ãã‚’åˆ†æã—ã€æ©Ÿå‹•çš„ã«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’èª¿æ•´ã€‚å®ˆã‚Šã¨æ”»ã‚ã‚’å·§ã¿ã«ä½¿ã„åˆ†ã‘ã€è¶…éãƒªã‚¿ãƒ¼ãƒ³ã‚’ç‹™ã„ã¾ã™ã€‚',
                detailedDescription: 'ã‚ãªãŸã¯å¸‚å ´ã‚’ã€Œèª­ã‚€ã€ã“ã¨ã«èˆˆå‘³ãŒã‚ã‚Šã¾ã™ã€‚çµŒæ¸ˆæŒ‡æ¨™ã‚„ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¦‹ã¦æŠ•è³‡åˆ¤æ–­ã‚’ä¸‹ã™ã“ã¨ã«é­…åŠ›ã‚’æ„Ÿã˜ã‚‹ã‚¿ã‚¤ãƒ—ã€‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªé‹ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ã§ã€å¸‚å ´å¹³å‡ã‚’ä¸Šå›ã‚‹ãƒªã‚¿ãƒ¼ãƒ³ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚',
                strengths: ['å¸‚å ´å‹•å‘ã¸ã®é«˜ã„æ„Ÿåº¦', 'æŸ”è»Ÿãªãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªèª¿æ•´', 'ãƒªã‚¹ã‚¯ç®¡ç†æ„è­˜ãŒé«˜ã„'],
                watchOut: ['é »ç¹ãªå£²è²·ã§ã‚³ã‚¹ãƒˆãŒã‹ã•ã‚€å¯èƒ½æ€§', 'ã€Œèª­ã¿ã€ãŒå¤–ã‚ŒãŸæ™‚ã®ãƒ€ãƒ¡ãƒ¼ã‚¸'],
                levelAdvice: {
                    1: 'ã¾ãšã¯çµŒæ¸ˆãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’èª­ã‚€ç¿’æ…£ã‚’ã¤ã‘ã€å¸‚å ´ãŒã©ã†åå¿œã™ã‚‹ã‹ã‚’è¦³å¯Ÿã—ã¾ã—ã‚‡ã†ã€‚',
                    2: 'ã‚»ã‚¯ã‚¿ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚„æ™¯æ°—ã‚µã‚¤ã‚¯ãƒ«ã®è€ƒãˆæ–¹ã‚’å­¦ã³ã€ETFã‚’æ´»ç”¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚',
                    3: 'ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã®åŸºç¤ã‚„ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³æˆ¦ç•¥ãªã©ã‚‚è¦–é‡ã«å…¥ã‚Œã¦ã¿ã¦ã¯ã€‚'
                },
                traits: ['æˆ¦ç•¥çš„', 'æ©Ÿå‹•æ€§', 'åˆ†æé‡è¦–'],
                allocation: { safe: 30, balanced: 40, growth: 30 },
                recommended: ['ã‚»ã‚¯ã‚¿ãƒ¼ETF', 'ã‚¹ãƒãƒ¼ãƒˆãƒ™ãƒ¼ã‚¿', 'ãƒªãƒ¼ãƒˆ']
            },
            {
                id: 'explorer',
                name: 'The Explorer',
                nameJp: 'æ¢æ±‚è€…',
                icon: 'ğŸ”­',
                description: 'æˆé•·æ©Ÿä¼šã‚’ç©æ¥µçš„ã«è¿½æ±‚ã€‚ãƒªã‚¹ã‚¯ã‚’ç†è§£ã—ãŸä¸Šã§ã€ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚„æ–°èˆˆå¸‚å ´ã¸ã®æŠ•è³‡ã‚‚æ¤œè¨ã—ã¾ã™ã€‚',
                detailedDescription: 'ã‚ãªãŸã¯ã€Œæˆé•·ã€ã«é­…åŠ›ã‚’æ„Ÿã˜ã‚‹ã‚¿ã‚¤ãƒ—ã§ã™ã€‚æ–°ã—ã„ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚„æœªé–‹æ‹“ã®å¸‚å ´ã«èˆˆå‘³ãŒã‚ã‚Šã€å¤§ããªãƒªã‚¿ãƒ¼ãƒ³ã‚’æ±‚ã‚ã¦ç©æ¥µçš„ã«æŠ•è³‡å…ˆã‚’æ¢æ±‚ã—ã¾ã™ã€‚å¥½å¥‡å¿ƒæ—ºç››ã§ã€å­¦ã¶ã“ã¨ã‚’æ¥½ã—ã‚ã‚‹æ€§æ ¼ã§ã™ã€‚',
                strengths: ['æˆé•·æ ªã‚„ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‹å—…è¦š', 'å­¦ç¿’æ„æ¬²ãŒé«˜ã„', 'å¤±æ•—ã‚’æã‚ŒãšæŒ‘æˆ¦ã§ãã‚‹'],
                watchOut: ['éåº¦ãªé›†ä¸­æŠ•è³‡ã®ãƒªã‚¹ã‚¯', 'FOMOï¼ˆä¹—ã‚Šé…ã‚Œææ€–ï¼‰ã«é§†ã‚‰ã‚ŒãŸåˆ¤æ–­'],
                levelAdvice: {
                    1: 'ã€Œæˆé•·æ ªã€ã¨ã¯ä½•ã‹ã€ãªãœãƒªã‚¹ã‚¯ãŒé«˜ã„ã®ã‹ã‚’ã—ã£ã‹ã‚Šç†è§£ã—ã¾ã—ã‚‡ã†ã€‚',
                    2: 'PERã‚„PBRãªã©ã®åŸºæœ¬çš„ãªãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™ã‚’å­¦ã³ã€å‰²é«˜ãƒ»å‰²å®‰ã‚’åˆ¤æ–­ã§ãã‚‹ã‚ˆã†ã«ã€‚',
                    3: 'æ–°èˆˆå›½æŠ•è³‡ã®ãƒªã‚¹ã‚¯ï¼ˆæ”¿æ²»ãƒ»ç‚ºæ›¿ãƒ»æµå‹•æ€§ï¼‰ã‚„ã€ãƒ†ãƒ¼ãƒæŠ•è³‡ã®è½ã¨ã—ç©´ã‚‚æŠ¼ã•ãˆã¦ãŠãã¾ã—ã‚‡ã†ã€‚'
                },
                traits: ['æˆé•·å¿—å‘', 'å¥½å¥‡å¿ƒæ—ºç››', 'ä¸­ã€œé«˜ãƒªã‚¹ã‚¯'],
                allocation: { safe: 25, balanced: 35, growth: 40 },
                recommended: ['ç±³å›½æ ªå¼', 'ãƒ†ãƒƒã‚¯æ ª', 'æ–°èˆˆå›½ãƒ•ã‚¡ãƒ³ãƒ‰']
            },
            {
                id: 'visionary',
                name: 'The Visionary',
                nameJp: 'å…ˆè¦‹è€…',
                icon: 'ğŸ¦…',
                description: 'æ¬¡ä¸–ä»£ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ã„ã¡æ—©ãæ•æ‰ã€‚é«˜ã„æˆé•·æ€§ãŒè¦‹è¾¼ã‚ã‚‹åˆ†é‡ã¸ç©æ¥µçš„ã«è³‡é‡‘ã‚’é…åˆ†ã—ã€å¤§ããªé£›èºã‚’ç‹™ã„ã¾ã™ã€‚',
                detailedDescription: 'ã‚ãªãŸã¯ã€Œæœªæ¥ã‚’è¦‹ã‚‹ç›®ã€ã‚’æŒã£ã¦ã„ã¾ã™ã€‚AIã‚„å®‡å®™é–‹ç™ºã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¨ãƒãƒ«ã‚®ãƒ¼ãªã©ã€ã“ã‚Œã‹ã‚‰ä¼¸ã³ã‚‹åˆ†é‡ã‚’è¦‹æ¥µã‚ã€æ—©ã„æ®µéšã§æŠ•è³‡ã™ã‚‹ã“ã¨ã§å¤§ããªãƒªã‚¿ãƒ¼ãƒ³ã‚’ç‹™ã†ã‚¿ã‚¤ãƒ—ã€‚å…ˆè¡Œè€…åˆ©ç›Šã‚’å–ã‚Šã«ã„ãã‚¹ã‚¿ã‚¤ãƒ«ã§ã™ã€‚',
                strengths: ['ãƒˆãƒ¬ãƒ³ãƒ‰ã®åˆæœŸæ®µéšã§å‚å…¥ã§ãã‚‹', 'é•·æœŸçš„ãªãƒ“ã‚¸ãƒ§ãƒ³ã‚’æŒã¦ã‚‹', 'å¸‚å ´ã®å¤‰åŒ–ã«æ•æ„Ÿ'],
                watchOut: ['ã€Œæ—©ã™ããŸã€æŠ•è³‡ã§è³‡é‡‘ãŒå¡©æ¼¬ã‘ã«ãªã‚‹ãƒªã‚¹ã‚¯', 'ãƒ†ãƒ¼ãƒæ ªã®æ€¥è½'],
                levelAdvice: {
                    1: 'ãƒ†ãƒ¼ãƒæŠ•è³‡ã¨åˆ†æ•£æŠ•è³‡ã®é•ã„ã‚’ç†è§£ã—ã€ãƒªã‚¹ã‚¯ç®¡ç†ã®åŸºæœ¬ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚',
                    2: 'æ¥­ç•Œåˆ†æã®æ–¹æ³•ã‚„ã€æˆé•·ç”£æ¥­ã‚’è¦‹æ¥µã‚ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’èº«ã«ã¤ã‘ã¾ã—ã‚‡ã†ã€‚',
                    3: 'IPOæŠ•è³‡ã‚„ãƒ™ãƒ³ãƒãƒ£ãƒ¼æŠ•è³‡ã®ä¸–ç•Œã‚‚è¦—ã„ã¦ã¿ã¦ã¯ã€‚ãŸã ã—è³‡é‡‘ç®¡ç†ã¯å³æ ¼ã«ã€‚'
                },
                traits: ['å…ˆè¦‹æ€§', 'ãƒˆãƒ¬ãƒ³ãƒ‰å¿—å‘', 'ç©æ¥µçš„'],
                allocation: { safe: 15, balanced: 30, growth: 55 },
                recommended: ['ã‚°ãƒ­ãƒ¼ã‚¹æ ª', 'ãƒ†ãƒ¼ãƒå‹æŠ•ä¿¡', 'ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³æ ']
            },
            {
                id: 'pioneer',
                name: 'The Pioneer',
                nameJp: 'é–‹æ‹“è€…',
                icon: 'ğŸš€',
                description: 'ãƒã‚¤ãƒªã‚¹ã‚¯ãƒ»ãƒã‚¤ãƒªã‚¿ãƒ¼ãƒ³ã‚’æã‚Œãªã„æŒ‘æˆ¦è€…ã€‚æš—å·è³‡ç”£ã‚„IPOéŠ˜æŸ„ãªã©ã€é«˜æˆé•·åˆ†é‡ã«æœæ•¢ã«æŒ‘ã¿ã¾ã™ã€‚',
                detailedDescription: 'ã‚ãªãŸã¯ã€Œé–‹æ‹“è€…ã€ã§ã™ã€‚ã¾ã èª°ã‚‚è¶³ã‚’è¸ã¿å…¥ã‚Œã¦ã„ãªã„é ˜åŸŸã«é£›ã³è¾¼ã¿ã€å¤§ããªãƒªã‚¿ãƒ¼ãƒ³ã‚’ç‹™ã†ã“ã¨ã«èˆˆå¥®ã‚’æ„Ÿã˜ã‚‹ã‚¿ã‚¤ãƒ—ã€‚æš—å·è³‡ç”£ã‚„IPOã€ãƒ¬ãƒãƒ¬ãƒƒã‚¸å•†å“ãªã©ã€ãƒã‚¤ãƒªã‚¹ã‚¯ãƒ»ãƒã‚¤ãƒªã‚¿ãƒ¼ãƒ³ãªæŠ•è³‡ã«ã‚‚è‡†ã—ã¾ã›ã‚“ã€‚',
                strengths: ['é«˜ã„ãƒªã‚¹ã‚¯è¨±å®¹åº¦', 'å¤§ããªãƒªã‚¿ãƒ¼ãƒ³ã‚’å¾—ã‚‹å¯èƒ½æ€§', 'æ–°ã—ã„è³‡ç”£ã‚¯ãƒ©ã‚¹ã¸ã®ç†è§£'],
                watchOut: ['å…ƒæœ¬ã‚’å¤§ããæ¯€æã™ã‚‹ãƒªã‚¹ã‚¯', 'æŠ•æ©Ÿã¨æŠ•è³‡ã®å¢ƒç•Œç·šãŒã‚ã„ã¾ã„ã«ãªã‚ŠãŒã¡'],
                levelAdvice: {
                    1: 'ãƒã‚¤ãƒªã‚¹ã‚¯æŠ•è³‡ã¯ã€Œä½™å‰°è³‡é‡‘ã€ã§è¡Œã†ã¹ãç†ç”±ã‚’ç†è§£ã—ã¾ã—ã‚‡ã†ã€‚ç”Ÿæ´»è²»ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã“ã¨ã€‚',
                    2: 'æš—å·è³‡ç”£ã®ä»•çµ„ã¿ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã€ã‚¦ã‚©ãƒ¬ãƒƒãƒˆï¼‰ã‚„ãƒ¬ãƒãƒ¬ãƒƒã‚¸ã®æœ¬å½“ã®ãƒªã‚¹ã‚¯ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚',
                    3: 'ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚¸ãƒ³ã‚°ã‚„æåˆ‡ã‚Šãƒ«ãƒ¼ãƒ«ãªã©ã€ãƒ—ãƒ­ã®è³‡é‡‘ç®¡ç†è¡“ã‚’èº«ã«ã¤ã‘ã¾ã—ã‚‡ã†ã€‚'
                },
                traits: ['æŒ‘æˆ¦çš„', 'é«˜ãƒªã‚¹ã‚¯è¨±å®¹', 'ã‚¢ã‚°ãƒ¬ãƒƒã‚·ãƒ–'],
                allocation: { safe: 10, balanced: 25, growth: 65 },
                recommended: ['å€‹åˆ¥æ ª', 'ä»®æƒ³é€šè²¨', 'ãƒ¬ãƒãƒ¬ãƒƒã‚¸å•†å“']
            },
        ];

        // ============================================
        // SETTINGS MODAL
        // ============================================
        // ============================================
        // SETTINGS MODAL - Simplified (API keys removed for security)
        // ============================================
        const SettingsModal = ({ isOpen, onClose, onNavigate }) => {
            const [confirmReset, setConfirmReset] = useState(false);

            if (!isOpen) return null;

            const handleReset = () => {
                try {
                    localStorage.removeItem('invision_state_v1');
                    window.location.reload();
                } catch (err) {
                    console.error('Reset failed:', err);
                }
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-obsidian/80 backdrop-blur-sm">
                    <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.95 }}
                        className="w-full max-w-md bg-ash border border-white/10 p-8 rounded-sm shadow-2xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-dim hover:text-white">âœ•</button>
                        <h2 className="text-xl font-bold text-platinum mb-6">è¨­å®š</h2>

                        <div className="space-y-6">
                            {/* App Info */}
                            <div className="space-y-3">
                                <h3 className="text-sm font-bold text-platinum border-b border-white/10 pb-2">ã‚¢ãƒ—ãƒªæƒ…å ±</h3>
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-dim">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</span>
                                    <span className="text-platinum font-mono">1.0.0</span>
                                </div>
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-dim">ãƒ“ãƒ«ãƒ‰</span>
                                    <span className="text-platinum font-mono">2026.02.04</span>
                                </div>
                            </div>

                            {/* Data Reset */}
                            <div className="space-y-4 pt-4 border-t border-white/10">
                                <h3 className="text-sm font-bold text-platinum border-b border-white/10 pb-2">æ³•çš„äº‹é …</h3>
                                <button onClick={() => { onClose(); onNavigate('tokushoho'); }}
                                    className="w-full text-left text-sm text-dim hover:text-gold transition-colors py-1 flex items-center justify-between group">
                                    ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜
                                    <span className="text-white/20 group-hover:text-gold">â†’</span>
                                </button>
                            </div>

                            {/* Data Reset */}
                            <div className="space-y-4 pt-4 border-t border-white/10">
                                <h3 className="text-sm font-bold text-rose-500 border-b border-rose-500/20 pb-2">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                                <p className="text-xs text-dim leading-relaxed">
                                    ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆå­¦ç¿’çŠ¶æ³ãƒ»è¨ºæ–­çµæœãƒ»ãƒ—ãƒ©ãƒ³æƒ…å ±ãªã©ï¼‰ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                                </p>

                                {!confirmReset ? (
                                    <button onClick={() => setConfirmReset(true)} className="w-full py-3 bg-rose-500/10 border border-rose-500/50 text-rose-500 text-sm font-bold rounded-sm hover:bg-rose-500 hover:text-white transition-all">
                                        ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                                    </button>
                                ) : (
                                    <div className="space-y-3">
                                        <p className="text-sm text-rose-400 font-bold text-center">æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
                                        <div className="flex gap-2">
                                            <button onClick={() => setConfirmReset(false)} className="flex-1 py-3 bg-ash border border-white/10 text-platinum text-sm font-bold rounded-sm hover:bg-white/10 transition-colors">
                                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                            </button>
                                            <button onClick={handleReset} className="flex-1 py-3 bg-rose-600 text-white text-sm font-bold rounded-sm hover:bg-rose-500 shadow-lg shadow-rose-900/50 transition-colors">
                                                å‰Šé™¤ã™ã‚‹
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="mt-8 pt-4 border-t border-white/10">
                            <button onClick={onClose} className="w-full py-3 bg-white/5 border border-white/10 text-platinum text-sm font-bold rounded-sm hover:bg-white/10 transition-colors">
                                é–‰ã˜ã‚‹
                            </button>
                        </div>
                    </motion.div>
                </div>
            );
        };

        // ============================================
        // MARKET COMPONENTS - LUXURY EDITION
        // ============================================
        // Helper: Generate Dynamic User Title
        const getUserTitle = (profile, progress = 0) => {
            if (!profile) return "ã‚²ã‚¹ãƒˆ";

            const levels = {
                1: "é§†ã‘å‡ºã—",
                2: "è¦‹ç¿’ã„",
                3: "ç†Ÿç·´ã®",
                4: "æ­´æˆ¦ã®",
                5: "ä¼èª¬ã®"
            };

            // Base level from diagnosis (initialLevel) + bonus from progress (1 level per 20 cards)
            const currentLevel = Math.min(5, (profile.experienceLevel || 1) + Math.floor(progress / 20));
            const type = profile.nameJp || profile.baseType || "æŠ•è³‡å®¶";

            return `${levels[currentLevel]}${type}`;
        };

        const MarketTicker = ({ items }) => (
            <div className="fixed bottom-0 left-0 right-0 h-10 bg-obsidian/90 backdrop-blur-lg border-t border-white/5 z-50 flex items-center overflow-hidden">
                <div className="flex animate-ticker whitespace-nowrap">
                    {[...items, ...items, ...items].map((item, i) => (
                        <div key={i} className="flex items-center gap-3 mx-8 text-[10px] font-mono">
                            <span className="text-white/40">{item.symbol}</span>
                            <span className="text-white/60">{item.price}</span>
                            <span className={`${item.trend === 'up' ? 'text-emerald-400/60' : 'text-rose-400/60'}`}>{item.change}</span>
                        </div>
                    ))}
                </div>
            </div>
        );

        const MarketIntelligence = ({ onNavigate }) => {
            const [data, setData] = useState({ ticker: [], news: [], grok: [] });
            const [activeTab, setActiveTab] = useState('All');
            const [timeLeft, setTimeLeft] = useState(3600);
            const [isUpdating, setIsUpdating] = useState(false);
            const [isLive, setIsLive] = useState(false);

            useEffect(() => { fetchMarketData(); }, []);
            useEffect(() => { const t = setInterval(() => { setTimeLeft(p => { if (p <= 1) { fetchMarketData(); return 3600; } return p - 1; }); }, 1000); return () => clearInterval(t); }, []);

            const fetchMarketData = async () => {
                setIsUpdating(true);
                let cData = { bitcoin: { usd: 0, usd_24h_change: 0 }, ethereum: { usd: 0, usd_24h_change: 0 } };
                try { const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd,jpy&include_24hr_change=true'); if (r.ok) { cData = await r.json(); setIsLive(true); } } catch (e) { setIsLive(false); }

                const mockTicker = [{ symbol: 'USD/JPY', price: '148.24', change: '+0.15%', trend: 'up' }, { symbol: 'NI225', price: '38,540', change: '-0.32%', trend: 'down' }, { symbol: 'S&P500', price: '5,088', change: '+0.45%', trend: 'up' }, { symbol: 'GOLD', price: '2,035', change: '+0.05%', trend: 'up' }, { symbol: 'NVDA', price: '788.15', change: '+3.50%', trend: 'up' }];
                if (cData.bitcoin.usd !== 0) {
                    const bc = cData.bitcoin.usd_24h_change.toFixed(2); mockTicker.push({ symbol: 'BTC/USD', price: cData.bitcoin.usd.toLocaleString(), change: (bc > 0 ? '+' : '') + bc + '%', trend: bc > 0 ? 'up' : 'down' });
                    const ec = cData.ethereum.usd_24h_change.toFixed(2); mockTicker.push({ symbol: 'ETH/USD', price: cData.ethereum.usd.toLocaleString(), change: (ec > 0 ? '+' : '') + ec + '%', trend: ec > 0 ? 'up' : 'down' });
                }

                const lNews = [
                    { id: 101, source: 'Bloomberg', time: '10m ago', title: 'ECBç·è£ã€Œã‚¤ãƒ³ãƒ•ãƒ¬ç‡2%ç›®æ¨™ã¸ã®ç¢ºä¿¡å¼·ã¾ã‚‹ã€', summary: 'ãƒ©ã‚¬ãƒ«ãƒ‰ç·è£ã¯ã€ãƒ¦ãƒ¼ãƒ­åœã®ã‚¤ãƒ³ãƒ•ãƒ¬åœ§åŠ›ãŒäºˆæƒ³ä»¥ä¸Šã«æ—©ãç·©å’Œã—ã¦ã„ã‚‹ã€‚', impact: 'High', category: 'Macro' },
                    { id: 102, source: 'Reuters', time: '30m ago', title: 'OpenAIã€æ–°ä½œå‹•ç”»ç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã€ŒSoraã€ã‚’å…¬é–‹', summary: 'ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æœ€é•·1åˆ†ã®é«˜å“è³ªå‹•ç”»ã‚’ç”Ÿæˆã€‚', impact: 'Medium', category: 'Tech' },
                    { id: 103, source: 'CoinGecko', time: 'Live', title: `BTC: $${cData.bitcoin?.usd?.toLocaleString() || 'N/A'}`, summary: 'CoinGecko Live Price', impact: 'High', category: 'Crypto' }
                ];

                const gData = [
                    { id: 201, topic: '$NVDA', sentiment: 'Bullish', score: 88, volume: '145K', summary: 'AIéœ€è¦ã®åº•å …ã•ã‹ã‚‰ã€ŒæŠ¼ã—ç›®è²·ã„ã€ã®å£°ãŒåœ§å€’çš„å¤šæ•°ã€‚' },
                    { id: 202, topic: 'CPI Watch', sentiment: 'Bearish', score: 65, volume: '220K', summary: 'ã‚¤ãƒ³ãƒ•ãƒ¬å†ç‡ƒã‚’è­¦æˆ’ã™ã‚‹æŠ•ç¨¿ãŒå¢—åŠ ä¸­ã€‚' },
                    { id: 203, topic: '#Bitcoin', sentiment: 'Bullish', score: 92, volume: '350K', summary: 'ã€ŒATHï¼ˆæœ€é«˜å€¤ï¼‰æ›´æ–°ã¯æ™‚é–“ã®å•é¡Œã€ã¨ã®è¦‹æ–¹ãŒæ”¯é…çš„ã€‚' }
                ];

                setData({ ticker: mockTicker, news: lNews, grok: gData });
                setTimeout(() => { setIsUpdating(false); setTimeLeft(3600); }, 800);
            };

            const formatTime = (s) => `${String(Math.floor(s / 60)).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`;
            const filteredNews = activeTab === 'All' ? data.news : data.news.filter(n => n.category === activeTab);

            return (
                <div className="min-h-screen bg-obsidian pt-24 pb-20 px-4 sm:px-8 relative overflow-hidden">
                    {/* Dynamic Background Lighting */}
                    <div className="fixed inset-0 pointer-events-none overflow-hidden">
                        <div className="absolute -top-[20%] -right-[10%] w-[800px] h-[800px] bg-gold/5 rounded-full blur-[150px] opacity-30" />
                        <div className="absolute bottom-[20%] -left-[10%] w-[600px] h-[600px] bg-emerald-500/5 rounded-full blur-[120px] opacity-20" />
                    </div>

                    <div className="max-w-6xl mx-auto relative z-10">
                        {/* Unified Header - Asset Gallery Style */}
                        <div className="mb-16">
                            <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }}>
                                <p className="text-dim text-xs tracking-[0.4em] mb-4 text-gold">MARKET INTELLIGENCE</p>
                                <h2 className="text-4xl md:text-5xl font-black tracking-tighter text-platinum mb-4">å¸‚å ´ã‚’<span className="text-gold-gradient">è¦‹ã¤ã‚ã‚‹</span></h2>
                                <div className="flex items-center gap-4">
                                    <p className="text-dim text-sm">å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã¨AIåˆ†æ</p>
                                    {isLive && <span className="text-[10px] text-emerald-400 bg-emerald-500/10 border border-emerald-500/30 px-3 py-1 rounded-full">â— LIVE</span>}
                                    <span className="text-xs text-dim font-mono">{formatTime(timeLeft)}</span>
                                    <button onClick={fetchMarketData} disabled={isUpdating} className={`text-dim hover:text-gold transition-all ${isUpdating ? 'animate-spin' : ''}`}>â†»</button>
                                </div>
                            </motion.div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
                            {/* Social Sentiment Panel */}
                            <div className="space-y-6">
                                <div className="flex items-center gap-4 mb-6 p-4 bg-gradient-to-r from-white/5 to-transparent rounded-sm border-l-2 border-gold/50">
                                    <div className="w-10 h-10 rounded-sm bg-gradient-to-br from-white to-gray-300 text-black flex items-center justify-center font-black text-lg">X</div>
                                    <div>
                                        <p className="text-lg font-bold text-platinum">Social Sentiment</p>
                                        <p className="text-xs text-dim">Powered by Grok AI</p>
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    {data.grok.map((item, i) => (
                                        <motion.div key={i} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: i * 0.15 }}
                                            className="bg-gradient-to-br from-ash/80 to-ash/40 border border-white/5 rounded-sm p-6 hover:border-gold/30 transition-all duration-300 group relative overflow-hidden">
                                            {/* Subtle glow on hover */}
                                            <div className={`absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 ${item.sentiment === 'Bullish' ? 'bg-emerald-500/5' : item.sentiment === 'Bearish' ? 'bg-rose-500/5' : 'bg-amber-500/5'}`} />
                                            <div className="relative z-10">
                                                <div className="flex justify-between items-start mb-4">
                                                    <h4 className="text-xl font-bold text-platinum group-hover:text-gold transition-colors">{item.topic}</h4>
                                                    <span className={`text-[10px] tracking-widest font-bold px-3 py-1.5 rounded-sm uppercase ${item.sentiment === 'Bullish' ? 'text-emerald-400 bg-emerald-500/10 border border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)]' : item.sentiment === 'Bearish' ? 'text-rose-400 bg-rose-500/10 border border-rose-500/30 shadow-[0_0_10px_rgba(244,63,94,0.2)]' : 'text-amber-400 bg-amber-500/10 border border-amber-500/30'}`}>
                                                        {item.sentiment === 'Bullish' ? 'BULLISH' : item.sentiment === 'Bearish' ? 'BEARISH' : 'MIXED'} {item.score}%
                                                    </span>
                                                </div>
                                                <div className="w-full h-2 bg-stone/50 rounded-full mb-4 overflow-hidden">
                                                    <motion.div initial={{ width: 0 }} animate={{ width: `${item.score}%` }} transition={{ duration: 1.2, delay: i * 0.2, ease: [0.4, 0, 0.2, 1] }}
                                                        className={`h-full ${item.sentiment === 'Bullish' ? 'bg-gradient-to-r from-emerald-600 to-emerald-400' : item.sentiment === 'Bearish' ? 'bg-gradient-to-r from-rose-600 to-rose-400' : 'bg-gradient-to-r from-amber-600 to-amber-400'}`} />
                                                </div>
                                                <p className="text-sm text-platinum/70 leading-relaxed">{item.summary}</p>
                                            </div>
                                        </motion.div>
                                    ))}
                                </div>
                            </div>

                            {/* News Feed */}
                            <div className="space-y-6">
                                <div className="flex gap-3 mb-6 border-b border-white/5 pb-4">
                                    {['All', 'Macro', 'Crypto', 'Tech'].map(tab => (
                                        <button key={tab} onClick={() => setActiveTab(tab)}
                                            className={`px-4 py-2 rounded-sm text-sm transition-all font-medium ${activeTab === tab ? 'bg-gold/10 text-gold border border-gold/30' : 'text-dim hover:text-platinum'}`}>
                                            {tab}
                                        </button>
                                    ))}
                                </div>
                                <div className="space-y-4">
                                    <AnimatePresence mode="popLayout">
                                        {filteredNews.map((news, i) => (
                                            <motion.div key={i} initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} transition={{ delay: i * 0.08 }}
                                                className="group cursor-pointer p-4 rounded-sm border border-transparent hover:border-white/10 hover:bg-white/[0.02] transition-all duration-300">
                                                <div className="flex items-center gap-3 mb-2">
                                                    <span className="text-xs text-gold font-mono">{news.time}</span>
                                                    <span className="text-[10px] text-dim border border-white/10 px-2 py-0.5 rounded-sm">{news.source}</span>
                                                    {news.impact === 'High' && <span className="text-[10px] text-amber-400 bg-amber-500/10 border border-amber-500/30 px-2 py-0.5 rounded-sm">âš¡ HIGH</span>}
                                                </div>
                                                <h3 className="text-lg font-bold text-platinum mb-2 group-hover:text-gold transition-colors leading-tight">{news.title}</h3>
                                                <p className="text-sm text-platinum/60 leading-relaxed">{news.summary}</p>
                                            </motion.div>
                                        ))}
                                    </AnimatePresence>
                                </div>
                            </div>
                        </div>
                    </div>
                    <MarketTicker items={data.ticker} />
                </div>
            );
        };

        // ============================================
        // CALIBRATION (STEP 1) - WITH PROFILE DISPLAY
        // ============================================
        // ASSET DATA & MODAL
        // ============================================
        const assetDetailData = [
            {
                id: 1, name: 'NISA', nameJp: 'ã¤ã¿ãŸã¦NISA', tagline: 'éèª²ç¨ã§ã€æœªæ¥ã‚’ç©ã¿ä¸Šã’ã‚‹', image: 'https://images.unsplash.com/photo-1579621970563-ebec7560ff3e?w=800&q=80', riskLevel: 2,
                knowledge: ['å¹´é–“120ä¸‡å††ã¾ã§éèª²ç¨', 'æœ€é•·20å¹´ã®é‹ç”¨æœŸé–“', 'é•·æœŸãƒ»åˆ†æ•£ãƒ»ç©ç«‹ã®ç‹é“'],
                description: 'å›½ãŒç”¨æ„ã—ãŸã€ŒæŠ•è³‡ã®ç¨é‡‘ãŒã‹ã‹ã‚‰ãªã„ã€ãŠå¾—ãªåˆ¶åº¦ã€‚éŠ€è¡Œé é‡‘ã®å»¶é•·ã¨ã—ã¦ã€åˆå¿ƒè€…ãŒæœ€åˆã«å§‹ã‚ã‚‹ã¹ãæŠ•è³‡ã®å…¥ã‚Šå£ã§ã™ã€‚',
                pros: ['é‹ç”¨ç›ŠãŒéèª²ç¨ï¼ˆé€šå¸¸ç´„20%ã®ç¨é‡‘ãŒã‚¼ãƒ­ï¼‰', '100å††ã‹ã‚‰å§‹ã‚ã‚‰ã‚Œã‚‹è¨¼åˆ¸ä¼šç¤¾ã‚‚', 'é€”ä¸­ã§å£²å´ãƒ»å¼•ãå‡ºã—ã‚‚è‡ªç”±'],
                cons: ['å¹´é–“æŠ•è³‡ä¸Šé™ãŒ120ä¸‡å††', 'å…ƒæœ¬ä¿è¨¼ã¯ãªã„', 'éèª²ç¨æ ã®å†åˆ©ç”¨ã¯ç¿Œå¹´ä»¥é™'],
                steps: ['è¨¼åˆ¸å£åº§ã‚’é–‹è¨­ï¼ˆæ¥½å¤©ãƒ»SBIç­‰ï¼‰', 'NISAå£åº§ã‚’ç”³ã—è¾¼ã‚€', 'æŠ•è³‡ä¿¡è¨—ã‚’é¸ã¶ï¼ˆå…¨ä¸–ç•Œæ ªå¼ãŒäººæ°—ï¼‰', 'æ¯æœˆã®ç©ç«‹é‡‘é¡ã‚’è¨­å®š'],
                glossary: [{ word: 'éèª²ç¨', def: 'åˆ©ç›Šã«ç¨é‡‘ãŒã‹ã‹ã‚‰ãªã„ã“ã¨' }, { word: 'æŠ•è³‡ä¿¡è¨—', def: 'å°‚é–€å®¶ãŒé‹ç”¨ã™ã‚‹é‡‘èå•†å“ã®è©°ã‚åˆã‚ã›' }],
                brokers: [
                    { name: 'SBIè¨¼åˆ¸', feature: 'æ¥­ç•Œæœ€å®‰ã‚¯ãƒ©ã‚¹ã®æ‰‹æ•°æ–™ã€‚ã‚¯ãƒ¬ã‚«ç©ç«‹ã§ãƒã‚¤ãƒ³ãƒˆé‚„å…ƒ', url: 'https://www.sbisec.co.jp/', recommended: true },
                    { name: 'æ¥½å¤©è¨¼åˆ¸', feature: 'æ¥½å¤©ãƒã‚¤ãƒ³ãƒˆã§æŠ•è³‡å¯èƒ½ã€‚æ¥½å¤©çµŒæ¸ˆåœã¨ã®ç›¸æ€§â—', url: 'https://www.rakuten-sec.co.jp/' },
                    { name: 'ãƒãƒãƒƒã‚¯ã‚¹è¨¼åˆ¸', feature: 'dãƒã‚¤ãƒ³ãƒˆé‚„å…ƒç‡ãŒé«˜ã„ã€‚éŠ˜æŸ„åˆ†æãƒ„ãƒ¼ãƒ«å……å®Ÿ', url: 'https://www.monex.co.jp/' }
                ]
            },
            {
                id: 2, name: 'JP STOCKS', nameJp: 'å›½å†…æ ªå¼', tagline: 'æ—¥æœ¬ä¼æ¥­ã¨å…±ã«æˆé•·ã™ã‚‹', image: 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&q=80', riskLevel: 3,
                knowledge: ['é…å½“é‡‘ã§å®šæœŸåå…¥', 'æ ªä¸»å„ªå¾…ã¨ã„ã†ç‰¹å…¸', '100æ ªå˜ä½ãŒåŸºæœ¬'],
                description: 'ãƒˆãƒ¨ã‚¿ã€ã‚½ãƒ‹ãƒ¼ã€ä»»å¤©å ‚ãªã©ã€èº«è¿‘ãªæ—¥æœ¬ä¼æ¥­ã®ã‚ªãƒ¼ãƒŠãƒ¼ã«ãªã‚Œã¾ã™ã€‚é…å½“é‡‘ã‚„æ ªä¸»å„ªå¾…ã‚‚é­…åŠ›çš„ã§ã™ã€‚',
                pros: ['æ ªä¸»å„ªå¾…ã§å•†å“åˆ¸ã‚„å‰²å¼•ãŒè²°ãˆã‚‹', 'é…å½“é‡‘ã§å¹´1ã€œ2å›ã®åå…¥', 'ä¼æ¥­ã®æˆé•·ã¨å…±ã«è³‡ç”£å¢—åŠ '],
                cons: ['æœ€ä½100æ ªå˜ä½ã§æ•°ä¸‡ã€œæ•°åä¸‡å††å¿…è¦', 'ä¼æ¥­æ¥­ç¸¾ã«å·¦å³ã•ã‚Œã‚‹', 'ç‚ºæ›¿ãƒªã‚¹ã‚¯ãŒãªã„åˆ†ã€æˆé•·æ€§ã¯é™å®šçš„'],
                steps: ['è¨¼åˆ¸å£åº§ã‚’é–‹è¨­', 'æ°—ã«ãªã‚‹ä¼æ¥­ã‚’ç ”ç©¶', '100æ ªå˜ä½ã§è³¼å…¥', 'é•·æœŸä¿æœ‰ã§é…å½“ã¨å„ªå¾…ã‚’æ¥½ã—ã‚€'],
                glossary: [{ word: 'é…å½“é‡‘', def: 'ä¼æ¥­ãŒåˆ©ç›Šã®ä¸€éƒ¨ã‚’æ ªä¸»ã«åˆ†é…ã™ã‚‹ãŠé‡‘' }, { word: 'æ ªä¸»å„ªå¾…', def: 'æ ªä¸»ã¸ã®æ„Ÿè¬ã¨ã—ã¦ä¼æ¥­ãŒè´ˆã‚‹ç‰¹å…¸' }],
                brokers: [
                    { name: 'SBIè¨¼åˆ¸', feature: 'å›½å†…æ ªå–å¼•æ‰‹æ•°æ–™0å††ï¼ˆæ¡ä»¶ã‚ã‚Šï¼‰ã€‚IPOå–æ‰±ã„ãŒè±Šå¯Œ', url: 'https://www.sbisec.co.jp/' },
                    { name: 'æ¥½å¤©è¨¼åˆ¸', feature: 'æ¥½å¤©ãƒã‚¤ãƒ³ãƒˆæŠ•è³‡å¯¾å¿œã€‚ã„ã¡ã«ã¡å®šé¡ã§æ‰‹æ•°æ–™ç„¡æ–™æ ', url: 'https://www.rakuten-sec.co.jp/' },
                    { name: 'æ¾äº•è¨¼åˆ¸', feature: '50ä¸‡å††ã¾ã§æ‰‹æ•°æ–™ç„¡æ–™ã€‚æ ªä¸»å„ªå¾…æ¤œç´¢ãƒ„ãƒ¼ãƒ«å……å®Ÿ', url: 'https://www.matsui.co.jp/' }
                ]
            },
            {
                id: 3, name: 'US STOCKS', nameJp: 'ç±³å›½æ ªå¼', tagline: 'ä¸–ç•Œæœ€å¤§å¸‚å ´ã¸ã‚¢ã‚¯ã‚»ã‚¹', image: 'https://images.unsplash.com/photo-1534430480872-3498386e7856?w=800&q=80', riskLevel: 3,
                knowledge: ['GAFAMç­‰ã®å·¨å¤§ä¼æ¥­', '1æ ªã‹ã‚‰è³¼å…¥å¯èƒ½', 'ç‚ºæ›¿ãƒªã‚¹ã‚¯ã«æ³¨æ„'],
                description: 'Appleã€Googleã€Amazonãªã©ä¸–ç•Œã‚’å‹•ã‹ã™ãƒ†ãƒƒã‚¯ä¼æ¥­ã«æŠ•è³‡ã€‚1æ ªã‹ã‚‰è²·ãˆã‚‹æ‰‹è»½ã•ã¨ã€é«˜ã„æˆé•·æ€§ãŒé­…åŠ›ã€‚',
                pros: ['1æ ªã‹ã‚‰è³¼å…¥å¯èƒ½ï¼ˆæ•°åƒå††ã‹ã‚‰ï¼‰', 'ä¸–ç•Œæœ€å¤§ã®å¸‚å ´ã§æµå‹•æ€§ãŒé«˜ã„', 'éå»30å¹´ã§å¹´å¹³å‡ç´„10%ã®ãƒªã‚¿ãƒ¼ãƒ³'],
                cons: ['ç‚ºæ›¿ãƒªã‚¹ã‚¯ï¼ˆå††é«˜ã§æå¤±ã®å¯èƒ½æ€§ï¼‰', 'ç±³å›½ã®çµŒæ¸ˆãƒ»æ”¿æ²»å‹•å‘ã«å·¦å³ã•ã‚Œã‚‹', 'é…å½“ã«ç±³å›½ã§ã®æºæ³‰å¾´åã‚ã‚Š'],
                steps: ['ç±³å›½æ ªå¯¾å¿œã®è¨¼åˆ¸å£åº§ã‚’é–‹è¨­', 'ç‚ºæ›¿æ‰‹æ•°æ–™ã‚’ç¢ºèª', 'æ°—ã«ãªã‚‹éŠ˜æŸ„ã‚’ãƒ‰ãƒ«å»ºã¦ã§è³¼å…¥', 'ç¢ºå®šç”³å‘Šã§å¤–å›½ç¨é¡æ§é™¤ã‚’æ¤œè¨'],
                glossary: [{ word: 'ç‚ºæ›¿ãƒªã‚¹ã‚¯', def: 'å††ã¨ãƒ‰ãƒ«ã®äº¤æ›ãƒ¬ãƒ¼ãƒˆå¤‰å‹•ã«ã‚ˆã‚‹æç›Š' }, { word: 'S&P500', def: 'ç±³å›½ä¸»è¦500ç¤¾ã®æ ªä¾¡æŒ‡æ•°' }],
                brokers: [
                    { name: 'SBIè¨¼åˆ¸', feature: 'ç‚ºæ›¿æ‰‹æ•°æ–™æœ€å®‰ã€‚ç±³å›½æ ª4000éŠ˜æŸ„ä»¥ä¸Šå–æ‰±ã„', url: 'https://www.sbisec.co.jp/', recommended: true },
                    { name: 'ãƒãƒãƒƒã‚¯ã‚¹è¨¼åˆ¸', feature: 'ç±³å›½æ ªå–å¼•æ‰‹æ•°æ–™ãŒå®‰ã„ã€‚éŠ˜æŸ„ã‚¹ã‚«ã‚¦ã‚¿ãƒ¼å……å®Ÿ', url: 'https://www.monex.co.jp/' },
                    { name: 'æ¥½å¤©è¨¼åˆ¸', feature: 'å††è²¨æ±ºæ¸ˆå¯¾å¿œã€‚æ¥½å¤©ãƒã‚¤ãƒ³ãƒˆã§è³¼å…¥å¯èƒ½', url: 'https://www.rakuten-sec.co.jp/' }
                ]
            },
            {
                id: 4, name: 'FOREX', nameJp: 'FXå–å¼•', tagline: 'é€šè²¨ã®æ³¢ã‚’èª­ã‚€', image: 'https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=800&q=80', riskLevel: 5,
                knowledge: ['24æ™‚é–“å–å¼•å¯èƒ½', 'ãƒ¬ãƒãƒ¬ãƒƒã‚¸ã§åŠ¹ç‡åŒ–', 'ãƒªã‚¹ã‚¯ç®¡ç†ãŒå¿…é ˆ'],
                description: 'é€šè²¨ã‚’å£²è²·ã—ã¦ç‚ºæ›¿å·®ç›Šã‚’ç‹™ã†å–å¼•ã€‚å°‘é¡ã§å¤§ããªå–å¼•ãŒã§ãã¾ã™ãŒã€ãã®åˆ†ãƒªã‚¹ã‚¯ã‚‚é«˜ã„ä¸Šç´šè€…å‘ã‘ã€‚',
                pros: ['24æ™‚é–“å–å¼•å¯èƒ½', 'ãƒ¬ãƒãƒ¬ãƒƒã‚¸ã§è³‡é‡‘åŠ¹ç‡ãŒé«˜ã„', 'ä¸‹è½ç›¸å ´ã§ã‚‚åˆ©ç›Šã‚’ç‹™ãˆã‚‹'],
                cons: ['ãƒ¬ãƒãƒ¬ãƒƒã‚¸ã§æå¤±ã‚‚æ‹¡å¤§', 'ç›¸å ´äºˆæ¸¬ãŒéå¸¸ã«é›£ã—ã„', 'åˆå¿ƒè€…ã¯è³‡é‡‘ã‚’å¤±ã„ã‚„ã™ã„'],
                steps: ['FXå°‚ç”¨å£åº§ã‚’é–‹è¨­', 'ãƒ‡ãƒ¢å–å¼•ã§ç·´ç¿’', 'æœ€å°ãƒ­ãƒƒãƒˆã§å®Ÿè·µ', 'ãƒ­ã‚¹ã‚«ãƒƒãƒˆãƒ©ã‚¤ãƒ³ã‚’å¿…ãšè¨­å®š'],
                glossary: [{ word: 'ãƒ¬ãƒãƒ¬ãƒƒã‚¸', def: 'æ‰‹æŒã¡è³‡é‡‘ã®ä½•å€ã‚‚ã®å–å¼•ãŒã§ãã‚‹ä»•çµ„ã¿' }, { word: 'ãƒ­ã‚¹ã‚«ãƒƒãƒˆ', def: 'æå¤±ãŒä¸€å®šä»¥ä¸Šã«ãªã‚‹ã¨è‡ªå‹•æ±ºæ¸ˆã•ã‚Œã‚‹ä»•çµ„ã¿' }],
                brokers: [
                    { name: 'DMM FX', feature: 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ¥­ç•Œæœ€ç‹­æ°´æº–ã€‚ã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒªä½¿ã„ã‚„ã™ã„', url: 'https://fx.dmm.com/', recommended: true },
                    { name: 'GMOã‚¯ãƒªãƒƒã‚¯è¨¼åˆ¸', feature: 'å–å¼•é«˜ä¸–ç•Œä¸€ã€‚é«˜æ©Ÿèƒ½ãƒãƒ£ãƒ¼ãƒˆãƒ„ãƒ¼ãƒ«', url: 'https://www.click-sec.com/' },
                    { name: 'SBI FXãƒˆãƒ¬ãƒ¼ãƒ‰', feature: '1é€šè²¨ã‹ã‚‰å–å¼•å¯èƒ½ã€‚å°‘é¡ç·´ç¿’ã«æœ€é©', url: 'https://www.sbifxt.co.jp/' }
                ]
            },
            {
                id: 5, name: 'FUNDS', nameJp: 'æŠ•è³‡ä¿¡è¨—', tagline: 'ãƒ—ãƒ­ã«é‹ç”¨ã‚’ä»»ã›ã‚‹', image: 'https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=800&q=80', riskLevel: 2,
                knowledge: ['100å††ã‹ã‚‰åˆ†æ•£æŠ•è³‡', 'æ‰‹æ•°æ–™ã®ç¢ºèªã‚’', 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å‹ãŒäººæ°—'],
                description: 'å°‚é–€å®¶ãŒã‚ãªãŸã®ä»£ã‚ã‚Šã«é‹ç”¨ã™ã‚‹ã€ŒãŠé‡‘ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å•†å“ã€ã€‚1æœ¬ã§æ•°ç™¾ã€œæ•°åƒéŠ˜æŸ„ã«åˆ†æ•£æŠ•è³‡ã§ãã¾ã™ã€‚',
                pros: ['100å††ã‹ã‚‰æŠ•è³‡å¯èƒ½', 'åˆ†æ•£æŠ•è³‡ãŒè‡ªå‹•ã§ã§ãã‚‹', 'é‹ç”¨ã¯ãƒ—ãƒ­ã«ãŠä»»ã›'],
                cons: ['ä¿¡è¨—å ±é…¬ï¼ˆæ‰‹æ•°æ–™ï¼‰ãŒæ¯æ—¥ã‹ã‹ã‚‹', 'è‡ªåˆ†ã§éŠ˜æŸ„ã‚’é¸ã¹ãªã„', 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å‹ã¯æ‰‹æ•°æ–™ãŒé«˜ã‚'],
                steps: ['è¨¼åˆ¸å£åº§ã‚’é–‹è¨­', 'ä½ã‚³ã‚¹ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ãƒ³ãƒ‰ã‚’é¸ã¶', 'eMAXIS Slimã‚·ãƒªãƒ¼ã‚ºãªã©ãŒäººæ°—', 'æ¯æœˆç©ç«‹è¨­å®šã‚’ã™ã‚‹'],
                glossary: [{ word: 'ä¿¡è¨—å ±é…¬', def: 'æŠ•è³‡ä¿¡è¨—ã®é‹ç”¨ç®¡ç†ã«ã‹ã‹ã‚‹å¹´é–“æ‰‹æ•°æ–™' }, { word: 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹', def: 'æ—¥çµŒå¹³å‡ã‚„S&P500ãªã©ã®æŒ‡æ•°ã«é€£å‹•ã™ã‚‹é‹ç”¨' }],
                brokers: [
                    { name: 'SBIè¨¼åˆ¸', feature: 'æŠ•ä¿¡æœ¬æ•°ãŒè±Šå¯Œã€‚ã‚¯ãƒ¬ã‚«ç©ç«‹ã§ãƒã‚¤ãƒ³ãƒˆé‚„å…ƒ', url: 'https://www.sbisec.co.jp/' },
                    { name: 'æ¥½å¤©è¨¼åˆ¸', feature: 'æ¥½å¤©ã‚«ãƒ¼ãƒ‰ç©ç«‹ã§1%é‚„å…ƒã€‚ãƒã‚¤ãƒ³ãƒˆæŠ•è³‡å¯', url: 'https://www.rakuten-sec.co.jp/' },
                    { name: 'auã‚«ãƒ–ã‚³ãƒ è¨¼åˆ¸', feature: 'Pontaãƒã‚¤ãƒ³ãƒˆã§æŠ•è³‡å¯èƒ½ã€‚auãƒ¦ãƒ¼ã‚¶ãƒ¼å„ªé‡', url: 'https://kabu.com/' }
                ]
            },
            {
                id: 6, name: 'CRYPTO', nameJp: 'ä»®æƒ³é€šè²¨', tagline: 'ãƒ‡ã‚¸ã‚¿ãƒ«æ™‚ä»£ã®æ–°è³‡ç”£', image: 'https://images.unsplash.com/photo-1639762681485-074b7f938ba0?w=800&q=80', riskLevel: 5,
                knowledge: ['é«˜ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£', '24æ™‚é–“365æ—¥å–å¼•', 'ç·è³‡ç”£ã®5%ä»¥ä¸‹ãŒç›®å®‰'],
                description: 'ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ã‚„ã‚¤ãƒ¼ã‚µãƒªã‚¢ãƒ ãªã©ã€ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³æŠ€è¡“ã‚’åŸºç›¤ã¨ã—ãŸãƒ‡ã‚¸ã‚¿ãƒ«è³‡ç”£ã€‚ä¾¡æ ¼å¤‰å‹•ãŒæ¿€ã—ã„ãƒã‚¤ãƒªã‚¹ã‚¯æŠ•è³‡ã€‚',
                pros: ['24æ™‚é–“365æ—¥å–å¼•å¯èƒ½', 'å°‘é¡ã‹ã‚‰è³¼å…¥å¯èƒ½', 'é«˜ã„ãƒªã‚¿ãƒ¼ãƒ³ã®å¯èƒ½æ€§'],
                cons: ['ä¾¡æ ¼å¤‰å‹•ãŒéå¸¸ã«æ¿€ã—ã„', 'è¦åˆ¶ãƒªã‚¹ã‚¯ãŒã‚ã‚‹', 'ãƒãƒƒã‚­ãƒ³ã‚°ã‚„è©æ¬ºã®ãƒªã‚¹ã‚¯'],
                steps: ['æš—å·è³‡ç”£å–å¼•æ‰€ã§å£åº§é–‹è¨­', 'æœ¬äººç¢ºèªã‚’å®Œäº†', 'æ—¥æœ¬å††ã‚’å…¥é‡‘', 'BTC/ETHãªã©ä¸»è¦éŠ˜æŸ„ã‹ã‚‰å°‘é¡è³¼å…¥'],
                glossary: [{ word: 'ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£', def: 'ä¾¡æ ¼ã®å¤‰å‹•å¹…ã®å¤§ãã•' }, { word: 'ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³', def: 'å–å¼•å±¥æ­´ã‚’åˆ†æ•£ç®¡ç†ã™ã‚‹æŠ€è¡“' }],
                brokers: [
                    { name: 'bitFlyer', feature: 'å›½å†…å¤§æ‰‹ã®ä»®æƒ³é€šè²¨å–å¼•æ‰€ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã«æ³¨åŠ›', url: 'https://bitflyer.com/' },
                    { name: 'Coincheck', feature: 'ã‚¢ãƒ—ãƒªãŒã‚·ãƒ³ãƒ—ãƒ«ã€‚åˆå¿ƒè€…å‘ã‘UI', url: 'https://coincheck.com/' },
                    { name: 'GMOã‚³ã‚¤ãƒ³', feature: 'æ‰‹æ•°æ–™ãŒå®‰ã„ã€‚ç©ç«‹ã‚µãƒ¼ãƒ“ã‚¹å……å®Ÿ', url: 'https://coin.z.com/' }
                ]
            },
            {
                id: 7, name: 'iDeCo', nameJp: 'å€‹äººå‹ç¢ºå®šæ‹ å‡ºå¹´é‡‘', tagline: 'ç¨åˆ¶å„ªé‡ã§è€å¾Œã«å‚™ãˆã‚‹', image: 'https://images.unsplash.com/photo-1553729459-efe14ef6055d?w=800&q=80', riskLevel: 2,
                knowledge: ['æ›é‡‘ãŒå…¨é¡æ‰€å¾—æ§é™¤', 'é‹ç”¨ç›Šã‚‚éèª²ç¨', '60æ­³ã¾ã§å¼•ãå‡ºã—ä¸å¯'],
                description: 'è€å¾Œè³‡é‡‘å°‚ç”¨ã®ç§çš„å¹´é‡‘åˆ¶åº¦ã€‚ç¨åˆ¶å„ªé‡ãŒéå¸¸ã«æ‰‹åšãã€ç¯€ç¨ã—ãªãŒã‚‰è³‡ç”£å½¢æˆã§ãã¾ã™ã€‚ãŸã ã—60æ­³ã¾ã§å¼•ãå‡ºã›ã¾ã›ã‚“ã€‚',
                pros: ['æ›é‡‘ãŒå…¨é¡æ‰€å¾—æ§é™¤', 'é‹ç”¨ç›ŠãŒéèª²ç¨', 'å—å–æ™‚ã‚‚ç¨åˆ¶å„ªé‡'],
                cons: ['60æ­³ã¾ã§åŸå‰‡å¼•ãå‡ºã—ä¸å¯', 'åŠ å…¥è€…ã«ã‚ˆã£ã¦æ›é‡‘ä¸Šé™ãŒç•°ãªã‚‹', 'å£åº§ç®¡ç†æ‰‹æ•°æ–™ãŒã‹ã‹ã‚‹'],
                steps: ['åŠ å…¥è³‡æ ¼ã¨æ›é‡‘ä¸Šé™ã‚’ç¢ºèª', 'è¨¼åˆ¸ä¼šç¤¾ã§iDeCoå£åº§ã‚’é–‹è¨­', 'é‹ç”¨å•†å“ã‚’é¸æŠ', 'æ¯æœˆã®æ›é‡‘ã‚’è¨­å®š'],
                glossary: [{ word: 'æ‰€å¾—æ§é™¤', def: 'èª²ç¨å¯¾è±¡ã¨ãªã‚‹æ‰€å¾—ã‹ã‚‰å·®ã—å¼•ã‘ã‚‹é‡‘é¡' }, { word: 'ç¢ºå®šæ‹ å‡ºå¹´é‡‘', def: 'æ›é‡‘ã‚’è‡ªåˆ†ã§é‹ç”¨ã™ã‚‹å¹´é‡‘åˆ¶åº¦' }],
                brokers: [
                    { name: 'SBIè¨¼åˆ¸', feature: 'é‹å–¶ç®¡ç†æ‰‹æ•°æ–™ãŒç„¡æ–™ã€‚å•†å“ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—è±Šå¯Œ', url: 'https://www.sbisec.co.jp/', recommended: true },
                    { name: 'æ¥½å¤©è¨¼åˆ¸', feature: 'æ¥½å¤©è¨¼åˆ¸iDeCoå®šæœŸé é‡‘ã‚ã‚Šã€‚ã‚·ãƒ³ãƒ—ãƒ«è¨­è¨ˆ', url: 'https://www.rakuten-sec.co.jp/' },
                    { name: 'ãƒãƒãƒƒã‚¯ã‚¹è¨¼åˆ¸', feature: 'eMAXIS Slimå…¨ä¸–ç•Œå–æ‰±ã„ã€‚ä½ã‚³ã‚¹ãƒˆå•†å“å……å®Ÿ', url: 'https://www.monex.co.jp/' }
                ]
            },
            {
                id: 8, name: 'BONDS', nameJp: 'å‚µåˆ¸', tagline: 'å®‰å®šåç›Šã®åœŸå°ã‚’ä½œã‚‹', image: 'https://images.unsplash.com/photo-1554224155-6726b3ff858f?w=800&q=80', riskLevel: 1,
                knowledge: ['å›½å‚µã¯æœ€ã‚‚å®‰å…¨', 'å®šæœŸçš„ãªåˆ©æ¯åå…¥', 'é‡‘åˆ©ã¨ä¾¡æ ¼ã¯é€†ç›¸é–¢'],
                description: 'å›½ã‚„ä¼æ¥­ã«ãŠé‡‘ã‚’è²¸ã—ã€åˆ©æ¯ã‚’å—ã‘å–ã‚‹æŠ•è³‡ã€‚æ ªå¼ã‚ˆã‚Šä½ãƒªã‚¹ã‚¯ãƒ»ä½ãƒªã‚¿ãƒ¼ãƒ³ã§ã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®å®‰å®šå‰¤ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚',
                pros: ['æ ªå¼ã‚ˆã‚Šä¾¡æ ¼å¤‰å‹•ãŒå°ã•ã„', 'å®šæœŸçš„ãªåˆ©æ¯åå…¥', 'å›½å‚µã¯å…ƒæœ¬ä¿è¨¼ã«è¿‘ã„å®‰å…¨æ€§'],
                cons: ['æ ªå¼ã‚ˆã‚ŠæœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³ãŒä½ã„', 'é‡‘åˆ©ä¸Šæ˜‡ã§å‚µåˆ¸ä¾¡æ ¼ã¯ä¸‹è½', 'ã‚¤ãƒ³ãƒ•ãƒ¬ã«å¼±ã„'],
                steps: ['è¨¼åˆ¸å£åº§ã‚’é–‹è¨­', 'å€‹äººå‘ã‘å›½å‚µã‹å‚µåˆ¸ãƒ•ã‚¡ãƒ³ãƒ‰ã‚’é¸æŠ', 'å¤‰å‹•10å¹´å›½å‚µãŒåˆå¿ƒè€…å‘ã‘', 'è³¼å…¥å¾Œã¯æº€æœŸã¾ã§ä¿æœ‰'],
                glossary: [{ word: 'åˆ©å›ã‚Š', def: 'æŠ•è³‡é¡ã«å¯¾ã™ã‚‹å¹´é–“åç›Šã®å‰²åˆ' }, { word: 'å„Ÿé‚„', def: 'å‚µåˆ¸ã®æº€æœŸæ™‚ã«å…ƒæœ¬ãŒè¿”æ¸ˆã•ã‚Œã‚‹ã“ã¨' }],
                brokers: [
                    { name: 'SBIè¨¼åˆ¸', feature: 'å‚µåˆ¸ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—å……å®Ÿã€‚ç¤¾å‚µã‚‚è³¼å…¥å¯èƒ½', url: 'https://www.sbisec.co.jp/', recommended: true },
                    { name: 'æ¥½å¤©è¨¼åˆ¸', feature: 'å€‹äººå‘ã‘å›½å‚µè³¼å…¥ã§ãƒã‚¤ãƒ³ãƒˆé‚„å…ƒ', url: 'https://www.rakuten-sec.co.jp/' },
                    { name: 'è²¡å‹™çœ', feature: 'å€‹äººå‘ã‘å›½å‚µã®ç›´æ¥è³¼å…¥ã€‚æœ€ã‚‚å®‰å¿ƒ', url: 'https://www.mof.go.jp/jgbs/individual/' }
                ]
            }
        ];

        const AssetDetailModal = ({ asset, onClose }) => {
            if (!asset) return null;
            return (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="fixed inset-0 z-50 flex items-center justify-center bg-obsidian/95 backdrop-blur-md p-4 pt-10 sm:pt-4" onClick={onClose}>
                    <motion.div initial={{ opacity: 0, scale: 0.95, y: 20 }} animate={{ opacity: 1, scale: 1, y: 0 }} exit={{ opacity: 0, scale: 0.95 }} onClick={e => e.stopPropagation()}
                        className="w-full max-w-2xl max-h-[90vh] overflow-y-auto bg-ash border border-white/10 rounded-sm my-8 custom-shadow custom-scrollbar relative">
                        <div className="relative h-40 overflow-hidden">
                            <img src={asset.image} alt="" className="w-full h-full object-cover filter brightness-50" />
                            <div className="absolute inset-0 bg-gradient-to-t from-ash to-transparent" />
                            <button onClick={onClose} className="absolute top-4 right-4 text-white/70 hover:text-white text-2xl bg-black/50 w-10 h-10 rounded-full flex items-center justify-center">âœ•</button>
                            <div className="absolute bottom-4 left-6">
                                <h3 className="text-4xl font-black text-platinum">{asset.name}</h3>
                                <p className="text-gold font-bold">{asset.nameJp}</p>
                            </div>
                        </div>
                        <div className="p-6 space-y-6">
                            <p className="text-lg text-platinum/90 leading-relaxed">{asset.description}</p>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-sm p-4">
                                    <p className="text-xs text-emerald-500 uppercase tracking-wider mb-2 font-bold">ãƒ¡ãƒªãƒƒãƒˆ</p>
                                    <ul className="space-y-2">{asset.pros.map((p, i) => <li key={i} className="text-sm text-platinum/80 flex items-start gap-2"><span className="text-emerald-500">âœ“</span>{p}</li>)}</ul>
                                </div>
                                <div className="bg-rose-500/10 border border-rose-500/30 rounded-sm p-4">
                                    <p className="text-xs text-rose-500 uppercase tracking-wider mb-2 font-bold">ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ</p>
                                    <ul className="space-y-2">{asset.cons.map((c, i) => <li key={i} className="text-sm text-platinum/80 flex items-start gap-2"><span className="text-rose-500">!</span>{c}</li>)}</ul>
                                </div>
                            </div>

                            <div className="bg-obsidian/50 border border-white/5 rounded-sm p-4">
                                <p className="text-xs text-gold uppercase tracking-wider mb-3 font-bold">å§‹ã‚æ–¹ã‚¹ãƒ†ãƒƒãƒ—</p>
                                <div className="space-y-3">
                                    {asset.steps.map((s, i) => (
                                        <div key={i} className="flex items-center gap-4">
                                            <span className="w-8 h-8 rounded-full bg-gold/20 text-gold flex items-center justify-center font-bold text-sm">{i + 1}</span>
                                            <span className="text-sm text-platinum/80">{s}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {asset.glossary.length > 0 && (
                                <div className="border-t border-white/10 pt-4">
                                    <p className="text-xs text-dim uppercase tracking-wider mb-3">ç”¨èªè§£èª¬</p>
                                    <div className="flex flex-wrap gap-2">
                                        {asset.glossary.map((g, i) => (
                                            <div key={i} className="bg-obsidian/50 border border-white/5 px-3 py-2 rounded-sm group relative">
                                                <span className="text-gold text-sm cursor-help">{g.word}</span>
                                                <div className="absolute bottom-full left-0 mb-2 hidden group-hover:block bg-ash border border-white/10 p-3 rounded-sm w-48 z-10 shadow-xl">
                                                    <p className="text-xs text-platinum/80">{g.def}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {asset.brokers && (
                                <div className="bg-gradient-to-br from-gold/10 to-amber-500/5 border border-gold/30 rounded-sm p-5">
                                    <p className="text-xs text-gold uppercase tracking-wider mb-4 font-bold flex items-center gap-2">ğŸ¦ å‚è€ƒå£åº§</p>
                                    <div className="space-y-3">
                                        {asset.brokers.map((broker, i) => (
                                            <a key={i} href={broker.url} target="_blank" rel="noopener noreferrer"
                                                className="block bg-ash/50 border border-white/10 rounded-sm p-4 hover:border-gold/50 transition-all group">
                                                <div className="flex items-center justify-between mb-2">
                                                    <span className="text-lg font-bold text-platinum group-hover:text-gold transition-colors">{broker.name}</span>
                                                    {broker.recommended && <span className="text-[10px] bg-gold text-black px-2 py-0.5 rounded-sm font-bold">å‚è€ƒ</span>}
                                                </div>
                                                <p className="text-sm text-platinum/70">{broker.feature}</p>
                                                <p className="text-xs text-gold mt-2">å£åº§é–‹è¨­ã¯ã“ã¡ã‚‰ â†’</p>
                                            </a>
                                        ))}
                                    </div>
                                    <p className="text-[10px] text-dim mt-3">
                                        â€» å¤–éƒ¨ã‚µã‚¤ãƒˆã¸é·ç§»ã—ã¾ã™ã€‚æŠ•è³‡å‹§èª˜ã‚’ç›®çš„ã¨ã—ãŸã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br />
                                        â€» æœ¬ãƒªãƒ³ã‚¯ã¯ææºã‚µãƒ¼ãƒ“ã‚¹ã¸ã®æ¡ˆå†…ã‚’å«ã¿ã¾ã™
                                    </p>
                                </div>
                            )}
                        </div>
                    </motion.div>
                </motion.div>
            );
        };

        const PortfolioCalibration = ({ onComplete, existingProfile, onRediagnose, isOnboarding, onSkip, onNavigate, onSelectAsset }) => {
            const [currentQ, setCurrentQ] = useState(0);
            const [viewingAsset, setViewingAsset] = useState(null);
            const [answers, setAnswers] = useState({});
            const [showResult, setShowResult] = useState(false);
            const [sliderValue, setSliderValue] = useState(30); // Default age 30
            const [isDiagnosing, setIsDiagnosing] = useState(!existingProfile);
            const [showIntro, setShowIntro] = useState(!existingProfile);

            const questions = [
                // PROFILE (1 question) - Now a slider for precise age
                { id: 0, category: 'PROFILE', question: 'ã‚ãªãŸã®å¹´é½¢ã¯ï¼Ÿ', type: 'slider', min: 18, max: 80, step: 1, unit: 'æ­³' },
                // LIFESTYLE (3 questions)
                { id: 1, category: 'LIFESTYLE', question: 'ã‚¹ã‚¿ãƒã®æ–°ä½œãŒå‡ºãŸã‚‰ã€ã™ãè©¦ã™ï¼Ÿ', type: 'choice', options: [{ label: 'ã™ãè¡Œãï¼', value: 4 }, { label: 'SNSã§è©•åˆ¤è¦‹ã¦ã‹ã‚‰', value: 3 }, { label: 'å®šç•ªã—ã‹é ¼ã¾ãªã„', value: 2 }, { label: 'ã‚³ãƒ³ãƒ“ãƒ‹ã‚³ãƒ¼ãƒ’ãƒ¼æ´¾', value: 1 }] },
                { id: 2, category: 'LIFESTYLE', question: 'æœã‚’è²·ã†ã¨ãã€ä½•ã‚’é‡è¦–ã™ã‚‹ï¼Ÿ', type: 'choice', options: [{ label: 'ä»Šå­£ã®ãƒˆãƒ¬ãƒ³ãƒ‰æœ€å„ªå…ˆ', value: 4 }, { label: 'ã‚³ã‚¹ãƒ‘ã¨è¦‹ãŸç›®ã®ãƒãƒ©ãƒ³ã‚¹', value: 3 }, { label: '10å¹´ç€ã‚Œã‚‹å®šç•ª', value: 2 }, { label: 'å¿…è¦æœ€ä½é™ã—ã‹è²·ã‚ãªã„', value: 1 }] },
                { id: 3, category: 'LIFESTYLE', question: 'æ—…è¡Œã®äºˆç´„ã‚¹ã‚¿ã‚¤ãƒ«ã¯ï¼Ÿ', type: 'choice', options: [{ label: 'å½“æ—¥ãƒãƒ¼ãƒ—ãƒ©ãƒ³ã§å‡ºç™º', value: 4 }, { label: 'å¤§ã¾ã‹ãªãƒ—ãƒ©ãƒ³ã ã‘æ±ºã‚ã‚‹', value: 3 }, { label: 'äº‹å‰ã«ã—ã£ã‹ã‚Šè¨ˆç”»', value: 2 }, { label: 'æ—…è¡Œã‚ˆã‚Šå®¶ã§ã‚†ã£ãã‚Š', value: 1 }] },
                // FINANCE (4 questions)
                { id: 4, category: 'FINANCE', question: '1ãƒ¶æœˆã§è‡ªç”±ã«å‹•ã‹ã›ã‚‹ä½™è£•ã¯ï¼Ÿ', type: 'slider', min: 0, max: 100, step: 1, unit: 'å††' },
                { id: 5, category: 'FINANCE', question: 'ä¸‡ãŒä¸€ã®ç”Ÿæ´»é˜²è¡›è³‡é‡‘ã¯ï¼Ÿ', type: 'choice', options: [{ label: '6ãƒ¶æœˆåˆ†ä»¥ä¸Šã‚ã‚‹', value: 1 }, { label: '3ã€œ5ãƒ¶æœˆåˆ†ç¨‹åº¦', value: 2 }, { label: '1ã€œ2ãƒ¶æœˆåˆ†ç¨‹åº¦', value: 3 }, { label: 'ã»ã¼ãªã„ or ã“ã‚Œã‹ã‚‰', value: 4 }] },
                { id: 6, category: 'FINANCE', question: 'æ¯æœˆã®è²¯è“„é¡ï¼ˆæŠ•è³‡å«ã‚€ï¼‰ã¯ï¼Ÿ', type: 'choice', options: [{ label: 'åå…¥ã®30%ä»¥ä¸Š', value: 1 }, { label: 'åå…¥ã®10-30%ç¨‹åº¦', value: 2 }, { label: 'åå…¥ã®10%æœªæº€', value: 3 }, { label: 'ã»ã¨ã‚“ã©è²¯è“„ã§ãã¦ã„ãªã„', value: 4 }] },
                { id: 7, category: 'FINANCE', question: 'ãƒœãƒ¼ãƒŠã‚¹ã®ä½¿ã„æ–¹ã¯ï¼Ÿ', type: 'choice', options: [{ label: 'å…¨é¡æŠ•è³‡ãƒ»è²¯è“„', value: 1 }, { label: 'åŠåˆ†ä»¥ä¸Šã‚’è²¯è“„', value: 2 }, { label: 'å¿…è¦ãªã‚‚ã®ã«ä½¿ã†', value: 3 }, { label: 'ç‰¹ã«æ±ºã‚ã¦ã„ãªã„', value: 4 }] },
                // RISK (4 questions)
                { id: 8, category: 'RISK', question: '100ä¸‡å††æŠ•è³‡ã—ã¦50ä¸‡å††ã«ãªã£ãŸã‚‰ï¼Ÿ', type: 'choice', options: [{ label: 'æ€–ã„ã€ã‚„ã‚ãŸã„', value: 1 }, { label: 'å°‘ã—ä¸å®‰ã ãŒè€ãˆã‚‹', value: 2 }, { label: 'é•·æœŸãªã‚‰å•é¡Œãªã—', value: 3 }, { label: 'ã‚€ã—ã‚è²·ã„å¢—ã—ãƒãƒ£ãƒ³ã‚¹', value: 4 }] },
                { id: 9, category: 'RISK', question: 'ã€Œãƒã‚¤ãƒªã‚¹ã‚¯ãƒ»ãƒã‚¤ãƒªã‚¿ãƒ¼ãƒ³ã€ã¨ã„ã†è¨€è‘‰ã®å°è±¡ã¯ï¼Ÿ', type: 'choice', options: [{ label: 'å±é™ºã€é¿ã‘ãŸã„', value: 1 }, { label: 'ç†è§£ã¯ã™ã‚‹ãŒæ…é‡ã«', value: 2 }, { label: 'ä¸€éƒ¨ãªã‚‰æ¤œè¨ã™ã‚‹', value: 3 }, { label: 'ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹', value: 4 }] },
                { id: 10, category: 'RISK', question: 'å‹äººãŒã€Œå„²ã‹ã‚‹è©±ãŒã‚ã‚‹ã€ã¨è¨€ã£ã¦ããŸã‚‰ï¼Ÿ', type: 'choice', options: [{ label: 'çµ¶å¯¾ã«æ–­ã‚‹', value: 1 }, { label: 'è©³ã—ãèã„ã¦æ…é‡ã«åˆ¤æ–­', value: 2 }, { label: 'å°‘é¡ãªã‚‰è©¦ã—ã¦ã¿ã‚‹', value: 3 }, { label: 'é¢ç™½ãã†ãªã‚‰ä¹—ã£ã¦ã¿ã‚‹', value: 4 }] },
                { id: 11, category: 'RISK', question: 'æŠ•è³‡ã§ä¸€ç•ªé¿ã‘ãŸã„ã“ã¨ã¯ï¼Ÿ', type: 'choice', options: [{ label: 'å…ƒæœ¬å‰²ã‚Œ', value: 1 }, { label: 'æœŸå¾…ã‚ˆã‚Šä½ã„ãƒªã‚¿ãƒ¼ãƒ³', value: 2 }, { label: 'æŠ•è³‡æ©Ÿä¼šã®é€ƒã—', value: 3 }, { label: 'å„²ã‘ã‚’é€ƒã™ã“ã¨', value: 4 }] },
                // KNOWLEDGE (3 questions)
                { id: 12, category: 'KNOWLEDGE', question: 'æŠ•è³‡çµŒé¨“ã¯ã©ã®ãã‚‰ã„ï¼Ÿ', type: 'choice', options: [{ label: 'å…¨ãã®åˆå¿ƒè€…', value: 1 }, { label: 'NISAå£åº§ã‚’é–‹è¨­ã—ãŸç¨‹åº¦', value: 2 }, { label: '1å¹´ä»¥ä¸Šé‹ç”¨ä¸­', value: 3 }, { label: 'è¤‡æ•°è³‡ç”£ã‚’é‹ç”¨ä¸­', value: 4 }] },
                { id: 13, category: 'KNOWLEDGE', question: 'ã€Œè¤‡åˆ©ã€ã£ã¦èª¬æ˜ã§ãã‚‹ï¼Ÿ', type: 'choice', options: [{ label: 'èã„ãŸã“ã¨ãªã„', value: 1 }, { label: 'èã„ãŸã“ã¨ã¯ã‚ã‚‹', value: 2 }, { label: 'ãªã‚“ã¨ãªãã‚ã‹ã‚‹', value: 3 }, { label: 'å®Œç’§ã«ç†è§£ã—ã¦ã„ã‚‹', value: 4 }] },
                { id: 14, category: 'KNOWLEDGE', question: 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŠ•è³‡ã¨å€‹åˆ¥æ ªã®é•ã„ã¯ï¼Ÿ', type: 'choice', options: [{ label: 'ã‚ã‹ã‚‰ãªã„', value: 1 }, { label: 'ãªã‚“ã¨ãªãã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ã‚ã‚‹', value: 2 }, { label: 'èª¬æ˜ã§ãã‚‹', value: 3 }, { label: 'ä¸¡æ–¹é‹ç”¨ã—ãŸçµŒé¨“ãŒã‚ã‚‹', value: 4 }] },
                // GOALS (2 questions)
                { id: 15, category: 'GOALS', question: 'æŠ•è³‡ã§é”æˆã—ãŸã„ä¸€ç•ªã®ç›®æ¨™ã¯ï¼Ÿ', type: 'choice', options: [{ label: 'è€å¾Œè³‡é‡‘ã®ç¢ºä¿', value: 1 }, { label: 'æ•™è‚²è³‡é‡‘ãƒ»ä½å®…è³‡é‡‘', value: 2 }, { label: 'çµŒæ¸ˆçš„è‡ªç”±ï¼ˆFIREï¼‰', value: 3 }, { label: 'è³‡ç”£ã‚’å¤§ããå¢—ã‚„ã™', value: 4 }] },
                { id: 16, category: 'GOALS', question: 'ä½•å¹´ãã‚‰ã„ã®æœŸé–“ã§æŠ•è³‡ã‚’è€ƒãˆã¦ã„ã‚‹ï¼Ÿ', type: 'choice', options: [{ label: '20å¹´ä»¥ä¸Šã®è¶…é•·æœŸ', value: 1 }, { label: '10-20å¹´ç¨‹åº¦', value: 2 }, { label: '5-10å¹´ç¨‹åº¦', value: 3 }, { label: '5å¹´ä»¥å†…', value: 4 }] },
            ];

            const mapFinanceValue = (val) => {
                if (val <= 50) return Math.round((val / 50) * 50000 / 1000) * 1000;
                const t = (val - 50) / 50;
                return Math.round((50000 + Math.pow(t, 2.5) * 2950000) / 10000) * 10000;
            };

            const handleAnswer = (val) => {
                // If it's the finance slider (ID 4), map the 0-100 value to yen first
                const actualValue = questions[currentQ].id === 4 ? mapFinanceValue(val) : val;

                // Normalize age slider value to risk score (1-4)
                let normalizedVal = actualValue;
                if (questions[currentQ].type === 'slider' && questions[currentQ].id === 0) {
                    // Age-based risk scoring: younger = higher risk tolerance
                    if (actualValue < 30) normalizedVal = 4;
                    else if (actualValue < 40) normalizedVal = 3;
                    else if (actualValue < 60) normalizedVal = 2;
                    else normalizedVal = 1;
                } else if (questions[currentQ].id === 4) {
                    // Normalize finance value: 50k=2, 100k=3, 200k+=4
                    if (actualValue >= 200000) normalizedVal = 4;
                    else if (actualValue >= 100000) normalizedVal = 3;
                    else if (actualValue >= 50000) normalizedVal = 2;
                    else normalizedVal = 1;
                }
                setAnswers({ ...answers, [questions[currentQ].id]: normalizedVal });
                if (currentQ < questions.length - 1) {
                    setTimeout(() => {
                        const nextQ = questions[currentQ + 1];
                        if (nextQ.type === 'slider') {
                            setSliderValue(nextQ.id === 0 ? 30 : 50); // Age: 30, Finance: 50 (center)
                        }
                        setCurrentQ(currentQ + 1);
                    }, 300);
                }
                else setTimeout(() => setShowResult(true), 300);
            };

            const calculateProfile = () => {
                // Category-based weighted scoring system
                // RISK: 40%, FINANCE: 25%, KNOWLEDGE: 15%, LIFESTYLE: 10%, GOALS: 10%
                const categoryWeights = {
                    PROFILE: 0,      // Age is used for adjustment, not direct score
                    LIFESTYLE: 0.10,
                    FINANCE: 0.25,
                    RISK: 0.40,
                    KNOWLEDGE: 0.15,
                    GOALS: 0.10
                };

                // Group answers by category
                const categoryScores = {};
                const categoryCounts = {};

                questions.forEach(q => {
                    const cat = q.category;
                    const answer = answers[q.id];
                    if (answer !== undefined && cat !== 'PROFILE') {
                        if (!categoryScores[cat]) {
                            categoryScores[cat] = 0;
                            categoryCounts[cat] = 0;
                        }
                        categoryScores[cat] += answer;
                        categoryCounts[cat] += 1;
                    }
                });

                // Calculate normalized score per category (0-100)
                const normalizedCategoryScores = {};
                Object.keys(categoryScores).forEach(cat => {
                    const maxPossible = categoryCounts[cat] * 4;
                    normalizedCategoryScores[cat] = Math.round((categoryScores[cat] / maxPossible) * 100);
                });

                // Calculate weighted total score (0-100)
                let weightedScore = 0;
                Object.keys(normalizedCategoryScores).forEach(cat => {
                    weightedScore += normalizedCategoryScores[cat] * (categoryWeights[cat] || 0);
                });
                weightedScore = Math.round(weightedScore);

                // Age adjustment: younger investors can tolerate slightly more risk
                const age = answers[0] || 30;
                let ageAdjustment = 0;
                if (age < 30) ageAdjustment = 5;
                else if (age < 40) ageAdjustment = 2;
                else if (age >= 60) ageAdjustment = -5;

                const finalScore = Math.max(0, Math.min(100, weightedScore + ageAdjustment));

                // Profile selection based on clear thresholds
                // Score < 20: Guardian (æœ€ã‚‚ä¿å®ˆçš„)
                // Score 20-34: Custodian
                // Score 35-44: Conservative
                // Score 45-54: Architect
                // Score 55-64: Strategist
                // Score 65-74: Explorer
                // Score 75-84: Visionary
                // Score >= 85: Pioneer (æœ€ã‚‚ç©æ¥µçš„)
                let selected;
                let profileReason;

                if (finalScore < 20) {
                    selected = profiles[0]; // Guardian
                    profileReason = 'è³‡ç”£ä¿å…¨ã‚’æœ€å„ªå…ˆã¨ã—ã€å…ƒæœ¬å‰²ã‚Œãƒªã‚¹ã‚¯ã‚’æ¥µåŠ›é¿ã‘ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚';
                } else if (finalScore < 35) {
                    selected = profiles[1]; // Custodian
                    profileReason = 'å …å®Ÿãªè³‡ç”£ç®¡ç†ã‚’å¥½ã¿ã€ã‚¤ãƒ³ãƒ•ãƒ¬ã«è² ã‘ãªã„ç¨‹åº¦ã®é‹ç”¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚';
                } else if (finalScore < 45) {
                    selected = profiles[2]; // Conservative
                    profileReason = 'å®‰å®šæ€§ã‚’é‡è¦–ã—ã¤ã¤ã€ç€å®Ÿãªè³‡ç”£å½¢æˆã‚’ç›®æŒ‡ã™ãƒãƒ©ãƒ³ã‚¹å¿—å‘ã§ã™ã€‚';
                } else if (finalScore < 55) {
                    selected = profiles[3]; // Architect
                    profileReason = 'é•·æœŸçš„ãªè¦–ç‚¹ã§è³‡ç”£ã‚’è¨­è¨ˆã—ã€ãƒªã‚¹ã‚¯ã¨ãƒªã‚¿ãƒ¼ãƒ³ã®ãƒãƒ©ãƒ³ã‚¹ã‚’é‡è¦–ã—ã¾ã™ã€‚';
                } else if (finalScore < 65) {
                    selected = profiles[4]; // Strategist
                    profileReason = 'å¸‚å ´ã®å‹•ãã‚’åˆ†æã—ã€æ©Ÿå‹•çš„ãªãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªèª¿æ•´ã‚’å¥½ã¿ã¾ã™ã€‚';
                } else if (finalScore < 75) {
                    selected = profiles[5]; // Explorer
                    profileReason = 'æ–°ã—ã„æŠ•è³‡æ©Ÿä¼šã‚’ç©æ¥µçš„ã«æ¢æ±‚ã—ã€å¤šæ§˜ãªè³‡ç”£ã¸ã®åˆ†æ•£ã‚’å¿—å‘ã—ã¾ã™ã€‚';
                } else if (finalScore < 85) {
                    selected = profiles[6]; // Visionary
                    profileReason = 'å°†æ¥ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è¦‹æ®ãˆã€æˆé•·æ€§ã®é«˜ã„è³‡ç”£ã¸ã®æŠ•è³‡ã‚’å¥½ã¿ã¾ã™ã€‚';
                } else {
                    selected = profiles[7]; // Pioneer
                    profileReason = 'é«˜ã„ãƒªã‚¹ã‚¯ã‚’è¨±å®¹ã—ã€ç©æ¥µçš„ãªãƒªã‚¿ãƒ¼ãƒ³ã‚’è¿½æ±‚ã™ã‚‹æŠ•è³‡ã‚¹ã‚¿ã‚¤ãƒ«ã§ã™ã€‚';
                }

                // Experience level from knowledge questions
                const knowledgeScore = normalizedCategoryScores['KNOWLEDGE'] || 0;
                let expLevel = 1;
                if (knowledgeScore >= 75) expLevel = 3;      // ç†Ÿç·´
                else if (knowledgeScore >= 50) expLevel = 2; // è¦‹ç¿’ã„
                else expLevel = 1;                            // é§†ã‘å‡ºã—

                return {
                    ...selected,
                    baseType: selected.nameJp,
                    initialLevel: expLevel,
                    experienceLevel: expLevel,
                    // Extended diagnostic data
                    diagnosticData: {
                        finalScore,
                        categoryScores: normalizedCategoryScores,
                        ageAdjustment,
                        profileReason,
                        timestamp: Date.now()
                    }
                };
            };
            const profile = showResult ? calculateProfile() : existingProfile;

            const startRediagnose = () => {
                setCurrentQ(0);
                setAnswers({});
                setShowResult(false);
                setIsDiagnosing(true);
            };

            // Show existing profile if not diagnosing
            if (!isDiagnosing && existingProfile) {
                const expLevel = existingProfile.experienceLevel || 1;
                const levelNames = { 1: 'é§†ã‘å‡ºã—', 2: 'è¦‹ç¿’ã„', 3: 'ç†Ÿç·´' };
                const levelColors = { 1: 'text-dim', 2: 'text-emerald-400', 3: 'text-gold' };

                return (
                    <div className="min-h-screen bg-obsidian px-8 py-24 overflow-y-auto">
                        <motion.div className="max-w-2xl mx-auto" initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                            <p className="text-dim text-sm tracking-[0.3em] mb-6">YOUR PROFILE</p>

                            {/* Header */}
                            <div className="flex items-center gap-4 mb-6">
                                <span className="text-7xl">{existingProfile.icon}</span>
                                <div>
                                    <h2 className="text-4xl font-black">{existingProfile.name}</h2>
                                    <p className="text-2xl text-gold">{getUserTitle(existingProfile, 0)}</p>
                                </div>
                            </div>

                            {/* Knowledge Level Badge */}
                            <div className="flex items-center gap-3 mb-6">
                                <span className={`text-sm font-bold ${levelColors[expLevel]}`}>ğŸ“š çŸ¥è­˜ãƒ¬ãƒ™ãƒ«: {levelNames[expLevel]}</span>
                                <div className="flex gap-1">
                                    {[1, 2, 3].map(l => (
                                        <div key={l} className={`w-3 h-3 rounded-full ${l <= expLevel ? 'bg-gold' : 'bg-stone'}`} />
                                    ))}
                                </div>
                            </div>

                            {/* Short Description */}
                            <p className="text-lg text-platinum/80 mb-4">{existingProfile.description}</p>

                            {/* Detailed Description */}
                            {existingProfile.detailedDescription && (
                                <div className="bg-ash/30 border border-white/5 rounded-sm p-5 mb-6">
                                    <p className="text-sm text-platinum/70 leading-relaxed">{existingProfile.detailedDescription}</p>
                                </div>
                            )}

                            {/* Traits */}
                            <div className="flex flex-wrap gap-2 mb-8">
                                {existingProfile.traits.map((t, i) => <span key={i} className="text-xs bg-ash border border-white/10 px-3 py-1 rounded-full text-platinum/70">{t}</span>)}
                            </div>

                            {/* Strengths & Watch Out */}
                            <div className="grid md:grid-cols-2 gap-4 mb-8">
                                {existingProfile.strengths && (
                                    <div className="bg-emerald-500/10 border border-emerald-500/20 rounded-sm p-5">
                                        <p className="text-xs text-emerald-400 uppercase tracking-wider mb-3 font-bold">ğŸ’ª å¼·ã¿</p>
                                        <ul className="space-y-2">
                                            {existingProfile.strengths.map((s, i) => (
                                                <li key={i} className="text-sm text-platinum/80 flex items-start gap-2">
                                                    <span className="text-emerald-400 mt-0.5">âœ“</span>
                                                    <span>{s}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                                {existingProfile.watchOut && (
                                    <div className="bg-amber-500/10 border border-amber-500/20 rounded-sm p-5">
                                        <p className="text-xs text-amber-400 uppercase tracking-wider mb-3 font-bold">âš ï¸ æ³¨æ„ç‚¹</p>
                                        <ul className="space-y-2">
                                            {existingProfile.watchOut.map((w, i) => (
                                                <li key={i} className="text-sm text-platinum/80 flex items-start gap-2">
                                                    <span className="text-amber-400 mt-0.5">!</span>
                                                    <span>{w}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                            </div>

                            {/* Level-based Advice */}
                            {existingProfile.levelAdvice && existingProfile.levelAdvice[expLevel] && (
                                <div className="bg-gradient-to-r from-gold/10 to-amber-500/5 border border-gold/20 rounded-sm p-5 mb-8">
                                    <p className="text-xs text-gold uppercase tracking-wider mb-2 font-bold">ğŸ’¡ {levelNames[expLevel]}ã®ã‚ãªãŸã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</p>
                                    <p className="text-sm text-platinum/90 leading-relaxed">{existingProfile.levelAdvice[expLevel]}</p>
                                </div>
                            )}

                            {/* Allocation */}
                            <div className="bg-ash/50 border border-white/5 rounded-sm p-6 mb-8">
                                <p className="text-xs text-dim uppercase tracking-wider mb-4">ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹</p>
                                <div className="flex h-3 rounded-full overflow-hidden mb-4">
                                    <div className="bg-emerald-500" style={{ width: `${existingProfile.allocation.safe}%` }} />
                                    <div className="bg-amber-500" style={{ width: `${existingProfile.allocation.balanced}%` }} />
                                    <div className="bg-rose-500" style={{ width: `${existingProfile.allocation.growth}%` }} />
                                </div>
                                <div className="flex justify-between text-xs text-dim">
                                    <span>ğŸ›¡ï¸ å®‰å…¨ {existingProfile.allocation.safe}%</span>
                                    <span>âš–ï¸ ãƒãƒ©ãƒ³ã‚¹ {existingProfile.allocation.balanced}%</span>
                                    <span>ğŸš€ æˆé•· {existingProfile.allocation.growth}%</span>
                                </div>
                            </div>

                            {/* Recommended Products */}
                            <div className="mb-10">
                                <p className="text-xs text-dim uppercase tracking-wider mb-3">å‚è€ƒãƒ—ãƒ­ãƒ€ã‚¯ãƒˆ</p>
                                <div className="flex flex-wrap gap-2">
                                    {existingProfile.recommended.map((r, i) => {
                                        const assetMapping = {
                                            'ã¤ã¿ãŸã¦NISA': 1, 'NISA': 1,
                                            'å›½å†…æ ªå¼': 2, 'æ—¥æœ¬æ ª': 2,
                                            'ç±³å›½æ ªå¼': 3, 'ãƒ†ãƒƒã‚¯æ ª': 3, 'ã‚°ãƒ­ãƒ¼ã‚¹æ ª': 3, 'ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³æ ': 3, 'å€‹åˆ¥æ ª': 3,
                                            'FX': 4,
                                            'æŠ•è³‡ä¿¡è¨—': 5, 'å…¨ä¸–ç•Œæ ªå¼': 5, 'ãƒãƒ©ãƒ³ã‚¹ãƒ•ã‚¡ãƒ³ãƒ‰': 5, 'å®ˆã‚Šã®æŠ•ä¿¡': 5, 'æ–°èˆˆå›½ãƒ•ã‚¡ãƒ³ãƒ‰': 5, 'ãƒ†ãƒ¼ãƒå‹æŠ•ä¿¡': 5, 'ã‚»ã‚¯ã‚¿ãƒ¼ETF': 5, 'ã‚¹ãƒãƒ¼ãƒˆãƒ™ãƒ¼ã‚¿': 5,
                                            'ä»®æƒ³é€šè²¨': 6,
                                            'iDeCo': 7,
                                            'å‚µåˆ¸': 8, 'å›½å†…å‚µåˆ¸': 8, 'å›½å‚µ': 8, 'é«˜æ ¼ä»˜ç¤¾å‚µ': 8, 'å‚µåˆ¸ãƒ•ã‚¡ãƒ³ãƒ‰': 8,
                                            'ãƒªãƒ¼ãƒˆ': 9,
                                            'ã‚³ãƒ¢ãƒ‡ã‚£ãƒ†ã‚£': 10, 'é‡‘': 10, 'ã‚´ãƒ¼ãƒ«ãƒ‰': 10,
                                            'å®šæœŸé é‡‘': 8, 'ãƒ¬ãƒãƒ¬ãƒƒã‚¸å•†å“': 6
                                        };
                                        const aid = assetMapping[r] || (Object.keys(assetMapping).find(k => r.includes(k)) ? assetMapping[Object.keys(assetMapping).find(k => r.includes(k))] : null);

                                        return (
                                            <button key={i} onClick={() => {
                                                if (aid) {
                                                    const asset = assetDetailData.find(a => a.id === aid);
                                                    if (asset) setViewingAsset(asset);
                                                }
                                            }} className={`text-sm px-4 py-2 rounded-sm border transition-all ${aid ? 'bg-gold/10 border-gold/30 text-gold hover:bg-gold hover:text-black cursor-pointer' : 'bg-white/5 border-white/10 text-dim cursor-default'}`}>
                                                {r}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            <button onClick={startRediagnose} className="btn-sharp px-8 py-4 rounded-sm border-dim text-dim w-full text-lg font-bold hover:border-gold hover:text-gold transition-all">
                                å†è¨ºæ–­
                            </button>
                        </motion.div>
                        <AnimatePresence>
                            {viewingAsset && <AssetDetailModal asset={viewingAsset} onClose={() => setViewingAsset(null)} />}
                        </AnimatePresence>
                    </div>
                );
            }

            if (showResult && profile) {
                // Broker Database
                const brokerPool = {
                    sbi: { name: 'SBIè¨¼åˆ¸', feature: 'å¹…åºƒã„å•†å“ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—ã€‚NISAãƒ»iDeCoãƒ»ç±³å›½æ ªã«å¯¾å¿œ', url: 'https://www.sbisec.co.jp/' },
                    rakuten: { name: 'æ¥½å¤©è¨¼åˆ¸', feature: 'æ¥½å¤©ãƒã‚¤ãƒ³ãƒˆæŠ•è³‡ã€‚æ¥½å¤©çµŒæ¸ˆåœã¨ã®ç›¸æ€§æŠœç¾¤', url: 'https://www.rakuten-sec.co.jp/' },
                    monex: { name: 'ãƒãƒãƒƒã‚¯ã‚¹è¨¼åˆ¸', feature: 'åˆ†æãƒ„ãƒ¼ãƒ«å……å®Ÿã€‚ç±³å›½æ ªã«å¼·ã„', url: 'https://www.monex.co.jp/' },
                    matsui: { name: 'æ¾äº•è¨¼åˆ¸', feature: 'è€èˆ—ã®å®‰å¿ƒæ„Ÿã€‚é›»è©±ç›¸è«‡ã‚µãƒãƒ¼ãƒˆãŒå……å®Ÿ', url: 'https://www.matsui.co.jp/' },
                    wealthnavi: { name: 'WealthNavi', feature: 'å…¨è‡ªå‹•ãƒ­ãƒœã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã€‚ã»ã£ãŸã‚‰ã‹ã—é‹ç”¨', url: 'https://www.wealthnavi.com/' },
                    coincheck: { name: 'Coincheck', feature: 'ã‚·ãƒ³ãƒ—ãƒ«ãªUIã§ä½¿ã„ã‚„ã™ã„ã€‚åˆå¿ƒè€…å‘ã‘ã®ä»®æƒ³é€šè²¨å–å¼•æ‰€', url: 'https://coincheck.com/' },
                    au: { name: 'auã‚«ãƒ–ã‚³ãƒ è¨¼åˆ¸', feature: 'Pontaãƒã‚¤ãƒ³ãƒˆãŒè²¯ã¾ã‚‹ã€‚auãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒªãƒƒãƒˆã‚ã‚Š', url: 'https://kabu.com/' }
                };

                // Profile-based Recommendations
                const getBrokers = (pid) => {
                    switch (pid) {
                        case 'guardian': return [brokerPool.wealthnavi, brokerPool.matsui, brokerPool.sbi];
                        case 'custodian': return [brokerPool.wealthnavi, brokerPool.sbi, brokerPool.rakuten];
                        case 'conservative': return [brokerPool.rakuten, brokerPool.sbi, brokerPool.au];
                        case 'architect': return [brokerPool.sbi, brokerPool.rakuten, brokerPool.monex];
                        case 'strategist': return [brokerPool.monex, brokerPool.sbi, brokerPool.rakuten];
                        case 'explorer': return [brokerPool.sbi, brokerPool.monex, brokerPool.rakuten];
                        case 'visionary': return [brokerPool.monex, brokerPool.sbi, brokerPool.coincheck];
                        case 'pioneer': return [brokerPool.coincheck, brokerPool.sbi, brokerPool.monex];
                        default: return [brokerPool.sbi, brokerPool.rakuten, brokerPool.monex];
                    }
                };
                const recommendedBrokers = getBrokers(profile.id);

                return (
                    <div className="min-h-screen bg-obsidian px-8 py-24 overflow-y-auto">
                        <motion.div className="max-w-2xl mx-auto" initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                            <p className="text-dim text-sm tracking-[0.3em] mb-6">STEP 1: DIAGNOSIS COMPLETE</p>
                            <div className="flex items-center gap-4 mb-4">
                                <span className="text-6xl">{profile.icon}</span>
                                <div>
                                    <h2 className="text-4xl font-black">{profile.name}</h2>
                                    <p className="text-2xl text-gold">{getUserTitle(profile, 0)}</p>
                                </div>
                            </div>
                            <p className="text-lg text-platinum/80 mb-8">{profile.description}</p>
                            <div className="flex flex-wrap gap-2 mb-8">
                                {profile.traits.map((t, i) => <span key={i} className="text-xs bg-ash border border-white/10 px-3 py-1 rounded-full text-platinum/70">{t}</span>)}
                            </div>
                            <div className="bg-ash/50 border border-white/5 rounded-sm p-6 mb-8">
                                <p className="text-xs text-dim uppercase tracking-wider mb-4">ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹</p>
                                <div className="flex h-3 rounded-full overflow-hidden mb-4">
                                    <div className="bg-emerald-500" style={{ width: `${profile.allocation.safe}%` }} />
                                    <div className="bg-amber-500" style={{ width: `${profile.allocation.balanced}%` }} />
                                    <div className="bg-rose-500" style={{ width: `${profile.allocation.growth}%` }} />
                                </div>
                                <div className="flex justify-between text-xs text-dim">
                                    <span>ğŸ›¡ï¸ å®‰å…¨ {profile.allocation.safe}%</span>
                                    <span>âš–ï¸ ãƒãƒ©ãƒ³ã‚¹ {profile.allocation.balanced}%</span>
                                    <span>ğŸš€ æˆé•· {profile.allocation.growth}%</span>
                                </div>
                            </div>
                            <div className="mb-8">
                                <p className="text-xs text-dim uppercase tracking-wider mb-3">å‚è€ƒãƒ—ãƒ­ãƒ€ã‚¯ãƒˆ</p>
                                <div className="flex flex-wrap gap-2">
                                    {profile.recommended.map((r, i) => {
                                        const assetMapping = {
                                            'ã¤ã¿ãŸã¦NISA': 1, 'NISA': 1,
                                            'å›½å†…æ ªå¼': 2, 'æ—¥æœ¬æ ª': 2,
                                            'ç±³å›½æ ªå¼': 3, 'ãƒ†ãƒƒã‚¯æ ª': 3, 'ã‚°ãƒ­ãƒ¼ã‚¹æ ª': 3, 'ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³æ ': 3, 'å€‹åˆ¥æ ª': 3,
                                            'FX': 4,
                                            'æŠ•è³‡ä¿¡è¨—': 5, 'å…¨ä¸–ç•Œæ ªå¼': 5, 'ãƒãƒ©ãƒ³ã‚¹ãƒ•ã‚¡ãƒ³ãƒ‰': 5, 'å®ˆã‚Šã®æŠ•ä¿¡': 5, 'æ–°èˆˆå›½ãƒ•ã‚¡ãƒ³ãƒ‰': 5, 'ãƒ†ãƒ¼ãƒå‹æŠ•ä¿¡': 5, 'ã‚»ã‚¯ã‚¿ãƒ¼ETF': 5, 'ã‚¹ãƒãƒ¼ãƒˆãƒ™ãƒ¼ã‚¿': 5,
                                            'ä»®æƒ³é€šè²¨': 6,
                                            'iDeCo': 7,
                                            'å‚µåˆ¸': 8, 'å›½å†…å‚µåˆ¸': 8, 'å›½å‚µ': 8, 'é«˜æ ¼ä»˜ç¤¾å‚µ': 8, 'å‚µåˆ¸ãƒ•ã‚¡ãƒ³ãƒ‰': 8,
                                            'ãƒªãƒ¼ãƒˆ': 9,
                                            'ã‚³ãƒ¢ãƒ‡ã‚£ãƒ†ã‚£': 10,
                                            'å®šæœŸé é‡‘': 8, 'ãƒ¬ãƒãƒ¬ãƒƒã‚¸å•†å“': 6
                                        };
                                        const aid = assetMapping[r] || (Object.keys(assetMapping).find(k => r.includes(k)) ? assetMapping[Object.keys(assetMapping).find(k => r.includes(k))] : null);

                                        return (
                                            <button key={i} onClick={() => {
                                                if (aid) {
                                                    onSelectAsset(aid);
                                                    onNavigate('gallery');
                                                }
                                            }} className={`text-sm px-4 py-2 rounded-sm border transition-all ${aid ? 'bg-gold/10 border-gold/30 text-gold hover:bg-gold hover:text-black cursor-pointer' : 'bg-white/5 border-white/10 text-dim cursor-default'}`}>
                                                {r}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Recommended Brokers Section */}
                            <div className="bg-gradient-to-br from-gold/10 to-amber-500/5 border border-gold/30 rounded-sm p-6 mb-8">
                                <p className="text-xs text-gold uppercase tracking-wider mb-4 font-bold">ğŸ¦ ã¾ãšã¯ã“ã“ã§å£åº§é–‹è¨­</p>
                                <p className="text-sm text-platinum/70 mb-4">æŠ•è³‡ã‚’å§‹ã‚ã‚‹ã«ã¯è¨¼åˆ¸å£åº§ãŒå¿…è¦ã§ã™ã€‚ã”è‡ªèº«ã§é¸ã‚“ã§é–‹è¨­ã—ã¾ã—ã‚‡ã†ã€‚</p>
                                <div className="space-y-3">
                                    {recommendedBrokers.map((broker, i) => (
                                        <a key={i} href={broker.url} target="_blank" rel="noopener noreferrer"
                                            className="block bg-ash/50 border border-white/10 rounded-sm p-4 hover:border-gold/50 transition-all group">
                                            <div className="flex items-center justify-between mb-1">
                                                <span className="text-lg font-bold text-platinum group-hover:text-gold transition-colors">{broker.name}</span>
                                                {broker.recommended && <span className="text-[10px] bg-gold text-black px-2 py-0.5 rounded-sm font-bold">å‚è€ƒ</span>}
                                            </div>
                                            <p className="text-sm text-platinum/60">{broker.feature}</p>
                                        </a>
                                    ))}
                                </div>
                                <p className="text-[10px] text-dim mt-3">â€» å¤–éƒ¨ã‚µã‚¤ãƒˆã¸é·ç§»ã—ã¾ã™ã€‚å£åº§é–‹è¨­ã¯ã™ã¹ã¦ç„¡æ–™ã§ã™ã€‚</p>
                                <p className="text-[10px] text-dim">â€» æœ¬æƒ…å ±ã¯æŠ•è³‡å‹§èª˜ã‚’ç›®çš„ã¨ã—ãŸã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ€çµ‚çš„ãªæŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
                            </div>

                            <div className="flex gap-4">
                                <button onClick={startRediagnose} className="btn-sharp px-6 py-4 rounded-sm border-dim text-dim flex-1 font-bold hover:border-gold hover:text-gold transition-all">
                                    ã‚„ã‚Šç›´ã™
                                </button>
                                <button onClick={() => onComplete(profile)} className="btn-sharp px-6 py-4 rounded-sm border-gold text-gold flex-[2] text-lg font-bold hover:bg-gold hover:text-black transition-all">
                                    ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã«åæ˜ ã™ã‚‹
                                </button>
                            </div>
                        </motion.div>
                        <AnimatePresence>
                            {viewingAsset && <AssetDetailModal asset={viewingAsset} onClose={() => setViewingAsset(null)} />}
                        </AnimatePresence>
                    </div>
                );
            }

            // Intro View
            if (showIntro && !existingProfile) {
                return (
                    <div className="min-h-screen bg-obsidian flex flex-col justify-center items-center px-8 relative overflow-hidden">
                        {/* Background ambience */}
                        <div className="absolute inset-0 pointer-events-none">
                            <div className="absolute top-1/4 left-1/4 w-[500px] h-[500px] bg-gold/5 rounded-full blur-[120px] opacity-30" />
                        </div>

                        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="max-w-xl w-full text-center relative z-10">
                            <p className="text-dim text-xs tracking-[0.4em] mb-6 text-gold">START YOUR JOURNEY</p>
                            <h2 className="text-4xl md:text-5xl font-black tracking-tighter text-platinum mb-6">
                                ã‚ãªãŸã®<span className="text-gold-gradient">æŠ•è³‡ã‚¿ã‚¤ãƒ—</span>ã‚’è¨ºæ–­
                            </h2>
                            <p className="text-lg text-platinum/70 leading-relaxed mb-12">
                                ç°¡å˜ãªè³ªå•ã«ç­”ãˆã¦ã€<br />ã‚ãªãŸã«æœ€é©ãªæŠ•è³‡æˆ¦ç•¥ã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†ã€‚
                            </p>

                            <div className="space-y-4 max-w-sm mx-auto">
                                <button onClick={() => setShowIntro(false)} className="btn-sharp w-full py-4 bg-gold text-black font-bold text-lg rounded-sm hover:bg-amber-400 transition-colors custom-shadow">
                                    è¨ºæ–­ã‚’å§‹ã‚ã‚‹
                                </button>
                                <p className="text-[10px] text-dim text-center">
                                    â€» è¨ºæ–­çµæœã¯è‡ªå·±åˆ†æã®å‚è€ƒã¨ã—ã¦ã”åˆ©ç”¨ãã ã•ã„
                                </p>

                                {isOnboarding && onSkip && (
                                    <button onClick={onSkip} className="text-dim text-xs hover:text-white transition-colors">
                                        ãƒ›ãƒ¼ãƒ ã¸
                                    </button>
                                )}
                            </div>
                        </motion.div>
                    </div>
                );
            }

            const handleBack = () => {
                if (currentQ > 0) {
                    const prevQ = questions[currentQ - 1];
                    if (prevQ.type === 'slider') {
                        // Restore previous answer if it exists, otherwise use default
                        const prevAnswer = answers[prevQ.id];
                        // Note: handleAnswer might have normalized the value, 
                        // but for sliders we usually want the raw value if possible.
                        // However, current implementation only stores normalized risk scores for some sliders.
                        // For simplicity, we use the default or the last known raw value if we were to track it.
                        // Since we don't track raw value in state yet, we use defaults for now.
                        setSliderValue(prevQ.id === 0 ? 30 : 50);
                    }
                    setCurrentQ(currentQ - 1);
                }
            };

            const q = questions[currentQ];
            const p = ((currentQ + 1) / questions.length) * 100;

            return (
                <div className="min-h-screen bg-obsidian flex flex-col justify-center px-8 py-24">
                    <div className="max-w-2xl mx-auto w-full">
                        <div className="mb-12">
                            <div className="flex justify-between items-center text-dim text-sm mb-2">
                                <div className="flex items-center gap-4">
                                    <span>STEP 1: CALIBRATION</span>
                                    {currentQ > 0 && (
                                        <button onClick={handleBack} className="text-platinum/50 hover:text-gold transition-colors flex items-center gap-1">
                                            <span>â†</span> æˆ»ã‚‹
                                        </button>
                                    )}
                                </div>
                                <span>{currentQ + 1}/{questions.length}</span>
                            </div>
                            <div className="h-px bg-stone"><motion.div className="h-full bg-gold" animate={{ width: `${p}%` }} /></div>
                        </div>
                        <AnimatePresence mode="wait">
                            <motion.div key={q.id} initial={{ opacity: 0, x: 30 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -30 }}>
                                <h2 className="text-3xl font-bold mb-12">{q.question}</h2>
                                {q.type === 'choice' ?
                                    <div className="flex flex-col gap-3">{q.options.map((o, i) => <button key={i} onClick={() => handleAnswer(o.value)} className="btn-sharp text-left px-6 py-5 rounded-sm text-lg hover:bg-ash/50">{o.label}</button>)}</div>
                                    : <div className="space-y-8">
                                        <p className="text-5xl font-bold text-gold text-center">
                                            {(q.id === 4 ? mapFinanceValue(sliderValue) : sliderValue).toLocaleString()}
                                            <span className="text-lg text-dim ml-2">{q.unit}</span>
                                        </p>
                                        <input type="range" min={q.min} max={q.max} step={q.step} value={sliderValue} onChange={e => setSliderValue(Number(e.target.value))} className="w-full h-2 bg-stone rounded-full appearance-none cursor-pointer [&::-webkit-slider-thumb]:bg-gold" />
                                        <button onClick={() => handleAnswer(sliderValue)} className="btn-sharp w-full py-5 border-gold text-gold">æ±ºå®š</button>
                                    </div>
                                }
                            </motion.div>
                        </AnimatePresence>
                    </div>
                </div>
            );
        };



        // ============================================
        // PERSONALIZED BRIEFING - LUXURY COLLECTION
        // Cards now loaded from external cards.js file
        // Total: 230 cards (200 standard + 30 Pro chart patterns)
        // ============================================
        // briefingCards is loaded from cards.js via window.briefingCards


        // ============================================
        // TINDER-STYLE LEARNING WITH ROADMAPS
        // ============================================
        const assetRoadmaps = {
            'NISA': [
                { id: 'nisa-1', title: 'NISAã®åŸºæœ¬ã‚’ç†è§£', cards: [4, 87, 103], level: 1 },
                { id: 'nisa-2', title: 'æ–°NISAã®æ´»ç”¨', cards: [181, 182, 183], level: 1 },
                { id: 'nisa-3', title: 'å£åº§é–‹è¨­ã¨åˆ¶åº¦æ´»ç”¨', cards: [106, 107, 88], level: 2 },
                { id: 'nisa-4', title: 'éŠ˜æŸ„é¸å®šã¨ç©ç«‹è¨­å®š', cards: [108, 109, 110], level: 3 },
                { id: 'nisa-5', title: 'é•·æœŸé‹ç”¨ã®ãƒã‚¤ãƒ³ãƒ‰', cards: [67, 68, 85], level: 4 }
            ],
            'å›½å†…æ ªå¼': [
                { id: 'jp-1', title: 'æ ªå¼æŠ•è³‡ã®åŸºç¤', cards: [26, 31, 7], level: 1 },
                { id: 'jp-2', title: 'éŠ˜æŸ„åˆ†æã®åŸºæœ¬', cards: [39, 40, 42], level: 2 },
                { id: 'jp-3', title: 'å¸‚å ´ã¨æŒ‡æ¨™', cards: [141, 142, 143], level: 2 },
                { id: 'jp-4', title: 'é…å½“ã¨å„ªå¾…', cards: [38, 45, 117], level: 3 },
                { id: 'jp-5', title: 'ç¨é‡‘ã¨ç¢ºå®šç”³å‘Š', cards: [86, 90, 91], level: 4 }
            ],
            'ç±³å›½æ ªå¼': [
                { id: 'us-1', title: 'ç±³å›½å¸‚å ´ã®åŸºç¤', cards: [32, 254, 26], level: 1 },
                { id: 'us-2', title: 'ä¸»è¦æŒ‡æ•°ã¨ç‰¹å¾´', cards: [33, 144, 258], level: 2 },
                { id: 'us-3', title: 'ç‚ºæ›¿ã¨æµ·å¤–æŠ•è³‡', cards: [29, 112, 93], level: 2 },
                { id: 'us-4', title: 'æŠ•è³‡æˆ¦ç•¥', cards: [54, 260, 49], level: 3 },
                { id: 'us-5', title: 'ETFæ´»ç”¨è¡“', cards: [28, 34, 111], level: 4 }
            ],
            'æŠ•è³‡ä¿¡è¨—': [
                { id: 'fund-1', title: 'è¤‡åˆ©ã¨åˆ†æ•£ã®åŸºç¤', cards: [1, 3, 252], level: 1 },
                { id: 'fund-2', title: 'ãƒ•ã‚¡ãƒ³ãƒ‰ã®ç¨®é¡', cards: [248, 251, 261], level: 2 },
                { id: 'fund-3', title: 'ãƒ•ã‚¡ãƒ³ãƒ‰ã®é¸ã³æ–¹', cards: [110, 21, 20], level: 3 },
                { id: 'fund-4', title: 'ç©ç«‹æŠ•è³‡ã®å®Ÿè·µ', cards: [46, 63, 109], level: 3 },
                { id: 'fund-5', title: 'é•·æœŸé‹ç”¨ã®ãƒã‚¤ãƒ³ãƒ‰', cards: [67, 77, 85], level: 4 }
            ],
            'å‚µåˆ¸ãƒ»é‡‘åˆ©': [
                { id: 'bonds-1', title: 'å‚µåˆ¸ã®åŸºç¤', cards: [27, 246, 249], level: 1 },
                { id: 'bonds-2', title: 'å®šæœŸé é‡‘ã¨å›½å‚µ', cards: [247, 49, 19], level: 1 },
                { id: 'bonds-3', title: 'é‡‘åˆ©ã¨ãƒªã‚¹ã‚¯', cards: [12, 44, 37], level: 2 },
                { id: 'bonds-4', title: 'ç¤¾å‚µã¨ãƒ•ã‚¡ãƒ³ãƒ‰', cards: [250, 253, 48], level: 3 },
                { id: 'bonds-5', title: 'å®Ÿè·µçš„ãªå‚µåˆ¸æŠ•è³‡', cards: [28, 35, 115], level: 4 }
            ],
            'ä¸å‹•ç”£(REIT)': [
                { id: 'reit-1', title: 'REITã®åŸºç¤', cards: [35, 257, 19], level: 1 },
                { id: 'reit-2', title: 'ãƒ¡ãƒªãƒƒãƒˆã¨ãƒªã‚¹ã‚¯', cards: [7, 60, 61], level: 2 },
                { id: 'reit-3', title: 'åˆ†é…é‡‘ã¨åˆ©å›ã‚Š', cards: [38, 46, 126], level: 3 },
                { id: 'reit-4', title: 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæ´»ç”¨', cards: [3, 47, 48], level: 4 }
            ],
            'é«˜åº¦ãªæˆ¦ç•¥': [
                { id: 'strategy-1', title: 'ã‚¹ãƒãƒ¼ãƒˆãƒ™ãƒ¼ã‚¿', cards: [256, 115, 28], level: 3, isPro: true },
                { id: 'strategy-2', title: 'ã‚»ã‚¯ã‚¿ãƒ¼ãƒ»ãƒ†ãƒ¼ãƒ', cards: [255, 261, 262], level: 3, isPro: true },
                { id: 'strategy-3', title: 'æ–°èˆˆå›½æŠ•è³‡', cards: [30, 259, 29], level: 4, isPro: true },
                { id: 'strategy-4', title: 'ãƒ¬ãƒãƒ¬ãƒƒã‚¸ã¨ãƒªã‚¹ã‚¯', cards: [265, 49, 16], level: 5, isPro: true }
            ],
            'FX': [
                { id: 'fx-1', title: 'FXã®åŸºç¤', cards: [301, 302, 303], level: 1, isPro: true },
                { id: 'fx-2', title: 'å–å¼•ã®ä»•çµ„ã¿', cards: [304, 305, 306], level: 2, isPro: true },
                { id: 'fx-3', title: 'ãƒªã‚¹ã‚¯ç®¡ç†', cards: [307, 308, 60], level: 2, isPro: true },
                { id: 'fx-4', title: 'ç›¸å ´ã‚’å‹•ã‹ã™è¦å› ', cards: [309, 310, 311], level: 3, isPro: true },
                { id: 'fx-5', title: 'ãƒˆãƒ¬ãƒ¼ãƒ‰æˆ¦ç•¥', cards: [312, 313, 314], level: 4, isPro: true }
            ],
            'ä»®æƒ³é€šè²¨': [
                { id: 'crypto-1', title: 'ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã®åŸºç¤', cards: [351, 352, 353], level: 1, isPro: true },
                { id: 'crypto-2', title: 'ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹', cards: [354, 355, 361], level: 2, isPro: true },
                { id: 'crypto-3', title: 'ä¿ç®¡ã¨é€é‡‘', cards: [356, 364, 362], level: 2, isPro: true },
                { id: 'crypto-4', title: 'DeFiã¨NFT', cards: [357, 358, 360], level: 3, isPro: true },
                { id: 'crypto-5', title: 'æœªæ¥ã®é‡‘è', cards: [359, 365, 264], level: 4, isPro: true }
            ],
            'iDeCo': [
                { id: 'ideco-1', title: 'iDeCoã®åŸºæœ¬', cards: [8, 89, 88], level: 1, isPro: true },
                { id: 'ideco-2', title: 'æ›é‡‘ã¨ç¯€ç¨åŠ¹æœ', cards: [90, 91, 101], level: 2, isPro: true },
                { id: 'ideco-3', title: 'é‹ç”¨å•†å“ã®é¸ã³æ–¹', cards: [110, 21, 47], level: 3, isPro: true },
                { id: 'ideco-4', title: 'å‡ºå£æˆ¦ç•¥', cards: [50, 118, 105], level: 4, isPro: true }
            ],
            'ãƒãƒ£ãƒ¼ãƒˆåˆ†æ': [
                { id: 'chart-1', title: 'ãƒ­ãƒ¼ã‚½ã‚¯è¶³ã®èª­ã¿æ–¹', cards: [213, 214, 215], level: 1, isPro: true },
                { id: 'chart-2', title: 'åè»¢ãƒ‘ã‚¿ãƒ¼ãƒ³', cards: [201, 203, 204], level: 2, isPro: true },
                { id: 'chart-3', title: 'ç¶™ç¶šãƒ‘ã‚¿ãƒ¼ãƒ³', cards: [207, 211, 212], level: 3, isPro: true },
                { id: 'chart-4', title: 'ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™', cards: [219, 220, 222], level: 4, isPro: true },
                { id: 'chart-5', title: 'ä¸€ç›®å‡è¡¡è¡¨ã‚’æ¥µã‚ã‚‹', cards: [231, 232, 233], level: 5, isPro: true },
                { id: 'chart-6', title: 'æ³¢å‹•è«–ã¨ã‚µã‚¤ã‚¯ãƒ«', cards: [234, 243, 236], level: 5, isPro: true },
                { id: 'chart-7', title: 'é…’ç”°äº”æ³•ã¨ä¹–é›¢', cards: [244, 245, 241], level: 6, isPro: true },
                { id: 'chart-8', title: 'ãã®ä»–ã®é‡è¦ãƒ‘ã‚¿ãƒ¼ãƒ³', cards: [238, 239, 242], level: 6, isPro: true }
            ]
        };

        // ============================================
        // COURSE BUNDLES (Purchasable Roadmaps)
        // ============================================
        const courseBundles = {
            'index-beginner': {
                id: 'index-beginner',
                title: 'æŠ•è³‡åˆå¿ƒè€…ã®ãŸã‚ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŠ•è³‡ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—',
                subtitle: 'å£åº§é–‹è¨­ã‹ã‚‰ç©ç«‹è¨­å®šã¾ã§å®Œå…¨ã‚¬ã‚¤ãƒ‰',
                price: 480,
                icon: 'ğŸ“ˆ',
                shortTitle: 'INDEXæŠ•è³‡',
                description: 'æŠ•è³‡åˆå¿ƒè€…å‘ã‘ã€‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŠ•è³‡ã®åŸºç¤ã€NISAæ´»ç”¨ã€å£åº§é–‹è¨­ã€ç©ç«‹è¨­å®šã€å‡ºå£æˆ¦ç•¥ã¾ã§ã‚’ç¶²ç¾…ã—ãŸå®Œå…¨ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã€‚å…¨62æšã®ã‚«ãƒ¼ãƒ‰ã§ä½“ç³»çš„ã«å­¦ã¹ã¾ã™ã€‚',
                features: [
                    'å…¨62æšã®å­¦ç¿’ã‚«ãƒ¼ãƒ‰',
                    'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŠ•è³‡ã®åŸºç¤',
                    'æ–°NISAå®Œå…¨å¯¾å¿œ',
                    'å£åº§é–‹è¨­ã¨ç©ç«‹è¨­å®š',
                    'ãƒªã‚¹ã‚¯ç®¡ç†ã¨å‡ºå£æˆ¦ç•¥'
                ],
                steps: [
                    {
                        id: 'idx-1',
                        title: 'Step 1: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŠ•è³‡ã‚’çŸ¥ã‚‹',
                        subtitle: 'æŠ•è³‡ã®åœŸå°ã‚’ç¯‰ã',
                        cards: [5001, 5002, 5003, 5004, 5005, 5006, 5007],
                        level: 1,
                        description: 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŠ•è³‡ã®æœ¬è³ªã€ãªãœé¸ã°ã‚Œã‚‹ã®ã‹ã€ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚’æ·±ãç†è§£ã—ã¾ã™ã€‚'
                    },
                    {
                        id: 'idx-2',
                        title: 'Step 2: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ãƒ³ãƒ‰ã‚’ç†è§£ã™ã‚‹',
                        subtitle: 'å•†å“ã®ä»•çµ„ã¿ã‚’çŸ¥ã‚‹',
                        cards: [5008, 5009, 5010, 5011, 5012, 5013, 5014],
                        level: 1,
                        description: 'æŠ•è³‡ä¿¡è¨—ã®ä»•çµ„ã¿ã€ETFã¨ã®é•ã„ã€ä¸»è¦æŒ‡æ•°ã€ã‚³ã‚¹ãƒˆæ¯”è¼ƒãªã©å•†å“é¸ã³ã®åŸºç¤ã‚’å­¦ã³ã¾ã™ã€‚'
                    },
                    {
                        id: 'idx-3',
                        title: 'Step 3: NISAåˆ¶åº¦ã‚’æ´»ç”¨ã™ã‚‹',
                        subtitle: 'ç¨åˆ¶å„ªé‡ã‚’æœ€å¤§åŒ–',
                        cards: [5015, 5016, 5017, 5018, 5019, 5020],
                        level: 2,
                        description: 'æ–°NISAåˆ¶åº¦ã®å…¨ä½“åƒã€ã¤ã¿ãŸã¦æŠ•è³‡æ ã¨æˆé•·æŠ•è³‡æ ã€iDeCoã¨ã®ä½¿ã„åˆ†ã‘ã‚’å­¦ã³ã¾ã™ã€‚'
                    },
                    {
                        id: 'idx-4',
                        title: 'Step 4: è¨¼åˆ¸å£åº§ã‚’é–‹è¨­ã™ã‚‹',
                        subtitle: 'å®Ÿéš›ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’èµ·ã“ã™',
                        cards: [5021, 5022, 5023, 5024, 5025, 5026],
                        level: 2,
                        description: 'ãƒãƒƒãƒˆè¨¼åˆ¸ã®ãƒ¡ãƒªãƒƒãƒˆã€å£åº§é–‹è¨­æ‰‹é †ã€ç‰¹å®šå£åº§ã¨NISAå£åº§ã®é•ã„ã‚’è§£èª¬ã—ã¾ã™ã€‚'
                    },
                    {
                        id: 'idx-5',
                        title: 'Step 5: ãƒ•ã‚¡ãƒ³ãƒ‰ã‚’é¸ã‚“ã§ç©ç«‹è¨­å®š',
                        subtitle: 'è‡ªå‹•åŒ–ã§ç¶™ç¶šã™ã‚‹ä»•çµ„ã¿',
                        cards: [5027, 5028, 5029, 5030, 5031, 5032, 5033],
                        level: 3,
                        description: 'äººæ°—ãƒ•ã‚¡ãƒ³ãƒ‰ã®æ¯”è¼ƒã€ç©ç«‹é‡‘é¡ã®æ±ºã‚æ–¹ã€ãƒ‰ãƒ«ã‚³ã‚¹ãƒˆå¹³å‡æ³•ã®åŠ¹æœã‚’å­¦ã³ã¾ã™ã€‚'
                    },
                    {
                        id: 'idx-6',
                        title: 'Step 6: é‹ç”¨ã‚’ç¶™ç¶šã™ã‚‹',
                        subtitle: 'æš´è½ã—ã¦ã‚‚æ…Œã¦ãªã„',
                        cards: [5034, 5035, 5036, 5037, 5038],
                        level: 3,
                        description: 'é‹ç”¨çŠ¶æ³ã®ç¢ºèªé »åº¦ã€æš´è½æ™‚ã®å¿ƒæ§‹ãˆã€æŠ•è³‡ã‚’ç¶šã‘ã‚‹ã‚³ãƒ„ã‚’èº«ã«ã¤ã‘ã¾ã™ã€‚'
                    },
                    {
                        id: 'idx-7',
                        title: 'Step 7: å‡ºå£æˆ¦ç•¥ã‚’è€ƒãˆã‚‹',
                        subtitle: 'è³‡ç”£ã®ä½¿ã„æ–¹ã‚’è¨ˆç”»',
                        cards: [5039, 5040, 5041, 5042],
                        level: 4,
                        description: 'å–ã‚Šå´©ã—ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€4%ãƒ«ãƒ¼ãƒ«ã€æ¬¡ä¸–ä»£ã¸ã®è³‡ç”£æ‰¿ç¶™ã‚’å­¦ã³ã¾ã™ã€‚'
                    }
                ],
                totalCards: 62,
                estimatedTime: 'ç´„5æ™‚é–“',
                targetAudience: 'æŠ•è³‡æœªçµŒé¨“è€…ã€œåˆå¿ƒè€…'
            },
            'crypto-beginner': {
                id: 'crypto-beginner',
                title: 'ä»®æƒ³é€šè²¨ãƒ»ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³å®Œå…¨å…¥é–€ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—',
                subtitle: 'ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ã‹ã‚‰DeFiãƒ»NFTã¾ã§ä½“ç³»çš„ã«å­¦ã¶',
                price: 680,
                icon: 'â‚¿',
                shortTitle: 'ä»®æƒ³é€šè²¨',
                description: 'ä»®æƒ³é€šè²¨ã®åŸºç¤ã‹ã‚‰DeFiã€NFTã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¾ã§ã€‚å…¨50æšã®ã‚«ãƒ¼ãƒ‰ã§æš—å·è³‡ç”£ã®ä¸–ç•Œã‚’ä½“ç³»çš„ã«å­¦ã¹ã¾ã™ã€‚',
                features: [
                    'å…¨50æšã®å­¦ç¿’ã‚«ãƒ¼ãƒ‰',
                    'ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã®åŸºç¤',
                    'ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ãƒ»ã‚¤ãƒ¼ã‚µãƒªã‚¢ãƒ ',
                    'DeFiãƒ»NFTã®ç†è§£',
                    'ã‚¦ã‚©ãƒ¬ãƒƒãƒˆç®¡ç†ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£'
                ],
                steps: [
                    {
                        id: 'cry-1',
                        title: 'Step 1: ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã‚’ç†è§£ã™ã‚‹',
                        subtitle: 'æŠ€è¡“ã®åŸºç¤ã‚’å­¦ã¶',
                        cards: [6001, 6002, 6003, 6004, 6005, 6006],
                        level: 1,
                        description: 'ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã®ä»•çµ„ã¿ã€åˆ†æ•£å‹å°å¸³ã€ã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ç†è§£ã—ã¾ã™ã€‚'
                    },
                    {
                        id: 'cry-2',
                        title: 'Step 2: ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ã‚’çŸ¥ã‚‹',
                        subtitle: 'æœ€åˆã®æš—å·è³‡ç”£',
                        cards: [6007, 6008, 6009, 6010, 6011, 6012],
                        level: 1,
                        description: 'ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ã®æ­´å²ã€ç‰¹å¾´ã€åŠæ¸›æœŸã€ãƒã‚¤ãƒ‹ãƒ³ã‚°ã®ä»•çµ„ã¿ã‚’å­¦ã³ã¾ã™ã€‚'
                    },
                    {
                        id: 'cry-3',
                        title: 'Step 3: ã‚¤ãƒ¼ã‚µãƒªã‚¢ãƒ ã¨ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ',
                        subtitle: 'ãƒ—ãƒ­ã‚°ãƒ©ãƒ å¯èƒ½ãªãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³',
                        cards: [6013, 6014, 6015, 6016, 6017],
                        level: 2,
                        description: 'ã‚¤ãƒ¼ã‚µãƒªã‚¢ãƒ ã®ç‰¹å¾´ã€ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã€ã‚¬ã‚¹ä»£ã®ä»•çµ„ã¿ã‚’å­¦ã³ã¾ã™ã€‚'
                    },
                    {
                        id: 'cry-4',
                        title: 'Step 4: ã‚¢ãƒ«ãƒˆã‚³ã‚¤ãƒ³ã®ä¸–ç•Œ',
                        subtitle: 'å¤šæ§˜ãªæš—å·è³‡ç”£ã‚’çŸ¥ã‚‹',
                        cards: [6018, 6019, 6020, 6021, 6022],
                        level: 2,
                        description: 'ä¸»è¦ãªã‚¢ãƒ«ãƒˆã‚³ã‚¤ãƒ³ã€ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ã‚¤ãƒ³ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚'
                    },
                    {
                        id: 'cry-5',
                        title: 'Step 5: ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã¨å–å¼•æ‰€',
                        subtitle: 'è³‡ç”£ã‚’ç®¡ç†ã™ã‚‹',
                        cards: [6023, 6024, 6025, 6026, 6027, 6028],
                        level: 2,
                        description: 'ãƒ›ãƒƒãƒˆã‚¦ã‚©ãƒ¬ãƒƒãƒˆã€ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã€å–å¼•æ‰€ã®ä½¿ã„æ–¹ã‚’å­¦ã³ã¾ã™ã€‚'
                    },
                    {
                        id: 'cry-6',
                        title: 'Step 6: DeFiï¼ˆåˆ†æ•£å‹é‡‘èï¼‰å…¥é–€',
                        subtitle: 'éŠ€è¡Œãªã—ã®é‡‘è',
                        cards: [6029, 6030, 6031, 6032, 6033, 6034],
                        level: 3,
                        description: 'DEXã€ãƒ¬ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã€ã‚¤ãƒ¼ãƒ«ãƒ‰ãƒ•ã‚¡ãƒ¼ãƒŸãƒ³ã‚°ã€æµå‹•æ€§æä¾›ã‚’å­¦ã³ã¾ã™ã€‚'
                    },
                    {
                        id: 'cry-7',
                        title: 'Step 7: NFTã¨ãƒ‡ã‚¸ã‚¿ãƒ«è³‡ç”£',
                        subtitle: 'å”¯ä¸€ç„¡äºŒã®ãƒˆãƒ¼ã‚¯ãƒ³',
                        cards: [6035, 6036, 6037, 6038, 6039],
                        level: 3,
                        description: 'NFTã®ä»•çµ„ã¿ã€æ´»ç”¨äº‹ä¾‹ã€ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã‚’å­¦ã³ã¾ã™ã€‚'
                    },
                    {
                        id: 'cry-8',
                        title: 'Step 8: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨è©æ¬ºå¯¾ç­–',
                        subtitle: 'è³‡ç”£ã‚’å®ˆã‚‹',
                        cards: [6040, 6041, 6042, 6043, 6044, 6045],
                        level: 2,
                        description: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®åŸºæœ¬ã€è©æ¬ºã®æ‰‹å£ã€è‡ªå·±ç®¡ç†ã®é‡è¦æ€§ã‚’å­¦ã³ã¾ã™ã€‚'
                    },
                    {
                        id: 'cry-9',
                        title: 'Step 9: ç¨é‡‘ãƒ»è¦åˆ¶ãƒ»æœªæ¥',
                        subtitle: 'ãƒ«ãƒ¼ãƒ«ã‚’çŸ¥ã‚Šæœªæ¥ã‚’è¦‹æ®ãˆã‚‹',
                        cards: [6046, 6047, 6048, 6049, 6050],
                        level: 3,
                        description: 'æ—¥æœ¬ã®ç¨åˆ¶ã€è¦åˆ¶å‹•å‘ã€Web3.0ã®æœªæ¥ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚'
                    }
                ],
                totalCards: 50,
                estimatedTime: 'ç´„4æ™‚é–“',
                targetAudience: 'ä»®æƒ³é€šè²¨åˆå¿ƒè€…ã€œä¸­ç´šè€…'
            }
        };


        const TheBriefing = ({ onNavigate, userProfile, userGoals, onProgressUpdate, userPlan, onUpgrade, understoodCards, setUnderstoodCards, unclearCards, setUnclearCards, purchasedBundles, onPurchaseBundle, freeLimit, nextReplenishTime, onUpdateLimits, dailyCompleted, onUpdateDailyCompleted }) => {
            const [viewMode, setViewMode] = useState('swipe'); // 'swipe', 'roadmap', or 'subscription'
            const [currentCardIndex, setCurrentCardIndex] = useState(0);
            // understoodCards and unclearCards now come from props (App level) for persistence
            // dailyCompleted now comes from props (App level) for persistence and daily reset
            const [selectedRoadmap, setSelectedRoadmap] = useState(null);
            const [swipeDir, setSwipeDir] = useState(null);
            const [userLevel, setUserLevel] = useState(1);
            // userPlan is now a prop, setSubscriptionPlan removed
            const [activeRoadmapFilter, setActiveRoadmapFilter] = useState(null); // Pro feature: filter cards to specific roadmap

            const basicLimit = 360; // Updated to match actual card count
            const DAILY_REPLENISH_AMOUNT = 5;
            const REPLENISH_INTERVAL = 24 * 60 * 60 * 1000; // 24 hours

            // Safe reference to cards - prevents ReferenceError if cards.js not loaded
            const allCards = useMemo(() => {
                const briefing = Array.isArray(window.briefingCards) ? window.briefingCards : [];
                const indexBundle = Array.isArray(window.indexBundleCards) ? window.indexBundleCards : [];
                const cryptoBundle = Array.isArray(window.cryptoBundleCards) ? window.cryptoBundleCards : [];
                return [...briefing, ...indexBundle, ...cryptoBundle];
            }, []);

            // Get all card IDs from purchased bundles (for unlimited access)
            const purchasedBundleCardIds = useMemo(() => {
                if (!purchasedBundles || purchasedBundles.length === 0) return new Set();
                const ids = new Set();
                purchasedBundles.forEach(bundleId => {
                    const bundle = courseBundles[bundleId];
                    if (bundle) {
                        bundle.steps.forEach(step => {
                            step.cards.forEach(cardId => ids.add(cardId));
                        });
                    }
                });
                return ids;
            }, [purchasedBundles]);

            const proCards = useMemo(() => allCards.filter(c => c.isPro), [allCards]);
            const basicCards = useMemo(() => allCards.filter(c => !c.isPro), [allCards]);


            // Replenish Logic
            const [now, setNow] = useState(Date.now());

            // Timer for real-time countdown
            useEffect(() => {
                const timer = setInterval(() => setNow(Date.now()), 1000);
                return () => clearInterval(timer);
            }, []);

            // Replenish Logic - synced with 'now'
            // Replenish Logic - synced with 'now'
            useEffect(() => {
                if (nextReplenishTime && now >= nextReplenishTime) {
                    onUpdateLimits({ freeLimit: freeLimit + DAILY_REPLENISH_AMOUNT, nextReplenishTime: null });
                }
            }, [now, nextReplenishTime]);

            // Trigger limit timer when reached
            // Trigger limit timer when reached
            useEffect(() => {
                const totalCardsViewed = understoodCards.length + unclearCards.length;
                if (userPlan === 'free' && totalCardsViewed >= freeLimit && !nextReplenishTime) {
                    onUpdateLimits({ nextReplenishTime: Date.now() + REPLENISH_INTERVAL });
                }
            }, [understoodCards, unclearCards, freeLimit, userPlan, nextReplenishTime]);

            // Chart Pattern SVG Helper Component
            const ChartPatternSVG = ({ pattern }) => {
                const patterns = {
                    head_and_shoulders: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,50 20,40 30,25 40,40 55,15 70,40 80,25 90,40 115,50" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <line x1="20" y1="40" x2="90" y2="40" stroke="#DAA520" strokeWidth="1" strokeDasharray="3,3" opacity="0.5" />
                            <text x="55" y="8" fill="#DAA520" fontSize="6" textAnchor="middle">H</text>
                            <text x="30" y="20" fill="#888" fontSize="5" textAnchor="middle">S</text>
                            <text x="80" y="20" fill="#888" fontSize="5" textAnchor="middle">S</text>
                        </svg>
                    ),
                    double_top: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,50 25,20 45,40 65,20 85,50 115,55" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <line x1="25" y1="20" x2="65" y2="20" stroke="#DAA520" strokeWidth="1" strokeDasharray="2,2" opacity="0.5" />
                        </svg>
                    ),
                    double_bottom: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,10 25,50 45,25 65,50 85,10 115,5" fill="none" stroke="#10B981" strokeWidth="2" />
                            <line x1="25" y1="50" x2="65" y2="50" stroke="#10B981" strokeWidth="1" strokeDasharray="2,2" opacity="0.5" />
                        </svg>
                    ),
                    golden_cross: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,50 30,45 50,35 70,25 90,18 115,10" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <polyline points="5,40 30,42 50,40 70,35 90,28 115,20" fill="none" stroke="#888" strokeWidth="1.5" strokeDasharray="4,2" />
                            <circle cx="60" cy="37" r="4" fill="#DAA520" opacity="0.8" />
                            <text x="60" y="52" fill="#DAA520" fontSize="6" textAnchor="middle">GC</text>
                        </svg>
                    ),
                    dead_cross: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,10 30,18 50,30 70,40 90,48 115,55" fill="none" stroke="#F43F5E" strokeWidth="2" />
                            <polyline points="5,20 30,22 50,28 70,35 90,42 115,48" fill="none" stroke="#888" strokeWidth="1.5" strokeDasharray="4,2" />
                            <circle cx="55" cy="30" r="4" fill="#F43F5E" opacity="0.8" />
                            <text x="55" y="45" fill="#F43F5E" fontSize="6" textAnchor="middle">DC</text>
                        </svg>
                    ),
                    symmetrical_triangle: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,15 25,45 45,20 65,40 85,28 100,35 115,10" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <line x1="5" y1="15" x2="85" y2="35" stroke="#888" strokeWidth="1" strokeDasharray="2,2" opacity="0.5" />
                            <line x1="25" y1="45" x2="85" y2="28" stroke="#888" strokeWidth="1" strokeDasharray="2,2" opacity="0.5" />
                        </svg>
                    ),
                    doji: (
                        <svg viewBox="0 0 60 60" className="w-16 h-16 mx-auto">
                            <line x1="30" y1="10" x2="30" y2="50" stroke="#DAA520" strokeWidth="1.5" />
                            <line x1="22" y1="30" x2="38" y2="30" stroke="#DAA520" strokeWidth="3" />
                        </svg>
                    ),
                    hammer: (
                        <svg viewBox="0 0 60 60" className="w-16 h-16 mx-auto">
                            <line x1="30" y1="20" x2="30" y2="50" stroke="#DAA520" strokeWidth="1.5" />
                            <rect x="24" y="12" width="12" height="10" fill="#10B981" stroke="#10B981" />
                        </svg>
                    ),
                    engulfing: (
                        <svg viewBox="0 0 80 60" className="w-20 h-16 mx-auto">
                            <rect x="20" y="25" width="10" height="15" fill="#F43F5E" />
                            <rect x="40" y="15" width="15" height="30" fill="#10B981" />
                        </svg>
                    ),
                    bollinger_bands: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <path d="M5,30 Q30,10 60,30 T115,30" fill="none" stroke="#888" strokeWidth="1" strokeDasharray="2,2" />
                            <path d="M5,40 Q30,35 60,40 T115,40" fill="none" stroke="#DAA520" strokeWidth="1.5" />
                            <path d="M5,50 Q30,55 60,50 T115,50" fill="none" stroke="#888" strokeWidth="1" strokeDasharray="2,2" />
                            <polyline points="10,42 30,38 50,45 70,35 90,42 110,38" fill="none" stroke="#10B981" strokeWidth="1.5" />
                        </svg>
                    ),
                    rsi: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <rect x="5" y="5" width="110" height="50" fill="none" stroke="#333" strokeWidth="0.5" />
                            <line x1="5" y1="15" x2="115" y2="15" stroke="#F43F5E" strokeWidth="0.5" strokeDasharray="2,2" opacity="0.5" />
                            <line x1="5" y1="45" x2="115" y2="45" stroke="#10B981" strokeWidth="0.5" strokeDasharray="2,2" opacity="0.5" />
                            <polyline points="10,35 25,28 40,38 55,22 70,30 85,12 100,25 110,32" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <text x="5" y="12" fill="#F43F5E" fontSize="6">70</text>
                            <text x="5" y="50" fill="#10B981" fontSize="6">30</text>
                        </svg>
                    ),
                    macd: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <line x1="5" y1="35" x2="115" y2="35" stroke="#333" strokeWidth="0.5" />
                            <polyline points="10,40 30,32 50,38 70,28 90,35 110,25" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <polyline points="10,42 30,38 50,40 70,33 90,38 110,30" fill="none" stroke="#F43F5E" strokeWidth="1.5" strokeDasharray="3,2" />
                            {[15, 25, 35, 45, 55, 65, 75, 85, 95, 105].map((x, i) => (
                                <rect key={i} x={x} y={35 - (i % 2 === 0 ? 5 : -2)} width="3" height={Math.abs((i % 2 === 0 ? 5 : -2))} fill={i % 2 === 0 ? "#10B981" : "#F43F5E"} opacity="0.5" />
                            ))}
                        </svg>
                    ),
                    moving_average: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,45 20,38 35,42 50,35 65,40 80,30 95,35 110,25" fill="none" stroke="#888" strokeWidth="1" />
                            <polyline points="5,50 30,42 55,45 80,38 110,30" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <polyline points="5,52 40,48 75,45 110,38" fill="none" stroke="#10B981" strokeWidth="1.5" strokeDasharray="4,2" />
                        </svg>
                    ),
                    candlestick_basics: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <g>
                                <line x1="20" y1="12" x2="20" y2="50" stroke="#10B981" strokeWidth="1" />
                                <rect x="15" y="20" width="10" height="20" fill="#10B981" />
                            </g>
                            <g>
                                <line x1="50" y1="8" x2="50" y2="45" stroke="#F43F5E" strokeWidth="1" />
                                <rect x="45" y="15" width="10" height="22" fill="#F43F5E" />
                            </g>
                            <g>
                                <line x1="80" y1="18" x2="80" y2="55" stroke="#10B981" strokeWidth="1" />
                                <rect x="75" y="25" width="10" height="18" fill="#10B981" />
                            </g>
                            <g>
                                <line x1="105" y1="5" x2="105" y2="40" stroke="#F43F5E" strokeWidth="1" />
                                <rect x="100" y="10" width="10" height="25" fill="#F43F5E" />
                            </g>
                        </svg>
                    ),
                    ichimoku_base: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            {/* Cloud */}
                            <path d="M10,40 Q40,30 60,35 Q90,30 115,25 L115,35 Q90,40 60,45 Q40,40 10,50 Z" fill="#10B981" opacity="0.2" />
                            {/* Conversion Line (Tenkan) */}
                            <polyline points="10,45 30,35 60,40 90,20 115,15" fill="none" stroke="#3B82F6" strokeWidth="1.5" />
                            {/* Base Line (Kijun) */}
                            <polyline points="10,48 40,40 70,38 100,25 115,22" fill="none" stroke="#EF4444" strokeWidth="1.5" />
                        </svg>
                    ),
                    ichimoku_cloud_break: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <path d="M10,35 Q60,30 115,25 L115,45 Q60,50 10,55 Z" fill="#10B981" opacity="0.2" />
                            <polyline points="10,50 40,45 60,20 80,15 115,10" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <circle cx="60" cy="20" r="3" fill="#DAA520" />
                        </svg>
                    ),
                    sanyaku_kouten: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <defs>
                                <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
                                    <path d="M0,0 L0,6 L9,3 z" fill="#DAA520" />
                                </marker>
                            </defs>
                            <path d="M10,40 Q60,35 115,30 L115,50 Q60,55 10,60 Z" fill="#10B981" opacity="0.1" />
                            <polyline points="10,55 40,45 60,25 90,15 115,10" fill="none" stroke="#DAA520" strokeWidth="2" markerEnd="url(#arrow)" />
                            <text x="60" y="20" fill="#DAA520" fontSize="8" fontWeight="bold" textAnchor="middle">BUY!</text>
                        </svg>
                    ),
                    elliott_wave_impulse: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="5,50 25,30 40,40 70,10 90,25 115,5" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <text x="25" y="25" fill="#888" fontSize="6">1</text>
                            <text x="40" y="48" fill="#888" fontSize="6">2</text>
                            <text x="70" y="5" fill="#888" fontSize="6">3</text>
                            <text x="90" y="32" fill="#888" fontSize="6">4</text>
                            <text x="115" y="15" fill="#888" fontSize="6">5</text>
                        </svg>
                    ),
                    stochastic: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <rect x="5" y="10" width="110" height="40" fill="none" stroke="#333" strokeWidth="0.5" />
                            <line x1="5" y1="15" x2="115" y2="15" stroke="#F43F5E" strokeDasharray="2,2" opacity="0.5" />
                            <line x1="5" y1="45" x2="115" y2="45" stroke="#10B981" strokeDasharray="2,2" opacity="0.5" />
                            <path d="M5,40 Q30,50 50,20 Q80,10 115,30" fill="none" stroke="#DAA520" strokeWidth="1.5" />
                            <path d="M5,45 Q30,55 55,25 Q80,15 115,35" fill="none" stroke="#F43F5E" strokeWidth="1" strokeDasharray="3,2" />
                        </svg>
                    ),
                    parabolic: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <path d="M5,50 Q60,10 115,40" fill="none" stroke="#888" strokeWidth="1" opacity="0.5" />
                            {[10, 20, 30, 40, 50].map((x, i) => (
                                <circle key={i} cx={x} cy={55 - i * 8} r="1.5" fill="#10B981" />
                            ))}
                            {[60, 70, 80, 90, 100, 110].map((x, i) => (
                                <circle key={i + 5} cx={x} cy={20 + i * 5} r="1.5" fill="#F43F5E" />
                            ))}
                        </svg>
                    ),
                    v_bottom: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polyline points="10,10 60,50 110,10" fill="none" stroke="#DAA520" strokeWidth="2" />
                            <circle cx="60" cy="50" r="3" fill="#DAA520" />
                        </svg>
                    ),
                    rounding_bottom: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <path d="M10,10 C10,10 20,50 60,50 C100,50 110,10 110,10" fill="none" stroke="#DAA520" strokeWidth="2" />
                        </svg>
                    ),
                    diamond_top: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <polygon points="10,30 60,10 110,30 60,50" fill="rgba(218,165,32,0.1)" stroke="#DAA520" strokeWidth="1.5" />
                            <polyline points="20,40 40,20 60,40 80,20 100,40" fill="none" stroke="#888" strokeWidth="1" opacity="0.6" />
                        </svg>
                    ),
                    rectangle: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <rect x="10" y="15" width="100" height="30" fill="rgba(255,255,255,0.05)" stroke="#DAA520" strokeWidth="1" strokeDasharray="3,3" />
                            <polyline points="10,30 30,15 50,45 70,15 90,45 110,30" fill="none" stroke="#888" strokeWidth="1.5" />
                        </svg>
                    ),
                    divergence: (
                        <svg viewBox="0 0 120 60" className="w-full h-20">
                            <line x1="10" y1="25" x2="110" y2="15" stroke="#DAA520" strokeWidth="1.5" markerEnd="url(#arrow)" />
                            <line x1="10" y1="45" x2="110" y2="55" stroke="#F43F5E" strokeWidth="1.5" markerEnd="url(#arrow)" />
                            <text x="60" y="35" fill="#888" fontSize="8" textAnchor="middle">DIVERGENCE</text>
                        </svg>
                    ),
                };
                return patterns[pattern] || (
                    <svg viewBox="0 0 120 60" className="w-full h-20">
                        <polyline points="5,50 30,35 55,45 80,25 105,30 115,15" fill="none" stroke="#DAA520" strokeWidth="2" />
                    </svg>
                );
            };

            const dailyGoal = 5;
            const cardRef = useRef(null);

            // Sync progress with parent
            useEffect(() => {
                if (onProgressUpdate) onProgressUpdate(understoodCards.length);
            }, [understoodCards, onProgressUpdate]);

            // Check if paywall should be shown (not for roadmap viewing or purchased bundle cards)
            const totalCardsViewed = understoodCards.length + unclearCards.length;
            const cardLimit = userPlan === 'free' ? freeLimit : (userPlan === 'basic' ? basicLimit : allCards.length);

            // Check if currently viewing bundle cards (unlimited access for purchased bundles)
            const isViewingBundleCards = useMemo(() => {
                if (!activeRoadmapFilter || activeRoadmapFilter.length === 0) return false;
                return activeRoadmapFilter.some(cardId => purchasedBundleCardIds.has(cardId));
            }, [activeRoadmapFilter, purchasedBundleCardIds]);

            // Don't show paywall if viewing purchased bundle cards
            const shouldShowPaywall = userPlan === 'free' && totalCardsViewed >= freeLimit && viewMode === 'swipe' && !isViewingBundleCards;
            const isPro = userPlan === 'pro';


            // Randomized order for Today's Learning (shuffled once per session/load)
            const shuffledCardIds = useMemo(() => {
                return allCards.map(c => c.id).sort(() => Math.random() - 0.5);
            }, [allCards]);

            // Personalize cards based on profile and understanding
            const getPersonalizedCards = () => {
                // Filter out Pro cards for non-Pro users
                const accessibleCards = isPro ? allCards : basicCards;

                // If filtering by roadmap (Pro feature)
                if (activeRoadmapFilter && activeRoadmapFilter.length > 0) {
                    // Start roadmap mode: Return ALL cards in the roadmap, regardless of 'understood' status
                    // This creates a continuous flow (1->2->3)
                    const roadmapCards = accessibleCards.filter(c => activeRoadmapFilter.includes(c.id));
                    // Sort based on the order in activeRoadmapFilter to match roadmap steps
                    return roadmapCards.sort((a, b) => activeRoadmapFilter.indexOf(a.id) - activeRoadmapFilter.indexOf(b.id));
                }

                // Today's Learning Mode (Random Order)
                // Filter out bundle cards - allow only basic Briefing cards for random swipe
                // Note: accessibleCards might contain bundle cards if user is Pro, but we want to exclude them from "Today's Learning" random mix
                // unless they are explicitly selected via Roadmap Mode.

                // Identify basic cards (from briefingCards)
                const basicCardIds = (window.briefingCards || []).map(c => c.id);

                // Check if card is from premium bundles (index, crypto)
                const isPremiumBundleCard = (id) => {
                    return (window.indexBundleCards || []).some(c => c.id === id) ||
                        (window.cryptoBundleCards || []).some(c => c.id === id);
                };

                // Filter cards based on user plan
                let cards = accessibleCards.filter(c => {
                    // Always exclude premium bundle cards from random swipe
                    if (isPremiumBundleCard(c.id)) return false;
                    // Only include basic briefing cards
                    if (!basicCardIds.includes(c.id)) return false;
                    // Free users: exclude Pro-only cards (advanced strategies, FX, etc.)
                    if (!isPro && c.isPro) return false;
                    return true;
                });

                // Use shuffled order
                cards.sort((a, b) => shuffledCardIds.indexOf(a.id) - shuffledCardIds.indexOf(b.id));

                // Move unclear cards to front for review
                const unclearFirst = cards.filter(c => unclearCards.includes(c.id));

                // Get unlearned cards (exclude understood and unclear)
                // No level filter for "Complete Random" experience as requested
                const rest = cards.filter(c => !unclearCards.includes(c.id) && !understoodCards.includes(c.id));

                return [...unclearFirst, ...rest];
            };

            const availableCards = getPersonalizedCards();
            const currentCard = availableCards[currentCardIndex];

            const handleSwipe = (direction) => {
                if (!currentCard) return;
                setSwipeDir(direction);

                setTimeout(() => {
                    if (direction === 'right') {
                        // Understood
                        const newUnderstood = [...understoodCards.filter(id => id !== currentCard.id), currentCard.id];
                        setUnderstoodCards(newUnderstood);

                        // Remove from unclear if present
                        const newUnclear = unclearCards.filter(id => id !== currentCard.id);
                        if (newUnclear.length !== unclearCards.length) {
                            setUnclearCards(newUnclear);
                        }

                        // Level up check
                    } else {
                        // Unclear - add for review
                        // Avoid duplicates if already in unclear
                        if (!unclearCards.includes(currentCard.id)) {
                            setUnclearCards([...unclearCards, currentCard.id]);
                        }
                    }

                    // Update Progress for daily goal (persisted in App)
                    if (direction === 'right' || direction === 'left') {
                        onUpdateDailyCompleted({ dailyCompleted: dailyCompleted + 1 });
                    }

                    // Logic Update:
                    // If Roadmap Mode: Advance index to show next card in fixed list
                    // If Today's Learning (Random): Always advance index
                    // For left swipe: card goes to unclearFirst at front of list,
                    // so we need to advance past it to avoid showing same card
                    if (activeRoadmapFilter) {
                        setCurrentCardIndex(prev => prev + 1);
                    } else {
                        if (direction === 'left') {
                            // Left-swiped card will be at front of unclearFirst,
                            // advance index to skip past it
                            setCurrentCardIndex(prev => prev + 1);
                        } else {
                            // Right-swiped card is removed from list (understood),
                            // reset to 0 since list shrinks
                            setCurrentCardIndex(0);
                        }
                    }

                    setSwipeDir(null);
                }, 300);
            };

            // Drag handlers for swipe
            const handleDrag = (e, info) => {
                if (Math.abs(info.offset.x) > 80) {
                    handleSwipe(info.offset.x > 0 ? 'right' : 'left');
                }
            };

            const getRoadmapProgress = (roadmap) => {
                const userExp = userProfile?.experienceLevel || 1;
                // Filter steps that are relevant for the user's level (hide/exclude basic steps from progress)
                const relevantSteps = roadmap.filter(step => step.level >= userExp);

                // If all steps are below user level (e.g. Expert user on Basic roadmap), considered 100% complete
                if (relevantSteps.length === 0) return 100;

                const totalCards = relevantSteps.reduce((sum, step) => sum + step.cards.length, 0);
                if (totalCards === 0) return 100;

                const completedCards = relevantSteps.reduce((sum, step) => sum + step.cards.filter(id => understoodCards.includes(id)).length, 0);
                return Math.round((completedCards / totalCards) * 100);
            };

            const levelLabels = { 1: 'â˜…', 2: 'â˜…â˜…', 3: 'â˜…â˜…â˜…' };

            // Subscription Paywall
            if (viewMode === 'subscription' || shouldShowPaywall) {
                return (
                    <div className="min-h-screen bg-obsidian pt-24 pb-20 px-4 sm:px-8 relative overflow-hidden">
                        {/* Dynamic Background Lighting */}
                        <div className="fixed inset-0 pointer-events-none overflow-hidden">
                            <div className="absolute top-[5%] left-1/4 w-[600px] h-[600px] bg-gold/10 rounded-full blur-[150px] opacity-40" />
                            <div className="absolute bottom-[10%] right-1/4 w-[500px] h-[500px] bg-amber-500/10 rounded-full blur-[120px] opacity-30" />
                        </div>

                        <div className="max-w-xl mx-auto relative z-10">
                            {/* Header */}
                            <div className="mb-12 text-center">
                                <motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }}>
                                    <p className="text-dim text-xs tracking-[0.4em] mb-4 text-gold">INVISION PREMIUM</p>
                                    <h2 className="text-4xl md:text-5xl font-black tracking-tighter text-platinum mb-4">æŠ•è³‡å­¦ç¿’ã‚’<span className="text-gold-gradient">åŠ é€Ÿ</span>ã™ã‚‹</h2>
                                    <p className="text-dim text-lg">ç„¡æ–™ã§{freeLimit}æšã®å­¦ç¿’ã‚«ãƒ¼ãƒ‰ã‚’ä½“é¨“ã—ã¾ã—ãŸ</p>
                                    {nextReplenishTime && (
                                        <p className="text-sm text-gold mt-2 bg-gold/10 inline-block px-3 py-1 rounded-sm border border-gold/30 font-mono">
                                            æ¬¡ã®{DAILY_REPLENISH_AMOUNT}æšã¾ã§<br />
                                            {Math.max(0, Math.floor((nextReplenishTime - now) / 1000 / 60 / 60)).toString().padStart(2, '0')}:
                                            {Math.max(0, Math.floor(((nextReplenishTime - now) / 1000 / 60) % 60)).toString().padStart(2, '0')}:
                                            {Math.max(0, Math.floor(((nextReplenishTime - now) / 1000) % 60)).toString().padStart(2, '0')}
                                        </p>
                                    )}
                                </motion.div>
                            </div>

                            {/* Progress Display */}
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.2 }}
                                className="bg-ash/50 border border-white/10 rounded-sm p-6 mb-8 text-center">
                                <p className="text-4xl font-black text-gold mb-2">{allCards.length > 0 ? Math.round((totalCardsViewed / allCards.length) * 100) : 0}%</p>
                                <p className="text-sm text-dim">å­¦ç¿’é€²æ—ç‡</p>
                            </motion.div>

                            {/* Subscription Plans */}
                            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.3 }}
                                className="space-y-4 mb-8">

                                {/* Pro Plan */}
                                <div className="bg-gradient-to-br from-gold/20 to-amber-500/10 border-2 border-gold rounded-sm p-6 relative overflow-hidden">
                                    <div className="absolute top-4 right-4 text-[10px] bg-gold text-black px-3 py-1 rounded-sm font-bold">äººæ°—No.1</div>
                                    <h3 className="text-2xl font-black text-platinum mb-2">Pro</h3>
                                    <div className="flex items-end gap-2 mb-4">
                                        <span className="text-4xl font-black text-gold">Â¥980</span>
                                        <span className="text-dim text-sm mb-1">/ è²·ã„åˆ‡ã‚Š</span>
                                    </div>
                                    <ul className="space-y-3 mb-6">
                                        <li className="flex items-center gap-3 text-sm text-platinum/80"><span className="text-gold">âœ“</span>å…¨{allCards.length}æšã®å­¦ç¿’ã‚«ãƒ¼ãƒ‰</li>
                                        <li className="flex items-center gap-3 text-sm text-platinum/80"><span className="text-gold">âœ“</span>ã‚¢ã‚»ãƒƒãƒˆåˆ¥ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—å­¦ç¿’</li>
                                        <li className="flex items-center gap-3 text-sm text-platinum/80"><span className="text-gold">âœ“</span>Grok AIã«ã‚ˆã‚‹è³ªå•å›ç­”</li>
                                        <li className="flex items-center gap-3 text-sm text-platinum/80"><span className="text-gold">âœ“</span>æ–°ã—ã„å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å…ˆè¡Œã‚¢ã‚¯ã‚»ã‚¹</li>
                                    </ul>
                                    <button onClick={() => { onUpgrade('pro'); setViewMode('swipe'); }}
                                        className="w-full py-4 bg-gold text-black font-bold text-lg rounded-sm hover:bg-amber-400 transition-colors">
                                        Proã‚’å§‹ã‚ã‚‹
                                    </button>
                                </div>

                                {/* Basic Plan */}
                                <div className="bg-ash/50 border border-white/10 rounded-sm p-6">
                                    <h3 className="text-xl font-bold text-platinum mb-2">Basic</h3>
                                    <div className="flex items-end gap-2 mb-4">
                                        <span className="text-3xl font-bold text-platinum">Â¥480</span>
                                        <span className="text-dim text-sm mb-1">/ è²·ã„åˆ‡ã‚Š</span>
                                    </div>
                                    <ul className="space-y-2 mb-6">
                                        <li className="flex items-center gap-3 text-sm text-platinum/70"><span className="text-emerald-400">âœ“</span>{basicCards.length}æšã®å­¦ç¿’ã‚«ãƒ¼ãƒ‰</li>
                                        <li className="flex items-center gap-3 text-sm text-platinum/70"><span className="text-emerald-400">âœ“</span>ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—é–²è¦§</li>
                                    </ul>
                                    <button onClick={() => { onUpgrade('basic'); setViewMode('swipe'); }}
                                        className="w-full py-3 border border-white/30 text-platinum font-bold rounded-sm hover:border-gold hover:text-gold transition-colors">
                                        Basicã‚’å§‹ã‚ã‚‹
                                    </button>
                                </div>
                            </motion.div>

                            {/* Benefits */}
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.5 }}
                                className="text-center">
                                <p className="text-xs text-dim mb-2">ğŸ’³ ã„ã¤ã§ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½</p>
                                <p className="text-xs text-dim">ğŸ“± å…¨ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ</p>
                            </motion.div>

                            {/* Back Button */}
                            <div className="mt-8 text-center">
                                <button onClick={() => onNavigate('gallery')} className="text-dim text-sm hover:text-gold transition-colors">
                                    â† ã‚¢ã‚»ãƒƒãƒˆä¸€è¦§ã«æˆ»ã‚‹
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (viewMode === 'roadmap') {
                return (
                    <div className="h-screen bg-obsidian pt-24 pb-20 px-8 relative overflow-y-auto custom-scrollbar">
                        {/* Dynamic Background Lighting */}
                        <div className="fixed inset-0 pointer-events-none overflow-hidden">
                            <div className="absolute top-[5%] -right-[15%] w-[700px] h-[700px] bg-gold/5 rounded-full blur-[150px] opacity-25" />
                            <div className="absolute bottom-[20%] -left-[10%] w-[500px] h-[500px] bg-emerald-500/5 rounded-full blur-[120px] opacity-15" />
                        </div>

                        <div className="max-w-4xl mx-auto relative z-10">
                            {/* Unified Header - Asset Gallery Style */}
                            <div className="mb-12">
                                <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }}>
                                    <p className="text-dim text-xs tracking-[0.4em] mb-4 text-gold">LEARNING ROADMAP</p>
                                    <h2 className="text-4xl md:text-5xl font-black tracking-tighter text-platinum mb-4">æŠ•è³‡ã¸ã®<span className="text-gold-gradient">é“ã®ã‚Š</span></h2>
                                    <div className="flex items-center gap-4">
                                        <p className="text-dim text-sm">å„ã‚¢ã‚»ãƒƒãƒˆã®ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚’å®Œäº†ã™ã‚‹ã¨ã€æŠ•è³‡ã‚’å§‹ã‚ã‚‹æº–å‚™ãŒæ•´ã„ã¾ã™</p>
                                        <button onClick={() => setViewMode('swipe')} className="text-xs text-gold hover:text-gold/80 transition-colors border border-gold/30 px-3 py-1 rounded-sm">
                                            â† å­¦ç¿’ã«æˆ»ã‚‹
                                        </button>
                                    </div>
                                </motion.div>
                            </div>


                            {/* Learned Archive */}
                            {understoodCards.length > 0 && (
                                <div className="mb-12 opacity-60 hover:opacity-100 transition-opacity">
                                    <div className="flex items-center justify-between mb-4">
                                        <p className="text-dim text-xs tracking-[0.2em]">LEARNED ARCHIVE</p>
                                        <span className="text-xs text-emerald-400 font-mono">{understoodCards.length} Cards</span>
                                    </div>
                                    <div className="overflow-x-auto pb-4 scrollbar-hide flex gap-4 snap-x snap-mandatory">
                                        {understoodCards.map(id => {
                                            const card = allCards.find(c => c.id === id);
                                            if (!card) return null;
                                            return (
                                                <div key={id} className="min-w-[200px] bg-white/5 border border-white/10 rounded-sm p-4 snap-center cursor-pointer hover:bg-white/10 transition-colors"
                                                    onClick={() => { setActiveRoadmapFilter([id]); setCurrentCardIndex(0); setViewMode('swipe'); }}>
                                                    <div className="text-[10px] text-emerald-400 mb-2 font-bold flex items-center gap-1">
                                                        <span>âœ“</span> LEARNED
                                                    </div>
                                                    <h4 className="text-sm font-bold text-platinum line-clamp-2">{card.title}</h4>
                                                    <p className="text-[10px] text-dim mt-2">{card.category}</p>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {unclearCards.length > 0 && (
                                    <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }}
                                        onClick={() => setSelectedRoadmap('weakness')}
                                        className="cursor-pointer bg-gradient-to-br from-rose-950/20 to-rose-900/5 border border-rose-500/30 rounded-sm p-6 transition-all duration-300 hover:border-rose-400 group relative overflow-hidden">
                                        <div className="absolute inset-0 bg-rose-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500" />
                                        <div className="relative z-10">
                                            <div className="flex items-center justify-between mb-4">
                                                <h3 className="text-xl font-bold text-rose-400 group-hover:text-rose-300 transition-colors">è‹¦æ‰‹å…‹æœ</h3>
                                                <span className="text-xs bg-rose-500/20 text-rose-400 px-2 py-1 rounded-sm font-bold">{unclearCards.length} Review</span>
                                            </div>
                                            <p className="text-sm text-platinum/60 mb-6">ã‚¹ãƒ¯ã‚¤ãƒ—ã§ã€Œã‚‚ã†ä¸€åº¦ã€ã¨ã—ãŸã‚«ãƒ¼ãƒ‰ã‚’å¾©ç¿’ã—ã¾ã—ã‚‡ã†ã€‚</p>
                                            <div className="grid grid-cols-2 gap-2">
                                                {unclearCards.slice(0, 4).map(id => {
                                                    const card = allCards.find(c => c.id === id);
                                                    return card ? (
                                                        <div key={id} className="text-[10px] text-platinum/40 bg-white/5 p-2 rounded-sm line-clamp-1">{card.title}</div>
                                                    ) : null;
                                                })}
                                                {unclearCards.length > 4 && <div className="text-[10px] text-rose-400 p-2">+ {unclearCards.length - 4} more</div>}
                                            </div>
                                        </div>
                                    </motion.div>
                                )}

                                {/* Course Bundles Section - Luxury Safe Style */}
                                <div className="md:col-span-2 mb-8">
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="text-gold text-sm">ğŸ”</span>
                                        <p className="text-[10px] text-gold/60 tracking-[0.3em] font-medium uppercase">Premium Bundles</p>
                                    </div>
                                    <div className="flex gap-4 flex-wrap">
                                        {Object.values(courseBundles).map((bundle, idx) => {
                                            const isPurchased = purchasedBundles?.includes(bundle.id);
                                            const bundleProgress = isPurchased
                                                ? Math.round((bundle.steps.flatMap(s => s.cards).filter(id => understoodCards.includes(id)).length / bundle.totalCards) * 100)
                                                : 0;
                                            const isComplete = bundleProgress === 100;

                                            return (
                                                <motion.div
                                                    key={bundle.id}
                                                    initial={{ opacity: 0, scale: 0.9 }}
                                                    animate={{ opacity: 1, scale: 1 }}
                                                    transition={{ delay: idx * 0.1, type: "spring", stiffness: 200 }}
                                                    onClick={() => setSelectedRoadmap(`bundle:${bundle.id}`)}
                                                    className="cursor-pointer group"
                                                >
                                                    {/* Luxury Safe/Vault Design */}
                                                    <div className="relative w-[120px] h-[120px]">
                                                        {/* 3D Shadow Layer */}
                                                        <div className="absolute inset-0 translate-x-1 translate-y-1 bg-black/40 rounded-lg blur-sm" />

                                                        {/* Safe Body - 3D Effect with multiple layers */}
                                                        <div className={`absolute inset-0 rounded-lg border-2 transition-all duration-300 ${isPurchased
                                                            ? 'bg-gradient-to-br from-emerald-900 via-emerald-800 to-emerald-950 border-emerald-500/50 group-hover:border-emerald-400 group-hover:shadow-[0_0_20px_rgba(52,211,153,0.3)]'
                                                            : 'bg-gradient-to-br from-stone-800 via-stone-700 to-stone-900 border-gold/30 group-hover:border-gold group-hover:shadow-[0_0_25px_rgba(218,165,32,0.4)]'
                                                            }`}>

                                                            {/* Inner bevel effect */}
                                                            <div className="absolute inset-[3px] rounded-md bg-gradient-to-br from-white/10 via-transparent to-black/20" />

                                                            {/* Safe door frame */}
                                                            <div className="absolute inset-[8px] rounded border border-white/10 bg-gradient-to-br from-black/20 to-transparent" />

                                                            {/* Lock dial / progress indicator */}
                                                            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                                                                {isPurchased ? (
                                                                    <div className="relative">
                                                                        {/* Circular progress */}
                                                                        <svg className="w-10 h-10 -rotate-90" viewBox="0 0 36 36">
                                                                            <circle cx="18" cy="18" r="14" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="2" />
                                                                            <circle cx="18" cy="18" r="14" fill="none" stroke="url(#progressGradient)" strokeWidth="2"
                                                                                strokeDasharray={`${bundleProgress * 0.88} 88`} strokeLinecap="round" />
                                                                            <defs>
                                                                                <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                                                                    <stop offset="0%" stopColor="#10b981" />
                                                                                    <stop offset="100%" stopColor="#34d399" />
                                                                                </linearGradient>
                                                                            </defs>
                                                                        </svg>
                                                                        <span className="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-emerald-400">
                                                                            {isComplete ? 'âœ“' : `${bundleProgress}%`}
                                                                        </span>
                                                                    </div>
                                                                ) : (
                                                                    <div className="w-10 h-10 rounded-full border-2 border-gold/50 bg-gradient-to-br from-gold/20 to-amber-900/30 flex items-center justify-center group-hover:border-gold group-hover:scale-110 transition-all">
                                                                        <span className="text-gold text-lg group-hover:rotate-12 transition-transform">ğŸ”’</span>
                                                                    </div>
                                                                )}
                                                            </div>

                                                            {/* Handle bolts decorations */}
                                                            <div className="absolute top-2 left-2 w-2 h-2 rounded-full bg-gradient-to-br from-white/20 to-transparent border border-white/10" />
                                                            <div className="absolute top-2 right-2 w-2 h-2 rounded-full bg-gradient-to-br from-white/20 to-transparent border border-white/10" />
                                                            <div className="absolute bottom-2 left-2 w-2 h-2 rounded-full bg-gradient-to-br from-white/20 to-transparent border border-white/10" />
                                                            <div className="absolute bottom-2 right-2 w-2 h-2 rounded-full bg-gradient-to-br from-white/20 to-transparent border border-white/10" />
                                                        </div>

                                                        {/* Hover glow effect */}
                                                        <div className={`absolute -inset-2 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity duration-500 blur-xl ${isPurchased ? 'bg-emerald-500/20' : 'bg-gold/20'
                                                            }`} />
                                                    </div>

                                                    {/* Label - Abbreviated title only */}
                                                    <div className="mt-3 text-center">
                                                        <p className={`text-xs font-bold tracking-wide transition-colors ${isPurchased
                                                            ? 'text-emerald-400 group-hover:text-emerald-300'
                                                            : 'text-platinum/70 group-hover:text-gold'
                                                            }`}>
                                                            {bundle.shortTitle || 'INDEXæŠ•è³‡'}
                                                        </p>
                                                        {!isPurchased && (
                                                            <p className="text-[10px] text-gold/60 mt-0.5">Â¥{bundle.price}</p>
                                                        )}
                                                        {isPurchased && !isComplete && (
                                                            <p className="text-[9px] text-emerald-400/60 mt-0.5">å­¦ç¿’ä¸­</p>
                                                        )}
                                                        {isComplete && (
                                                            <p className="text-[9px] text-emerald-400 mt-0.5">âœ“ å®Œäº†</p>
                                                        )}
                                                    </div>
                                                </motion.div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {Object.entries(assetRoadmaps).map(([assetName, roadmap], idx) => {
                                    const progress = getRoadmapProgress(roadmap);
                                    const isComplete = progress === 100;
                                    const isProRoadmap = roadmap.some(step => step.isPro);

                                    // Access control logic:
                                    // Free: Can view all roadmaps, but items are blurred and not clickable for non-basic roadmaps
                                    // Basic: Full access to NISA~ä¸å‹•ç”£ (non-Pro roadmaps), Pro roadmaps are locked
                                    // Pro: Full access to everything
                                    const isBasicOrAbove = userPlan === 'basic' || userPlan === 'pro';
                                    const isFree = userPlan === 'free';
                                    const isLocked = isProRoadmap && !isPro;
                                    const shouldBlurItems = isFree && !isComplete; // Free users see blurred items (except completed ones)

                                    return (
                                        <motion.div key={assetName} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: idx * 0.15 }}
                                            onClick={() => {
                                                if (isLocked) {
                                                    setViewMode('subscription');
                                                } else if (isFree && !isProRoadmap) {
                                                    // Free users can click non-Pro roadmaps but show upgrade prompt
                                                    setViewMode('subscription');
                                                } else {
                                                    setSelectedRoadmap(assetName);
                                                }
                                            }}
                                            className={`cursor-pointer bg-gradient-to-br from-ash/60 to-ash/20 border rounded-sm p-6 transition-all duration-300 hover:border-gold/30 group relative overflow-hidden ${isComplete ? 'border-emerald-500/30' : isProRoadmap ? 'border-amber-500/30' : 'border-white/5'}`}>
                                            {/* Subtle glow on hover */}
                                            <div className={`absolute inset-0 ${isProRoadmap ? 'bg-amber-500/5' : 'bg-gold/5'} opacity-0 group-hover:opacity-100 transition-opacity duration-500`} />
                                            {/* Pro Badge */}
                                            {isProRoadmap && (
                                                <div className="absolute top-3 right-3 flex items-center gap-1 bg-gradient-to-r from-amber-600 to-amber-400 text-black text-[10px] font-bold px-2 py-0.5 rounded-sm">
                                                    <span>ğŸ‘‘</span> PRO
                                                </div>
                                            )}
                                            {/* Basic unlock badge for non-Pro roadmaps when user is Free */}
                                            {!isProRoadmap && isFree && (
                                                <div className="absolute top-3 right-3 flex items-center gap-1 bg-stone border border-white/10 text-platinum text-[10px] font-bold px-2 py-0.5 rounded-sm">
                                                    BASIC
                                                </div>
                                            )}
                                            {/* Lock overlay for Pro roadmaps on non-Pro users */}
                                            {isLocked && (
                                                <div className="absolute inset-0 bg-obsidian/60 backdrop-blur-[1px] flex items-center justify-center z-20">
                                                    <div className="text-center">
                                                        <span className="text-2xl">ğŸ”’</span>
                                                        <p className="text-xs text-amber-400 mt-1 font-medium">Proã§è§£æ”¾</p>
                                                    </div>
                                                </div>
                                            )}
                                            <div className="relative z-10">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h3 className={`text-xl font-bold ${isProRoadmap ? 'text-amber-400' : 'text-platinum'} group-hover:text-gold transition-colors`}>{assetName}</h3>
                                                    {isComplete && <span className="text-xs bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded-sm font-bold">å­¦ç¿’å®Œäº†</span>}
                                                </div>
                                                <div className="flex items-center gap-4 mb-4">
                                                    <div className="flex-1 h-2 bg-stone rounded-full overflow-hidden">
                                                        <motion.div initial={{ width: 0 }} animate={{ width: `${progress}%` }} transition={{ duration: 1, delay: idx * 0.2 }}
                                                            className={`h-full ${isComplete ? 'bg-gradient-to-r from-emerald-600 to-emerald-400' : isProRoadmap ? 'bg-gradient-to-r from-amber-600 to-amber-400' : 'bg-gradient-to-r from-gold to-amber-500'}`} />
                                                    </div>
                                                    <span className="text-sm font-bold text-gold">{progress}%</span>
                                                </div>
                                                <div className={`space-y-2 ${shouldBlurItems && !isProRoadmap ? 'blur-[3px] select-none' : ''}`}>
                                                    {roadmap.map((step, i) => {
                                                        const userExp = userProfile?.experienceLevel || 1;
                                                        const isBasic = step.level < userExp;
                                                        const stepComplete = step.cards.every(id => understoodCards.includes(id));

                                                        return (
                                                            <div key={step.id} className={`flex items-center gap-3 text-sm ${isBasic ? 'opacity-50' : ''}`}>
                                                                <span className={`w-5 h-5 rounded-full flex items-center justify-center text-xs ${stepComplete ? 'bg-emerald-500 text-white' : isProRoadmap ? 'bg-amber-900/50 text-amber-400' : 'bg-stone text-dim'}`}>
                                                                    {stepComplete ? 'âœ“' : (isBasic ? '-' : i + 1)}
                                                                </span>
                                                                <span className={stepComplete ? 'text-platinum/60 line-through' : 'text-platinum/80'}>
                                                                    {step.title}
                                                                </span>
                                                                {isBasic && <span className="text-[10px] border border-white/20 px-1 rounded text-dim">å¾©ç¿’</span>}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                {/* Upgrade hint for Free users on non-Pro roadmaps */}
                                                {isFree && !isProRoadmap && (
                                                    <div className="mt-4 pt-3 border-t border-white/10 text-center">
                                                        <p className="text-xs text-dim">ğŸ”“ ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ã§é–‹æ”¾</p>
                                                    </div>
                                                )}
                                            </div>
                                        </motion.div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Roadmap Detail Modal */}
                        <AnimatePresence>
                            {selectedRoadmap && (
                                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="fixed inset-0 z-50 flex items-center justify-center bg-obsidian/95 backdrop-blur-lg p-4" onClick={() => setSelectedRoadmap(null)}>
                                    <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} onClick={e => e.stopPropagation()}
                                        className="w-full max-w-md glass-panel rounded-sm p-10 max-h-[90vh] overflow-y-auto custom-scrollbar">
                                        {/* Modal Header - Dynamic based on type */}
                                        {(() => {
                                            const isBundle = selectedRoadmap?.startsWith('bundle:');
                                            // Handle bundle:ID:confirm format
                                            const parts = selectedRoadmap?.split(':') || [];
                                            const bundleId = isBundle ? parts[1] : null;
                                            const isConfirming = isBundle && parts[2] === 'confirm';

                                            const bundle = isBundle ? courseBundles[bundleId] : null;
                                            const isPurchased = isBundle && purchasedBundles?.includes(bundleId);
                                            const displayTitle = isBundle ? bundle?.title : selectedRoadmap;

                                            // If bundle is not purchased, show purchase UI
                                            if (isBundle && bundle && !isPurchased) {
                                                if (isConfirming) {
                                                    return (
                                                        <div className="text-center py-10">
                                                            <div className="w-16 h-16 mx-auto mb-6 bg-gold/10 rounded-full flex items-center justify-center border border-gold/30">
                                                                <span className="text-3xl">ğŸ¤”</span>
                                                            </div>
                                                            <h3 className="text-xl font-bold text-platinum mb-2">è³¼å…¥ã®ç¢ºèª</h3>
                                                            <p className="text-sm text-platinum/70 mb-8">
                                                                ã€Œ{bundle.title}ã€<br />
                                                                ã‚’ <span className="text-gold font-bold">Â¥{bundle.price}</span> ã§è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ
                                                            </p>
                                                            <div className="flex gap-3">
                                                                <button
                                                                    onClick={() => setSelectedRoadmap(`bundle:${bundleId}`)}
                                                                    className="flex-1 py-3 bg-white/5 border border-white/10 text-platinum/70 hover:bg-white/10 rounded-sm transition-colors"
                                                                >
                                                                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                                                </button>
                                                                <button
                                                                    onClick={() => {
                                                                        onPurchaseBundle(bundleId);
                                                                        // Verify purchase usually updates state, so no need to clean up selectedRoadmap specifically if we want to stay, 
                                                                        // but usually onPurchase updates state and re-renders.
                                                                        // We should probably stay on the bundle page which will now show as purchased.
                                                                        setSelectedRoadmap(`bundle:${bundleId}`);
                                                                    }}
                                                                    className="flex-1 py-3 bg-gradient-to-r from-gold to-amber-500 text-black font-bold rounded-sm hover:from-amber-400 hover:to-gold transition-all shadow-lg shadow-gold/20"
                                                                >
                                                                    è³¼å…¥ã™ã‚‹
                                                                </button>
                                                            </div>
                                                        </div>
                                                    );
                                                }

                                                return (
                                                    <div className="text-center">
                                                        {/* Close button */}
                                                        <button onClick={() => setSelectedRoadmap(null)} className="absolute top-4 right-4 text-white/30 hover:text-white/60 transition-colors text-lg">âœ•</button>

                                                        {/* Safe icon */}
                                                        <div className="w-20 h-20 mx-auto mb-6 relative">
                                                            <div className="absolute inset-0 rounded-lg bg-gradient-to-br from-stone-700 via-stone-600 to-stone-800 border-2 border-gold/40 shadow-xl">
                                                                <div className="absolute inset-[4px] rounded bg-gradient-to-br from-white/10 to-black/20" />
                                                                <div className="absolute inset-0 flex items-center justify-center">
                                                                    <span className="text-3xl">{bundle.icon}</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Title */}
                                                        <h3 className="text-xl font-bold text-platinum mb-2">{bundle.title}</h3>
                                                        <p className="text-xs text-gold mb-6">{bundle.subtitle}</p>

                                                        {/* Description */}
                                                        <p className="text-sm text-platinum/70 leading-relaxed mb-6">{bundle.description}</p>

                                                        {/* Features */}
                                                        <div className="space-y-2 mb-8 text-left">
                                                            {bundle.features.map((feature, i) => (
                                                                <div key={i} className="flex items-center gap-3 text-sm text-platinum/80">
                                                                    <span className="text-gold">âœ“</span>
                                                                    <span>{feature}</span>
                                                                </div>
                                                            ))}
                                                        </div>

                                                        {/* Stats */}
                                                        <div className="flex justify-center gap-6 mb-8">
                                                            <div className="text-center">
                                                                <p className="text-2xl font-bold text-gold">{bundle.totalCards}</p>
                                                                <p className="text-[10px] text-dim">ã‚«ãƒ¼ãƒ‰</p>
                                                            </div>
                                                            <div className="text-center">
                                                                <p className="text-2xl font-bold text-platinum">{bundle.steps.length}</p>
                                                                <p className="text-[10px] text-dim">ã‚¹ãƒ†ãƒƒãƒ—</p>
                                                            </div>
                                                            <div className="text-center">
                                                                <p className="text-lg font-bold text-platinum">{bundle.estimatedTime}</p>
                                                                <p className="text-[10px] text-dim">å­¦ç¿’æ™‚é–“</p>
                                                            </div>
                                                        </div>

                                                        {/* Purchase Button */}
                                                        <button
                                                            onClick={() => setSelectedRoadmap(`bundle:${bundle.id}:confirm`)}
                                                            className="w-full py-4 bg-gradient-to-r from-gold to-amber-500 text-black font-bold text-lg rounded-sm hover:from-amber-400 hover:to-gold transition-all shadow-lg shadow-gold/30 mb-3"
                                                        >
                                                            ğŸ”“ Â¥{bundle.price}ã§è³¼å…¥ã™ã‚‹
                                                        </button>
                                                    </div>
                                                );
                                            }

                                            return (
                                                <>
                                                    <div className="flex justify-between items-start mb-8">
                                                        <div>
                                                            <h3 className="text-xl font-light text-platinum tracking-wide">{displayTitle}</h3>
                                                            {isBundle && bundle && (
                                                                <p className="text-xs text-dim mt-1">{bundle.subtitle}</p>
                                                            )}
                                                        </div>
                                                        <button onClick={() => setSelectedRoadmap(null)} className="text-white/30 hover:text-white/60 transition-colors">âœ•</button>
                                                    </div>
                                                    <div className="space-y-8">
                                                        {selectedRoadmap === 'weakness' ? (
                                                            <div className="space-y-4 max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar">
                                                                {unclearCards.map(id => {
                                                                    const card = allCards.find(c => c.id === id);
                                                                    if (!card) return null;
                                                                    return (
                                                                        <div key={id}
                                                                            onClick={() => {
                                                                                setActiveRoadmapFilter([id]);
                                                                                setCurrentCardIndex(0);
                                                                                setSelectedRoadmap(null);
                                                                                setViewMode('swipe');
                                                                            }}
                                                                            className="bg-white/5 border border-white/10 rounded-sm p-4 flex justify-between items-center gap-4 cursor-pointer hover:bg-white/10 transition-all group">
                                                                            <div>
                                                                                <p className="text-sm text-platinum/90 font-medium mb-1 group-hover:text-gold transition-colors">{card.title}</p>
                                                                                <p className="text-[10px] text-dim">{card.category}</p>
                                                                            </div>
                                                                            <button onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                setUnclearCards(unclearCards.filter(c => c !== id));
                                                                                setUnderstoodCards([...understoodCards, id]);
                                                                            }} className="px-3 py-1.5 bg-emerald-500/10 border border-emerald-500/30 text-emerald-400 text-[10px] font-bold rounded-sm hover:bg-emerald-500 hover:text-white transition-all">
                                                                                ç†è§£ã—ãŸ
                                                                            </button>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        ) : isBundle && bundle ? (
                                                            /* Bundle Course Steps */
                                                            bundle.steps.map((step, i) => {
                                                                const stepComplete = step.cards.every(id => understoodCards.includes(id));
                                                                const stepProgress = Math.round((step.cards.filter(id => understoodCards.includes(id)).length / step.cards.length) * 100);

                                                                return (
                                                                    <div key={step.id} className={`border-l-2 pl-6 ${stepComplete ? 'border-emerald-500' : 'border-emerald-500/30'}`}>
                                                                        <div className="flex items-center gap-2 mb-2">
                                                                            <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${stepComplete ? 'bg-emerald-500 text-white' : 'bg-emerald-500/10 text-emerald-400'}`}>
                                                                                {stepComplete ? 'âœ“' : i + 1}
                                                                            </span>
                                                                            <p className="text-[9px] text-gold/60 tracking-widest uppercase">{step.title}</p>
                                                                        </div>
                                                                        <p className="text-xs text-dim mb-2">{step.subtitle}</p>
                                                                        <p className="text-sm text-platinum/60 mb-4">{step.description}</p>
                                                                        {/* Step Progress */}
                                                                        <div className="flex items-center gap-3 mb-3">
                                                                            <div className="flex-1 h-1.5 bg-stone rounded-full overflow-hidden">
                                                                                <div className={`h-full ${stepComplete ? 'bg-emerald-500' : 'bg-emerald-500'}`} style={{ width: `${stepProgress}%` }} />
                                                                            </div>
                                                                            <span className="text-[10px] text-dim font-mono">{stepProgress}%</span>
                                                                        </div>
                                                                        <div className="flex flex-wrap gap-2">
                                                                            {step.cards.map(cardId => {
                                                                                const card = allCards.find(c => c.id === cardId);
                                                                                const done = understoodCards.includes(cardId);
                                                                                return card ? (
                                                                                    <span key={cardId}
                                                                                        onClick={() => {
                                                                                            setActiveRoadmapFilter([cardId]);
                                                                                            setCurrentCardIndex(0);
                                                                                            setSelectedRoadmap(null);
                                                                                            setViewMode('swipe');
                                                                                        }}
                                                                                        className={`cursor-pointer transition-colors hover:bg-gold/20 text-[10px] px-3 py-1 rounded-full border flex items-center gap-1 ${done ? 'border-emerald-500/30 text-emerald-400/80 bg-emerald-500/5' : 'border-white/5 text-white/30'}`}>
                                                                                        {done && <span>âœ“</span>}
                                                                                        {card.title}
                                                                                    </span>
                                                                                ) : null;
                                                                            })}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })
                                                        ) : (
                                                            /* Asset Roadmap Steps */
                                                            assetRoadmaps[selectedRoadmap]?.map((step, i) => {
                                                                const userExp = userProfile?.experienceLevel || 1;
                                                                const isBasic = step.level < userExp;

                                                                return (
                                                                    <div key={step.id} className={`border-l pl-6 ${isBasic ? 'border-white/5 opacity-60' : 'border-white/10'}`}>
                                                                        <div className="flex items-center gap-2 mb-2">
                                                                            <p className="text-[9px] text-gold/60 tracking-widest uppercase">Step {i + 1}</p>
                                                                            {isBasic && <span className="text-[9px] border border-white/20 px-1.5 py-0.5 rounded text-dim">BASIC / REVIEW</span>}
                                                                        </div>
                                                                        <p className="text-sm text-platinum/80 mb-4">{step.title}</p>
                                                                        <div className="flex flex-wrap gap-2">
                                                                            {step.cards.map(cardId => {
                                                                                const card = allCards.find(c => c.id === cardId);
                                                                                const done = understoodCards.includes(cardId);
                                                                                return card ? (
                                                                                    <span key={cardId}
                                                                                        onClick={() => {
                                                                                            setActiveRoadmapFilter([cardId]);
                                                                                            setCurrentCardIndex(0);
                                                                                            setSelectedRoadmap(null);
                                                                                            setViewMode('swipe');
                                                                                        }}
                                                                                        className={`cursor-pointer transition-colors hover:bg-gold/20 text-[10px] px-3 py-1 rounded-full border flex items-center gap-1 ${done ? 'border-emerald-500/30 text-emerald-400/80 bg-emerald-500/5' : 'border-white/5 text-white/30'}`}>
                                                                                        {done && <span>âœ“</span>}
                                                                                        {card.title}
                                                                                    </span>
                                                                                ) : null;
                                                                            })}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })
                                                        )}
                                                    </div>
                                                    {/* Learning Button */}
                                                    <div className="mt-8 pt-6 border-t border-white/10">
                                                        {selectedRoadmap === 'weakness' ? (
                                                            <button onClick={() => {
                                                                setActiveRoadmapFilter(unclearCards);
                                                                setCurrentCardIndex(0);
                                                                setSelectedRoadmap(null);
                                                                setViewMode('swipe');
                                                            }} className="w-full py-3 bg-rose-500 text-white font-bold rounded-sm hover:bg-rose-400 transition-colors">
                                                                ğŸ”¥ è‹¦æ‰‹ãªã‚«ãƒ¼ãƒ‰ã‚’ç·å¾©ç¿’
                                                            </button>
                                                        ) : isBundle && bundle ? (
                                                            <button onClick={() => {
                                                                const bundleCards = bundle.steps.flatMap(step => step.cards);
                                                                setActiveRoadmapFilter(bundleCards);
                                                                const firstUnreadIndex = bundleCards.findIndex(id => !understoodCards.includes(id));
                                                                setCurrentCardIndex(firstUnreadIndex !== -1 ? firstUnreadIndex : 0);
                                                                setSelectedRoadmap(null);
                                                                setViewMode('swipe');
                                                            }} className="w-full py-3 bg-gradient-to-r from-emerald-600 to-teal-500 text-white font-bold rounded-sm hover:from-emerald-500 hover:to-teal-400 transition-all shadow-lg shadow-emerald-900/30">
                                                                ğŸ“ˆ ã“ã®ã‚³ãƒ¼ã‚¹ã‚’å­¦ç¿’ã™ã‚‹
                                                            </button>
                                                        ) : (
                                                            userPlan === 'pro' ? (
                                                                <button onClick={() => {
                                                                    const roadmapCards = assetRoadmaps[selectedRoadmap].flatMap(step => step.cards);
                                                                    setActiveRoadmapFilter(roadmapCards);
                                                                    const firstUnreadIndex = roadmapCards.findIndex(id => !understoodCards.includes(id));
                                                                    setCurrentCardIndex(firstUnreadIndex !== -1 ? firstUnreadIndex : 0);
                                                                    setSelectedRoadmap(null);
                                                                    setViewMode('swipe');
                                                                }} className="w-full py-3 bg-gold text-black font-bold rounded-sm hover:bg-amber-400 transition-colors">
                                                                    ğŸ´ ã“ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚’å­¦ç¿’
                                                                </button>
                                                            ) : (
                                                                <div className="text-center">
                                                                    <p className="text-xs text-dim mb-3">ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—åˆ¥ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ã¯Proãƒ—ãƒ©ãƒ³é™å®š</p>
                                                                    <button onClick={() => setViewMode('subscription')} className="w-full py-3 border border-gold/50 text-gold font-bold rounded-sm hover:bg-gold/10 transition-colors">
                                                                        ğŸ”“ Proã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                                                                    </button>
                                                                </div>
                                                            )
                                                        )}
                                                    </div>
                                                </>
                                            );
                                        })()}
                                    </motion.div>
                                </motion.div>
                            )}
                        </AnimatePresence>
                    </div>
                );
            }

            // Swipe Mode (Tinder-style) - LUXURY EDITION
            return (
                <div className="min-h-screen bg-obsidian pt-24 pb-20 px-4 sm:px-8 relative overflow-hidden">
                    {/* Dynamic Background Lighting */}
                    <div className="fixed inset-0 pointer-events-none overflow-hidden">
                        <div className="absolute -top-[10%] left-1/3 w-[700px] h-[700px] bg-gold/5 rounded-full blur-[150px] opacity-25" />
                        <div className="absolute bottom-[10%] -right-[10%] w-[500px] h-[500px] bg-amber-500/5 rounded-full blur-[120px] opacity-20" />
                    </div>

                    <div className="max-w-xl mx-auto relative z-10">
                        {/* Unified Header - Asset Gallery Style */}
                        <div className="mb-12">
                            <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }}>
                                <p className="text-dim text-xs tracking-[0.4em] mb-4 text-gold">TODAY'S LEARNING</p>
                                <h2 className="text-4xl md:text-5xl font-black tracking-tighter text-platinum mb-4">ã‚¹ãƒ¯ã‚¤ãƒ—ã§<span className="text-gold-gradient">å­¦ã¶</span></h2>
                                <div className="flex items-center gap-4">
                                    <p className="text-dim text-sm">ç†è§£åº¦ã‚’ãƒã‚§ãƒƒã‚¯</p>
                                    <button onClick={() => setViewMode('roadmap')}
                                        className="group relative overflow-hidden bg-gold/10 hover:bg-gold/20 text-gold text-xs font-bold px-4 py-2 rounded-full border border-gold/40 transition-all duration-300 hover:shadow-[0_0_15px_rgba(218,165,32,0.3)] flex items-center gap-2">
                                        <span className="relative z-10">ğŸ“ å­¦ç¿’ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚’è¦‹ã‚‹</span>
                                        {userPlan === 'pro' && <span className="bg-gradient-to-r from-amber-600 to-amber-400 text-black text-[9px] px-1.5 py-0.5 rounded-sm font-black relative z-10">PRO</span>}
                                        <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700" />
                                    </button>
                                </div>
                            </motion.div>
                        </div>

                        {/* Roadmap Mode Indicator - Always show if active */}
                        {activeRoadmapFilter && (
                            <motion.div initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }}
                                className="bg-gold/10 border border-gold/30 rounded-sm p-3 mb-6 flex items-center justify-between">
                                <span className="text-xs text-gold font-bold">ğŸ“ ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰</span>
                                <button onClick={() => { setActiveRoadmapFilter(null); setCurrentCardIndex(0); }} className="text-xs text-dim hover:text-platinum transition-colors">Ã— çµ‚äº†</button>
                            </motion.div>
                        )}

                        {/* Daily Progress - Only show if goal not reached */}
                        {dailyCompleted < dailyGoal && (
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.2 }}
                                className="bg-gradient-to-r from-gold/10 to-amber-500/5 border border-gold/20 rounded-sm p-5 mb-10">
                                <div className="flex items-center justify-between mb-3">
                                    <span className="text-sm text-platinum font-bold">ä»Šæ—¥ã®ç›®æ¨™</span>
                                    <span className="text-gold font-bold">{dailyCompleted}/{dailyGoal}</span>
                                </div>
                                <div className="flex gap-2">
                                    {[...Array(dailyGoal)].map((_, i) => (
                                        <motion.div key={i} initial={{ scale: 0 }} animate={{ scale: 1 }} transition={{ delay: 0.3 + i * 0.1 }}
                                            className={`flex-1 h-2 rounded-full ${i < dailyCompleted ? 'bg-gold' : 'bg-stone'}`} />
                                    ))}
                                </div>
                            </motion.div>
                        )}

                        {/* Swipe Card */}
                        {currentCard ? (
                            <div className="relative h-[360px] sm:h-[420px] md:h-[480px] mb-10">
                                <AnimatePresence mode="wait">
                                    <motion.div
                                        key={currentCard.id}
                                        ref={cardRef}
                                        drag="x"
                                        dragConstraints={{ left: -1000, right: 1000 }}
                                        dragElastic={0.7}
                                        dragTransition={{ bounceStiffness: 300, bounceDamping: 20 }}
                                        onDragEnd={handleDrag}
                                        initial={{ opacity: 0, y: 30, scale: 0.95 }}
                                        animate={{
                                            opacity: 1,
                                            y: 0,
                                            scale: 1,
                                            x: swipeDir === 'right' ? 400 : swipeDir === 'left' ? -400 : 0,
                                            rotate: swipeDir === 'right' ? 12 : swipeDir === 'left' ? -12 : 0
                                        }}
                                        exit={{ opacity: 0, scale: 0.9, y: -20 }}
                                        transition={{
                                            type: 'spring',
                                            stiffness: 260,
                                            damping: 25,
                                            mass: 0.8,
                                            opacity: { duration: 0.3 },
                                            exit: { duration: 0.4, ease: [0.22, 1, 0.36, 1] }
                                        }}
                                        className="absolute inset-0 glass-panel rounded-sm p-6 sm:p-10 cursor-grab active:cursor-grabbing touch-none luxury-glow"
                                    >
                                        {/* Swipe Indicators - More subtle */}
                                        <motion.div
                                            className="absolute top-8 left-8 pointer-events-none"
                                            animate={{ opacity: swipeDir === 'left' ? 0.8 : 0 }}
                                        >
                                            <span className="text-rose-400/80 text-sm font-medium border border-rose-400/40 rounded-full px-4 py-2">ã‚‚ã†ä¸€åº¦</span>
                                        </motion.div>
                                        <motion.div
                                            className="absolute top-8 right-8 pointer-events-none"
                                            animate={{ opacity: swipeDir === 'right' ? 0.8 : 0 }}
                                        >
                                            <span className="text-emerald-400/80 text-sm font-medium border border-emerald-400/40 rounded-full px-4 py-2">ç†è§£ã—ãŸ</span>
                                        </motion.div>

                                        {/* Card Content */}
                                        <div className="h-full flex flex-col pt-8">
                                            <div className="flex items-start justify-between mb-8">
                                                <span className="text-4xl opacity-80">{currentCard.icon}</span>
                                                <span className="text-[10px] text-white/30 tracking-widest">{levelLabels[currentCard.level]}</span>
                                            </div>
                                            <h3 className="text-xl font-medium text-platinum mb-4 tracking-wide">{currentCard.title}</h3>
                                            {/* Chart Pattern Visualization for Pro Cards */}
                                            {currentCard.pattern && (
                                                <div className="mb-4 bg-white/5 rounded-sm p-3 border border-gold/10">
                                                    <ChartPatternSVG pattern={currentCard.pattern} />
                                                </div>
                                            )}
                                            <p className="text-sm text-white/50 leading-[1.8] flex-1">{currentCard.content}</p>
                                            {currentCard.terms.length > 0 && (
                                                <div className="mt-6 pt-6 border-t border-white/5">
                                                    <div className="flex flex-wrap gap-2">
                                                        {currentCard.terms.map((t, i) => (
                                                            <span key={i} className="text-[10px] text-gold/60 border border-white/5 px-3 py-1 rounded-full">{t.word}</span>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </motion.div>
                                </AnimatePresence>
                            </div>
                        ) : (
                            <div className="h-[360px] sm:h-[420px] md:h-[480px] flex items-center justify-center glass-panel rounded-sm">
                                <div className="text-center">
                                    <p className="text-white/30 text-sm mb-4">
                                        {activeRoadmapFilter ? "ã“ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã¯å®Œäº†ã§ã™" : "ã™ã¹ã¦å®Œäº†ã—ã¾ã—ãŸ"}
                                    </p>
                                    {activeRoadmapFilter && (
                                        <button onClick={() => { setActiveRoadmapFilter(null); setViewMode('roadmap'); }} className="px-6 py-3 bg-gold text-black font-bold rounded-sm">
                                            ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã«æˆ»ã‚‹
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Swipe Buttons - Enhanced Luxury */}
                        {currentCard && (
                            <div className="flex justify-center gap-20">
                                <motion.button
                                    onClick={() => handleSwipe('left')}
                                    whileHover={{ scale: 1.15, boxShadow: '0 0 30px rgba(244, 63, 94, 0.3)' }}
                                    whileTap={{ scale: 0.95 }}
                                    className="w-16 h-16 rounded-full border-2 border-white/10 text-white/50 flex items-center justify-center text-xl hover:border-rose-400/50 hover:text-rose-400 transition-colors duration-300 bg-gradient-to-br from-rose-500/5 to-transparent backdrop-blur-sm"
                                >âœ•</motion.button>
                                <motion.button
                                    onClick={() => handleSwipe('right')}
                                    whileHover={{ scale: 1.15, boxShadow: '0 0 30px rgba(52, 211, 153, 0.3)' }}
                                    whileTap={{ scale: 0.95 }}
                                    className="w-16 h-16 rounded-full border-2 border-white/10 text-white/50 flex items-center justify-center text-xl hover:border-emerald-400/50 hover:text-emerald-400 transition-colors duration-300 bg-gradient-to-br from-emerald-500/5 to-transparent backdrop-blur-sm"
                                >âœ“</motion.button>
                            </div>
                        )}

                        {/* Minimal Stats */}
                        <div className="mt-12 flex justify-center gap-12">
                            <div className="text-center">
                                <p className="text-xl font-light text-platinum/80">{understoodCards.length}</p>
                                <p className="text-[9px] text-white/20 tracking-widest uppercase mt-1">Learned</p>
                            </div>
                            <div className="text-center">
                                <p className="text-xl font-light text-white/40">{unclearCards.length}</p>
                                <p className="text-[9px] text-white/20 tracking-widest uppercase mt-1">Review</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================
        // ASSET GALLERY WITH DETAIL MODALS
        // ============================================


        const LuxuryCard = ({ asset, index, onSelect }) => {
            const [isHovered, setIsHovered] = useState(false);
            const riskColors = { 1: 'bg-emerald-500', 2: 'bg-emerald-400', 3: 'bg-amber-500', 4: 'bg-orange-500', 5: 'bg-rose-500' };
            return (
                <motion.div onClick={() => onSelect(asset)} className="relative flex-shrink-0 w-[260px] h-[420px] sm:w-[300px] sm:h-[500px] md:w-[380px] md:h-[580px] snap-center group cursor-pointer" initial={{ opacity: 0, x: 50 }} whileInView={{ opacity: 1, x: 0 }} viewport={{ once: true }} transition={{ duration: 0.8, delay: index * 0.1 }} onHoverStart={() => setIsHovered(true)} onHoverEnd={() => setIsHovered(false)}>
                    <div className="absolute inset-0 overflow-hidden rounded-sm border border-white/10 bg-ash custom-shadow transition-all duration-500 hover:border-gold/50">
                        <motion.div className="absolute inset-0 z-0 bg-obsidian" animate={{ scale: isHovered ? 1.05 : 1 }} transition={{ duration: 0.8 }}>
                            <div className="absolute inset-0 z-10 grain opacity-40 mix-blend-overlay pointer-events-none" />
                            <div className="absolute inset-0 bg-gradient-to-t from-obsidian via-transparent to-transparent z-20 opacity-90" />
                            <img src={asset.image} alt="" className="w-full h-full object-cover filter grayscale-[30%] contrast-125 opacity-60" />
                        </motion.div>
                        <div className="absolute inset-0 z-40 p-8 flex flex-col justify-between">
                            <div className="flex justify-between items-start">
                                <span className="text-xs font-bold tracking-[0.2em] text-gold/80 border border-gold/20 px-2 py-1">0{index + 1}</span>
                                <div className="flex items-center gap-1">
                                    <span className="text-[10px] text-dim">RISK</span>
                                    {[1, 2, 3, 4, 5].map(l => <div key={l} className={`w-2 h-2 rounded-full ${l <= asset.riskLevel ? riskColors[asset.riskLevel] : 'bg-stone'}`} />)}
                                </div>
                            </div>
                            <div>
                                <h3 className="text-5xl font-black tracking-tighter text-platinum mb-2">{asset.name}</h3>
                                <p className="text-sm font-bold tracking-widest text-gold mb-4 border-b border-gold/30 pb-2 inline-block">{asset.nameJp}</p>
                                <p className="text-platinum/80 text-sm leading-relaxed mb-4">{asset.tagline}</p>
                                <motion.div className="space-y-2 overflow-hidden" initial={{ height: 0, opacity: 0 }} animate={{ height: isHovered ? 'auto' : 0, opacity: isHovered ? 1 : 0 }} transition={{ duration: 0.4 }}>
                                    {asset.knowledge.map((item, i) => (<div key={i} className="flex items-start gap-2 text-xs text-platinum/70 bg-obsidian/60 p-2 rounded-sm border border-white/5"><span className="text-gold">â—</span>{item}</div>))}
                                    <div className="text-center pt-2 text-gold text-sm font-bold">ã‚¿ãƒƒãƒ—ã§è©³ç´°ã‚’è¦‹ã‚‹ â†’</div>
                                </motion.div>
                            </div>
                        </div>
                    </div>
                </motion.div>
            );
        };

        const AssetGallery = ({ onNavigate, preSelectedAssetId, onClearPreSelection }) => {
            const [selectedAsset, setSelectedAsset] = useState(null);

            useEffect(() => {
                if (preSelectedAssetId) {
                    const asset = assetDetailData.find(a => a.id === preSelectedAssetId);
                    if (asset) setSelectedAsset(asset);
                    if (onClearPreSelection) onClearPreSelection();
                }
            }, [preSelectedAssetId, onClearPreSelection]);
            return (
                <div className="min-h-screen bg-obsidian relative flex flex-col justify-center py-20 pb-32">
                    <div className="fixed inset-0 pointer-events-none overflow-hidden">
                        <div className="absolute -top-[20%] -right-[10%] w-[1000px] h-[1000px] bg-gold/5 rounded-full blur-[150px] opacity-20" />
                        <div className="absolute bottom-[-10%] left-[-10%] w-[800px] h-[800px] bg-platinum/5 rounded-full blur-[120px] opacity-10" />
                    </div>
                    <div className="relative z-10 w-full max-w-[1400px] mx-auto">
                        <div className="px-8 md:px-16 mb-12">
                            <motion.div initial={{ opacity: 0, x: -20 }} whileInView={{ opacity: 1, x: 0 }} viewport={{ once: true }}>
                                <p className="text-dim text-xs tracking-[0.4em] mb-4 text-gold">ASSET GALLERY</p>
                                <h2 className="text-4xl md:text-6xl font-black tracking-tighter text-platinum mb-6">æŠ•è³‡å…ˆã‚’<span className="text-gold-gradient">é¸ã¶</span></h2>
                                <p className="text-dim max-w-xl text-sm leading-loose">ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è©³ç´°ã‚’ç¢ºèªã€‚åˆå¿ƒè€…å‘ã‘ã®è§£èª¬ä»˜ãã§ã™ã€‚</p>
                            </motion.div>
                        </div>
                        <div className="overflow-x-auto pb-16 px-4 sm:px-8 md:px-16 scrollbar-hide flex gap-4 sm:gap-8 snap-x snap-mandatory" style={{ scrollbarWidth: 'none' }}>
                            {assetDetailData.map((asset, i) => <LuxuryCard key={asset.id} asset={asset} index={i} onSelect={setSelectedAsset} />)}
                        </div>
                    </div>

                    {/* Footer Disclaimer */}
                    <footer className="w-full py-16 px-8 border-t border-white/5 bg-obsidian text-center mt-20 relative z-10">
                        <div className="max-w-4xl mx-auto space-y-6">
                            <h3 className="text-gold text-lg font-bold tracking-widest uppercase mb-4">INVISION</h3>
                            <p className="text-xs text-dim leading-loose">
                                INVISIONã¯ã€æŠ•è³‡ã‚’å§‹ã‚ã‚‹å‰ã«ã€Œè‡ªåˆ†ã‚’çŸ¥ã‚‹ã€ãŸã‚ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚<br />
                                ã“ã®ã‚µã‚¤ãƒˆã¯å­¦ç¿’ãƒ»è‡ªå·±åˆ†æã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€ç‰¹å®šã®å•†å“ã®è³¼å…¥ã‚’å‹§ã‚ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br />
                                è¨ºæ–­ã‚„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœã¯ã‚ãã¾ã§å‚è€ƒæƒ…å ±ã§ã‚ã‚Šã€å°†æ¥ã®æˆæœã‚’ç´„æŸã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br />
                                æŠ•è³‡ã®æœ€çµ‚åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ã¨ãªã‚Šã¾ã™ã€‚å…ƒæœ¬ãŒæ¸›ã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã“ã¨ã‚’ã”ç†è§£ãã ã•ã„ã€‚
                            </p>
                            <p className="text-[10px] text-white/20 mt-8">
                                Â© 2024 INVISION. All Rights Reserved. Used for demonstration purposes.
                                <br />
                                <button onClick={() => { sessionStorage.removeItem('visited'); window.location.reload(); }} className="mt-2 text-rose-500 hover:text-rose-400 underline">
                                    [Debug] Reset First Visit Status
                                </button>
                            </p>
                        </div>
                    </footer>

                    {/* Asset Detail Modal */}
                    <AnimatePresence>
                        {selectedAsset && <AssetDetailModal asset={selectedAsset} onClose={() => setSelectedAsset(null)} />}
                    </AnimatePresence>
                </div>
            );
        };

        const PortfolioCreator = ({ userProfile, onNavigate, userPlan, onUpgrade, portfolioSettings, onSave }) => {
            const [principal, setPrincipal] = useState(portfolioSettings?.principal || 1000000);
            const [monthly, setMonthly] = useState(portfolioSettings?.monthly || 30000);
            const [allocation, setAllocation] = useState(portfolioSettings?.allocation || userProfile?.allocation || { safe: 30, balanced: 40, growth: 30 });
            const [isSaved, setIsSaved] = useState(false);

            // Stable auto-balance logic with clamping and proper redistribution
            const updateAllocation = (type, rawValue) => {
                // Clamp the input value to 0-100
                const value = Math.max(0, Math.min(100, rawValue));
                const diff = value - allocation[type];
                if (diff === 0) return;

                const otherTypes = Object.keys(allocation).filter(k => k !== type);
                const othersTotal = otherTypes.reduce((sum, k) => sum + allocation[k], 0);

                let newAlloc = { ...allocation, [type]: value };

                if (othersTotal === 0) {
                    // If others are all 0, distribute remaining equally
                    const remaining = 100 - value;
                    otherTypes.forEach(k => newAlloc[k] = remaining / otherTypes.length);
                } else {
                    // Proportional redistribution
                    const remaining = 100 - value;
                    otherTypes.forEach(k => {
                        const ratio = allocation[k] / othersTotal;
                        newAlloc[k] = remaining * ratio;
                    });
                }

                // Clamp all values to 0-100
                Object.keys(newAlloc).forEach(k => {
                    newAlloc[k] = Math.max(0, Math.min(100, newAlloc[k]));
                });

                // Round for display
                Object.keys(newAlloc).forEach(k => newAlloc[k] = Math.round(newAlloc[k]));

                // Ensure sum is exactly 100 after rounding
                const roundedSum = Object.values(newAlloc).reduce((a, b) => a + b, 0);
                if (roundedSum !== 100) {
                    // Adjust the largest 'other' value to compensate
                    const maxOther = otherTypes.reduce((max, k) => newAlloc[k] > newAlloc[max] ? k : max, otherTypes[0]);
                    newAlloc[maxOther] += (100 - roundedSum);
                    // Final clamp
                    newAlloc[maxOther] = Math.max(0, Math.min(100, newAlloc[maxOther]));
                }

                setAllocation(newAlloc);
                setIsSaved(false);
            };

            const handleSave = () => {
                onSave({ principal, monthly, allocation });
                setIsSaved(true);
                setTimeout(() => setIsSaved(false), 3000);
            };

            useEffect(() => {
                setIsSaved(false);
            }, [principal, monthly]);

            const projection = useMemo(() => {
                // More realistic return assumptions: Safe 0.5% (Deposits/Bonds), Balanced 4% (Global/Balance), Growth 7% (Stocks)
                // Inflation is not adjusted here for simplicity, but nominal returns are set more conservatively.
                const r = ((allocation.safe * 0.5) + (allocation.balanced * 4.0) + (allocation.growth * 7.0)) / 100; // Weighted Return
                const data = [];
                let currentAmount = principal;
                for (let i = 0; i <= 20; i++) {
                    data.push({ year: i, amount: Math.round(currentAmount) });
                    currentAmount = currentAmount * (1 + r / 100) + (monthly * 12);
                }
                return data;
            }, [allocation, principal, monthly]);

            return (
                <div className="min-h-screen bg-obsidian pt-28 pb-32 px-4 sm:px-8 relative overflow-hidden">
                    {/* Atmospheric Background - Matching AssetGallery */}
                    <div className="fixed inset-0 pointer-events-none overflow-hidden">
                        <div className="absolute -top-[20%] -right-[10%] w-[1000px] h-[1000px] bg-gold/5 rounded-full blur-[150px] opacity-20" />
                        <div className="absolute bottom-[-10%] left-[-10%] w-[800px] h-[800px] bg-platinum/5 rounded-full blur-[120px] opacity-10" />
                    </div>

                    <div className="max-w-6xl mx-auto relative z-10">
                        <div className="mb-16">
                            <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }}>
                                <div className="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-6">
                                    <h2 className="text-4xl md:text-6xl font-black tracking-tighter text-platinum">æœªæ¥ã‚’<span className="text-gold-gradient">è¨­è¨ˆ</span>ã™ã‚‹</h2>
                                    <button
                                        onClick={handleSave}
                                        className={`px-4 py-2 rounded-sm font-bold text-xs transition-all duration-300 flex items-center gap-2 border ${isSaved
                                            ? 'bg-white/10 border-white/20 text-platinum'
                                            : 'bg-white/5 text-dim border-white/10 hover:bg-white/10 hover:text-platinum'
                                            }`}
                                    >
                                        {isSaved ? (
                                            <>
                                                <span className="text-sm">âœ“</span> ä¿å­˜æ¸ˆã¿
                                            </>
                                        ) : (
                                            "ä¿å­˜"
                                        )}
                                    </button>
                                </div>
                                <p className="text-dim text-sm max-w-xl leading-loose">è‡ªå·±åˆ†æã¨æŠ•è³‡çŸ¥è­˜ã®å­¦ç¿’ã‚’ã‚‚ã¨ã«ã€è³‡ç”£é…åˆ†ã®è€ƒãˆæ–¹ã‚’å­¦ã³ã¾ã™ã€‚<br />â€» ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯å­¦ç¿’ç›®çš„ã®å‚è€ƒå€¤ã§ã‚ã‚Šã€å®Ÿéš›ã®é‹ç”¨çµæœã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                            </motion.div>
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-16">
                            {/* Controls Panel */}
                            <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.1 }} className="space-y-8">
                                {/* Compact Investment Inputs Row */}
                                <div className="bg-gradient-to-br from-ash/80 to-ash/40 backdrop-blur-sm border border-white/5 rounded-sm p-6 custom-shadow hover:border-gold/30 transition-all duration-500 group">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                        {/* Initial Investment */}
                                        <div>
                                            <label className="block text-[9px] text-gold uppercase tracking-[0.15em] mb-2 font-bold">
                                                åˆæœŸæŠ•è³‡é¡
                                            </label>
                                            <div className="flex items-center gap-2">
                                                <span className="text-lg text-gold font-serif italic">Â¥</span>
                                                <input type="number" value={principal} onChange={e => setPrincipal(Number(e.target.value))}
                                                    className="w-full bg-transparent border-b border-white/10 text-2xl font-serif text-platinum placeholder-dim focus:border-gold outline-none transition-all tracking-wider text-right py-1" />
                                            </div>
                                        </div>
                                        {/* Monthly Contribution */}
                                        <div>
                                            <label className="block text-[9px] text-gold uppercase tracking-[0.15em] mb-2 font-bold">
                                                æ¯æœˆã®ç©ç«‹é¡
                                            </label>
                                            <div className="flex items-center gap-2">
                                                <span className="text-lg text-gold font-serif italic">Â¥</span>
                                                <input type="number" value={monthly} onChange={e => setMonthly(Number(e.target.value))}
                                                    className="w-full bg-transparent border-b border-white/10 text-2xl font-serif text-platinum placeholder-dim focus:border-gold outline-none transition-all tracking-wider text-right py-1" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gradient-to-br from-ash/80 to-ash/40 backdrop-blur-sm border border-white/5 rounded-sm p-10 space-y-10 custom-shadow">
                                    <div className="flex justify-between items-end mb-6">
                                        <label className="text-[10px] text-gold uppercase tracking-[0.2em] font-bold">ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</label>
                                        <span className="text-xs text-dim">ALLOCATION</span>
                                    </div>

                                    {/* Safe */}
                                    <div className="group">
                                        <div className="flex justify-between mb-3 border-l-2 border-emerald-500 pl-3 transition-all group-hover:border-l-4">
                                            <span className="text-platinum font-bold text-lg">å®ˆã‚Š</span>
                                            <span className="text-emerald-400 font-mono text-xl">{allocation.safe}%</span>
                                        </div>
                                        <input type="range" min="0" max="100" value={allocation.safe} onChange={(e) => updateAllocation('safe', Number(e.target.value))}
                                            className="w-full h-1 bg-stone/50 rounded-lg appearance-none cursor-pointer accent-emerald-500 hover:h-2 transition-all" />
                                        <p className="text-xs text-dim mt-2 pl-3">å›½å‚µãƒ»ç¾é‡‘ãªã©ã€‚ä½ãƒªã‚¹ã‚¯ã§ç€å®Ÿãªé‹ç”¨ã€‚</p>
                                    </div>

                                    {/* Balanced */}
                                    <div className="group">
                                        <div className="flex justify-between mb-3 border-l-2 border-amber-500 pl-3 transition-all group-hover:border-l-4">
                                            <span className="text-platinum font-bold text-lg">ãƒãƒ©ãƒ³ã‚¹</span>
                                            <span className="text-amber-500 font-mono text-xl">{allocation.balanced}%</span>
                                        </div>
                                        <input type="range" min="0" max="100" value={allocation.balanced} onChange={(e) => updateAllocation('balanced', Number(e.target.value))}
                                            className="w-full h-1 bg-stone/50 rounded-lg appearance-none cursor-pointer accent-amber-500 hover:h-2 transition-all" />
                                        <p className="text-xs text-dim mt-2 pl-3">æŠ•è³‡ä¿¡è¨—ãƒ»REITãªã©ã€‚æˆé•·ã¨å®‰å®šã®ãƒãƒ©ãƒ³ã‚¹ã€‚</p>
                                    </div>

                                    {/* Growth */}
                                    <div className="group">
                                        <div className="flex justify-between mb-3 border-l-2 border-rose-500 pl-3 transition-all group-hover:border-l-4">
                                            <span className="text-platinum font-bold text-lg">æ”»ã‚</span>
                                            <span className="text-rose-500 font-mono text-xl">{allocation.growth}%</span>
                                        </div>
                                        <input type="range" min="0" max="100" value={allocation.growth} onChange={(e) => updateAllocation('growth', Number(e.target.value))}
                                            className="w-full h-1 bg-stone/50 rounded-lg appearance-none cursor-pointer accent-rose-500 hover:h-2 transition-all" />
                                        <p className="text-xs text-dim mt-2 pl-3">æ ªå¼ãƒ»ä»®æƒ³é€šè²¨ãªã©ã€‚é«˜ã„ãƒªã‚¿ãƒ¼ãƒ³ã‚’ç‹™ã†ã€‚</p>
                                    </div>
                                </div>
                            </motion.div>

                            {/* Visualization */}
                            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="space-y-8">
                                {/* Pie Chart */}
                                <div className="bg-gradient-to-br from-ash/80 to-ash/40 backdrop-blur-sm border border-white/5 rounded-sm p-8 flex flex-col items-center justify-center relative min-h-[400px] custom-shadow hover:border-gold/30 transition-all duration-500 group">
                                    <div className="relative w-64 h-64 rounded-full custom-shadow"
                                        style={{
                                            background: `conic-gradient(
                                                #10b981 0% ${allocation.safe}%, 
                                                #f59e0b ${allocation.safe}% ${allocation.safe + allocation.balanced}%, 
                                                #f43f5e ${allocation.safe + allocation.balanced}% 100%
                                            )`
                                        }}>
                                        <div className="absolute inset-4 bg-ash rounded-full flex flex-col items-center justify-center">
                                            <span className="text-dim text-xs tracking-widest uppercase">PORTFOLIO</span>
                                            <span className="text-3xl font-black text-platinum">100%</span>
                                        </div>
                                    </div>

                                    {/* Legend */}
                                    <div className="flex gap-8 mt-8">
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-emerald-500 rounded-full" /><span className="text-sm text-platinum">å®ˆã‚Š</span></div>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-amber-500 rounded-full" /><span className="text-sm text-platinum">ãƒãƒ©ãƒ³ã‚¹</span></div>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-rose-500 rounded-full" /><span className="text-sm text-platinum">æ”»ã‚</span></div>
                                    </div>
                                </div>

                                {/* Projection */}
                                <div className="bg-ash/50 border border-white/10 rounded-sm p-8 relative overflow-hidden group">
                                    <div className={`relative transition-all duration-500 ${userPlan === 'basic' ? 'filter blur-sm opacity-50 grayscale-[0.5]' : ''}`}>
                                        <h3 className="text-lg font-bold text-platinum mb-2">è³‡ç”£æ¨ç§»ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆå‚è€ƒå€¤ï¼‰</h3>
                                        <p className="text-[10px] text-dim mb-6">â€» ä»¥ä¸‹ã¯éå»ã®å¹³å‡ãƒªã‚¿ãƒ¼ãƒ³ã«åŸºã¥ãä»®æƒ³ã®è¨ˆç®—ä¾‹ã§ã‚ã‚Šã€å°†æ¥ã®é‹ç”¨çµæœã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                                        <div className="flex items-end justify-between mb-8">
                                            <div>
                                                <p className="text-xs text-dim mb-1">ç¾åœ¨ã®å…ƒé‡‘</p>
                                                <p className="text-xl font-mono text-platinum">Â¥{principal.toLocaleString()}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xs text-gold mb-1">å‚è€ƒå€¤ï¼ˆä¸ç¢ºå®Ÿï¼‰</p>
                                                <p className="text-4xl font-black text-gold">Â¥{projection[20].amount.toLocaleString()}</p>
                                                <p className="text-xs text-emerald-400">+{((projection[20].amount - (principal + monthly * 12 * 20)) / (principal + monthly * 12 * 20) * 100).toFixed(0)}% return</p>
                                            </div>
                                        </div>

                                        {/* Simple Bar Chart */}
                                        <div className="flex items-end gap-1 h-32 md:gap-2">
                                            {projection.map((p, i) => (
                                                <div key={i} className="flex-1 bg-gradient-to-t from-gold/20 to-gold/60 rounded-t-sm relative group"
                                                    style={{ height: `${(p.amount / projection[20].amount) * 100}%` }}>
                                                    <div className="absolute bottom-0 left-0 right-0 h-[1px] bg-gold/50" />
                                                </div>
                                            ))}
                                        </div>
                                        <div className="flex justify-between text-[10px] text-dim mt-2">
                                            <span>Now</span>
                                            <span>10 Years</span>
                                            <span>20 Years</span>
                                        </div>
                                    </div>

                                    {/* Pro Overlay */}
                                    {userPlan === 'basic' && (
                                        <div className="absolute inset-0 z-20 flex flex-col items-center justify-center p-6 text-center">
                                            <div className="bg-black/40 backdrop-blur-md border border-gold/30 p-8 rounded-sm max-w-sm w-full shadow-2xl">
                                                <p className="text-gold text-[10px] tracking-[0.3em] uppercase mb-4">PREMIUM INSIGHT</p>
                                                <h3 className="text-xl font-serif text-platinum mb-6 leading-relaxed">
                                                    ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è€ƒãˆæ–¹ã‚’<br />
                                                    <span className="text-gold-gradient">æ·±ã</span>å­¦ã¶ã€‚
                                                </h3>
                                                <button onClick={onUpgrade} className="group relative px-8 py-3 bg-transparent overflow-hidden rounded-sm border border-gold/50 transition-all hover:border-gold">
                                                    <div className="absolute inset-0 w-0 bg-gold/10 transition-all duration-[250ms] ease-out group-hover:w-full opacity-0 group-hover:opacity-100"></div>
                                                    <span className="relative text-xs tracking-widest text-gold font-medium group-hover:text-white transition-colors">UNLOCK PRO</span>
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Recommended Brokers based on Allocation */}
                                <div className="mt-8 pt-8 border-t border-white/10">
                                    <h3 className="text-sm font-bold text-platinum mb-4 flex items-center gap-2">
                                        <span>ğŸ¦</span> ã“ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã¸ã®å‚è€ƒå£åº§
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {(() => {
                                            const recs = [];
                                            // Base recommendation
                                            recs.push({ name: 'SBIè¨¼åˆ¸', desc: 'ç·åˆåŠ›No.1ãƒ»åˆå¿ƒè€…ã«æœ€é©', url: 'https://www.sbisec.co.jp/' });

                                            // Dynamic recommendations based on allocation
                                            if (allocation.growth >= 40) {
                                                recs.push({ name: 'ãƒãƒãƒƒã‚¯ã‚¹è¨¼åˆ¸', desc: 'ç±³å›½æ ªãƒ»åˆ†ææ©Ÿèƒ½ãŒå……å®Ÿ', url: 'https://www.monex.co.jp/' });
                                                recs.push({ name: 'DMMæ ª', desc: 'ç±³å›½æ ªå–å¼•æ‰‹æ•°æ–™ãŒåœ§å€’çš„', url: 'https://kabu.dmm.com/' });
                                                recs.push({ name: 'GMOã‚¯ãƒªãƒƒã‚¯è¨¼åˆ¸', desc: 'é«˜æ©Ÿèƒ½ãƒ„ãƒ¼ãƒ«ãƒ»CFDå¯¾å¿œ', url: 'https://www.click-sec.com/' });
                                            } else if (allocation.safe >= 50) {
                                                recs.push({ name: 'æ¥½å¤©è¨¼åˆ¸', desc: 'ãƒã‚¤ãƒ³ãƒˆæŠ•è³‡ãƒ»è¦‹ã‚„ã™ã„ç”»é¢', url: 'https://www.rakuten-sec.co.jp/' });
                                                recs.push({ name: 'WealthNavi', desc: 'å…¨è‡ªå‹•ã§ãŠã¾ã‹ã›è³‡ç”£é‹ç”¨', url: 'https://www.wealthnavi.com/' });
                                                recs.push({ name: 'PayPayè¨¼åˆ¸', desc: 'ã‚¹ãƒãƒ›ã§1000å††ã‹ã‚‰æ‰‹è»½ã«', url: 'https://www.paypay-sec.co.jp/' });
                                            } else {
                                                // Balanced
                                                recs.push({ name: 'æ¥½å¤©è¨¼åˆ¸', desc: 'ãƒã‚¤ãƒ³ãƒˆæŠ•è³‡ãƒ»NISAå¯¾å¿œ', url: 'https://www.rakuten-sec.co.jp/' });
                                                recs.push({ name: 'auã‚«ãƒ–ã‚³ãƒ è¨¼åˆ¸', desc: 'Pontaãƒã‚¤ãƒ³ãƒˆãƒ»ã‚¯ãƒ¬ã‚«ç©ç«‹', url: 'https://kabu.com/' });
                                                recs.push({ name: 'PayPayè¨¼åˆ¸', desc: 'ã‚¹ãƒãƒ›ã§å°‘é¡ã‹ã‚‰é–‹å§‹', url: 'https://www.paypay-sec.co.jp/' });
                                            }

                                            return recs.slice(0, 4).map((b, i) => (
                                                <a key={i} href={b.url} target="_blank" rel="noopener noreferrer"
                                                    className="bg-ash/50 border border-white/5 p-4 rounded-sm hover:border-gold/30 hover:bg-white/5 transition-all flex justify-between items-center group">
                                                    <div>
                                                        <p className="font-bold text-platinum group-hover:text-gold transition-colors text-sm">{b.name}</p>
                                                        <p className="text-[10px] text-dim">{b.desc}</p>
                                                    </div>
                                                    <span className="text-gold opacity-0 group-hover:opacity-100 transition-opacity translate-x-[-10px] group-hover:translate-x-0 duration-300">â†’</span>
                                                </a>
                                            ));
                                        })()}
                                    </div>
                                    <p className="text-[10px] text-dim mt-3">â€» ãƒªãƒ³ã‚¯å…ˆã¯å„è¨¼åˆ¸ä¼šç¤¾ã®å…¬å¼ã‚µã‚¤ãƒˆã§ã™ã€‚</p>
                                </div>
                            </motion.div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================
        // BROKER COMPARISON PAGE
        // ============================================
        const BrokerComparison = ({ onNavigate }) => {
            const [selectedCategory, setSelectedCategory] = useState('all');
            const [selectedBroker, setSelectedBroker] = useState(null);
            const [tipsOpen, setTipsOpen] = useState(false);

            const brokers = [
                {
                    id: 'sbi',
                    name: 'SBIè¨¼åˆ¸',
                    category: 'general',
                    logo: 'ğŸ¦',
                    tagline: 'å¹…åºƒã„å•†å“ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—',
                    ratings: { fees: 5, products: 5, ease: 3, support: 3, tools: 4 },
                    features: ['å›½å†…æ ªå–å¼•æ‰‹æ•°æ–™0å††ãƒ—ãƒ©ãƒ³ã‚ã‚Š', 'NISAãƒ»iDeCoå¯¾å¿œ', 'ç±³å›½æ ªãƒ»æŠ•è³‡ä¿¡è¨—å……å®Ÿ', 'Tãƒã‚¤ãƒ³ãƒˆ/Vãƒã‚¤ãƒ³ãƒˆé€£æº'],
                    fees: { stock: '0å††ã€œ', fund: '0å††ã€œ', us: '0.495%' },
                    pros: ['å•†å“æ•°ãŒè±Šå¯Œ', 'IPOå–æ‰±ã„ãŒå¤šã„', 'ã‚¯ãƒ¬ã‚«ç©ç«‹å¯¾å¿œ'],
                    cons: ['ã‚µã‚¤ãƒˆãŒè¤‡é›‘', 'ã‚¢ãƒ—ãƒªãŒåˆ†æ•£'],
                    bestFor: ['å¹…åºƒã„å•†å“ã‚’æ‰±ã„ãŸã„æ–¹', 'ç±³å›½æ ªã«èˆˆå‘³ãŒã‚ã‚‹æ–¹'],
                    url: 'https://www.sbisec.co.jp/'
                },
                {
                    id: 'rakuten',
                    name: 'æ¥½å¤©è¨¼åˆ¸',
                    category: 'general',
                    logo: 'ğŸ›’',
                    tagline: 'æ¥½å¤©çµŒæ¸ˆåœã¨ã®é€£æº',
                    ratings: { fees: 5, products: 4, ease: 5, support: 3, tools: 4 },
                    features: ['æ¥½å¤©ãƒã‚¤ãƒ³ãƒˆæŠ•è³‡', 'æ¥½å¤©ã‚«ãƒ¼ãƒ‰ç©ç«‹ã§é‚„å…ƒ', 'æ¥½å¤©éŠ€è¡Œé€£æºã§é‡‘åˆ©å„ªé‡', 'æ—¥çµŒãƒ†ãƒ¬ã‚³ãƒ³ç„¡æ–™'],
                    fees: { stock: '0å††ã€œ', fund: '0å††ã€œ', us: '0.495%' },
                    pros: ['æ¥½å¤©ãƒã‚¤ãƒ³ãƒˆãŒä½¿ãˆã‚‹', 'ã‚¢ãƒ—ãƒªãŒä½¿ã„ã‚„ã™ã„', 'ãƒãƒãƒ¼ãƒ–ãƒªãƒƒã‚¸ã§é‡‘åˆ©UP'],
                    cons: ['ãƒã‚¤ãƒ³ãƒˆé‚„å…ƒç‡ãŒå¤‰å‹•', 'æ¥½å¤©åœå¤–ã ã¨ãƒ¡ãƒªãƒƒãƒˆè–„'],
                    bestFor: ['æ¥½å¤©ãƒ¦ãƒ¼ã‚¶ãƒ¼', 'ãƒã‚¤ãƒ³ãƒˆæŠ•è³‡ã‚’ã—ãŸã„æ–¹'],
                    url: 'https://www.rakuten-sec.co.jp/'
                },
                {
                    id: 'matsui',
                    name: 'æ¾äº•è¨¼åˆ¸',
                    category: 'general',
                    logo: 'ğŸ¯',
                    tagline: 'è€èˆ—ã®å®‰å¿ƒæ„Ÿã¨ã‚µãƒãƒ¼ãƒˆ',
                    ratings: { fees: 4, products: 3, ease: 4, support: 5, tools: 3 },
                    features: ['50ä¸‡å††ã¾ã§æ‰‹æ•°æ–™ç„¡æ–™', 'é›»è©±ã‚µãƒãƒ¼ãƒˆå……å®Ÿ', 'æ ªä¸»å„ªå¾…æ¤œç´¢ãƒ„ãƒ¼ãƒ«', 'æŠ•è³‡ä¿¡è¨—100å††ã‹ã‚‰'],
                    fees: { stock: '0å††ï¼ˆ50ä¸‡ã¾ã§ï¼‰', fund: '0å††ã€œ', us: '0.495%' },
                    pros: ['ã‚µãƒãƒ¼ãƒˆãŒæ‰‹åšã„', 'åˆå¿ƒè€…å‘ã‘ãƒ„ãƒ¼ãƒ«å……å®Ÿ', '25æ­³ä»¥ä¸‹æ‰‹æ•°æ–™ç„¡æ–™'],
                    cons: ['ç±³å›½æ ªã®ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—ãŒå°‘ãªã„', 'ãƒã‚¤ãƒ³ãƒˆåˆ¶åº¦ãŒå¼±ã„'],
                    bestFor: ['ã‚µãƒãƒ¼ãƒˆé‡è¦–ã®æ–¹', 'æ ªä¸»å„ªå¾…ã«èˆˆå‘³ãŒã‚ã‚‹æ–¹'],
                    url: 'https://www.matsui.co.jp/'
                },
                {
                    id: 'monex',
                    name: 'ãƒãƒãƒƒã‚¯ã‚¹è¨¼åˆ¸',
                    category: 'general',
                    logo: 'ğŸ“Š',
                    tagline: 'ç±³å›½æ ªãƒ»åˆ†æãƒ„ãƒ¼ãƒ«ã«å¼·ã¿',
                    ratings: { fees: 3, products: 5, ease: 3, support: 3, tools: 5 },
                    features: ['ç±³å›½æ ªå–æ‰±ã„éŠ˜æŸ„æ•°ãŒå¤šã„', 'éŠ˜æŸ„ã‚¹ã‚«ã‚¦ã‚¿ãƒ¼ç„¡æ–™', 'dãƒã‚¤ãƒ³ãƒˆé€£æº', 'ãƒ¯ãƒ³æ ªã§1æ ªæŠ•è³‡'],
                    fees: { stock: '50ä¸‡ã¾ã§0å††', fund: '0å††ã€œ', us: 'ç´„å®šä»£é‡‘ã®0.495%' },
                    pros: ['ç±³å›½æ ªã«å¼·ã„', 'åˆ†æãƒ„ãƒ¼ãƒ«ãŒå……å®Ÿ', 'IPOæŠ½é¸ãŒå¹³ç­‰'],
                    cons: ['å›½å†…æ ªæ‰‹æ•°æ–™ãŒã‚„ã‚„é«˜ã‚', 'ã‚¢ãƒ—ãƒªã®æ“ä½œæ€§'],
                    bestFor: ['ç±³å›½æ ªãƒ¡ã‚¤ãƒ³ã®æ–¹', 'éŠ˜æŸ„åˆ†æã‚’ã—ãŸã„æ–¹'],
                    url: 'https://www.monex.co.jp/'
                },
                {
                    id: 'au',
                    name: 'auã‚«ãƒ–ã‚³ãƒ è¨¼åˆ¸',
                    category: 'general',
                    logo: 'ğŸ“±',
                    tagline: 'auãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ç‰¹å…¸å……å®Ÿ',
                    ratings: { fees: 4, products: 4, ease: 4, support: 3, tools: 3 },
                    features: ['Pontaãƒã‚¤ãƒ³ãƒˆæŠ•è³‡', 'au PAYã‚«ãƒ¼ãƒ‰ç©ç«‹', 'ãƒ—ãƒæ ªã§1æ ªæŠ•è³‡', 'NISAæ‰‹æ•°æ–™ç„¡æ–™'],
                    fees: { stock: '0å††ï¼ˆæ¡ä»¶ã‚ã‚Šï¼‰', fund: '0å††ã€œ', us: '0.495%' },
                    pros: ['Pontaãƒã‚¤ãƒ³ãƒˆãŒè²¯ã¾ã‚‹', 'auãƒ¦ãƒ¼ã‚¶ãƒ¼å„ªé‡', 'ãƒ—ãƒæ ªãŒæ‰‹è»½'],
                    cons: ['auåœå¤–ã ã¨ãƒ¡ãƒªãƒƒãƒˆè–„', 'ç±³å›½æ ªã¯ç‚ºæ›¿ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚ã‚Š'],
                    bestFor: ['auãƒ¦ãƒ¼ã‚¶ãƒ¼', 'Pontaãƒã‚¤ãƒ³ãƒˆã‚’æ´»ç”¨ã—ãŸã„æ–¹'],
                    url: 'https://kabu.com/'
                },
                {
                    id: 'paypay',
                    name: 'PayPayè¨¼åˆ¸',
                    category: 'mobile',
                    logo: 'ğŸ“±',
                    tagline: 'ã‚¹ãƒãƒ›ã§1000å††ã‹ã‚‰æŠ•è³‡',
                    ratings: { fees: 3, products: 3, ease: 5, support: 3, tools: 3 },
                    features: ['1000å††ã‹ã‚‰æ ªè³¼å…¥', 'PayPayãƒœãƒ¼ãƒŠã‚¹é‹ç”¨', 'ç±³å›½æ ªã‚‚é‡‘é¡æŒ‡å®š', 'ãƒãƒ³ã‚¬ã§å­¦ã¶æŠ•è³‡'],
                    fees: { stock: 'é‡‘é¡æŒ‡å®š', fund: '0å††ã€œ', us: 'é‡‘é¡æŒ‡å®š' },
                    pros: ['å°‘é¡ã‹ã‚‰å§‹ã‚ã‚‰ã‚Œã‚‹', 'PayPayé€£æº', 'ã‚¢ãƒ—ãƒªãŒè¶…ã‚·ãƒ³ãƒ—ãƒ«'],
                    cons: ['æŒ‡å€¤æ³¨æ–‡ä¸å¯', 'å–æ‰±éŠ˜æŸ„ãŒé™å®šçš„'],
                    bestFor: ['æŠ•è³‡åˆå¿ƒè€…', 'å°‘é¡ã§è©¦ã—ãŸã„æ–¹'],
                    url: 'https://www.paypay-sec.co.jp/'
                },
                {
                    id: 'gmo',
                    name: 'GMOã‚¯ãƒªãƒƒã‚¯è¨¼åˆ¸',
                    category: 'trader',
                    logo: 'ğŸ’»',
                    tagline: 'æ¥­ç•Œæœ€å®‰å€¤æ°´æº–ã®æ‰‹æ•°æ–™',
                    ratings: { fees: 5, products: 4, ease: 3, support: 3, tools: 5 },
                    features: ['æ‰‹æ•°æ–™ãŒå®‰ã„', 'é«˜æ©Ÿèƒ½ãƒ„ãƒ¼ãƒ«ã€Œã¯ã£ã¡ã‚…ã†å›ã€', 'CFD/FXæœ€å¼·', 'APIç’°å¢ƒå……å®Ÿ'],
                    fees: { stock: 'æ¥­ç•Œæœ€å®‰', fund: '0å††ã€œ', us: 'æ¥­ç•Œæœ€å®‰æ°´æº–' },
                    pros: ['ã‚³ã‚¹ãƒˆãŒä½ã„', 'ãƒˆãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ãŒé«˜æ€§èƒ½', 'CFDãŒå……å®Ÿ'],
                    cons: ['åˆå¿ƒè€…ã«ã¯ãƒ„ãƒ¼ãƒ«ãŒé›£ã—ã„ã‹ã‚‚', 'æŠ•è³‡ä¿¡è¨—ã¯å°‘ãªã‚'],
                    bestFor: ['ã‚³ã‚¹ãƒˆé‡è¦–ã®æ–¹', 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼'],
                    url: 'https://www.click-sec.com/'
                },
                {
                    id: 'dmm',
                    name: 'DMMæ ª',
                    category: 'general',
                    logo: 'âš¡',
                    tagline: 'ç±³å›½æ ªæ‰‹æ•°æ–™0å††ã€œ',
                    ratings: { fees: 5, products: 3, ease: 4, support: 3, tools: 4 },
                    features: ['ç±³å›½æ ªå–å¼•æ‰‹æ•°æ–™0å††', 'DMMãƒã‚¤ãƒ³ãƒˆé€£æº', 'æœ€çŸ­å³æ—¥å£åº§é–‹è¨­', 'ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã‚¢ãƒ—ãƒª'],
                    fees: { stock: 'æ¥­ç•Œæœ€å®‰æ°´æº–', fund: '-', us: '0å††' },
                    pros: ['ç±³å›½æ ªã‚³ã‚¹ãƒˆãŒåœ§å€’çš„', 'ã‚¢ãƒ—ãƒªãŒä½¿ã„ã‚„ã™ã„ï¼ˆã‹ã‚“ãŸã‚“/ãƒãƒ¼ãƒãƒ«ï¼‰', 'å£åº§é–‹è¨­ãŒæ—©ã„'],
                    cons: ['æŠ•è³‡ä¿¡è¨—ã®æ‰±ã„ãŒå°‘ãªã„', 'NISAã®é¸æŠè‚¢ãŒå°‘ãªã‚'],
                    bestFor: ['ç±³å›½æ ªãƒ¡ã‚¤ãƒ³ã®æ–¹', 'æ‰‹æ•°æ–™ã‚’æŠ‘ãˆãŸã„æ–¹'],
                    url: 'https://kabu.dmm.com/'
                },
                {
                    id: 'wealthnavi',
                    name: 'WealthNavi',
                    category: 'robo',
                    logo: 'ğŸ¤–',
                    tagline: 'å…¨è‡ªå‹•ã®ãŠã¾ã‹ã›è³‡ç”£é‹ç”¨',
                    ratings: { fees: 2, products: 3, ease: 5, support: 4, tools: 4 },
                    features: ['ãƒ­ãƒœã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼', 'è‡ªå‹•ãƒªãƒãƒ©ãƒ³ã‚¹', 'ç¨é‡‘æœ€é©åŒ–æ©Ÿèƒ½', 'NISAã«ã‚‚å¯¾å¿œ'],
                    fees: { stock: '-', fund: '-', us: 'å¹´ç‡1.1%ï¼ˆç¨è¾¼ï¼‰' },
                    pros: ['å®Œå…¨è‡ªå‹•ã§æ‰‹é–“ãªã—', 'ãƒªãƒãƒ©ãƒ³ã‚¹ä¸è¦', 'åˆå¿ƒè€…ã§ã‚‚å®‰å¿ƒ'],
                    cons: ['æ‰‹æ•°æ–™ãŒæ¯”è¼ƒçš„é«˜ã„', 'è‡ªåˆ†ã§éŠ˜æŸ„ã‚’é¸ã¹ãªã„'],
                    bestFor: ['æŠ•è³‡ã«æ™‚é–“ã‚’ã‹ã‘ãŸããªã„æ–¹', 'å®Œå…¨ãŠã¾ã‹ã›ã‚’å¸Œæœ›ã™ã‚‹æ–¹'],
                    url: 'https://www.wealthnavi.com/'
                },
                {
                    id: 'bitflyer',
                    name: 'bitFlyer',
                    category: 'crypto',
                    logo: 'â‚¿',
                    tagline: 'å›½å†…å¤§æ‰‹ã®ä»®æƒ³é€šè²¨å–å¼•æ‰€',
                    ratings: { fees: 3, products: 3, ease: 4, support: 4, tools: 3 },
                    features: ['ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³å–æ‰±ã„', 'Tãƒã‚¤ãƒ³ãƒˆé€£æº', 'ç©ç«‹ã‚µãƒ¼ãƒ“ã‚¹', 'bitFlyerã‚¯ãƒ¬ã‚«'],
                    fees: { stock: '-', fund: '-', us: 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ï¼ˆå¤‰å‹•ï¼‰' },
                    pros: ['ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«æ³¨åŠ›', '1å††ã‹ã‚‰è³¼å…¥å¯èƒ½', 'ãƒã‚¤ãƒ³ãƒˆæŠ•è³‡å¯¾å¿œ'],
                    cons: ['æ‰‹æ•°æ–™ãŒé«˜ã‚', 'ã‚¢ãƒ«ãƒˆã‚³ã‚¤ãƒ³æ•°ãŒå°‘ãªã‚'],
                    bestFor: ['ä»®æƒ³é€šè²¨åˆå¿ƒè€…', 'ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ã‚’å§‹ã‚ãŸã„æ–¹'],
                    url: 'https://bitflyer.com/'
                },
                {
                    id: 'coincheck',
                    name: 'Coincheck',
                    category: 'crypto',
                    logo: 'ğŸª™',
                    tagline: 'ã‚·ãƒ³ãƒ—ãƒ«ã§ä½¿ã„ã‚„ã™ã„UI',
                    ratings: { fees: 3, products: 4, ease: 5, support: 3, tools: 3 },
                    features: ['ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ—ãƒª', 'ã¤ã¿ãŸã¦æ©Ÿèƒ½', 'NFTå–æ‰±ã„', 'é›»æ°—ä»£ã‚’BTCã§'],
                    fees: { stock: '-', fund: '-', us: 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ï¼ˆå¤‰å‹•ï¼‰' },
                    pros: ['ã‚¢ãƒ—ãƒªãŒä½¿ã„ã‚„ã™ã„', 'éŠ˜æŸ„æ•°ãŒå¤šã„', '500å††ã‹ã‚‰è³¼å…¥å¯èƒ½'],
                    cons: ['ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ãŒåºƒã‚', 'éå»ã«ãƒãƒƒã‚­ãƒ³ã‚°è¢«å®³'],
                    bestFor: ['ä»®æƒ³é€šè²¨åˆå¿ƒè€…', 'ã‚·ãƒ³ãƒ—ãƒ«ãªUIã‚’å¥½ã‚€æ–¹'],
                    url: 'https://coincheck.com/'
                }
            ];

            const categories = [
                { id: 'all', label: 'ã™ã¹ã¦' },
                { id: 'general', label: 'ç·åˆè¨¼åˆ¸' },
                { id: 'robo', label: 'ãƒ­ãƒœã‚¢ãƒ‰' },
                { id: 'crypto', label: 'ä»®æƒ³é€šè²¨' }
            ];

            const filteredBrokers = selectedCategory === 'all' ? brokers : brokers.filter(b => b.category === selectedCategory);

            // Radar Chart Component - Glass Edition
            const RadarChart = ({ ratings, size = 100, showLabels = false }) => {
                const center = size / 2;
                const radius = size * (showLabels ? 0.3 : 0.38);
                const axes = ['fees', 'products', 'ease', 'support', 'tools'];
                const axisLabels = ['æ‰‹æ•°æ–™', 'å•†å“', 'ç°¡å˜ã•', 'ã‚µãƒãƒ¼ãƒˆ', 'ãƒ„ãƒ¼ãƒ«'];
                const angleStep = (Math.PI * 2) / axes.length;
                const chartId = useMemo(() => `radar-${Math.random().toString(36).substr(2, 9)}`, []);

                const getPoint = (value, index) => {
                    const angle = index * angleStep - Math.PI / 2;
                    const r = (value / 5) * radius;
                    return { x: center + r * Math.cos(angle), y: center + r * Math.sin(angle) };
                };

                const points = axes.map((axis, i) => getPoint(ratings[axis], i));
                const polygonPoints = points.map(p => `${p.x},${p.y}`).join(' ');

                // Grid lines (5 levels)
                const gridLines = [1, 2, 3, 4, 5].map(level => {
                    const gridPoints = axes.map((_, i) => getPoint(level, i));
                    return { points: gridPoints.map(p => `${p.x},${p.y}`).join(' '), level };
                });

                return (
                    <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
                        <defs>
                            {/* Glass fill gradient */}
                            <linearGradient id={`${chartId}-glass`} x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stopColor="rgba(255,255,255,0.15)" />
                                <stop offset="40%" stopColor="rgba(201,162,39,0.08)" />
                                <stop offset="100%" stopColor="rgba(255,255,255,0.12)" />
                            </linearGradient>
                            {/* Soft inner glow */}
                            <radialGradient id={`${chartId}-inner`} cx="50%" cy="40%" r="60%">
                                <stop offset="0%" stopColor="rgba(232,208,104,0.15)" />
                                <stop offset="100%" stopColor="rgba(0,0,0,0)" />
                            </radialGradient>
                            <filter id={`${chartId}-blur`}>
                                <feGaussianBlur stdDeviation="1.5" result="blur" />
                                <feMerge>
                                    <feMergeNode in="blur" />
                                    <feMergeNode in="SourceGraphic" />
                                </feMerge>
                            </filter>
                        </defs>

                        {/* Background ambient glow */}
                        <circle cx={center} cy={center} r={radius * 1.05} fill={`url(#${chartId}-inner)`} />

                        {/* Grid â€” clean concentric pentagons */}
                        {gridLines.map(({ points: line, level }) => (
                            <polygon key={level} points={line} fill="none"
                                stroke={`rgba(255,255,255,${level === 5 ? 0.12 : 0.04 + level * 0.01})`}
                                strokeWidth={level === 5 ? '0.8' : '0.4'} />
                        ))}

                        {/* Axis lines */}
                        {axes.map((_, i) => {
                            const endPoint = getPoint(5, i);
                            return <line key={i} x1={center} y1={center} x2={endPoint.x} y2={endPoint.y}
                                stroke="rgba(255,255,255,0.06)" strokeWidth="0.4" />
                        })}

                        {/* Data polygon â€” frosted glass */}
                        <polygon points={polygonPoints}
                            fill={`url(#${chartId}-glass)`}
                            stroke="rgba(255,255,255,0.35)"
                            strokeWidth={showLabels ? '1.5' : '1'}
                            strokeLinejoin="round" />

                        {/* Data points â€” refined dots */}
                        {points.map((p, i) => (
                            <g key={i}>
                                <circle cx={p.x} cy={p.y} r={showLabels ? '4' : '2.5'}
                                    fill="rgba(255,255,255,0.08)" stroke="rgba(255,255,255,0.25)" strokeWidth="0.5" />
                                <circle cx={p.x} cy={p.y} r={showLabels ? '2' : '1.5'}
                                    fill="rgba(232,208,104,0.9)" />
                            </g>
                        ))}

                        {/* Labels */}
                        {showLabels && axes.map((axis, i) => {
                            const angle = i * angleStep - Math.PI / 2;
                            const labelRadius = radius * 1.45;
                            const x = center + labelRadius * Math.cos(angle);
                            const y = center + labelRadius * Math.sin(angle);
                            const score = ratings[axis];
                            return (
                                <g key={i}>
                                    <text x={x} y={y - 6} fill="rgba(255,255,255,0.75)" fontSize="10" fontWeight="500"
                                        textAnchor="middle" dominantBaseline="middle"
                                        style={{ letterSpacing: '0.04em' }}>
                                        {axisLabels[i]}
                                    </text>
                                    <text x={x} y={y + 7} fill="rgba(232,208,104,0.8)" fontSize="9" fontWeight="600"
                                        textAnchor="middle" dominantBaseline="middle" fontFamily="monospace">
                                        {score.toFixed(1)}
                                    </text>
                                </g>
                            );
                        })}
                    </svg>
                );
            };


            return (
                <div className="min-h-screen bg-obsidian pt-28 pb-32 px-4 sm:px-8 relative overflow-hidden">
                    {/* Atmospheric Background */}
                    <div className="fixed inset-0 pointer-events-none overflow-hidden">
                        <div className="absolute -top-[20%] -right-[10%] w-[1000px] h-[1000px] bg-gold/5 rounded-full blur-[150px] opacity-20" />
                        <div className="absolute bottom-[-10%] left-[-10%] w-[800px] h-[800px] bg-emerald-500/5 rounded-full blur-[120px] opacity-10" />
                    </div>

                    <div className="max-w-6xl mx-auto relative z-10">
                        {/* Header */}
                        <div className="mb-16">
                            <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }}>
                                <div className="flex items-center justify-between mb-2">
                                    <p className="text-dim text-xs tracking-[0.4em] text-gold uppercase">Broker Comparison</p>
                                    <button onClick={() => setTipsOpen(!tipsOpen)} className="text-gold hover:scale-110 transition-transform text-lg" title="ç”¨èªè§£èª¬">
                                        â•
                                    </button>
                                </div>
                                <h2 className="text-4xl md:text-5xl font-black tracking-tighter text-platinum mb-4">è¨¼åˆ¸ä¼šç¤¾ã‚’<span className="text-gold-gradient">æ¯”è¼ƒ</span>ã™ã‚‹</h2>
                                <p className="text-dim text-sm max-w-xl leading-loose">
                                    å„è¨¼åˆ¸ä¼šç¤¾ã®ç‰¹å¾´ã‚’æ¯”è¼ƒã—ã¦ã€ã‚ãªãŸã«åˆã£ãŸå£åº§ã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†ã€‚<br />
                                    â€» æœ¬æƒ…å ±ã¯ä¸€èˆ¬çš„ãªæ¯”è¼ƒã§ã‚ã‚Šã€ç‰¹å®šã®ä¼šç¤¾ã‚’æ¨å¥¨ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                                </p>
                            </motion.div>
                        </div>

                        {/* Tips Section */}
                        <AnimatePresence>
                            {tipsOpen && (
                                <motion.div initial={{ height: 0, opacity: 0 }} animate={{ height: 'auto', opacity: 1 }} exit={{ height: 0, opacity: 0 }} className="overflow-hidden mb-10">
                                    <div className="bg-gold/5 border border-gold/20 rounded-sm p-6">
                                        <h3 className="text-gold font-bold mb-4 flex items-center gap-2"><span>ğŸ’¡</span> è¨¼åˆ¸ãƒ»è¨¼åˆ¸ä¼šç¤¾ã£ã¦ä½•ï¼Ÿ</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                                            <div>
                                                <h4 className="text-platinum font-bold mb-2">è¨¼åˆ¸ã¨ã¯ï¼Ÿ</h4>
                                                <p className="text-dim leading-relaxed">æ ªã‚„æŠ•è³‡ä¿¡è¨—ãªã©ã€ŒãŠé‡‘ã‚’å¢—ã‚„ã™ãŸã‚ã®å•†å“ã€ã®ã“ã¨ã€‚è²·ã†ã“ã¨ã§ã€ä¼æ¥­ã®æˆé•·ã‚„å›½ã®ä¿¡ç”¨ã«æŠ•è³‡ã—ã€åˆ©ç›Šã‚’å¾—ã‚‹æ¨©åˆ©ã‚’æŒã¦ã¾ã™ã€‚</p>
                                            </div>
                                            <div>
                                                <h4 className="text-platinum font-bold mb-2">è¨¼åˆ¸ä¼šç¤¾ã¨ã¯ï¼Ÿ</h4>
                                                <p className="text-dim leading-relaxed">è¨¼åˆ¸ã‚’å£²è²·ã™ã‚‹ãŸã‚ã®ãŠåº—ã§ã™ã€‚ã‚¹ãƒ¼ãƒ‘ãƒ¼ã§é£Ÿå“ã‚’è²·ã†ã‚ˆã†ã«ã€è¨¼åˆ¸ä¼šç¤¾ã§æ ªã‚„æŠ•è³‡ä¿¡è¨—ã‚’è²·ã„ã¾ã™ã€‚éŠ€è¡ŒãŒãŠé‡‘ã‚’é ã‹ã‚‹å ´æ‰€ãªã‚‰ã€è¨¼åˆ¸ä¼šç¤¾ã¯ãŠé‡‘ã‚’ã€Œåƒã‹ã›ã‚‹ã€å ´æ‰€ã§ã™ã€‚</p>
                                            </div>
                                        </div>
                                    </div>
                                </motion.div>
                            )}
                        </AnimatePresence>

                        {/* Category Filter */}
                        <div className="flex gap-3 mb-10 flex-wrap">
                            {categories.map(cat => (
                                <button key={cat.id} onClick={() => setSelectedCategory(cat.id)}
                                    className={`px-5 py-2 rounded-sm text-sm transition-all font-medium ${selectedCategory === cat.id ? 'bg-gold/10 text-gold border border-gold/30' : 'text-dim border border-white/10 hover:text-platinum hover:border-white/20'}`}>
                                    {cat.label}
                                </button>
                            ))}
                        </div>

                        {/* Broker Cards - Compact Radar Chart Design */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-12">
                            <AnimatePresence mode="popLayout">
                                {filteredBrokers.map((broker, i) => (
                                    <motion.div key={broker.id}
                                        initial={{ opacity: 0, scale: 0.9 }}
                                        animate={{ opacity: 1, scale: 1 }}
                                        exit={{ opacity: 0, scale: 0.9 }}
                                        transition={{ delay: i * 0.05, type: 'spring', stiffness: 300 }}
                                        onClick={() => setSelectedBroker(broker)}
                                        className="bg-gradient-to-br from-ash/80 to-ash/40 border border-white/5 rounded-sm p-4 cursor-pointer hover:border-gold/30 hover:scale-105 transition-all duration-300 group flex flex-col items-center">
                                        {/* Radar Chart */}
                                        <div className="mb-3 relative">
                                            <RadarChart ratings={broker.ratings} size={110} />
                                            <div className="absolute inset-0 flex items-center justify-center">
                                                <span className="text-2xl">{broker.logo}</span>
                                            </div>
                                        </div>
                                        {/* Name & Tagline */}
                                        <h3 className="text-sm font-bold text-platinum group-hover:text-gold transition-colors text-center">{broker.name}</h3>
                                        <p className="text-[10px] text-dim text-center mt-1 line-clamp-1">{broker.tagline}</p>
                                        <span className="text-[10px] text-gold mt-2 opacity-0 group-hover:opacity-100 transition-opacity">ã‚¿ãƒƒãƒ—ã§è©³ç´°</span>
                                    </motion.div>
                                ))}
                            </AnimatePresence>
                        </div>

                        {/* Disclaimer */}
                        <div className="text-center">
                            <p className="text-[10px] text-dim leading-relaxed">
                                â€» æ‰‹æ•°æ–™ãƒ»ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹ã¯å¤‰æ›´ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚æœ€æ–°æƒ…å ±ã¯å„ç¤¾å…¬å¼ã‚µã‚¤ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚<br />
                                â€» æœ¬ãƒšãƒ¼ã‚¸ã¯æƒ…å ±æä¾›ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€æŠ•è³‡å‹§èª˜ã‚’ç›®çš„ã¨ã—ãŸã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                            </p>
                        </div>
                    </div>

                    {/* Detail Modal */}
                    <AnimatePresence>
                        {selectedBroker && (
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
                                className="fixed inset-0 z-50 flex items-center justify-center bg-obsidian/90 backdrop-blur-lg p-4"
                                onClick={() => setSelectedBroker(null)}>
                                <motion.div initial={{ opacity: 0, scale: 0.95, y: 20 }} animate={{ opacity: 1, scale: 1, y: 0 }} exit={{ opacity: 0, scale: 0.95 }}
                                    onClick={e => e.stopPropagation()}
                                    className="w-full max-w-2xl max-h-[85vh] overflow-y-auto bg-ash border border-white/10 rounded-sm">
                                    {/* Modal Header */}
                                    <div className="sticky top-0 bg-ash/95 backdrop-blur-sm border-b border-white/10 p-6 flex justify-between items-start">
                                        <div className="flex items-center gap-4">
                                            <div className="w-14 h-14 rounded-sm bg-gradient-to-br from-gold/20 to-amber-500/10 flex items-center justify-center text-3xl">{selectedBroker.logo}</div>
                                            <div>
                                                <h2 className="text-2xl font-bold text-platinum">{selectedBroker.name}</h2>
                                                <p className="text-sm text-dim">{selectedBroker.tagline}</p>
                                            </div>
                                        </div>
                                        <button onClick={() => setSelectedBroker(null)} className="text-dim hover:text-white text-2xl">Ã—</button>
                                    </div>

                                    {/* Modal Content */}
                                    <div className="p-6 space-y-6">
                                        {/* Detailed Radar Chart */}
                                        <div className="flex justify-center py-4 bg-gradient-to-br from-white/5 to-transparent rounded-sm border border-white/5">
                                            <RadarChart ratings={selectedBroker.ratings} size={280} showLabels={true} />
                                        </div>
                                        {/* Features */}
                                        <div>
                                            <h3 className="text-sm text-gold uppercase tracking-wider mb-3">ä¸»ãªç‰¹å¾´</h3>
                                            <div className="flex flex-wrap gap-2">
                                                {selectedBroker.features.map((f, i) => (
                                                    <span key={i} className="text-sm text-platinum bg-gold/10 border border-gold/20 px-3 py-1.5 rounded-sm">{f}</span>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Fees */}
                                        <div className="bg-white/5 border border-white/10 rounded-sm p-4">
                                            <h3 className="text-sm text-gold uppercase tracking-wider mb-3">æ‰‹æ•°æ–™ï¼ˆç¨è¾¼ãƒ»ç›®å®‰ï¼‰</h3>
                                            <div className="grid grid-cols-3 gap-4 text-center">
                                                <div>
                                                    <p className="text-xs text-dim mb-1">å›½å†…æ ª</p>
                                                    <p className="text-lg font-bold text-platinum">{selectedBroker.fees.stock}</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs text-dim mb-1">æŠ•è³‡ä¿¡è¨—</p>
                                                    <p className="text-lg font-bold text-platinum">{selectedBroker.fees.fund}</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs text-dim mb-1">ç±³å›½æ ª/ãã®ä»–</p>
                                                    <p className="text-lg font-bold text-platinum">{selectedBroker.fees.us}</p>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Pros & Cons */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="bg-emerald-500/5 border border-emerald-500/20 rounded-sm p-4">
                                                <h3 className="text-sm text-emerald-400 uppercase tracking-wider mb-3">ãƒ¡ãƒªãƒƒãƒˆ</h3>
                                                <ul className="space-y-2">
                                                    {selectedBroker.pros.map((p, i) => (
                                                        <li key={i} className="text-sm text-platinum/80 flex items-start gap-2">
                                                            <span className="text-emerald-400">âœ“</span>{p}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                            <div className="bg-rose-500/5 border border-rose-500/20 rounded-sm p-4">
                                                <h3 className="text-sm text-rose-400 uppercase tracking-wider mb-3">ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ</h3>
                                                <ul className="space-y-2">
                                                    {selectedBroker.cons.map((c, i) => (
                                                        <li key={i} className="text-sm text-platinum/80 flex items-start gap-2">
                                                            <span className="text-rose-400">â–³</span>{c}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        </div>

                                        {/* Best For */}
                                        <div>
                                            <h3 className="text-sm text-gold uppercase tracking-wider mb-3">ã“ã‚“ãªäººã«å‘ã„ã¦ã„ã‚‹</h3>
                                            <div className="flex flex-wrap gap-2">
                                                {selectedBroker.bestFor.map((b, i) => (
                                                    <span key={i} className="text-sm text-platinum/80 bg-white/5 border border-white/10 px-3 py-1.5 rounded-sm">ğŸ‘¤ {b}</span>
                                                ))}
                                            </div>
                                        </div>

                                        {/* CTA */}
                                        <div className="pt-4 border-t border-white/10">
                                            <a href={selectedBroker.url} target="_blank" rel="noopener noreferrer"
                                                className="block w-full py-4 bg-gold/10 border border-gold/30 text-gold text-center font-bold rounded-sm hover:bg-gold hover:text-black transition-all">
                                                {selectedBroker.name}ã®å…¬å¼ã‚µã‚¤ãƒˆã¸ â†’
                                            </a>
                                            <p className="text-[10px] text-dim text-center mt-3">
                                                â€» å¤–éƒ¨ã‚µã‚¤ãƒˆã¸é·ç§»ã—ã¾ã™ã€‚æŠ•è³‡å‹§èª˜ã‚’ç›®çš„ã¨ã—ãŸã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br />
                                                â€» æœ¬ãƒªãƒ³ã‚¯ã¯ææºã‚µãƒ¼ãƒ“ã‚¹ã¸ã®æ¡ˆå†…ã‚’å«ã¿ã¾ã™
                                            </p>
                                        </div>
                                    </div>
                                </motion.div>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const Tokushoho = ({ onNavigate }) => {
            const tableRows = [
                { label: "è²©å£²äº‹æ¥­è€…", value: "ç”°ä¸­ æ»‰ä¸€éƒ" },
                { label: "æ‰€åœ¨åœ° / é€£çµ¡å…ˆ", value: "æ¶ˆè²»è€…åºã®è¦å®šã«åŸºã¥ãã€è«‹æ±‚ãŒã‚ã£ãŸå ´åˆã«ã¯é…æ»ãªãé–‹ç¤ºã„ãŸã—ã¾ã™ã€‚\nã”å¸Œæœ›ã®æ–¹ã¯ä¸‹è¨˜ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚\nsupport@invision-app.com" },
                { label: "è²©å£²ä¾¡æ ¼", value: "å„å•†å“ãƒšãƒ¼ã‚¸ã«è¨˜è¼‰ï¼ˆè¡¨ç¤ºä¾¡æ ¼ã¯æ¶ˆè²»ç¨ã‚’å«ã¿ã¾ã™ï¼‰" },
                { label: "å•†å“ä»£é‡‘ä»¥å¤–ã®å¿…è¦æ–™é‡‘", value: "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šæ–™é‡‘ãã®ä»–ã®é›»æ°—é€šä¿¡å›ç·šã®é€šä¿¡ã«é–¢ã™ã‚‹è²»ç”¨ã¯ãŠå®¢æ§˜ã®è² æ‹…ã¨ãªã‚Šã¾ã™ã€‚" },
                { label: "ãŠæ”¯æ‰•ã„æ–¹æ³•", value: "ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆï¼ˆVisa, Mastercard, JCB, Amex, Dinersï¼‰\nApple Pay, Google Pay" },
                { label: "ãŠæ”¯æ‰•ã„æ™‚æœŸ", value: "å•†å“è³¼å…¥æ™‚ã«ãŠæ”¯æ‰•ã„ãŒç¢ºå®šã—ã¾ã™ã€‚" },
                { label: "å•†å“ã®å¼•æ¸¡æ™‚æœŸ", value: "æ±ºæ¸ˆå®Œäº†å¾Œã€ç›´ã¡ã«ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚" },
                { label: "è¿”å“ãƒ»äº¤æ›", value: "ãƒ‡ã‚¸ã‚¿ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ€§è³ªä¸Šã€è³¼å…¥ç¢ºå®šå¾Œã®è¿”å“ãƒ»äº¤æ›ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ãŠå—ã‘ã§ãã¾ã›ã‚“ã€‚äºˆã‚ã”äº†æ‰¿ãã ã•ã„ã€‚" },
                { label: "å‹•ä½œç’°å¢ƒ", value: "iOS 15.0ä»¥ä¸Š / Android 10.0ä»¥ä¸Š\næ¨å¥¨ãƒ–ãƒ©ã‚¦ã‚¶ï¼šSafari, Chromeã®æœ€æ–°ç‰ˆ" },
            ];

            return (
                <div className="min-h-screen bg-obsidian py-24 px-8 relative overflow-hidden">
                    <div className="fixed inset-0 pointer-events-none">
                        <div className="absolute top-[10%] left-[10%] w-[500px] h-[500px] bg-gold/5 rounded-full blur-[120px] opacity-20" />
                        <div className="absolute bottom-[10%] right-[10%] w-[400px] h-[400px] bg-amber-500/5 rounded-full blur-[100px] opacity-10" />
                    </div>

                    <div className="max-w-3xl mx-auto relative z-10">
                        <button onClick={() => onNavigate('gallery')} className="text-dim hover:text-gold transition-colors mb-8 flex items-center gap-2 text-sm group">
                            <span className="group-hover:-translate-x-1 transition-transform">â†</span> æˆ»ã‚‹
                        </button>

                        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }}>
                            <p className="text-dim text-xs tracking-[0.3em] mb-4 text-gold font-bold">LEGAL INFORMATION</p>
                            <h2 className="text-3xl md:text-4xl font-black text-platinum mb-10 tracking-tight">ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜</h2>

                            <div className="bg-ash/50 border border-white/10 rounded-sm overflow-hidden backdrop-blur-sm">
                                {tableRows.map((row, i) => (
                                    <div key={i} className={`flex flex-col md:flex-row border-b border-white/5 last:border-0 ${i % 2 === 0 ? 'bg-white/[0.02]' : ''}`}>
                                        <div className="md:w-1/3 p-4 md:p-6 text-sm text-platinum/60 font-medium md:border-r border-white/5">
                                            {row.label}
                                        </div>
                                        <div className="md:w-2/3 p-4 md:p-6 text-sm text-platinum leading-relaxed whitespace-pre-wrap font-light">
                                            {row.value}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="mt-12 p-6 bg-white/5 border border-white/10 rounded-sm">
                                <h3 className="text-sm font-bold text-gold mb-2">ãŠå•ã„åˆã‚ã›ã«ã¤ã„ã¦</h3>
                                <p className="text-xs text-dim leading-relaxed">
                                    æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã«é–¢ã™ã‚‹ãŠå•ã„åˆã‚ã›ã¯ã€ä¸Šè¨˜ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ã§ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚<br />
                                    åŸå‰‡ã¨ã—ã¦2å–¶æ¥­æ—¥ä»¥å†…ã«ã”è¿”ä¿¡ã„ãŸã—ã¾ã™ãŒã€å†…å®¹ã«ã‚ˆã£ã¦ã¯ãŠæ™‚é–“ã‚’ã„ãŸã ãå ´åˆãŒã”ã–ã„ã¾ã™ã€‚<br />
                                    ãªãŠã€æŠ•è³‡åŠ©è¨€ã«è©²å½“ã™ã‚‹å€‹åˆ¥å…·ä½“çš„ãªã”è³ªå•ã«ã¯ãŠç­”ãˆã§ãã¾ã›ã‚“ã®ã§äºˆã‚ã”äº†æ‰¿ãã ã•ã„ã€‚
                                </p>
                            </div>
                        </motion.div>
                    </div>
                </div>
            );
        };

        // ============================================
        // HEADER & APP ROOT
        // ============================================
        const Header = ({ currentPage, onNavigate, onOpenSettings, showNav, userProfile, progress }) => (
            <header className="fixed top-0 left-0 right-0 z-40 bg-obsidian/80 backdrop-blur-sm border-b border-white/5">
                <div className="max-w-7xl mx-auto px-4 md:px-8 py-4 flex items-center justify-between">
                    <div className="flex items-center gap-4 flex-shrink-0">
                        <button onClick={() => onNavigate('gallery')} className="text-xl font-black tracking-tighter cursor-pointer">
                            <span className="text-gold-gradient">IN</span><span className="text-platinum">VISION</span>
                        </button>
                        {userProfile && (
                            <div className="hidden md:flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10">
                                <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse" />
                                <span className="text-xs font-mono text-platinum/80 tracking-wider">
                                    {getUserTitle(userProfile, progress)}
                                </span>
                            </div>
                        )}
                    </div>
                    {/* Always show nav, scrollable on mobile */}
                    <div className="flex items-center gap-4 md:gap-8 flex-1 justify-end min-w-0">
                        <nav className="flex items-center gap-4 md:gap-6 overflow-x-auto no-scrollbar mask-gradient-right pr-4">
                            {[{ id: 'gallery', label: 'ã‚¢ã‚»ãƒƒãƒˆ' }, { id: 'brokers', label: 'è¨¼åˆ¸' }, { id: 'briefing', label: 'å­¦ç¿’' }, { id: 'portfolio', label: 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª' }, { id: 'diagnosis', label: 'è¨ºæ–­' }].map(item => (
                                <button key={item.id} onClick={() => onNavigate(item.id)} className={`text-xs md:text-sm whitespace-nowrap transition-colors ${currentPage === item.id ? 'text-gold font-bold' : 'text-dim hover:text-platinum'}`}>{item.label}</button>
                            ))}
                        </nav>
                        <button onClick={onOpenSettings} className="text-dim hover:text-gold transition-colors flex-shrink-0">âš™ï¸</button>
                    </div>
                </div>
            </header>
        );

        const DisclaimerModal = ({ onAccept }) => (
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 sm:p-6">
                <motion.div initial={{ scale: 0.9, y: 20 }} animate={{ scale: 1, y: 0 }} className="w-full max-w-lg bg-obsidian border border-gold/30 rounded-sm p-6 sm:p-8 shadow-2xl relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-gold to-transparent" />
                    <h2 className="text-2xl font-black text-platinum mb-6 text-center">ã”åˆ©ç”¨ã«ã‚ãŸã£ã¦</h2>
                    <div className="space-y-4 text-sm text-platinum/80 leading-relaxed max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                        <p>
                            INVISIONã¯ã€æŠ•è³‡ã‚’å§‹ã‚ã‚‹å‰ã«ã€Œè‡ªåˆ†ã‚’çŸ¥ã‚‹ã€ãŸã‚ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚<br />
                            ã“ã®ã‚µã‚¤ãƒˆã¯å­¦ç¿’ãƒ»è‡ªå·±åˆ†æã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€ç‰¹å®šã®å•†å“ã®è³¼å…¥ã‚’å‹§ã‚ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                        </p>
                        <ul className="list-disc pl-5 space-y-2 marker:text-gold">
                            <li>
                                è¨ºæ–­ã‚„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœã¯ã‚ãã¾ã§å‚è€ƒæƒ…å ±ã§ã‚ã‚Šã€å°†æ¥ã®æˆæœã‚’ç´„æŸã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                            </li>
                            <li>
                                æŠ•è³‡ã®æœ€çµ‚åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ã¨ãªã‚Šã¾ã™ã€‚å…ƒæœ¬ãŒæ¸›ã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã“ã¨ã‚’ã”ç†è§£ãã ã•ã„ã€‚
                            </li>
                            <li>
                                ç´¹ä»‹ã—ã¦ã„ã‚‹è¨¼åˆ¸ä¼šç¤¾ã‚„é‡‘èã‚µãƒ¼ãƒ“ã‚¹ã®æ¡ä»¶ã¯å¤‰æ›´ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚æœ€æ–°æƒ…å ±ã¯å„ç¤¾å…¬å¼ã‚µã‚¤ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚
                            </li>
                        </ul>
                    </div>
                    <div className="mt-8 pt-6 border-t border-white/10 flex flex-col gap-4">
                        <button onClick={onAccept} className="w-full py-4 bg-gold text-black font-bold text-lg rounded-sm hover:bg-amber-400 transition-colors shadow-[0_0_20px_rgba(218,165,32,0.3)]">
                            åŒæ„ã—ã¦å§‹ã‚ã‚‹
                        </button>
                    </div>
                </motion.div>
            </motion.div>
        );

        const SplashScreen = ({ onComplete }) => {
            useEffect(() => { setTimeout(onComplete, 2500); }, [onComplete]);
            return (<motion.div className="fixed inset-0 bg-obsidian z-50 flex items-center justify-center" exit={{ opacity: 0 }}><motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}><h1 className="text-6xl font-black tracking-tighter"><span className="text-gold-gradient">IN</span><span className="text-platinum">VISION</span></h1><motion.div className="h-px bg-gold/50 mt-4" initial={{ scaleX: 0 }} animate={{ scaleX: 1 }} transition={{ duration: 2 }} /></motion.div></motion.div>);
        };

        // iOS Home Screen Install Prompt
        const IOSInstallPrompt = ({ onDismiss }) => {
            const [step, setStep] = useState(0);
            const steps = [
                { icon: 'â–¡â†‘', title: 'å…±æœ‰ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—', desc: 'ç”»é¢ä¸‹éƒ¨ã®å…±æœ‰ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆâ–¡ã«â†‘ï¼‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„', visual: 'â¬†ï¸' },
                { icon: 'ï¼‹', title: 'ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’ã‚¿ãƒƒãƒ—', desc: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠ', visual: 'ğŸ“±' },
                { icon: 'âœ“', title: 'ã€Œè¿½åŠ ã€ã‚’ã‚¿ãƒƒãƒ—', desc: 'å³ä¸Šã®ã€Œè¿½åŠ ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å®Œäº†ï¼', visual: 'âœ…' }
            ];
            return (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/90 backdrop-blur-md p-0 sm:p-6">
                    <motion.div initial={{ y: 100, opacity: 0 }} animate={{ y: 0, opacity: 1 }} transition={{ type: 'spring', stiffness: 300, damping: 30 }}
                        className="w-full sm:max-w-md bg-obsidian border border-gold/30 rounded-t-2xl sm:rounded-sm p-6 sm:p-8 shadow-2xl relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-gold to-transparent" />

                        {/* Drag handle for mobile */}
                        <div className="flex justify-center mb-4 sm:hidden">
                            <div className="w-10 h-1 bg-white/20 rounded-full" />
                        </div>

                        <div className="text-center mb-6">
                            <div className="w-16 h-16 mx-auto mb-4 bg-gold/10 rounded-2xl flex items-center justify-center border border-gold/30">
                                <span className="text-3xl">ğŸ“²</span>
                            </div>
                            <h2 className="text-xl font-black text-platinum mb-2">ã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«ä½¿ã†</h2>
                            <p className="text-xs text-dim leading-relaxed">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«å¿«é©ã«ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™</p>
                        </div>

                        {/* Steps */}
                        <div className="space-y-3 mb-6">
                            {steps.map((s, i) => (
                                <motion.div key={i}
                                    initial={{ opacity: 0, x: -20 }}
                                    animate={{ opacity: 1, x: 0 }}
                                    transition={{ delay: 0.2 + i * 0.15 }}
                                    className={`flex items-center gap-4 p-3 rounded-sm border transition-all duration-300 ${step === i ? 'bg-gold/10 border-gold/40 shadow-[0_0_15px_rgba(201,162,39,0.1)]' : 'bg-white/3 border-white/5'
                                        }`}
                                    onClick={() => setStep(i)}>
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold flex-shrink-0 ${step === i ? 'bg-gold text-black' : 'bg-white/5 text-white/40'
                                        }`}>
                                        {i + 1}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <p className={`text-sm font-bold ${step === i ? 'text-gold' : 'text-platinum/60'}`}>{s.title}</p>
                                        {step === i && (
                                            <motion.p initial={{ opacity: 0, height: 0 }} animate={{ opacity: 1, height: 'auto' }}
                                                className="text-xs text-dim mt-1 leading-relaxed">{s.desc}</motion.p>
                                        )}
                                    </div>
                                    <span className="text-xl flex-shrink-0">{s.visual}</span>
                                </motion.div>
                            ))}
                        </div>

                        {/* Safari bottom bar illustration */}
                        <div className="bg-white/5 border border-white/10 rounded-sm p-3 mb-6">
                            <div className="flex items-center justify-center gap-6">
                                <span className="text-white/20">â—</span>
                                <span className="text-white/20">â–·</span>
                                <div className="ios-share-icon">
                                    <span>â†‘</span>
                                </div>
                                <span className="text-white/20">â˜°</span>
                                <span className="text-white/20">â–£</span>
                            </div>
                            <p className="text-center text-[10px] text-gold/60 mt-2">â†‘ ã“ã®å…±æœ‰ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—</p>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={onDismiss} className="flex-1 py-3 bg-white/5 border border-white/10 text-platinum/70 rounded-sm text-sm font-bold hover:bg-white/10 transition-colors">
                                ã‚ã¨ã§
                            </button>
                            <button onClick={onDismiss} className="flex-1 py-3 bg-gold text-black font-bold text-sm rounded-sm hover:bg-amber-400 transition-colors shadow-[0_0_15px_rgba(218,165,32,0.2)]">
                                OK
                            </button>
                        </div>
                    </motion.div>
                </motion.div>
            );
        };

        const App = () => {
            // localStorage key for state persistence
            const STORAGE_KEY = 'invision_state_v1';

            // Load initial state from localStorage
            const loadSavedState = () => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved) : null;
                } catch (e) {
                    console.warn('Failed to load saved state:', e);
                    return null;
                }
            };

            const savedState = useMemo(() => loadSavedState(), []);

            // ============================================
            // UNIFIED STATE WITH useReducer
            // ============================================
            const initialState = {
                // Persisted state
                onboardingStep: savedState?.onboardingStep ?? 0,
                currentPage: savedState?.currentPage ?? 'gallery',
                userProfile: savedState?.userProfile ?? null,
                userGoals: savedState?.userGoals ?? null,
                learnProgress: savedState?.learnProgress ?? 0,
                userPlan: savedState?.userPlan ?? 'free',
                understoodCards: savedState?.understoodCards ?? [],
                unclearCards: savedState?.unclearCards ?? [],
                purchasedBundles: savedState?.purchasedBundles ?? [],
                freeLimit: savedState?.freeLimit ?? 5,
                nextReplenishTime: savedState?.nextReplenishTime ?? null,
                dailyCompleted: savedState?.dailyCompleted ?? 0,
                lastDailyGoalDate: savedState?.lastDailyGoalDate ?? Date.now(),
                portfolioSettings: savedState?.portfolioSettings ?? null,
                // UI-only state (not persisted)
                showSplash: true,
                showSettings: false,
                showDisclaimer: true,
                showIOSPrompt: false,
                pageParams: null
            };

            // Action types for clear state transitions
            const ACTION_TYPES = {
                FINISH_SPLASH: 'FINISH_SPLASH',
                ACCEPT_DISCLAIMER: 'ACCEPT_DISCLAIMER',
                SHOW_IOS_PROMPT: 'SHOW_IOS_PROMPT',
                DISMISS_IOS_PROMPT: 'DISMISS_IOS_PROMPT',
                SET_PAGE: 'SET_PAGE',
                SET_PROFILE: 'SET_PROFILE',
                SET_GOALS: 'SET_GOALS',
                SET_PROGRESS: 'SET_PROGRESS',
                SET_PLAN: 'SET_PLAN',
                SET_ONBOARDING: 'SET_ONBOARDING',
                TOGGLE_SETTINGS: 'TOGGLE_SETTINGS',
                UPDATE_CARDS: 'UPDATE_CARDS',
                SET_PAGE_PARAMS: 'SET_PAGE_PARAMS',
                PURCHASE_BUNDLE: 'PURCHASE_BUNDLE',
                UPDATE_LIMITS: 'UPDATE_LIMITS',
                SET_DAILY_COMPLETED: 'SET_DAILY_COMPLETED',
                RESET_DAILY_GOAL: 'RESET_DAILY_GOAL',
                UPDATE_PORTFOLIO_SETTINGS: 'UPDATE_PORTFOLIO_SETTINGS'
            };

            const appReducer = (state, action) => {
                switch (action.type) {
                    case ACTION_TYPES.FINISH_SPLASH:
                        return { ...state, showSplash: false };
                    case ACTION_TYPES.ACCEPT_DISCLAIMER:
                        return { ...state, showDisclaimer: false, currentPage: state.onboardingStep === 0 ? 'diagnosis' : state.currentPage };
                    case ACTION_TYPES.SHOW_IOS_PROMPT:
                        return { ...state, showIOSPrompt: true };
                    case ACTION_TYPES.DISMISS_IOS_PROMPT:
                        return { ...state, showIOSPrompt: false };
                    case ACTION_TYPES.SET_PAGE:
                        return {
                            ...state,
                            currentPage: action.payload.page,
                            pageParams: action.payload.params || null,
                            onboardingStep: action.payload.page === 'gallery' && state.onboardingStep < 3
                                ? 3 : state.onboardingStep
                        };
                    case ACTION_TYPES.SET_PROFILE:
                        return { ...state, userProfile: action.payload };
                    case ACTION_TYPES.SET_GOALS:
                        return { ...state, userGoals: action.payload };
                    case ACTION_TYPES.SET_PROGRESS:
                        return { ...state, learnProgress: action.payload };
                    case ACTION_TYPES.SET_PLAN:
                        return { ...state, userPlan: action.payload };
                    case ACTION_TYPES.SET_ONBOARDING:
                        return { ...state, onboardingStep: action.payload };
                    case ACTION_TYPES.TOGGLE_SETTINGS:
                        return { ...state, showSettings: action.payload ?? !state.showSettings };
                    case ACTION_TYPES.UPDATE_CARDS:
                        return {
                            ...state,
                            understoodCards: action.payload.understood ?? state.understoodCards,
                            unclearCards: action.payload.unclear ?? state.unclearCards
                        };
                    case ACTION_TYPES.SET_PAGE_PARAMS:
                        return { ...state, pageParams: action.payload };
                    case ACTION_TYPES.PURCHASE_BUNDLE:
                        return {
                            ...state,
                            purchasedBundles: state.purchasedBundles.includes(action.payload)
                                ? state.purchasedBundles
                                : [...state.purchasedBundles, action.payload]
                        };
                    case ACTION_TYPES.UPDATE_LIMITS:
                        return {
                            ...state,
                            freeLimit: action.payload.freeLimit !== undefined ? action.payload.freeLimit : state.freeLimit,
                            nextReplenishTime: action.payload.nextReplenishTime !== undefined ? action.payload.nextReplenishTime : state.nextReplenishTime
                        };
                    case ACTION_TYPES.SET_DAILY_COMPLETED:
                        return {
                            ...state,
                            dailyCompleted: action.payload,
                            lastDailyGoalDate: Date.now()
                        };
                    case ACTION_TYPES.RESET_DAILY_GOAL:
                        return {
                            ...state,
                            dailyCompleted: 0,
                            lastDailyGoalDate: Date.now()
                        };
                    case ACTION_TYPES.UPDATE_PORTFOLIO_SETTINGS:
                        return {
                            ...state,
                            portfolioSettings: action.payload
                        };
                    default:
                        return state;
                }
            };

            const [state, dispatch] = useReducer(appReducer, initialState);

            // Destructure for convenience (read-only)
            const {
                showSplash, showSettings, showDisclaimer, showIOSPrompt, pageParams,
                onboardingStep, currentPage, userProfile, userGoals,
                learnProgress, userPlan, understoodCards, unclearCards,
                purchasedBundles, freeLimit, nextReplenishTime, dailyCompleted,
                portfolioSettings
            } = state;

            // Save persisted state to localStorage (debounced)
            useEffect(() => {
                const saveTimeout = setTimeout(() => {
                    try {
                        const stateToSave = {
                            onboardingStep: state.onboardingStep,
                            currentPage: state.currentPage,
                            userProfile: state.userProfile,
                            userGoals: state.userGoals,
                            learnProgress: state.learnProgress,
                            userPlan: state.userPlan,
                            understoodCards: state.understoodCards,
                            unclearCards: state.unclearCards,
                            purchasedBundles: state.purchasedBundles,
                            freeLimit: state.freeLimit,
                            nextReplenishTime: state.nextReplenishTime,
                            dailyCompleted: state.dailyCompleted,
                            lastDailyGoalDate: state.lastDailyGoalDate,
                            portfolioSettings: state.portfolioSettings
                        };
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
                    } catch (e) {
                        console.warn('Failed to save state:', e);
                    }
                }, 500);
                return () => clearTimeout(saveTimeout);
            }, [state]);

            // Check for new day to reset daily goal
            useEffect(() => {
                const lastDate = new Date(state.lastDailyGoalDate);
                const today = new Date();
                // If last goal date is not today (different day), reset
                if (lastDate.toDateString() !== today.toDateString()) {
                    dispatch({ type: ACTION_TYPES.RESET_DAILY_GOAL });
                }
            }, [state.lastDailyGoalDate]); // Run once on mount

            // ============================================
            // ACTION DISPATCHERS (memoized)
            // ============================================
            const acceptDisclaimer = useCallback(() => {
                dispatch({ type: ACTION_TYPES.ACCEPT_DISCLAIMER });
                // Check if iOS Safari and not already installed as PWA
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                const isStandalone = window.navigator.standalone === true;
                const hasSeenPrompt = sessionStorage.getItem('ios_prompt_seen');
                if (isIOS && !isStandalone && !hasSeenPrompt) {
                    dispatch({ type: ACTION_TYPES.SHOW_IOS_PROMPT });
                    sessionStorage.setItem('ios_prompt_seen', 'true');
                }
            }, []);

            const dismissIOSPrompt = useCallback(() => {
                dispatch({ type: ACTION_TYPES.DISMISS_IOS_PROMPT });
            }, []);

            const finishSplash = useCallback(() => {
                dispatch({ type: ACTION_TYPES.FINISH_SPLASH });
            }, []);

            const handleNavigate = useCallback((page, params) => {
                dispatch({ type: ACTION_TYPES.SET_PAGE, payload: { page, params } });
                if (page === 'gallery') {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }, []);

            const finishCalibration = useCallback((profile) => {
                dispatch({ type: ACTION_TYPES.SET_PROFILE, payload: profile });
                dispatch({ type: ACTION_TYPES.SET_ONBOARDING, payload: 3 });
                dispatch({ type: ACTION_TYPES.SET_PAGE, payload: { page: 'portfolio' } });
            }, []);

            const skipOnboarding = useCallback(() => {
                dispatch({ type: ACTION_TYPES.SET_ONBOARDING, payload: 3 });
                dispatch({ type: ACTION_TYPES.SET_PAGE, payload: { page: 'gallery' } });
            }, []);

            const handleDiagnosisComplete = useCallback((profile) => {
                dispatch({ type: ACTION_TYPES.SET_PROFILE, payload: profile });
                dispatch({ type: ACTION_TYPES.SET_PAGE, payload: { page: 'portfolio' } });
            }, []);

            const handleSkip = useCallback(() => {
                dispatch({ type: ACTION_TYPES.SET_PAGE, payload: { page: 'gallery' } });
            }, []);

            const handleSetProfile = useCallback((profile) => {
                dispatch({ type: ACTION_TYPES.SET_PROFILE, payload: profile });
            }, []);

            const handleSetPlan = useCallback((plan) => {
                dispatch({ type: ACTION_TYPES.SET_PLAN, payload: plan });
            }, []);

            const handleSetProgress = useCallback((progress) => {
                dispatch({ type: ACTION_TYPES.SET_PROGRESS, payload: progress });
            }, []);

            const handleUpdateCards = useCallback((cards) => {
                dispatch({ type: ACTION_TYPES.UPDATE_CARDS, payload: cards });
            }, []);

            const handleOpenSettings = useCallback(() => {
                dispatch({ type: ACTION_TYPES.TOGGLE_SETTINGS, payload: true });
            }, []);

            const handleCloseSettings = useCallback(() => {
                dispatch({ type: ACTION_TYPES.TOGGLE_SETTINGS, payload: false });
            }, []);

            const handleClearPreSelection = useCallback(() => {
                dispatch({ type: ACTION_TYPES.SET_PAGE_PARAMS, payload: null });
            }, []);

            const handlePurchaseBundle = useCallback((bundleId) => {
                dispatch({ type: ACTION_TYPES.PURCHASE_BUNDLE, payload: bundleId });
            }, []);

            const handleUpdateLimits = useCallback((limits) => {
                dispatch({ type: ACTION_TYPES.UPDATE_LIMITS, payload: limits });
                // If limits are being replenished (implied by adding to freeLimit or resetting time),
                // we should also reset the daily goal for the new "session"
                if (limits.freeLimit && limits.freeLimit > state.freeLimit) {
                    dispatch({ type: ACTION_TYPES.RESET_DAILY_GOAL });
                }
            }, [state.freeLimit]); // Add state.freeLimit dependency to compare

            const handleUpdateDailyCompleted = useCallback(({ dailyCompleted }) => {
                dispatch({ type: ACTION_TYPES.SET_DAILY_COMPLETED, payload: dailyCompleted });
            }, []);

            const handleUpdatePortfolioSettings = useCallback((settings) => {
                dispatch({ type: ACTION_TYPES.UPDATE_PORTFOLIO_SETTINGS, payload: settings });
            }, []);

            // ============================================
            // CONTENT RENDERER
            // ============================================
            const renderContent = () => {
                if (onboardingStep === 1) {
                    return <PortfolioCalibration onComplete={finishCalibration} isOnboarding={true} onSkip={skipOnboarding} onNavigate={handleNavigate} />;
                }

                switch (currentPage) {
                    case 'diagnosis':
                        return <PortfolioCalibration onComplete={handleDiagnosisComplete} onSkip={handleSkip} existingProfile={userProfile} isOnboarding={onboardingStep === 1} onNavigate={handleNavigate} />;
                    case 'portfolio':
                        return <PortfolioCreator
                            userProfile={userProfile}
                            onNavigate={handleNavigate}
                            userPlan={userPlan}
                            onUpgrade={() => handleSetPlan('pro')}
                            portfolioSettings={portfolioSettings}
                            onSave={handleUpdatePortfolioSettings}
                        />;
                    case 'market':
                        return <MarketIntelligence onNavigate={handleNavigate} />;
                    case 'briefing':
                        return <TheBriefing
                            onNavigate={handleNavigate}
                            userProfile={userProfile}
                            userGoals={userGoals}
                            onProgressUpdate={handleSetProgress}
                            userPlan={userPlan}
                            onUpgrade={handleSetPlan}
                            understoodCards={understoodCards}
                            unclearCards={unclearCards}
                            dailyCompleted={dailyCompleted}
                            setUnderstoodCards={(cards) => handleUpdateCards({ understood: cards })}
                            setUnclearCards={(cards) => handleUpdateCards({ unclear: cards })}
                            purchasedBundles={purchasedBundles}
                            onPurchaseBundle={handlePurchaseBundle}
                            freeLimit={freeLimit}
                            nextReplenishTime={nextReplenishTime}
                            onUpdateLimits={handleUpdateLimits}
                            onUpdateDailyCompleted={handleUpdateDailyCompleted}
                        />;
                    case 'calibration':
                        return <PortfolioCalibration existingProfile={userProfile} onComplete={(p) => { handleSetProfile(p); handleNavigate('gallery'); }} onNavigate={handleNavigate} />;
                    case 'brokers':
                        return <BrokerComparison onNavigate={handleNavigate} />;
                    case 'tokushoho':
                        return <Tokushoho onNavigate={handleNavigate} />;
                    default:
                        return <AssetGallery onNavigate={handleNavigate} preSelectedAssetId={pageParams?.assetId} onClearPreSelection={handleClearPreSelection} />;
                }
            };

            // ============================================
            // RENDER
            // ============================================
            return (
                <div className="font-sans text-platinum selection:bg-gold/30">
                    {showSplash && <SplashScreen onComplete={finishSplash} />}

                    {showDisclaimer && !showSplash && <DisclaimerModal onAccept={acceptDisclaimer} />}

                    {showIOSPrompt && !showSplash && !showDisclaimer && <IOSInstallPrompt onDismiss={dismissIOSPrompt} />}

                    {!showSplash && !showDisclaimer && !showIOSPrompt && (
                        <motion.div key="main" initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                            <Header
                                currentPage={currentPage}
                                onNavigate={handleNavigate}
                                onOpenSettings={handleOpenSettings}
                                showNav={true}
                                userProfile={userProfile}
                                progress={learnProgress}
                            />
                            {renderContent()}
                            <AnimatePresence>
                                <SettingsModal isOpen={showSettings} onClose={handleCloseSettings} onNavigate={handleNavigate} />
                            </AnimatePresence>
                        </motion.div>
                    )}
                </div>
            );
        };


        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>